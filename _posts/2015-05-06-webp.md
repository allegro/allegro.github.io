---
layout: post
title: WebP at Allegro
author: michal.jezierski
tags: [webp, images]
---

A lot has been written already about [WebP](http://en.wikipedia.org/wiki/WebP), the new image format by Google that
provides lossless and lossy compression for images on the web. It’s still not popular in web development though.
Although it’s already shipped by Chrome and Opera, Internet Explorer 11 and Firefox 39 lacks this feature completely.
Browser support can be checked on [caniuse.com](http://caniuse.com/#feat=webp) and
[status.modern.ie](https://status.modern.ie/webpimageformatsupport?term=webp) websites.

The table below shows potential benefits for selected websites if WebP is used instead of JPEG:

| website     | # of JPEG images | JPEG images size | WebP images size |
|-------------|------------------|------------------|------------------|
| bbc.com     | 26               | 332KB            | 188KB            |
| allegro.pl  | 26               | 1011KB           | 267KB            |
| amazon.com  | 147              | 1945KB           | 1082KB           |
| zalando.pl  | 34               | 410KB            | 67KB             |
| merlin.pl   | 77               | 858KB            | 366KB            |

We recently delivered WebP to [Allegro Articles’](http://allegro.pl/artykuly/elektronika) readers. And here’s what we
have gained in various departments:

| department                                                                 | size with JPEGs  | size with WebPs  |
|----------------------------------------------------------------------------|------------------|------------------|
| [electronics](http://allegro.pl/artykuly/elektronika)                      | 642KB            | 440KB            |
| [sports and leisure](http://allegro.pl/artykuly/sport-i-wypoczynek)        | 740KB            | 462KB            |
| [automotive](http://allegro.pl/artykuly/motoryzacja)                       | 747KB            | 501KB            |
| [household and health](http://allegro.pl/artykuly/dom-i-zdrowie)           | 821KB            | 445KB            |
| [baby](http://allegro.pl/artykuly/dziecko)                                 | 1004KB           | 462KB            |
| [culture and entertainment](http://allegro.pl/artykuly/kultura-i-rozrywka) | 742KB            | 462KB            |
| [fashion and beauty](http://allegro.pl/artykuly/moda-i-uroda)              | 682KB            | 425KB            |

We reduced website size by 40% in average. This is clearly a huge profit for mobile users.

### The `<picture/>` way

The basic way to provide the image format that user’s browser supports, is to use `picture` HTML5 tag. The most recent
documentation of the picture tag can be found in the latest
[HTML Editor’s Draft](http://www.w3.org/html/wg/drafts/html/master/#the-picture-element). Elementary example might
look like the following:

```html
<picture>
  <source srcset="photo.webp" type="image/webp" />
  <img src="photo.jpg" alt="photo" />
</picture>
```

What user agent does is called *image format based selection*. It inspects `type` attribute in the first picture’s
source child element. If a browser finds a given MIME type supported then the first source element is used. If it’s
not supported the next one is considered (`img` in this case, which obviously works everywhere).

The `picture` tag along with `source` are not supported everywhere
(check [browser support](http://caniuse.com/#search=picture)). Nevertheless web developers learned how to deal with
it. Scott Jehl wrote [picturefill](https://github.com/scottjehl/picturefill) which might be helpful in this cases.
It goes through each child of picture element and test your browser against given media types. Then it looks for a
best candidate on the basis of supported media types and `window.devicePixelRatio`. The best candidate is applied
and `img` tag is created with `src` value derived from `srcset`.

If you don’t care about adding some extra kilobytes to your website then picturefill might be good for you. There’s
one problem with this solution — you need to have two versions of your image. The first image as WebP and the second
one as JPEG. It means that you need to maintain both of them which is not always possible.

### Convert images on the fly

Having your own image conversion service is a good way to solve this problem. In Allegro we have ScaleMe which does
image conversion on the fly. We use it to manipulate images served for
[Allegro Articles](http://allegro.pl/elektronika). Compare these two images (use Chrome or Opera for the second URL):

http://articles.scaleme.pl/DB60B87F/27363/238x134/centercrop — JPEG, 14.4 KB

http://articles.scaleme.pl/DF95DFDF/27363/238x134/centercrop/format_webp — WebP, 4.7 KB

Media types and URLs are different, but the origin of these two images is the same. Note the difference in image
weights — it’s really significant, contrasting to the difference in quality, which is negligible.

### Analyze `Accept` header

Every WebP-enabled browser is expressing this fact via `Accept` header. For example Google Chrome sends the following:

```
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8
```

We can use above header to recognise user agents which do support webp form those who don’t. In
[Spring Framework](http://projects.spring.io/spring-framework/) this can be handled using an interceptor:

```java
public class WebpInterceptor extends HandlerInterceptorAdapter {
    private final Pattern webpPattern = Pattern.compile(".*image/webp.*");

    @Override
    public void postHandle(HttpServletRequest request,
                           HttpServletResponse response,
                           Object handler,
                           ModelAndView modelAndView) {
        String accept = request.getHeader("Accept");
        if (null != modelAndView && webpPattern.matcher(accept).matches()) {
            modelAndView.getModelMap().addAttribute("webp", true);
        }
    }
}
```

If a user agent supports WebP images then `webp` attribute is added to model. Now it can be used in a template —
here’s an example in [Handlebars](https://github.com/jknack/handlebars.java):

```html
{{if webp}}
  <img src='{{image article.image "webp"}}' alt="" />
{{else}}
  <img src='{{image article.image "jpeg"}}' alt="" />
{{/if}}
```

Above, the `image` helper uses a backend image manipulation tool and serves the desired image URL:

```java
@Override
public String image(String url, String format) {
    return imageManipulationService.buildImageUrl(format);
}
```

### Caching on proxy server

If any caching proxy servers are used (for example [Varnish Cache](https://www.varnish-cache.org/)) then don’t forget
to add the following response header:

`Vary: Accept`

This instructs proxy to cache a separate copy for every variation of `Accept` header. As a result, content with WebPs
is served to all WebP enabled browsers and content with JPEGs to the others.


### Summary

The benefit of using WebP is not so small, it’s big, sometimes very big. According to caniuse.com WebP format is
supported by 61% of users globally and by 72% of users in Poland. Taking it into account it’s worth to get your
hands dirty and provide WebP to your users.
