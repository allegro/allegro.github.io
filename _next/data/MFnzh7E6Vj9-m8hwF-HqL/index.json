{"pageProps":{"posts":[{"title":"Kotlin - a language for everyone and for everything. Even scripts.","link":"https://blog.allegro.tech/2021/04/kotlin-scripting.html","pubDate":"Tue, 13 Apr 2021 00:00:00 +0200","authors":{"author":[{"name":["Weronika Orczyk"],"photo":["https://blog.allegro.tech/img/authors/weronika.orczyk.jpg"],"url":["https://blog.allegro.tech/authors/weronika.orczyk"]}]},"content":"<p>According to Wikipedia there are approximately 700 computer languages available. Seven hundred.\nThis is an unbelievable number and it’s the reason why programmers face the problem of\nchoosing a programming language to work with, which frameworks to use and which tech stack to learn.\nAll of them have pros and cons, but when looking for an all-purpose language you should take Kotlin\ninto consideration and ask yourself the question: “Do I really need another programming language?”.</p>\n\n<p><img src=\"/img/articles/2021-04-13-scripting.jpg\" alt=\"scripting\" /></p>\n\n<p>Kotlin is an open source, statically typed and powerful language. It takes inspiration from many programming languages like Java,\nScala, C#, Groovy, Python and it attempts to combine the best features from each. The support for multiplatform programming\nis one of Kotlin’s key benefits. It is able to compile to many platforms including Android, JVM, JavaScript and native.</p>\n\n<p>Kotlin is great for building applications, but what if you need to write a script? The first thing that comes to mind is to use\na classic, traditional shell script or Python, what gives you the ability to move files, copy, delete and more by running\na program from command-line. But if Kotlin is your cup of tea, it can be also used as a scripting language!</p>\n\n<p>When talking about shell scripts, I have to mention their syntax, which can be unclear and enigmatic. It is really hard to write\na clear piece of code in a complex script. Another drawback is long execution time. Shell scripts are simply slow due to almost\nevery executed shell command’s need to launch a new process. Additionally, there are compatibility problems between platforms.\nThe creator of Perl, Larry Wall, famously wrote that “It is easier to port a shell than a shell script.”</p>\n\n<p>I’ve mentioned slow execution of shell scripts due to creation of a new process every command. It’s true,\nbut on the other hand spinning up a new JVM to execute a script and a compilation process is also long. The execution time usually\ndepends on a machine and distribution of JVM. It can be a bit frustrating when Java version is inappropriate for an executed script\nor when some machines use different operating system, what can lead to compatibility issues.</p>\n\n<p>So how about Python? It provides lots of useful libraries covering almost any needs and is available on most systems,\nessentially eliminating the problem of compatibility.</p>\n\n<p>While scripts written in Python are more readable than shell scripts, they aren’t type-safe in the way that Kotlin\nis. Kotlin is statically typed, what means that types are verified during compilation, and strongly typed, i.e.\nthe type of a variable cannot change after its declaration. In contrast to a dynamically typed language, including Python,\nit helps prevent all kinds of incompatible type errors. It brings the opportunity to create scripts that help automate\nmundane tasks, but doing it in a much safer way.</p>\n\n<p>Let’s move to the code and see Kotlin scripts in practice.</p>\n\n<h3 id=\"install-kotlin-for-scripting\">Install Kotlin for scripting</h3>\n<p>In order to allow scripting, you need to make Kotlin available for the entire system. Open a terminal and check if Kotlin is\ninstalled:</p>\n<div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>kotlinc -version\n</code></pre></div></div>\n<p>If the command was not found, the easiest way to install Kotlin on UNIX-based systems such as OS X,\nLinux, Cygwin, FreeBSD, and Solaris is SDKMAN!. Install Kotlin with the command:</p>\n<div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>sdk install kotlin\n</code></pre></div></div>\n\n<p>Alternatively, on OS X you can install the compiler via Homebrew:</p>\n<div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>brew install kotlin\n</code></pre></div></div>\n<p>Check the Kotlin version again.</p>\n\n<h3 id=\"first-script\">First script</h3>\n\n<p><a href=\"https://github.com/Kotlin/KEEP/blob/master/proposals/scripting-support.md\">Kotlin Evolution and Enhancement Process (KEEP) document</a>\nwas created to explain Kotlin scripting. It presents use cases of scripting with examples and contains the general proposal,\nbut it is still a draft. According to this file, a Kotlin script is a simple Kotlin snippet. Each command in the file is\nexecuted as if it was in the main function. To make a file executable, the file has to be named <code class=\"language-plaintext highlighter-rouge\">*.kts</code>.</p>\n\n<p>Create the first script and name the file <code class=\"language-plaintext highlighter-rouge\">first-script.kts</code>.</p>\n<div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>touch first-script.kts\n</code></pre></div></div>\n<p>Edit file and add some code:</p>\n<div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>println(\"Hello, it’s your first script called with args:\")\nargs.forEach {\n    println(\"* $it\")\n}\n</code></pre></div></div>\n<p>And run it with example arguments:</p>\n<div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>kotlinc -script first-script.kts test 'test with space'\n</code></pre></div></div>\n<p>You should see the result:</p>\n<div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>Hello, it’s your first script called with args:\n* test\n* test with space\n</code></pre></div></div>\n<p>Really simple! In addition, scripts can use Java or Kotlin stlib to have access to more powerful libraries.\nOf course, functions and classes can be used to make the script more readable and easy to maintain.</p>\n\n<div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>import java.io.File\n\nfun printDirs() {\n    File(\".\").listFiles { file -&gt; file.isDirectory }?.forEach {\n        println(it)\n    }\n}\n\nprintDirs()\n</code></pre></div></div>\n\n<h3 id=\"kotlin-main-kts\">Kotlin-main-kts</h3>\n<p>Kotlin-main-kts is a solution provided by the Kotlin team. The 1.3.70 version brought a set of improvements that\nprovide a better experience of using Kotlin scripts with IntelliJ IDEA and Kotlin command-line tools.\nMore details can be found in <a href=\"https://blog.jetbrains.com/kotlin/2020/03/kotlin-1-3-70-released/\">a release blog post</a>.\nAll you need to use kotlin-main-kts is to create a file named <code class=\"language-plaintext highlighter-rouge\">*.main.kts</code> and execute script.</p>\n\n<p>Moreover, from 1.3.70 on, it is easier to run the program. The command is:</p>\n\n<div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>kotlin myscript.main.kts\n</code></pre></div></div>\n\n<p>Using kotlin-main-kts has a lot of advantages. <code class=\"language-plaintext highlighter-rouge\">*.main.kts</code> scripts are supported out of the box in IntelliJ,\neven outside the source directories. It gives you highlighting and navigation, autocompletes code\nand resolves dynamic dependencies. What’s more, third party libraries can be used in scripts by\nincluding them as dependencies using directives or annotations specified with gradle-style with group ID,\nartifact ID and version. For example, if you write a script which copies data from a CSV file and inserts the data\ninto a database, you need to use a connector. You can achieve this by <code class=\"language-plaintext highlighter-rouge\">@file:DependsOn</code> annotation. The example below shows\nhow to connect to a MongoDB database. A database <em>URL</em> is required as an argument e.g. <code class=\"language-plaintext highlighter-rouge\">mongodb://localhost:27017/test-db</code></p>\n\n<div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>@file:Repository(\"https://jcenter.bintray.com\")\n@file:DependsOn(\"org.mongodb:mongo-java-driver:3.12.8\")\n\nimport com.mongodb.client.MongoClients\n\nfun createConnection(url: String) =\n    MongoClients.create(url).use {\n        println(\"Connected to MongoDB!\")\n    }\n\nval (mongoUrl) = args\ncreateConnection(mongoUrl)\n</code></pre></div></div>\n\n<p>What’s interesting, it is also possible to execute a script exactly in the same way as an executable file - for example by\ncommand <code class=\"language-plaintext highlighter-rouge\">./kotlin-script.main.kts</code>. The first line in a file makes difference. It is required to add <code class=\"language-plaintext highlighter-rouge\">#!/usr/bin/env kotlin</code>\nat the beginning of script to run it in such way.</p>\n\n<div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>#!/usr/bin/env kotlin\nprintln(\"Hello, world!\")\n</code></pre></div></div>\n\n<h3 id=\"kscript\">Kscript</h3>\n\n<p>Also, I have to mention <a href=\"https://github.com/holgerbrandl/kscript\">Kscript</a>. It is one of the ways to support scripting in\nKotlin. Actually, it is a wrapper around kotlinc which adds some features. After Kscript installation you can easily run\nscript by command:</p>\n<div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>kscript first-script.kts\n</code></pre></div></div>\n\n<p>This tool was created in 2016. In the beginning, Kotlin wasn’t feature-rich enough to be a viable alternative to the\nshell. <a href=\"https://www.youtube.com/watch?v=cOJPKhlRa8c\">The great talk on Kotlin Conf by Holger Brandl</a> shows the\nhistory of its creation and explains that initially the tool was created for data science purposes.</p>\n\n<p>The creators listed such advantages as:</p>\n<ul>\n  <li>compiled script caching (using md5 checksums)</li>\n  <li>dependency declarations using gradle-style resource locators and automatic dependency resolution</li>\n  <li>possibility to deploy scripts as standalone binaries</li>\n  <li>inlined usage - you don’t need to create script file</li>\n</ul>\n\n<p>In my opinion, the cache mechanism is the biggest advantage of using Kscript tool. Whenever you run a script with kotlinc\nit is recompiled, which makes it slow. Each time the script is started, Kscripts checks if code has been modified since the last\ncompilation (by hashing the content of the script). If file wasn’t changed, cached version is immediately executed. The\ntable below shows time of execution of the same script by <code class=\"language-plaintext highlighter-rouge\">kotlinc</code> command and Kscript. As we can see, the cache has a\npositive effect on execution time.</p>\n\n<table>\n  <thead>\n    <tr>\n      <th><code class=\"language-plaintext highlighter-rouge\">time kotlinc -script script.kts</code></th>\n      <th><code class=\"language-plaintext highlighter-rouge\">time kscript script.kts</code></th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <td>2.930s</td>\n      <td>3.972s</td>\n    </tr>\n    <tr>\n      <td>2.991s</td>\n      <td>0.868s</td>\n    </tr>\n    <tr>\n      <td>2.968s</td>\n      <td>0.912s</td>\n    </tr>\n  </tbody>\n</table>\n\n<p>Kotlin v1.4 brought a much improved scripting integration. But until Kotlin scripting interpreter isn’t rich and\nversatile, Kscript will be supported and developed.</p>\n\n<h3 id=\"conclusion\">Conclusion</h3>\n<p>Kotlin makes scripting really easy. Powerful scripts can be created with the autocompletion and the strong typing,\nmaking them really readable and highly maintainable.</p>\n\n<p>Happy scripting!</p>\n","contentSnippet":"According to Wikipedia there are approximately 700 computer languages available. Seven hundred.\nThis is an unbelievable number and it’s the reason why programmers face the problem of\nchoosing a programming language to work with, which frameworks to use and which tech stack to learn.\nAll of them have pros and cons, but when looking for an all-purpose language you should take Kotlin\ninto consideration and ask yourself the question: “Do I really need another programming language?”.\n\nKotlin is an open source, statically typed and powerful language. It takes inspiration from many programming languages like Java,\nScala, C#, Groovy, Python and it attempts to combine the best features from each. The support for multiplatform programming\nis one of Kotlin’s key benefits. It is able to compile to many platforms including Android, JVM, JavaScript and native.\nKotlin is great for building applications, but what if you need to write a script? The first thing that comes to mind is to use\na classic, traditional shell script or Python, what gives you the ability to move files, copy, delete and more by running\na program from command-line. But if Kotlin is your cup of tea, it can be also used as a scripting language!\nWhen talking about shell scripts, I have to mention their syntax, which can be unclear and enigmatic. It is really hard to write\na clear piece of code in a complex script. Another drawback is long execution time. Shell scripts are simply slow due to almost\nevery executed shell command’s need to launch a new process. Additionally, there are compatibility problems between platforms.\nThe creator of Perl, Larry Wall, famously wrote that “It is easier to port a shell than a shell script.”\nI’ve mentioned slow execution of shell scripts due to creation of a new process every command. It’s true,\nbut on the other hand spinning up a new JVM to execute a script and a compilation process is also long. The execution time usually\ndepends on a machine and distribution of JVM. It can be a bit frustrating when Java version is inappropriate for an executed script\nor when some machines use different operating system, what can lead to compatibility issues.\nSo how about Python? It provides lots of useful libraries covering almost any needs and is available on most systems,\nessentially eliminating the problem of compatibility.\nWhile scripts written in Python are more readable than shell scripts, they aren’t type-safe in the way that Kotlin\nis. Kotlin is statically typed, what means that types are verified during compilation, and strongly typed, i.e.\nthe type of a variable cannot change after its declaration. In contrast to a dynamically typed language, including Python,\nit helps prevent all kinds of incompatible type errors. It brings the opportunity to create scripts that help automate\nmundane tasks, but doing it in a much safer way.\nLet’s move to the code and see Kotlin scripts in practice.\nInstall Kotlin for scripting\nIn order to allow scripting, you need to make Kotlin available for the entire system. Open a terminal and check if Kotlin is\ninstalled:\n\nkotlinc -version\n\n\nIf the command was not found, the easiest way to install Kotlin on UNIX-based systems such as OS X,\nLinux, Cygwin, FreeBSD, and Solaris is SDKMAN!. Install Kotlin with the command:\n\nsdk install kotlin\n\n\nAlternatively, on OS X you can install the compiler via Homebrew:\n\nbrew install kotlin\n\n\nCheck the Kotlin version again.\nFirst script\nKotlin Evolution and Enhancement Process (KEEP) document\nwas created to explain Kotlin scripting. It presents use cases of scripting with examples and contains the general proposal,\nbut it is still a draft. According to this file, a Kotlin script is a simple Kotlin snippet. Each command in the file is\nexecuted as if it was in the main function. To make a file executable, the file has to be named *.kts.\nCreate the first script and name the file first-script.kts.\n\ntouch first-script.kts\n\n\nEdit file and add some code:\n\nprintln(\"Hello, it’s your first script called with args:\")\nargs.forEach {\n    println(\"* $it\")\n}\n\n\nAnd run it with example arguments:\n\nkotlinc -script first-script.kts test 'test with space'\n\n\nYou should see the result:\n\nHello, it’s your first script called with args:\n* test\n* test with space\n\n\nReally simple! In addition, scripts can use Java or Kotlin stlib to have access to more powerful libraries.\nOf course, functions and classes can be used to make the script more readable and easy to maintain.\n\nimport java.io.File\n\nfun printDirs() {\n    File(\".\").listFiles { file -> file.isDirectory }?.forEach {\n        println(it)\n    }\n}\n\nprintDirs()\n\n\nKotlin-main-kts\nKotlin-main-kts is a solution provided by the Kotlin team. The 1.3.70 version brought a set of improvements that\nprovide a better experience of using Kotlin scripts with IntelliJ IDEA and Kotlin command-line tools.\nMore details can be found in a release blog post.\nAll you need to use kotlin-main-kts is to create a file named *.main.kts and execute script.\nMoreover, from 1.3.70 on, it is easier to run the program. The command is:\n\nkotlin myscript.main.kts\n\n\nUsing kotlin-main-kts has a lot of advantages. *.main.kts scripts are supported out of the box in IntelliJ,\neven outside the source directories. It gives you highlighting and navigation, autocompletes code\nand resolves dynamic dependencies. What’s more, third party libraries can be used in scripts by\nincluding them as dependencies using directives or annotations specified with gradle-style with group ID,\nartifact ID and version. For example, if you write a script which copies data from a CSV file and inserts the data\ninto a database, you need to use a connector. You can achieve this by @file:DependsOn annotation. The example below shows\nhow to connect to a MongoDB database. A database URL is required as an argument e.g. mongodb://localhost:27017/test-db\n\n@file:Repository(\"https://jcenter.bintray.com\")\n@file:DependsOn(\"org.mongodb:mongo-java-driver:3.12.8\")\n\nimport com.mongodb.client.MongoClients\n\nfun createConnection(url: String) =\n    MongoClients.create(url).use {\n        println(\"Connected to MongoDB!\")\n    }\n\nval (mongoUrl) = args\ncreateConnection(mongoUrl)\n\n\nWhat’s interesting, it is also possible to execute a script exactly in the same way as an executable file - for example by\ncommand ./kotlin-script.main.kts. The first line in a file makes difference. It is required to add #!/usr/bin/env kotlin\nat the beginning of script to run it in such way.\n\n#!/usr/bin/env kotlin\nprintln(\"Hello, world!\")\n\n\nKscript\nAlso, I have to mention Kscript. It is one of the ways to support scripting in\nKotlin. Actually, it is a wrapper around kotlinc which adds some features. After Kscript installation you can easily run\nscript by command:\n\nkscript first-script.kts\n\n\nThis tool was created in 2016. In the beginning, Kotlin wasn’t feature-rich enough to be a viable alternative to the\nshell. The great talk on Kotlin Conf by Holger Brandl shows the\nhistory of its creation and explains that initially the tool was created for data science purposes.\nThe creators listed such advantages as:\ncompiled script caching (using md5 checksums)\ndependency declarations using gradle-style resource locators and automatic dependency resolution\npossibility to deploy scripts as standalone binaries\ninlined usage - you don’t need to create script file\nIn my opinion, the cache mechanism is the biggest advantage of using Kscript tool. Whenever you run a script with kotlinc\nit is recompiled, which makes it slow. Each time the script is started, Kscripts checks if code has been modified since the last\ncompilation (by hashing the content of the script). If file wasn’t changed, cached version is immediately executed. The\ntable below shows time of execution of the same script by kotlinc command and Kscript. As we can see, the cache has a\npositive effect on execution time.\ntime kotlinc -script script.kts\n      time kscript script.kts\n    \n2.930s\n      3.972s\n    \n2.991s\n      0.868s\n    \n2.968s\n      0.912s\n    \nKotlin v1.4 brought a much improved scripting integration. But until Kotlin scripting interpreter isn’t rich and\nversatile, Kscript will be supported and developed.\nConclusion\nKotlin makes scripting really easy. Powerful scripts can be created with the autocompletion and the strong typing,\nmaking them really readable and highly maintainable.\nHappy scripting!","guid":"https://blog.allegro.tech/2021/04/kotlin-scripting.html","categories":["tech","kotlin","script"],"isoDate":"2021-04-12T22:00:00.000Z","thumbnail":"images/post-headers/default.jpg"},{"title":"Digging into Allegro, or how I started my testing career","link":"https://blog.allegro.tech/2021/03/digging-into-allegro-how-i-started-testing-career.html","pubDate":"Tue, 23 Mar 2021 00:00:00 +0100","authors":{"author":[{"name":["Aleksandra Kulesz"],"photo":["https://blog.allegro.tech/img/authors/aleksandra.kulesz.jpg"],"url":["https://blog.allegro.tech/authors/aleksandra.kulesz"]}]},"content":"<p>Maybe it’s another “How I’ve changed my worklife” story, but I hope it is an interesting one. It seems quite important to tell: before the beginning of my\nAllegro adventure, I was working as… an archaeologist. It was both physical work on excavations and research work at my PhD studies. And the only thing that\nconnects my past work and the current one is: attention to detail.</p>\n\n<p>I had been thinking about changing my career path for some time. I’ve got some IT-experienced friends and they convinced me to try my luck in that field. In the\nbeginning I learned some front-end technologies on my own. Later I systematized and developed my knowledge at a programming bootcamp. And started looking for a\njob. I sent my application to Allegro for a front-end developer offer. Unfortunately, my lack of experience (and probably knowledge, too) caused me not to get a\njob offer. However, someone from the HR squad encouraged me to not give up and try one more time with the <a href=\"https://allegro.pl/praca/staze\">Summer eXperience internship program</a>.</p>\n\n<h2 id=\"it-begins\">It begins!</h2>\n\n<p>I did it! I was invited to begin cooperation (as Test Engineer Intern) with Allegro’s teams responsible for developing listings (search result pages). First of\nJuly was the day when I and my 52 intern-colleagues started work. After a two-day long onboarding (a very intensive time filled with tons of useful pieces of\ninformation!), I met my teammates for the first time. During summertime anti-covid restrictions were not so strict and I was able to visit the office a few\ntimes. We discussed my responsibilities and they guided me through the listings domain.</p>\n\n<p>In the beginning of my internship I had to test manually our web and mobile-web solutions. For a person who never had anything to do with a complex\nmicroservices system it was quite a challenging experience. I needed to understand and learn how services work and communicate with each other. The next step\nwas to become familiar with test environments. Phoenix (development test environments) and Sandbox are very useful, but at the same time they are very fussy.\nYou have to be quite patient to work with those tools. And when you are a QA Engineer you work with them all the time! But it turned out to be just a warm up. I\nquickly learned how to test our mobile applications (both for Android and iOS) and write and maintain automatic tests in the <a href=\"https://www.cypress.io/\">Cypress framework</a>.\nI was introduced to chaos and efficiency testing. I also wrote my first automatic tests in <a href=\"https://developer.android.com/training/testing/espresso\">Espresso</a>\nand TeaBiscuit (our internal tool). Every day brought something exciting and new, and still does.</p>\n\n<h2 id=\"what-do-i-like\">What do I like?</h2>\n\n<p>My favourite side of Allegro is knowledge sharing. Regarding common problems with technology or domain knowledge, I can always ask my supportive teammates, but\nthere is much more. We can take part in many interesting courses and workshops organised by people truly dedicated to their subjects. Among those are not only\ntech-courses, but you can also take part in workshops which develop your soft or leadership skills. In my opinion, the most important thing is talking to other\ntesters in our company. We have got a slack channel, a hot field of debates, sharing experiences and solving problems. There is also a monthly testers’ meeting.\nDuring these events we can present our tools, and share our feelings about them. After a short lecture we discuss a lot and it is really inspiring. Last but not\nleast are our conferences and hackathons. Allegro organizes amazing, huge meetings (in the past year, they were, of course, organised online). Subjects are very\ndiversified and broaden horizons.</p>\n\n<p>Another amazing issue is the attitude. The whole team is proud of their work and tries to cooperate agreeably in order to be effective and efficient. Even as an\nIntern you do not feel as a second-class employee, you are treated as seriously as your coworker with ten years of experience. I never met a person who was rude\nto me, or was angry with my lack of knowledge. Everybody knows that there are newbies in the company, and they are forgiving. When you achieve a goal your\ncolleagues are happy for you.</p>\n\n<h2 id=\"any-downsides\">Any downsides?</h2>\n\n<p>I was thinking long and hard about downsides or disadvantages of working at Allegro. Beside problems with test environments I mentioned above, I have one little\nissue. Because the company is so big, there are so many teams and services it is sometimes difficult to find the source of needed information. From time to time\nit takes much longer than you assumed. It might be a little bit frustrating. It also causes that many teams develop similar/alternative tools at the same time.\nSix months later, we realize that it could have been achieved faster and with less effort.Therefore, communication seems to be the most important thing, and\nsometimes it can be a bit neglected.</p>\n\n<p>There is another minor difficulty. There are small pieces of code, small features that do not have an owner. When you find a bug there or would like to make\nsome changes on it, it is not obvious to whom you should communicate your actions.</p>\n\n<h2 id=\"lets-wrap-up\">Let’s wrap up!</h2>\n\n<p>I like working with my teammates. I believe that I have developed a lot since I started work here. I am really happy to be part of this company, because Allegro\nis a great opportunity for everyone who wants to learn. It is good to be here! / Dobrze tu być!</p>\n","contentSnippet":"Maybe it’s another “How I’ve changed my worklife” story, but I hope it is an interesting one. It seems quite important to tell: before the beginning of my\nAllegro adventure, I was working as… an archaeologist. It was both physical work on excavations and research work at my PhD studies. And the only thing that\nconnects my past work and the current one is: attention to detail.\nI had been thinking about changing my career path for some time. I’ve got some IT-experienced friends and they convinced me to try my luck in that field. In the\nbeginning I learned some front-end technologies on my own. Later I systematized and developed my knowledge at a programming bootcamp. And started looking for a\njob. I sent my application to Allegro for a front-end developer offer. Unfortunately, my lack of experience (and probably knowledge, too) caused me not to get a\njob offer. However, someone from the HR squad encouraged me to not give up and try one more time with the Summer eXperience internship program.\nIt begins!\nI did it! I was invited to begin cooperation (as Test Engineer Intern) with Allegro’s teams responsible for developing listings (search result pages). First of\nJuly was the day when I and my 52 intern-colleagues started work. After a two-day long onboarding (a very intensive time filled with tons of useful pieces of\ninformation!), I met my teammates for the first time. During summertime anti-covid restrictions were not so strict and I was able to visit the office a few\ntimes. We discussed my responsibilities and they guided me through the listings domain.\nIn the beginning of my internship I had to test manually our web and mobile-web solutions. For a person who never had anything to do with a complex\nmicroservices system it was quite a challenging experience. I needed to understand and learn how services work and communicate with each other. The next step\nwas to become familiar with test environments. Phoenix (development test environments) and Sandbox are very useful, but at the same time they are very fussy.\nYou have to be quite patient to work with those tools. And when you are a QA Engineer you work with them all the time! But it turned out to be just a warm up. I\nquickly learned how to test our mobile applications (both for Android and iOS) and write and maintain automatic tests in the Cypress framework.\nI was introduced to chaos and efficiency testing. I also wrote my first automatic tests in Espresso\nand TeaBiscuit (our internal tool). Every day brought something exciting and new, and still does.\nWhat do I like?\nMy favourite side of Allegro is knowledge sharing. Regarding common problems with technology or domain knowledge, I can always ask my supportive teammates, but\nthere is much more. We can take part in many interesting courses and workshops organised by people truly dedicated to their subjects. Among those are not only\ntech-courses, but you can also take part in workshops which develop your soft or leadership skills. In my opinion, the most important thing is talking to other\ntesters in our company. We have got a slack channel, a hot field of debates, sharing experiences and solving problems. There is also a monthly testers’ meeting.\nDuring these events we can present our tools, and share our feelings about them. After a short lecture we discuss a lot and it is really inspiring. Last but not\nleast are our conferences and hackathons. Allegro organizes amazing, huge meetings (in the past year, they were, of course, organised online). Subjects are very\ndiversified and broaden horizons.\nAnother amazing issue is the attitude. The whole team is proud of their work and tries to cooperate agreeably in order to be effective and efficient. Even as an\nIntern you do not feel as a second-class employee, you are treated as seriously as your coworker with ten years of experience. I never met a person who was rude\nto me, or was angry with my lack of knowledge. Everybody knows that there are newbies in the company, and they are forgiving. When you achieve a goal your\ncolleagues are happy for you.\nAny downsides?\nI was thinking long and hard about downsides or disadvantages of working at Allegro. Beside problems with test environments I mentioned above, I have one little\nissue. Because the company is so big, there are so many teams and services it is sometimes difficult to find the source of needed information. From time to time\nit takes much longer than you assumed. It might be a little bit frustrating. It also causes that many teams develop similar/alternative tools at the same time.\nSix months later, we realize that it could have been achieved faster and with less effort.Therefore, communication seems to be the most important thing, and\nsometimes it can be a bit neglected.\nThere is another minor difficulty. There are small pieces of code, small features that do not have an owner. When you find a bug there or would like to make\nsome changes on it, it is not obvious to whom you should communicate your actions.\nLet’s wrap up!\nI like working with my teammates. I believe that I have developed a lot since I started work here. I am really happy to be part of this company, because Allegro\nis a great opportunity for everyone who wants to learn. It is good to be here! / Dobrze tu być!","guid":"https://blog.allegro.tech/2021/03/digging-into-allegro-how-i-started-testing-career.html","categories":["tech","testing","intern","career change"],"isoDate":"2021-03-22T23:00:00.000Z","thumbnail":"images/post-headers/testing.png"},{"title":"Finite-state machines made easy","link":"https://blog.allegro.tech/2021/03/state-machines-made-easy.html","pubDate":"Fri, 05 Mar 2021 00:00:00 +0100","authors":{"author":[{"name":["Tymon Felski"],"photo":["https://blog.allegro.tech/img/authors/tymon.felski.jpg"],"url":["https://blog.allegro.tech/authors/tymon.felski"]}]},"content":"<p>Coordinating complex processes, both business and technical, can be a challenging issue in a distributed system.\nEspecially when the complications associated with them, such as concurrency, idempotency, scalability and hindered\ntestability, come into play — possibly all at once.\nThis is definitely something that can keep many programmers awake at night.</p>\n\n<p>While this may sound dramatic, in reality there are many different solutions to this problem.\nOne group of such solutions extensively uses finite-state machines also known as finite-state automata.\nAs this article is meant for everyone, let’s start with some background information about what they are and how\nthey work.</p>\n\n<h2 id=\"what-are-finite-state-machines\">What are finite-state machines</h2>\n\n<p>For the sake of readability, I will sometimes be referring to finite-state machines as simply “state machines”.\nIf you’re already familiar with their formal definition, you may skip to the next section.</p>\n\n<p>Formally speaking, a finite-state machine is a mathematical model of computation that describes an abstract system\nhaving a finite number of permissible states. At any given point in time, the system is in exactly one of these\nstates.</p>\n\n<p>In practical terms such a machine is described by:</p>\n\n<ul>\n  <li>an initial (start) state,</li>\n  <li>a set of possible states,</li>\n  <li>a sequence of possible inputs (events),</li>\n  <li>a transition function which based on the last observed input and the machine’s current state, determines the next\nstate,</li>\n  <li>and a set of terminal (end) states — optionally.</li>\n</ul>\n\n<p>The machine starts off in the initial state and inspects all inputs in sequence.\nUpon observing each input, it uses the transition function to change its state.\nThe processing ends once all inputs have been observed.\nIf the machine’s state at the end of processing is one of the terminal states, the machine is assumed to accept the\ngiven input, and to reject it otherwise.</p>\n\n<p>As a side note, the description provided above uses the deterministic model of a finite-state automaton.\nThere are also alternative, non-deterministic machines, but I won’t be delving into them too much, as they can be\nconverted to deterministic ones anyway.</p>\n\n<p>If you’ve read this far, hopefully the rest of this post will be easier on the mind!\nDespite the intimidating formal definition, finite-state machines are more widespread than you might imagine.\nUpon closer inspection you might be able to spot them in your everyday life under the hood of things such as vending\nmachines, traffic lights and elevators.\nIn .NET they are used in the implementation of <code class=\"language-plaintext highlighter-rouge\">async</code>/<code class=\"language-plaintext highlighter-rouge\">await</code> or <code class=\"language-plaintext highlighter-rouge\">yield</code> syntax.\nTry decompiling your code and see how the language authors implemented those features.\nYou have probably already used some sort of state machine in your code without even realising it!</p>\n\n<h2 id=\"a-simple-example-of-a-basic-state-machine-implementation\">A simple example of a basic state machine implementation</h2>\n\n<p>Let’s take a closer look at the following piece of code:</p>\n\n<div class=\"language-csharp highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"k\">public</span> <span class=\"k\">enum</span> <span class=\"n\">Button</span>\n<span class=\"p\">{</span>\n    <span class=\"n\">Play</span><span class=\"p\">,</span>\n    <span class=\"n\">Stop</span>\n<span class=\"p\">}</span>\n\n<span class=\"k\">public</span> <span class=\"k\">enum</span> <span class=\"n\">State</span>\n<span class=\"p\">{</span>\n    <span class=\"n\">Playing</span><span class=\"p\">,</span>\n    <span class=\"n\">NotPlaying</span>\n<span class=\"p\">}</span>\n\n<span class=\"k\">public</span> <span class=\"k\">class</span> <span class=\"nc\">Player</span>\n<span class=\"p\">{</span>\n    <span class=\"k\">public</span> <span class=\"n\">State</span> <span class=\"n\">CurrentState</span> <span class=\"p\">{</span> <span class=\"k\">get</span><span class=\"p\">;</span> <span class=\"k\">private</span> <span class=\"k\">set</span><span class=\"p\">;</span> <span class=\"p\">}</span> <span class=\"p\">=</span> <span class=\"n\">State</span><span class=\"p\">.</span><span class=\"n\">NotPlaying</span><span class=\"p\">;</span>\n\n    <span class=\"k\">public</span> <span class=\"k\">void</span> <span class=\"nf\">HandleClick</span><span class=\"p\">(</span><span class=\"n\">Button</span> <span class=\"n\">button</span><span class=\"p\">)</span>\n    <span class=\"p\">{</span>\n        <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"n\">button</span> <span class=\"p\">==</span> <span class=\"n\">Button</span><span class=\"p\">.</span><span class=\"n\">Play</span><span class=\"p\">)</span>\n        <span class=\"p\">{</span>\n            <span class=\"n\">CurrentState</span> <span class=\"p\">=</span> <span class=\"n\">State</span><span class=\"p\">.</span><span class=\"n\">Playing</span><span class=\"p\">;</span>\n        <span class=\"p\">}</span>\n        <span class=\"k\">else</span> <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"n\">button</span> <span class=\"p\">==</span> <span class=\"n\">Button</span><span class=\"p\">.</span><span class=\"n\">Stop</span><span class=\"p\">)</span>\n        <span class=\"p\">{</span>\n            <span class=\"n\">CurrentState</span> <span class=\"p\">=</span> <span class=\"n\">State</span><span class=\"p\">.</span><span class=\"n\">NotPlaying</span><span class=\"p\">;</span>\n        <span class=\"p\">}</span>\n    <span class=\"p\">}</span>\n<span class=\"p\">}</span>\n</code></pre></div></div>\n\n<p>This is an example of a very simple state machine with two states and two events.\nThe player can be either playing or not playing music.\nPressing the Play button will start or keep playing music, while pressing the Stop button will stop the music or keep\nit stopped.</p>\n\n<p>The code is manageable at this point, since the example is quite straightforward.\nHowever, I hope you can imagine how adding more media controls that are usually present in music players will quickly\nresult in complex code that will not be easily maintainable anymore.\nFor instance, consider a feature request to have the Previous button change to the previous track if the player is less\nthan 3 seconds into the current track, or stay at the current track but rewind it to the beginning otherwise.</p>\n\n<p>That being said, in many cases this kind of state machine implementation would be more than enough.\nYou don’t always have to use a state-of-the-art, bleeding-edge solution to achieve desired goals.\nHowever, this is not something I would recommend to someone who is trying to tackle coordination of asynchronous\noperations within a distributed system.</p>\n\n<h2 id=\"a-more-maintainable-approach\">A more maintainable approach</h2>\n\n<p>Let me share our approach to this problem.\nWe have come up with a framework for building state machines in .NET with very little code that is maintainable and\ntestable.\nState machines built with this framework serve a purpose of orchestrating a wide range of business and technical\nprocesses in our microservice-based distributed architecture.\nThe framework is equipped with various features dictated by paradigms of distributed systems, which extend the\nstandard state machine definition.</p>\n\n<p>Before I move on to an example of its real-life application, I want to break down the state machine’s API, so that you\nknow what you’re looking at later on.\nTo keep things short, I will be showing you only snippets of simplified code, as implementation details can be\nexpanded upon in follow-up posts.</p>\n\n<p>The state machine is defined as follows:</p>\n\n<div class=\"language-csharp highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"k\">public</span> <span class=\"k\">class</span> <span class=\"nc\">StateMachine</span><span class=\"p\">&lt;</span><span class=\"n\">TStateBase</span><span class=\"p\">,</span> <span class=\"n\">TEventBase</span><span class=\"p\">&gt;</span>\n<span class=\"p\">{</span>\n    <span class=\"k\">public</span> <span class=\"nf\">StateMachine</span><span class=\"p\">(</span><span class=\"n\">TStateBase</span> <span class=\"n\">initialState</span><span class=\"p\">)</span>\n    <span class=\"p\">{</span>\n        <span class=\"c1\">// ...</span>\n    <span class=\"p\">}</span>\n<span class=\"p\">}</span>\n</code></pre></div></div>\n\n<p>It is a generic class that requires a definition of base types for all states (<code class=\"language-plaintext highlighter-rouge\">TStateBase</code>) and for all transition\ntriggers (<code class=\"language-plaintext highlighter-rouge\">TEventBase</code>).\nThe constructor accepts an initial state from which the state machine will start its operation.</p>\n\n<p>We can create the state machine like so:</p>\n\n<div class=\"language-csharp highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"kt\">var</span> <span class=\"n\">stateMachine</span> <span class=\"p\">=</span> <span class=\"k\">new</span> <span class=\"n\">StateMachine</span><span class=\"p\">&lt;</span><span class=\"n\">StateBase</span><span class=\"p\">,</span> <span class=\"n\">EventBase</span><span class=\"p\">&gt;(</span><span class=\"k\">new</span> <span class=\"nf\">InitialState</span><span class=\"p\">());</span>\n</code></pre></div></div>\n\n<p>Having created this object, we may start defining transitions.\nEach transtion consists of three required elements:</p>\n\n<ul>\n  <li>the state from which the transition can be triggered,</li>\n  <li>the transition trigger (an event),</li>\n  <li>the state to which the transition leads.</li>\n</ul>\n\n<p>Optionally, a transition can have side effects, called simply commands.\nA command (or a set of commands) will be run after a successful transition.\nThose can be pretty much anything from sending a message to another state machine to calling a specific service and\ndelegating a task to it.\nCommands allow a seamless integration of the state machine with external components.\nThere is a drawback, however.\nCommand execution may fail, what requires an idempotent retry policy to be employed.</p>\n\n<p>Transitions and commands can be conditional, meaning that a logical expression can be guarding and preventing the\nexecution of the whole transition, or just a command in some cases.</p>\n\n<p>A builder pattern which combines all of the aforementioned requirements is used to compose a transition:</p>\n\n<div class=\"language-csharp highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"n\">stateMachine</span>\n    <span class=\"p\">.</span><span class=\"n\">FromState</span><span class=\"p\">&lt;</span><span class=\"n\">TStateFrom</span><span class=\"p\">&gt;()</span>\n    <span class=\"p\">.</span><span class=\"n\">When</span><span class=\"p\">&lt;</span><span class=\"n\">TEvent</span><span class=\"p\">&gt;(</span><span class=\"cm\">/* Expression&lt;Func&lt;TStateFrom, TEvent, bool&gt;&gt; */</span><span class=\"p\">)</span>\n    <span class=\"p\">.</span><span class=\"n\">ToState</span><span class=\"p\">&lt;</span><span class=\"n\">TStateTo</span><span class=\"p\">&gt;(</span><span class=\"cm\">/* Expression&lt;Func&lt;TStateFrom, TEvent, TStateTo&gt;&gt; */</span><span class=\"p\">)</span>\n    <span class=\"p\">.</span><span class=\"nf\">RunCommand</span><span class=\"p\">(</span>\n        <span class=\"n\">when</span><span class=\"p\">:</span> <span class=\"cm\">/* Expression&lt;Func&lt;TStateFrom, TEvent, TStateTo, bool&gt;&gt; */</span><span class=\"p\">,</span>\n        <span class=\"n\">then</span><span class=\"p\">:</span> <span class=\"cm\">/* Expression&lt;Func&lt;TStateFrom, TEvent, TStateTo, TCommand&gt;&gt; */</span><span class=\"p\">)</span>\n    <span class=\"p\">.</span><span class=\"nf\">RunCommand</span><span class=\"p\">(</span><span class=\"cm\">/* ... */</span><span class=\"p\">)</span>\n    <span class=\"c1\">// ...</span>\n    <span class=\"p\">.</span><span class=\"nf\">RunCommand</span><span class=\"p\">(</span><span class=\"cm\">/* ... */</span><span class=\"p\">);</span>\n</code></pre></div></div>\n\n<p>This structure may be overwhelming at first, but bear with me.\nIt will all make sense in a bit.\nAs for now you need to know that:</p>\n\n<ul>\n  <li>if the state machine is in a state of <code class=\"language-plaintext highlighter-rouge\">TStateFrom</code> type,</li>\n  <li>and an event of type <code class=\"language-plaintext highlighter-rouge\">TEvent</code> occured,</li>\n  <li>and the condition (if defined) passed to <code class=\"language-plaintext highlighter-rouge\">When</code> method is satisfied,</li>\n</ul>\n\n<p>the transition will fire up and the state machine will switch to a new state of type <code class=\"language-plaintext highlighter-rouge\">TStateTo</code> using the factory method\nexpression passed to <code class=\"language-plaintext highlighter-rouge\">ToState</code> method.</p>\n\n<p>The state machine class exposes a method which can be used to trigger a transition with an event:</p>\n\n<div class=\"language-csharp highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"k\">public</span> <span class=\"n\">TransitionResult</span> <span class=\"nf\">Apply</span><span class=\"p\">(</span><span class=\"n\">TEventBase</span> <span class=\"n\">@event</span><span class=\"p\">);</span>\n</code></pre></div></div>\n\n<p>This method applies the supplied event to the current state by trying to find a matching transition in the transition\nmapping and changes the internal state of the machine.\nThe result contains information about the performed transition, along with commands that should be run.</p>\n\n<div class=\"language-csharp highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"k\">public</span> <span class=\"k\">class</span> <span class=\"nc\">TransitionResult</span>\n<span class=\"p\">{</span>\n    <span class=\"k\">public</span> <span class=\"n\">TStateBase</span> <span class=\"n\">StateFrom</span> <span class=\"p\">{</span> <span class=\"k\">get</span><span class=\"p\">;</span> <span class=\"p\">}</span>\n    <span class=\"k\">public</span> <span class=\"n\">TEventBase</span> <span class=\"n\">Event</span> <span class=\"p\">{</span> <span class=\"k\">get</span><span class=\"p\">;</span> <span class=\"p\">}</span>\n    <span class=\"k\">public</span> <span class=\"n\">TStateBase</span> <span class=\"n\">StateTo</span> <span class=\"p\">{</span> <span class=\"k\">get</span><span class=\"p\">;</span> <span class=\"p\">}</span>\n    <span class=\"k\">public</span> <span class=\"n\">IEnumerable</span><span class=\"p\">&lt;</span><span class=\"kt\">object</span><span class=\"p\">&gt;</span> <span class=\"n\">Commands</span> <span class=\"p\">{</span> <span class=\"k\">get</span><span class=\"p\">;</span> <span class=\"p\">}</span>\n    <span class=\"k\">public</span> <span class=\"kt\">bool</span> <span class=\"n\">IsValid</span> <span class=\"p\">{</span> <span class=\"k\">get</span><span class=\"p\">;</span> <span class=\"p\">}</span>\n<span class=\"p\">}</span>\n</code></pre></div></div>\n\n<p>If no matching transition definition is found given the machine’s current state – or if a transition is found, but its\nprecondition is not met – the event application will result in an invalid transition.\nIn that case, the state machine will not react to the event and simply retain its state, possibly logging that an\ninvalid event was received.</p>\n\n<p>If there are multiple matching transitions, the first one will fire up (in definition order).\nWe should, however, avoid designing states machines in such way if possible.</p>\n\n<p>As you can see, the representation of the machine is primarily type-based, so we can use polymorphism to our advantage.\nBy calling <code class=\"language-plaintext highlighter-rouge\">FromState&lt;TStateBase&gt;()</code> we can have a transition that can be fired up from any state.\nSimilarily, if we use a type that only some selected states derive from, we will have a transition applicable to these\nstates only.\nIt would be equivalent to duplicating that same transition for every one of these states.\nThis syntax can be particularly useful, when dealing with processes that have an expiration date and have to be\ncompleted within a specific time frame.\nReceiving an event about the process’ expiration may have to be handled regardless of the machine’s current state and\nresult in termination immediately.</p>\n\n<h2 id=\"implementation-manifest\">Implementation manifest</h2>\n\n<p>Now that I’ve described how a state machine can be defined in a declarative way using our framework, let’s talk a bit\nabout how that definition actually runs.</p>\n\n<p>In general, we use dependency injection to make the state machine definition work with other services and add-ons,\nsuch as specific command runners.\nI promised I would not dive deep into implementation details, but nonetheless I want to give you a little taste of\nwhat sits behind the scenes.</p>\n\n<p>If you don’t care for any of that, you may skip to the “Real-life example” section.</p>\n\n<h3 id=\"storage\">Storage</h3>\n\n<p>The state machine implementation is based on event sourcing.\nIn summary, this means that we don’t save the state of our application objects, but rather a series of events that\nchange the object’s state.\nThese events will give us the current view of the object when aggregated (“replayed”) in the order in which they\noccured.\nFor this purpose we currently use an open-source library,\n<a href=\"https://github.com/SQLStreamStore/SQLStreamStore\">SQLStreamStore</a>.</p>\n\n<p>SQLStreamStore offers an atomic and idempotent stream append operation.\nThanks to this, we don’t have to worry about race conditions between multiple instances of the same state machine\nhandling events in parallel, what is great for scalability.\nWe can also recognize a situation when the same event is being fed into the state machine again, what can happen\nwhen dealing with retry policies.\nThat, on the other hand, gives us a pretty good way of achieving deduplication.</p>\n\n<h3 id=\"caching\">Caching</h3>\n\n<p>Replaying all events every single time is an unnecessary overhead that we decided to mitigate by introducing\na lock-free cache for state snapshots.\nAfter each transition a state machine will cache its current state along with the stream version which it\ncorresponds to.\nThis gives us the ability to restore the state machine to the state it was in after handling <code class=\"language-plaintext highlighter-rouge\">n-1</code> events, when we want\nto handle the <code class=\"language-plaintext highlighter-rouge\">n</code>-th event.</p>\n\n<p>It requires, however, the states to be immutable, or else we may end up with an unexpected behaviour.\nIf states were not immutable, we could not be certain that the state object we cached after handling the <code class=\"language-plaintext highlighter-rouge\">n</code>-th event\nis still the same and has not been modified in the meantime.\nMoreover, immutable objects are inherently thread-safe.</p>\n\n<h3 id=\"instrumentation\">Instrumentation</h3>\n\n<p>This state machine framework is also equipped with heavy instrumentation.\nEvery executed transition and state change is logged, so we can easily track any errors.\nThis data is also useful for our data analytics team to keep track of business processes.\nA lot of different metrics come into play to measure performance of each and every state machine deployed.</p>\n\n<p>Finally, every historical transition is saved in a stream — separate from the event stream — and can be viewed with our\ninternal back-office tools.</p>\n\n<p>Thanks to the finite nature of the state machines, we can always log the current state and trace what made the system\nto be in that state, along with all its previous states.\nThis is something quite invaluable and helps immensely when diagnosing issues, especially in complex and\ninter-dependent business scenarios where a lot of things happen at the same time.</p>\n\n<h2 id=\"real-life-example\">Real-life example</h2>\n\n<p>So finally, the big question: how is this framework used on our platform?\nTo answer that we don’t need to reach far.</p>\n\n<p>In July of 2020 we launched a new payment method called Allegro Pay, which will eventually be available to every buyer\non Allegro.\nThis service allows the users to buy items now and pay for them later in a single payment after 30 days, or\nin multiple smaller monthly payments, depending on the value of purchased goods.</p>\n\n<p>Repayments can be easily made online using our Allegro Pay dashboard.\nUsers are even able to pay for multiple purchases at once.</p>\n\n<p><img src=\"/img/articles/2021-03-05-state-machines-made-easy/allegro-pay-dashboard.png\" alt=\"Allegro Pay dashboard\" /></p>\n\n<p>For more detailed information, I encourage you to read our\n<a href=\"https://allegro.pl/pomoc/dla-kupujacych/allegro-pay/\">Allegro Pay FAQ</a>.</p>\n\n<p>I suspect you already know where I’m going with this — my goal is to show you how our state machine framework is used\nto coordinate an actual business process of handling a repayment within Allegro Pay.</p>\n\n<h3 id=\"the-process-specification\">The process specification</h3>\n\n<p>Before we create our state machine, we need to have a rough idea of which states and events we want to handle.</p>\n\n<p>The repayment process is started in two different ways, but will end alike in both cases.</p>\n\n<ol>\n  <li>\n    <p>The user can initialize an immediate online repayment via the Allegro Pay dashboard.\n They are redirected to the payment provider’s website and complete the process there.</p>\n  </li>\n  <li>\n    <p>Alternatively, the user can request to repay their purchase with a traditional wire transfer, what we call an\noffline repayment.\n We know nothing about it until the money actually arrives at the target bank account.\n That method may take up to a couple of days.</p>\n  </li>\n</ol>\n\n<p>At this point both repayment paths merge, since from now on we can discard any knowledge about how the money\nwas received and focus on the fact that we have it.\nThe money source won’t be useful during the process coordination anymore.</p>\n\n<p>The next step is to register the repayment in our bookkeeping system.\nThe registration part is important for us, because it will tell us whether the purchase was paid in full or if further\nrepayments are required.\nAfter receiving information about successful registration, an email is sent to the user confirming that the\nrepayment was registered.</p>\n\n<p>After repayment is registered, we asynchronously await the feedback from the bookkeeping system on the transaction\nbeing settled and the repayment is to be marked as completed.</p>\n\n<h3 id=\"designing-the-state-machine\">Designing the state machine</h3>\n\n<p>I could show you the finished state machine and just paste a wall of text here, describing what it does, but where’s\nthe fun in that?\nInstead, I’d like to show you the step-by-step process I would go through when designing this kind of state machine.</p>\n\n<p>I’ll start off by simply creating a state machine that handles a repayment of a single purchase and then extend it\nto work for all cases.\nFirst we need to define the base types for all states and events:</p>\n\n<div class=\"language-csharp highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"k\">public</span> <span class=\"k\">abstract</span> <span class=\"k\">class</span> <span class=\"nc\">StateBase</span>\n<span class=\"p\">{</span>\n    <span class=\"k\">public</span> <span class=\"kt\">string</span> <span class=\"n\">UserId</span> <span class=\"p\">{</span> <span class=\"k\">get</span><span class=\"p\">;</span> <span class=\"n\">init</span><span class=\"p\">;</span> <span class=\"p\">}</span>\n    <span class=\"k\">public</span> <span class=\"kt\">string</span> <span class=\"n\">RepaymentId</span> <span class=\"p\">{</span> <span class=\"k\">get</span><span class=\"p\">;</span> <span class=\"n\">init</span><span class=\"p\">;</span> <span class=\"p\">}</span>\n    <span class=\"k\">public</span> <span class=\"kt\">string</span> <span class=\"n\">PaymentId</span> <span class=\"p\">{</span> <span class=\"k\">get</span><span class=\"p\">;</span> <span class=\"n\">init</span><span class=\"p\">;</span> <span class=\"p\">}</span>\n\n    <span class=\"k\">public</span> <span class=\"nf\">StateBase</span><span class=\"p\">(</span><span class=\"n\">StateBase</span> <span class=\"n\">other</span><span class=\"p\">)</span>\n    <span class=\"p\">{</span>\n        <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"n\">other</span> <span class=\"p\">==</span> <span class=\"k\">null</span><span class=\"p\">)</span> <span class=\"k\">return</span><span class=\"p\">;</span>\n\n        <span class=\"n\">UserId</span> <span class=\"p\">=</span> <span class=\"n\">other</span><span class=\"p\">.</span><span class=\"n\">UserId</span><span class=\"p\">;</span>\n        <span class=\"n\">RepaymentId</span> <span class=\"p\">=</span> <span class=\"n\">other</span><span class=\"p\">.</span><span class=\"n\">RepaymentId</span><span class=\"p\">;</span>\n        <span class=\"n\">PaymentId</span> <span class=\"p\">=</span> <span class=\"n\">other</span><span class=\"p\">.</span><span class=\"n\">PaymentId</span><span class=\"p\">;</span>\n    <span class=\"p\">}</span>\n<span class=\"p\">}</span>\n\n<span class=\"k\">public</span> <span class=\"k\">abstract</span> <span class=\"k\">class</span> <span class=\"nc\">EventBase</span> <span class=\"p\">{</span> <span class=\"p\">}</span>\n</code></pre></div></div>\n\n<p>As you can see, I already equipped the base state with all the properties we will need later to orchestrate this\nprocess:</p>\n\n<ul>\n  <li><code class=\"language-plaintext highlighter-rouge\">UserId</code> — tells us who is repaying,</li>\n  <li><code class=\"language-plaintext highlighter-rouge\">RepaymentId</code> — uniquely identifies the repayment process,</li>\n  <li><code class=\"language-plaintext highlighter-rouge\">PaymentId</code> — identifies the payment made by the user for this repayment.</li>\n</ul>\n\n<p>As for the event base, we don’t need anything special there, so it’s empty.</p>\n\n<p><code class=\"language-plaintext highlighter-rouge\">StateBase</code> class features a copy constructor, which rewrites all properties from the previous state when creating\na new one.</p>\n\n<p>None of the states will have any special properties, so there’s no point in painstakingly showing all individual\nsubclasses representing each state.\nHere are just a few sample classes of the initial state (<code class=\"language-plaintext highlighter-rouge\">NotStarted</code>) and one of the subsequent states:</p>\n\n<div class=\"language-csharp highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"k\">public</span> <span class=\"k\">class</span> <span class=\"nc\">NotStarted</span> <span class=\"p\">:</span> <span class=\"n\">StateBase</span>\n<span class=\"p\">{</span>\n    <span class=\"k\">public</span> <span class=\"nf\">NotStarted</span><span class=\"p\">()</span> <span class=\"p\">:</span> <span class=\"k\">base</span><span class=\"p\">(</span><span class=\"k\">null</span><span class=\"p\">)</span> <span class=\"p\">{</span> <span class=\"p\">}</span>\n<span class=\"p\">}</span>\n\n<span class=\"k\">public</span> <span class=\"k\">class</span> <span class=\"nc\">Created</span> <span class=\"p\">:</span> <span class=\"n\">StateBase</span>\n<span class=\"p\">{</span>\n    <span class=\"k\">public</span> <span class=\"nf\">Created</span><span class=\"p\">(</span><span class=\"n\">StateBase</span> <span class=\"n\">other</span><span class=\"p\">)</span> <span class=\"p\">:</span> <span class=\"k\">base</span><span class=\"p\">(</span><span class=\"n\">other</span><span class=\"p\">)</span> <span class=\"p\">{</span> <span class=\"p\">}</span>\n<span class=\"p\">}</span>\n</code></pre></div></div>\n\n<p>All of the remaining states are defined similarly to <code class=\"language-plaintext highlighter-rouge\">Created</code> state.\nThose states are:</p>\n\n<ul>\n  <li><code class=\"language-plaintext highlighter-rouge\">Paid</code>,</li>\n  <li><code class=\"language-plaintext highlighter-rouge\">Failed</code>,</li>\n  <li><code class=\"language-plaintext highlighter-rouge\">Registered</code>,</li>\n  <li><code class=\"language-plaintext highlighter-rouge\">Completed</code>.</li>\n</ul>\n\n<p>Once we have our states, we can focus on events and introduce transitions, one by one.</p>\n\n<p>We’ll start by handling an online repayment.\nIt begins with the user creating a repayment entity by selecting a payment in the Allegro Pay dashboard.\nThis generates an event, let’s call it <code class=\"language-plaintext highlighter-rouge\">OnlineRepaymentCreated</code>:</p>\n\n<div class=\"language-csharp highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"k\">public</span> <span class=\"k\">class</span> <span class=\"nc\">OnlineRepaymentCreated</span> <span class=\"p\">:</span> <span class=\"n\">EventBase</span>\n<span class=\"p\">{</span>\n    <span class=\"k\">public</span> <span class=\"kt\">string</span> <span class=\"n\">UserId</span> <span class=\"p\">{</span> <span class=\"k\">get</span><span class=\"p\">;</span> <span class=\"n\">init</span><span class=\"p\">;</span> <span class=\"p\">}</span>\n    <span class=\"k\">public</span> <span class=\"kt\">string</span> <span class=\"n\">RepaymentId</span> <span class=\"p\">{</span> <span class=\"k\">get</span><span class=\"p\">;</span> <span class=\"n\">init</span><span class=\"p\">;</span> <span class=\"p\">}</span>\n    <span class=\"k\">public</span> <span class=\"kt\">string</span> <span class=\"n\">PaymentId</span> <span class=\"p\">{</span> <span class=\"k\">get</span><span class=\"p\">;</span> <span class=\"n\">init</span><span class=\"p\">;</span> <span class=\"p\">}</span>\n<span class=\"p\">}</span>\n</code></pre></div></div>\n\n<p>We want this event to trigger a transition from <code class=\"language-plaintext highlighter-rouge\">NotStarted</code> to <code class=\"language-plaintext highlighter-rouge\">Created</code> state.</p>\n\n<div class=\"language-csharp highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"c1\">// 1. NotStarted : OnlineRepaymentCreated -&gt; Created</span>\n<span class=\"n\">stateMachine</span>\n    <span class=\"p\">.</span><span class=\"n\">FromState</span><span class=\"p\">&lt;</span><span class=\"n\">NotStarted</span><span class=\"p\">&gt;()</span>\n    <span class=\"p\">.</span><span class=\"n\">When</span><span class=\"p\">&lt;</span><span class=\"n\">OnlineRepaymentCreated</span><span class=\"p\">&gt;()</span>\n    <span class=\"p\">.</span><span class=\"n\">ToState</span><span class=\"p\">&lt;</span><span class=\"n\">Created</span><span class=\"p\">&gt;((</span><span class=\"k\">from</span><span class=\"p\">,</span> <span class=\"n\">@event</span><span class=\"p\">)</span> <span class=\"p\">=&gt;</span> <span class=\"k\">new</span> <span class=\"nf\">Created</span><span class=\"p\">(</span><span class=\"k\">from</span><span class=\"p\">)</span>\n    <span class=\"p\">{</span>\n        <span class=\"n\">UserId</span> <span class=\"p\">=</span> <span class=\"n\">@event</span><span class=\"p\">.</span><span class=\"n\">UserId</span><span class=\"p\">,</span>\n        <span class=\"n\">RepaymentId</span> <span class=\"p\">=</span> <span class=\"n\">@event</span><span class=\"p\">.</span><span class=\"n\">RepaymentId</span><span class=\"p\">,</span>\n        <span class=\"n\">PaymentId</span> <span class=\"p\">=</span> <span class=\"n\">@event</span><span class=\"p\">.</span><span class=\"n\">PaymentId</span>\n    <span class=\"p\">});</span>\n</code></pre></div></div>\n\n<p>At this point the user sees the repayment form, where they select a payment method.\nThey are then redirected to the payment provider’s website to finish the repayment.\nIn most cases it will succeed, but in some it fails due to a multitude of reasons, such as insufficient\nfunds on the account or the user providing wrong confirmation code.</p>\n\n<p>Therefore, we need two events:</p>\n\n<div class=\"language-csharp highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"k\">public</span> <span class=\"k\">class</span> <span class=\"nc\">OnlineRepaymentPaid</span> <span class=\"p\">:</span> <span class=\"n\">EventBase</span> <span class=\"p\">{</span> <span class=\"p\">}</span>\n\n<span class=\"k\">public</span> <span class=\"k\">class</span> <span class=\"nc\">OnlineRepaymentFailed</span> <span class=\"p\">:</span> <span class=\"n\">EventBase</span> <span class=\"p\">{</span> <span class=\"p\">}</span>\n</code></pre></div></div>\n\n<p>We could go about a single event called <code class=\"language-plaintext highlighter-rouge\">RepaymentResult</code> with an enum property indicating a success or a failure, but\nin my opinion the former approach is cleaner and more open to future changes.\nThese events will play a role in tranistions no. 2 and 3:</p>\n\n<div class=\"language-csharp highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"c1\">// 2. Created : OnlineRepaymentPaid -&gt; Paid</span>\n<span class=\"n\">stateMachine</span>\n    <span class=\"p\">.</span><span class=\"n\">FromState</span><span class=\"p\">&lt;</span><span class=\"n\">Created</span><span class=\"p\">&gt;()</span>\n    <span class=\"p\">.</span><span class=\"n\">When</span><span class=\"p\">&lt;</span><span class=\"n\">OnlineRepaymentPaid</span><span class=\"p\">&gt;()</span>\n    <span class=\"p\">.</span><span class=\"n\">ToState</span><span class=\"p\">&lt;</span><span class=\"n\">Paid</span><span class=\"p\">&gt;((</span><span class=\"k\">from</span><span class=\"p\">,</span> <span class=\"n\">@event</span><span class=\"p\">)</span> <span class=\"p\">=&gt;</span> <span class=\"k\">new</span> <span class=\"nf\">Paid</span><span class=\"p\">(</span><span class=\"k\">from</span><span class=\"p\">))</span>\n    <span class=\"p\">.</span><span class=\"nf\">RunCommand</span><span class=\"p\">((</span><span class=\"k\">from</span><span class=\"p\">,</span> <span class=\"n\">@event</span><span class=\"p\">,</span> <span class=\"n\">to</span><span class=\"p\">)</span> <span class=\"p\">=&gt;</span> <span class=\"k\">new</span> <span class=\"nf\">RegisterPaymentCommand</span><span class=\"p\">(</span><span class=\"n\">to</span><span class=\"p\">.</span><span class=\"n\">PaymentId</span><span class=\"p\">));</span>\n\n<span class=\"c1\">// 3. Created : OnlineRepaymentFailed -&gt; Failed</span>\n<span class=\"n\">stateMachine</span>\n    <span class=\"p\">.</span><span class=\"n\">FromState</span><span class=\"p\">&lt;</span><span class=\"n\">Created</span><span class=\"p\">&gt;()</span>\n    <span class=\"p\">.</span><span class=\"n\">When</span><span class=\"p\">&lt;</span><span class=\"n\">OnlineRepaymentFailed</span><span class=\"p\">&gt;()</span>\n    <span class=\"p\">.</span><span class=\"n\">ToState</span><span class=\"p\">&lt;</span><span class=\"n\">Failed</span><span class=\"p\">&gt;((</span><span class=\"k\">from</span><span class=\"p\">,</span> <span class=\"n\">@event</span><span class=\"p\">)</span> <span class=\"p\">=&gt;</span> <span class=\"k\">new</span> <span class=\"nf\">Failed</span><span class=\"p\">(</span><span class=\"k\">from</span><span class=\"p\">));</span>\n</code></pre></div></div>\n\n<p>You might notice that transition no. 2 has a command that I didn’t mention earlier specified.\nIt’s a simple class wrapping the payment identifier, which is interpreted by the command runner as a request to our\nbookkeeping system for registering this payment.</p>\n\n<p>This concludes the online path and we can move on to the offline repayment.\nIt is significantly easier, since we are simply notified that the money has been transferred to us.\nBecause of this, we can completely skip the <code class=\"language-plaintext highlighter-rouge\">Created</code> state and go straight to <code class=\"language-plaintext highlighter-rouge\">Paid</code>.\nWe need an event called <code class=\"language-plaintext highlighter-rouge\">OfflineRepaymentPaid</code> which contains the same properties as <code class=\"language-plaintext highlighter-rouge\">OnlineRepaymentCreated</code>:</p>\n\n<div class=\"language-csharp highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"k\">public</span> <span class=\"k\">class</span> <span class=\"nc\">OfflineRepaymentPaid</span> <span class=\"p\">:</span> <span class=\"n\">EventBase</span>\n<span class=\"p\">{</span>\n    <span class=\"k\">public</span> <span class=\"kt\">string</span> <span class=\"n\">UserId</span> <span class=\"p\">{</span> <span class=\"k\">get</span><span class=\"p\">;</span> <span class=\"n\">init</span><span class=\"p\">;</span> <span class=\"p\">}</span>\n    <span class=\"k\">public</span> <span class=\"kt\">string</span> <span class=\"n\">RepaymentId</span> <span class=\"p\">{</span> <span class=\"k\">get</span><span class=\"p\">;</span> <span class=\"n\">init</span><span class=\"p\">;</span> <span class=\"p\">}</span>\n    <span class=\"k\">public</span> <span class=\"kt\">string</span> <span class=\"n\">PaymentId</span> <span class=\"p\">{</span> <span class=\"k\">get</span><span class=\"p\">;</span> <span class=\"n\">init</span><span class=\"p\">;</span> <span class=\"p\">}</span>\n<span class=\"p\">}</span>\n</code></pre></div></div>\n\n<p>Let’s use it in the fourth transition that will once again call the registration command:</p>\n\n<div class=\"language-csharp highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"c1\">// 4. NotStarted : OfflineRepaymentPaid -&gt; Paid</span>\n<span class=\"n\">stateMachine</span>\n    <span class=\"p\">.</span><span class=\"n\">FromState</span><span class=\"p\">&lt;</span><span class=\"n\">NotStarted</span><span class=\"p\">&gt;()</span>\n    <span class=\"p\">.</span><span class=\"n\">When</span><span class=\"p\">&lt;</span><span class=\"n\">OfflineRepaymentPaid</span><span class=\"p\">&gt;()</span>\n    <span class=\"p\">.</span><span class=\"n\">ToState</span><span class=\"p\">&lt;</span><span class=\"n\">Paid</span><span class=\"p\">&gt;((</span><span class=\"k\">from</span><span class=\"p\">,</span> <span class=\"n\">@event</span><span class=\"p\">)</span> <span class=\"p\">=&gt;</span> <span class=\"k\">new</span> <span class=\"nf\">Paid</span><span class=\"p\">(</span><span class=\"k\">from</span><span class=\"p\">)</span>\n    <span class=\"p\">{</span>\n        <span class=\"n\">UserId</span> <span class=\"p\">=</span> <span class=\"n\">@event</span><span class=\"p\">.</span><span class=\"n\">UserId</span><span class=\"p\">,</span>\n        <span class=\"n\">RepaymentId</span> <span class=\"p\">=</span> <span class=\"n\">@event</span><span class=\"p\">.</span><span class=\"n\">RepaymentId</span><span class=\"p\">,</span>\n        <span class=\"n\">PaymentId</span> <span class=\"p\">=</span> <span class=\"n\">@event</span><span class=\"p\">.</span><span class=\"n\">PaymentId</span>\n    <span class=\"p\">})</span>\n    <span class=\"p\">.</span><span class=\"nf\">RunCommand</span><span class=\"p\">((</span><span class=\"k\">from</span><span class=\"p\">,</span> <span class=\"n\">@event</span><span class=\"p\">,</span> <span class=\"n\">to</span><span class=\"p\">)</span> <span class=\"p\">=&gt;</span> <span class=\"k\">new</span> <span class=\"nf\">RegisterPaymentCommand</span><span class=\"p\">(</span><span class=\"n\">@event</span><span class=\"p\">.</span><span class=\"n\">PaymentId</span><span class=\"p\">));</span>\n</code></pre></div></div>\n\n<p>This is where both repayment types merge and we can focus on our bookkeeping system.\nAs mentioned before, we are mostly interested in registration events published by the bookkeeping system.</p>\n\n<div class=\"language-csharp highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"k\">public</span> <span class=\"k\">class</span> <span class=\"nc\">PaymentRegistered</span> <span class=\"p\">:</span> <span class=\"n\">EventBase</span>\n<span class=\"p\">{</span>\n    <span class=\"k\">public</span> <span class=\"kt\">string</span> <span class=\"n\">PaymentId</span> <span class=\"p\">{</span> <span class=\"k\">get</span><span class=\"p\">;</span> <span class=\"n\">init</span><span class=\"p\">;</span> <span class=\"p\">}</span>\n<span class=\"p\">}</span>\n</code></pre></div></div>\n\n<p>Once we know that a payment is registered in our bookkeeping system, we are able to send an email to the user\nsummarizing what they paid for and follow-up information whether they still have more payments to be made.\nThis can be done with a transition like this:</p>\n\n<div class=\"language-csharp highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"c1\">// 5. Paid : PaymentRegistered -&gt; Registered</span>\n<span class=\"n\">stateMachine</span>\n    <span class=\"p\">.</span><span class=\"n\">FromState</span><span class=\"p\">&lt;</span><span class=\"n\">Paid</span><span class=\"p\">&gt;()</span>\n    <span class=\"p\">.</span><span class=\"n\">When</span><span class=\"p\">&lt;</span><span class=\"n\">PaymentRegistered</span><span class=\"p\">&gt;()</span>\n    <span class=\"p\">.</span><span class=\"n\">ToState</span><span class=\"p\">&lt;</span><span class=\"n\">Registered</span><span class=\"p\">&gt;((</span><span class=\"k\">from</span><span class=\"p\">,</span> <span class=\"n\">@event</span><span class=\"p\">)</span> <span class=\"p\">=&gt;</span> <span class=\"k\">new</span> <span class=\"nf\">Registered</span><span class=\"p\">(</span><span class=\"k\">from</span><span class=\"p\">))</span>\n    <span class=\"p\">.</span><span class=\"nf\">RunCommand</span><span class=\"p\">((</span><span class=\"k\">from</span><span class=\"p\">,</span> <span class=\"n\">@event</span><span class=\"p\">,</span> <span class=\"n\">to</span><span class=\"p\">)</span> <span class=\"p\">=&gt;</span> <span class=\"k\">new</span> <span class=\"nf\">SendRepaymentRegisteredEmailCommand</span><span class=\"p\">(</span><span class=\"n\">to</span><span class=\"p\">.</span><span class=\"n\">UserId</span><span class=\"p\">,</span> <span class=\"n\">to</span><span class=\"p\">.</span><span class=\"n\">RepaymentId</span><span class=\"p\">));</span>\n</code></pre></div></div>\n\n<p>Again, <code class=\"language-plaintext highlighter-rouge\">SendRepaymentRegisteredEmailCommand</code> is a simple class wrapping two properties that will be interpreted by the\ncommand runner and result in an email sent to the user.</p>\n\n<p>The last step is to wait for the final event <code class=\"language-plaintext highlighter-rouge\">PaymentCompleted</code>.\nTheoretically it could be omitted in this state machine, but it’s useful for auditing purposes.</p>\n\n<div class=\"language-csharp highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"k\">public</span> <span class=\"k\">class</span> <span class=\"nc\">PaymentCompleted</span> <span class=\"p\">:</span> <span class=\"n\">EventBase</span>\n<span class=\"p\">{</span>\n    <span class=\"k\">public</span> <span class=\"kt\">string</span> <span class=\"n\">PaymentId</span> <span class=\"p\">{</span> <span class=\"k\">get</span><span class=\"p\">;</span> <span class=\"n\">init</span><span class=\"p\">;</span> <span class=\"p\">}</span>\n<span class=\"p\">}</span>\n</code></pre></div></div>\n\n<p>It’s time to create the final transition:</p>\n\n<div class=\"language-csharp highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"c1\">// 6. Registered : PaymentCompleted -&gt; Completed</span>\n<span class=\"n\">stateMachine</span>\n    <span class=\"p\">.</span><span class=\"n\">FromState</span><span class=\"p\">&lt;</span><span class=\"n\">Registered</span><span class=\"p\">&gt;()</span>\n    <span class=\"p\">.</span><span class=\"n\">When</span><span class=\"p\">&lt;</span><span class=\"n\">PaymentCompleted</span><span class=\"p\">&gt;()</span>\n    <span class=\"p\">.</span><span class=\"n\">ToState</span><span class=\"p\">&lt;</span><span class=\"n\">Completed</span><span class=\"p\">&gt;((</span><span class=\"k\">from</span><span class=\"p\">,</span> <span class=\"n\">@event</span><span class=\"p\">)</span> <span class=\"p\">=&gt;</span> <span class=\"k\">new</span> <span class=\"nf\">Completed</span><span class=\"p\">(</span><span class=\"k\">from</span><span class=\"p\">));</span>\n</code></pre></div></div>\n\n<p>And we’re done!\nRight?\nNot really.</p>\n\n<p>As is usually the case with event-sourced systems, the order of incoming events can’t always be relied on.\nThe bookkeeping system will sometimes — for reasons I don’t want to delve into — publish events <code class=\"language-plaintext highlighter-rouge\">PaymentRegistered</code> and\n<code class=\"language-plaintext highlighter-rouge\">PaymentCompleted</code> at the same time.\nDue to a lack of message ordering guarantees, it’s possible for us to receive <code class=\"language-plaintext highlighter-rouge\">PaymentCompleted</code> event before\n<code class=\"language-plaintext highlighter-rouge\">PaymentRegistered</code>.\nThe current definition of the state machine is not prepared for that.</p>\n\n<p>Fortunately, the fix is quite easy, as we can simply introduce two more transitions:</p>\n\n<div class=\"language-csharp highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"c1\">// 7. Paid : PaymentCompleted -&gt; Completed</span>\n<span class=\"n\">stateMachine</span>\n    <span class=\"p\">.</span><span class=\"n\">FromState</span><span class=\"p\">&lt;</span><span class=\"n\">Paid</span><span class=\"p\">&gt;()</span>\n    <span class=\"p\">.</span><span class=\"n\">When</span><span class=\"p\">&lt;</span><span class=\"n\">PaymentCompleted</span><span class=\"p\">&gt;()</span>\n    <span class=\"p\">.</span><span class=\"n\">ToState</span><span class=\"p\">&lt;</span><span class=\"n\">Completed</span><span class=\"p\">&gt;((</span><span class=\"k\">from</span><span class=\"p\">,</span> <span class=\"n\">@event</span><span class=\"p\">)</span> <span class=\"p\">=&gt;</span> <span class=\"k\">new</span> <span class=\"nf\">Completed</span><span class=\"p\">(</span><span class=\"k\">from</span><span class=\"p\">));</span>\n\n<span class=\"c1\">// 8. Completed : PaymentRegistered -&gt; Completed</span>\n<span class=\"n\">stateMachine</span>\n    <span class=\"p\">.</span><span class=\"n\">FromState</span><span class=\"p\">&lt;</span><span class=\"n\">Completed</span><span class=\"p\">&gt;()</span>\n    <span class=\"p\">.</span><span class=\"n\">When</span><span class=\"p\">&lt;</span><span class=\"n\">PaymentRegistered</span><span class=\"p\">&gt;()</span>\n    <span class=\"p\">.</span><span class=\"n\">ToState</span><span class=\"p\">&lt;</span><span class=\"n\">Completed</span><span class=\"p\">&gt;((</span><span class=\"k\">from</span><span class=\"p\">,</span> <span class=\"n\">@event</span><span class=\"p\">)</span> <span class=\"p\">=&gt;</span> <span class=\"k\">new</span> <span class=\"nf\">Completed</span><span class=\"p\">(</span><span class=\"k\">from</span><span class=\"p\">))</span>\n    <span class=\"p\">.</span><span class=\"nf\">RunCommand</span><span class=\"p\">((</span><span class=\"k\">from</span><span class=\"p\">,</span> <span class=\"n\">@event</span><span class=\"p\">,</span> <span class=\"n\">to</span><span class=\"p\">)</span> <span class=\"p\">=&gt;</span> <span class=\"k\">new</span> <span class=\"nf\">SendRepaymentRegisteredEmailCommand</span><span class=\"p\">(</span><span class=\"n\">to</span><span class=\"p\">.</span><span class=\"n\">UserId</span><span class=\"p\">,</span> <span class=\"n\">to</span><span class=\"p\">.</span><span class=\"n\">RepaymentId</span><span class=\"p\">));</span>\n</code></pre></div></div>\n\n<p>In this scenario we completely skip <code class=\"language-plaintext highlighter-rouge\">Registered</code> state, but that’s something we just have to deal with.\nEvents are important from analytics and diagnostics standpoints, states — not so much.</p>\n\n<p>That wraps up the event flow for this scenario.\nIt can be visualized with a diagram like this:</p>\n\n<p><img src=\"/img/articles/2021-03-05-state-machines-made-easy/repayment-state-machine-v1.png\" alt=\"Repayment state machine diagram (V1)\" /></p>\n\n<p>Our state machine framework is equipped with a pretty useful visualisation extension.\nIt’s a pretty neat tool that makes it easy to figure out how the state machine works, without having to delve into the\ncode.\nA simple unit test that calls this extension can render a state machine diagram like one above using PlantUML\nsyntax, which in this case would go as follows:</p>\n\n<div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>@startuml\nhide empty description\n[*] --&gt; NotStarted\nNotStarted --&gt; Created: &lt;b&gt;OnlineRepaymentCreated&lt;/b&gt;\nCreated --&gt; Paid: &lt;b&gt;OnlineRepaymentPaid&lt;/b&gt;\\n&lt;i&gt;then:&lt;/i&gt; RegisterPaymentCommand\nCreated --&gt; Failed: &lt;b&gt;OnlineRepaymentFailed&lt;/b&gt;\nNotStarted --&gt; Paid: &lt;b&gt;OfflineRepaymentPaid&lt;/b&gt;\\n&lt;i&gt;then:&lt;/i&gt; RegisterPaymentCommand\nPaid --&gt; Registered: &lt;b&gt;PaymentRegistered&lt;/b&gt;\\n&lt;i&gt;then:&lt;/i&gt; SendRepaymentRegisteredEmailCommand\nRegistered --&gt; Completed: &lt;b&gt;PaymentCompleted&lt;/b&gt;\nPaid --&gt; Completed: &lt;b&gt;PaymentCompleted&lt;/b&gt;\nCompleted --&gt; Completed: &lt;b&gt;PaymentRegistered&lt;/b&gt;\\n&lt;i&gt;then:&lt;/i&gt; SendRepaymentRegisteredEmailCommand\n@enduml\n</code></pre></div></div>\n\n<p>However, recall that this is just a state machine to handle a repayment for a single payment selected by the user.\nI promised we would extend it to handle multiple payments.\nLet’s do that.\nFirst we’ll extend the base state definition:</p>\n\n<div class=\"language-csharp highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"k\">public</span> <span class=\"k\">abstract</span> <span class=\"k\">class</span> <span class=\"nc\">StateBase</span>\n<span class=\"p\">{</span>\n    <span class=\"k\">public</span> <span class=\"kt\">string</span> <span class=\"n\">UserId</span> <span class=\"p\">{</span> <span class=\"k\">get</span><span class=\"p\">;</span> <span class=\"n\">init</span><span class=\"p\">;</span> <span class=\"p\">}</span>\n    <span class=\"k\">public</span> <span class=\"kt\">string</span> <span class=\"n\">RepaymentId</span> <span class=\"p\">{</span> <span class=\"k\">get</span><span class=\"p\">;</span> <span class=\"n\">init</span><span class=\"p\">;</span> <span class=\"p\">}</span>\n    <span class=\"k\">public</span> <span class=\"n\">HashSet</span><span class=\"p\">&lt;</span><span class=\"kt\">string</span><span class=\"p\">&gt;</span> <span class=\"n\">PaymentIds</span> <span class=\"p\">{</span> <span class=\"k\">get</span><span class=\"p\">;</span> <span class=\"n\">init</span><span class=\"p\">;</span> <span class=\"p\">}</span>\n    <span class=\"k\">public</span> <span class=\"n\">HashSet</span><span class=\"p\">&lt;</span><span class=\"kt\">string</span><span class=\"p\">&gt;</span> <span class=\"n\">RegisteredPaymentIds</span> <span class=\"p\">{</span> <span class=\"k\">get</span><span class=\"p\">;</span> <span class=\"n\">init</span><span class=\"p\">;</span> <span class=\"p\">}</span>\n    <span class=\"k\">public</span> <span class=\"n\">HashSet</span><span class=\"p\">&lt;</span><span class=\"kt\">string</span><span class=\"p\">&gt;</span> <span class=\"n\">CompletedPaymentIds</span> <span class=\"p\">{</span> <span class=\"k\">get</span><span class=\"p\">;</span> <span class=\"n\">init</span><span class=\"p\">;</span> <span class=\"p\">}</span>\n\n    <span class=\"k\">public</span> <span class=\"nf\">StateBase</span><span class=\"p\">(</span><span class=\"n\">StateBase</span> <span class=\"n\">other</span><span class=\"p\">)</span>\n    <span class=\"p\">{</span>\n        <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"n\">other</span> <span class=\"p\">==</span> <span class=\"k\">null</span><span class=\"p\">)</span> <span class=\"k\">return</span><span class=\"p\">;</span>\n\n        <span class=\"n\">UserId</span> <span class=\"p\">=</span> <span class=\"n\">other</span><span class=\"p\">.</span><span class=\"n\">UserId</span><span class=\"p\">;</span>\n        <span class=\"n\">RepaymentId</span> <span class=\"p\">=</span> <span class=\"n\">other</span><span class=\"p\">.</span><span class=\"n\">RepaymentId</span><span class=\"p\">;</span>\n        <span class=\"n\">PaymentIds</span> <span class=\"p\">=</span> <span class=\"k\">new</span> <span class=\"n\">HashSet</span><span class=\"p\">&lt;</span><span class=\"kt\">string</span><span class=\"p\">&gt;(</span><span class=\"n\">other</span><span class=\"p\">.</span><span class=\"n\">PaymentIds</span><span class=\"p\">);</span>\n        <span class=\"n\">RegisteredPaymentIds</span> <span class=\"p\">=</span> <span class=\"k\">new</span> <span class=\"n\">HashSet</span><span class=\"p\">&lt;</span><span class=\"kt\">string</span><span class=\"p\">&gt;(</span><span class=\"n\">other</span><span class=\"p\">.</span><span class=\"n\">RegisteredPaymentIds</span><span class=\"p\">);</span>\n        <span class=\"n\">CompletedPaymentIds</span> <span class=\"p\">=</span> <span class=\"k\">new</span> <span class=\"n\">HashSet</span><span class=\"p\">&lt;</span><span class=\"kt\">string</span><span class=\"p\">&gt;(</span><span class=\"n\">other</span><span class=\"p\">.</span><span class=\"n\">CompletedPaymentIds</span><span class=\"p\">);</span>\n    <span class=\"p\">}</span>\n<span class=\"p\">}</span>\n</code></pre></div></div>\n\n<p>Three things have changed:</p>\n\n<ul>\n  <li><code class=\"language-plaintext highlighter-rouge\">PaymentId</code> changed from a <code class=\"language-plaintext highlighter-rouge\">string</code> to a <code class=\"language-plaintext highlighter-rouge\">HashSet&lt;string&gt;</code> and is now called <code class=\"language-plaintext highlighter-rouge\">PaymentIds</code> to represent multiple\npayments selected by the user,</li>\n  <li>a <code class=\"language-plaintext highlighter-rouge\">HashSet&lt;string&gt;</code> called <code class=\"language-plaintext highlighter-rouge\">RegisteredPaymentIds</code> was added to keep track of registered payments,</li>\n  <li>a <code class=\"language-plaintext highlighter-rouge\">HashSet&lt;string&gt;</code> called <code class=\"language-plaintext highlighter-rouge\">CompletedPaymentIds</code> was added to keep track of completed payments.</li>\n</ul>\n\n<p>We also have to modify <code class=\"language-plaintext highlighter-rouge\">OnlineRepaymentCreated</code> event by introducing a collection of payment identifiers, like so:</p>\n\n<div class=\"language-csharp highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"k\">public</span> <span class=\"k\">class</span> <span class=\"nc\">OnlineRepaymentCreated</span> <span class=\"p\">:</span> <span class=\"n\">EventBase</span>\n<span class=\"p\">{</span>\n    <span class=\"k\">public</span> <span class=\"kt\">string</span> <span class=\"n\">UserId</span> <span class=\"p\">{</span> <span class=\"k\">get</span><span class=\"p\">;</span> <span class=\"n\">init</span><span class=\"p\">;</span> <span class=\"p\">}</span>\n    <span class=\"k\">public</span> <span class=\"kt\">string</span> <span class=\"n\">RepaymentId</span> <span class=\"p\">{</span> <span class=\"k\">get</span><span class=\"p\">;</span> <span class=\"n\">init</span><span class=\"p\">;</span> <span class=\"p\">}</span>\n    <span class=\"k\">public</span> <span class=\"n\">IEnumerable</span><span class=\"p\">&lt;</span><span class=\"kt\">string</span><span class=\"p\">&gt;</span> <span class=\"n\">PaymentIds</span> <span class=\"p\">{</span> <span class=\"k\">get</span><span class=\"p\">;</span> <span class=\"n\">init</span><span class=\"p\">;</span> <span class=\"p\">}</span>\n<span class=\"p\">}</span>\n</code></pre></div></div>\n\n<p>Because of this, we need to introduce a small change to transition no. 1:</p>\n\n<div class=\"language-csharp highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"c1\">// 1'. NotStarted : OnlineRepaymentCreated -&gt; Created</span>\n<span class=\"n\">stateMachine</span>\n    <span class=\"p\">.</span><span class=\"n\">FromState</span><span class=\"p\">&lt;</span><span class=\"n\">NotStarted</span><span class=\"p\">&gt;()</span>\n    <span class=\"p\">.</span><span class=\"n\">When</span><span class=\"p\">&lt;</span><span class=\"n\">OnlineRepaymentCreated</span><span class=\"p\">&gt;()</span>\n    <span class=\"p\">.</span><span class=\"n\">ToState</span><span class=\"p\">&lt;</span><span class=\"n\">Created</span><span class=\"p\">&gt;((</span><span class=\"k\">from</span><span class=\"p\">,</span> <span class=\"n\">@event</span><span class=\"p\">)</span> <span class=\"p\">=&gt;</span> <span class=\"k\">new</span> <span class=\"nf\">Created</span><span class=\"p\">(</span><span class=\"k\">from</span><span class=\"p\">)</span>\n    <span class=\"p\">{</span>\n        <span class=\"n\">UserId</span> <span class=\"p\">=</span> <span class=\"n\">@event</span><span class=\"p\">.</span><span class=\"n\">UserId</span><span class=\"p\">,</span>\n        <span class=\"n\">RepaymentId</span> <span class=\"p\">=</span> <span class=\"n\">@event</span><span class=\"p\">.</span><span class=\"n\">RepaymentId</span><span class=\"p\">,</span>\n        <span class=\"n\">PaymentIds</span> <span class=\"p\">=</span> <span class=\"k\">new</span> <span class=\"n\">HashSet</span><span class=\"p\">&lt;</span><span class=\"kt\">string</span><span class=\"p\">&gt;(</span><span class=\"n\">@event</span><span class=\"p\">.</span><span class=\"n\">PaymentIds</span><span class=\"p\">)</span>\n    <span class=\"p\">});</span>\n</code></pre></div></div>\n\n<p>Transition no. 2 is similarly adjusted to these changes by passing the set of payment identifiers to the\nbookkeeping system:</p>\n\n<div class=\"language-csharp highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"p\">(</span><span class=\"k\">from</span><span class=\"p\">,</span> <span class=\"n\">@event</span><span class=\"p\">,</span> <span class=\"n\">to</span><span class=\"p\">)</span> <span class=\"p\">=&gt;</span> <span class=\"k\">new</span> <span class=\"nf\">RegisterPaymentsCommand</span><span class=\"p\">(</span><span class=\"n\">to</span><span class=\"p\">.</span><span class=\"n\">PaymentIds</span><span class=\"p\">)</span>\n</code></pre></div></div>\n\n<p>Now we can move to the remaining transitions.\nTransition no. 5 has to be split into two.\nWe want to stay in the <code class=\"language-plaintext highlighter-rouge\">Paid</code> state until all registration events are received and only then switch to <code class=\"language-plaintext highlighter-rouge\">Registered</code>.\nThis can be achieved with:</p>\n\n<div class=\"language-csharp highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"c1\">// 5'. Paid : PaymentRegistered -&gt; Paid</span>\n<span class=\"n\">stateMachine</span>\n    <span class=\"p\">.</span><span class=\"n\">FromState</span><span class=\"p\">&lt;</span><span class=\"n\">Paid</span><span class=\"p\">&gt;()</span>\n    <span class=\"p\">.</span><span class=\"n\">When</span><span class=\"p\">&lt;</span><span class=\"n\">PaymentRegistered</span><span class=\"p\">&gt;((</span><span class=\"k\">from</span><span class=\"p\">,</span> <span class=\"n\">@event</span><span class=\"p\">)</span> <span class=\"p\">=&gt;</span> <span class=\"p\">!</span><span class=\"k\">from</span><span class=\"p\">.</span><span class=\"n\">PaymentIds</span><span class=\"p\">.</span><span class=\"nf\">All</span><span class=\"p\">(</span>\n        <span class=\"n\">id</span> <span class=\"p\">=&gt;</span> <span class=\"k\">from</span><span class=\"p\">.</span><span class=\"n\">RegisteredPaymentIds</span><span class=\"p\">.</span><span class=\"nf\">Contains</span><span class=\"p\">(</span><span class=\"n\">id</span><span class=\"p\">)</span> <span class=\"p\">||</span> <span class=\"n\">id</span> <span class=\"p\">==</span> <span class=\"n\">@event</span><span class=\"p\">.</span><span class=\"n\">PaymentId</span><span class=\"p\">))</span>\n    <span class=\"p\">.</span><span class=\"n\">ToState</span><span class=\"p\">&lt;</span><span class=\"n\">Paid</span><span class=\"p\">&gt;((</span><span class=\"k\">from</span><span class=\"p\">,</span> <span class=\"n\">@event</span><span class=\"p\">)</span> <span class=\"p\">=&gt;</span>\n    <span class=\"p\">{</span>\n        <span class=\"kt\">var</span> <span class=\"n\">to</span> <span class=\"p\">=</span> <span class=\"k\">new</span> <span class=\"nf\">Paid</span><span class=\"p\">(</span><span class=\"k\">from</span><span class=\"p\">);</span>\n        <span class=\"n\">to</span><span class=\"p\">.</span><span class=\"n\">RegisteredPaymentIds</span><span class=\"p\">.</span><span class=\"nf\">Add</span><span class=\"p\">(</span><span class=\"n\">@event</span><span class=\"p\">.</span><span class=\"n\">PaymentId</span><span class=\"p\">);</span>\n        <span class=\"k\">return</span> <span class=\"n\">to</span><span class=\"p\">;</span>\n    <span class=\"p\">});</span>\n\n<span class=\"c1\">// 5''. Paid : PaymentRegistered -&gt; Registered</span>\n<span class=\"n\">stateMachine</span>\n    <span class=\"p\">.</span><span class=\"n\">FromState</span><span class=\"p\">&lt;</span><span class=\"n\">Paid</span><span class=\"p\">&gt;()</span>\n    <span class=\"p\">.</span><span class=\"n\">When</span><span class=\"p\">&lt;</span><span class=\"n\">PaymentRegistered</span><span class=\"p\">&gt;((</span><span class=\"k\">from</span><span class=\"p\">,</span> <span class=\"n\">@event</span><span class=\"p\">)</span> <span class=\"p\">=&gt;</span> <span class=\"k\">from</span><span class=\"p\">.</span><span class=\"n\">PaymentIds</span><span class=\"p\">.</span><span class=\"nf\">All</span><span class=\"p\">(</span>\n        <span class=\"n\">id</span> <span class=\"p\">=&gt;</span> <span class=\"k\">from</span><span class=\"p\">.</span><span class=\"n\">RegisteredPaymentIds</span><span class=\"p\">.</span><span class=\"nf\">Contains</span><span class=\"p\">(</span><span class=\"n\">id</span><span class=\"p\">)</span> <span class=\"p\">||</span> <span class=\"n\">id</span> <span class=\"p\">==</span> <span class=\"n\">@event</span><span class=\"p\">.</span><span class=\"n\">PaymentId</span><span class=\"p\">))</span>\n    <span class=\"p\">.</span><span class=\"n\">ToState</span><span class=\"p\">&lt;</span><span class=\"n\">Registered</span><span class=\"p\">&gt;((</span><span class=\"k\">from</span><span class=\"p\">,</span> <span class=\"n\">@event</span><span class=\"p\">)</span> <span class=\"p\">=&gt;</span>\n    <span class=\"p\">{</span>\n        <span class=\"kt\">var</span> <span class=\"n\">to</span> <span class=\"p\">=</span> <span class=\"k\">new</span> <span class=\"nf\">Registered</span><span class=\"p\">(</span><span class=\"k\">from</span><span class=\"p\">);</span>\n        <span class=\"n\">to</span><span class=\"p\">.</span><span class=\"n\">RegisteredPaymentIds</span><span class=\"p\">.</span><span class=\"nf\">Add</span><span class=\"p\">(</span><span class=\"n\">@event</span><span class=\"p\">.</span><span class=\"n\">PaymentId</span><span class=\"p\">);</span>\n        <span class=\"k\">return</span> <span class=\"n\">to</span><span class=\"p\">;</span>\n    <span class=\"p\">});</span>\n    <span class=\"p\">.</span><span class=\"nf\">RunCommand</span><span class=\"p\">((</span><span class=\"k\">from</span><span class=\"p\">,</span> <span class=\"n\">@event</span><span class=\"p\">,</span> <span class=\"n\">to</span><span class=\"p\">)</span> <span class=\"p\">=&gt;</span> <span class=\"k\">new</span> <span class=\"nf\">SendRepaymentRegisteredEmailCommand</span><span class=\"p\">(</span><span class=\"n\">to</span><span class=\"p\">.</span><span class=\"n\">UserId</span><span class=\"p\">,</span> <span class=\"n\">to</span><span class=\"p\">.</span><span class=\"n\">RepaymentId</span><span class=\"p\">));</span>\n</code></pre></div></div>\n\n<p>As you can see, the command is now defined only for the second transition that triggers after all payments are\nregistered.\nWe have to slightly adjust transition no. 8, which is responsible for sending the email, too:</p>\n\n<div class=\"language-csharp highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"c1\">// 8'. Completed : PaymentRegistered -&gt; Completed</span>\n<span class=\"n\">stateMachine</span>\n    <span class=\"p\">.</span><span class=\"n\">FromState</span><span class=\"p\">&lt;</span><span class=\"n\">Completed</span><span class=\"p\">&gt;()</span>\n    <span class=\"p\">.</span><span class=\"n\">When</span><span class=\"p\">&lt;</span><span class=\"n\">PaymentRegistered</span><span class=\"p\">&gt;()</span>\n    <span class=\"p\">.</span><span class=\"n\">ToState</span><span class=\"p\">&lt;</span><span class=\"n\">Completed</span><span class=\"p\">&gt;((</span><span class=\"k\">from</span><span class=\"p\">,</span> <span class=\"n\">@event</span><span class=\"p\">)</span> <span class=\"p\">=&gt;</span>\n    <span class=\"p\">{</span>\n        <span class=\"kt\">var</span> <span class=\"n\">to</span> <span class=\"p\">=</span> <span class=\"k\">new</span> <span class=\"nf\">Completed</span><span class=\"p\">(</span><span class=\"k\">from</span><span class=\"p\">);</span>\n        <span class=\"n\">to</span><span class=\"p\">.</span><span class=\"n\">RegisteredPaymentIds</span><span class=\"p\">.</span><span class=\"nf\">Add</span><span class=\"p\">(</span><span class=\"n\">@event</span><span class=\"p\">.</span><span class=\"n\">PaymentId</span><span class=\"p\">);</span>\n        <span class=\"k\">return</span> <span class=\"n\">to</span><span class=\"p\">;</span>\n    <span class=\"p\">})</span>\n    <span class=\"p\">.</span><span class=\"nf\">RunCommand</span><span class=\"p\">(</span>\n        <span class=\"n\">when</span><span class=\"p\">:</span> <span class=\"p\">(</span><span class=\"k\">from</span><span class=\"p\">,</span> <span class=\"n\">@event</span><span class=\"p\">,</span> <span class=\"n\">to</span><span class=\"p\">)</span> <span class=\"p\">=&gt;</span> <span class=\"n\">to</span><span class=\"p\">.</span><span class=\"n\">PaymentIds</span><span class=\"p\">.</span><span class=\"nf\">SetEquals</span><span class=\"p\">(</span><span class=\"n\">to</span><span class=\"p\">.</span><span class=\"n\">RegisteredPaymentIds</span><span class=\"p\">),</span>\n        <span class=\"n\">then</span><span class=\"p\">:</span> <span class=\"p\">(</span><span class=\"k\">from</span><span class=\"p\">,</span> <span class=\"n\">@event</span><span class=\"p\">,</span> <span class=\"n\">to</span><span class=\"p\">)</span> <span class=\"p\">=&gt;</span> <span class=\"k\">new</span> <span class=\"nf\">SendRepaymentRegisteredEmailCommand</span><span class=\"p\">(</span><span class=\"n\">to</span><span class=\"p\">.</span><span class=\"n\">UserId</span><span class=\"p\">,</span> <span class=\"n\">to</span><span class=\"p\">.</span><span class=\"n\">RepaymentId</span><span class=\"p\">));</span>\n</code></pre></div></div>\n\n<p>This time the transition is not conditional, however the command is.\nIt will execute only after we handle final registration event and the payment identifier sets <code class=\"language-plaintext highlighter-rouge\">PaymentIds</code> and\n<code class=\"language-plaintext highlighter-rouge\">RegisteredPaymentIds</code> become equal.</p>\n\n<p>We cannot forget about all transitions that are triggered by <code class=\"language-plaintext highlighter-rouge\">PaymentCompleted</code> event.\nThose will have to be changed like so:</p>\n\n<div class=\"language-csharp highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"c1\">// 6'. Registered : PaymentCompleted -&gt; Registered</span>\n<span class=\"n\">stateMachine</span>\n    <span class=\"p\">.</span><span class=\"n\">FromState</span><span class=\"p\">&lt;</span><span class=\"n\">Registered</span><span class=\"p\">&gt;()</span>\n    <span class=\"p\">.</span><span class=\"n\">When</span><span class=\"p\">&lt;</span><span class=\"n\">PaymentCompleted</span><span class=\"p\">&gt;((</span><span class=\"k\">from</span><span class=\"p\">,</span> <span class=\"n\">@event</span><span class=\"p\">)</span> <span class=\"p\">=&gt;</span> <span class=\"p\">!</span><span class=\"k\">from</span><span class=\"p\">.</span><span class=\"n\">PaymentIds</span><span class=\"p\">.</span><span class=\"nf\">All</span><span class=\"p\">(</span>\n        <span class=\"n\">id</span> <span class=\"p\">=&gt;</span> <span class=\"k\">from</span><span class=\"p\">.</span><span class=\"n\">CompletedPaymentIds</span><span class=\"p\">.</span><span class=\"nf\">Contains</span><span class=\"p\">(</span><span class=\"n\">id</span><span class=\"p\">)</span> <span class=\"p\">||</span> <span class=\"n\">id</span> <span class=\"p\">==</span> <span class=\"n\">@event</span><span class=\"p\">.</span><span class=\"n\">PaymentId</span><span class=\"p\">))</span>\n    <span class=\"p\">.</span><span class=\"n\">ToState</span><span class=\"p\">&lt;</span><span class=\"n\">Registered</span><span class=\"p\">&gt;((</span><span class=\"k\">from</span><span class=\"p\">,</span> <span class=\"n\">@event</span><span class=\"p\">)</span> <span class=\"p\">=&gt;</span>\n    <span class=\"p\">{</span>\n        <span class=\"kt\">var</span> <span class=\"n\">to</span> <span class=\"p\">=</span> <span class=\"k\">new</span> <span class=\"nf\">Registered</span><span class=\"p\">(</span><span class=\"k\">from</span><span class=\"p\">);</span>\n        <span class=\"n\">to</span><span class=\"p\">.</span><span class=\"n\">CompletedPaymentIds</span><span class=\"p\">.</span><span class=\"nf\">Add</span><span class=\"p\">(</span><span class=\"n\">@event</span><span class=\"p\">.</span><span class=\"n\">PaymentId</span><span class=\"p\">);</span>\n        <span class=\"k\">return</span> <span class=\"n\">to</span><span class=\"p\">;</span>\n    <span class=\"p\">});</span>\n\n<span class=\"c1\">// 6''. Registered : PaymentCompleted -&gt; Completed</span>\n<span class=\"n\">stateMachine</span>\n    <span class=\"p\">.</span><span class=\"n\">FromState</span><span class=\"p\">&lt;</span><span class=\"n\">Registered</span><span class=\"p\">&gt;()</span>\n    <span class=\"p\">.</span><span class=\"n\">When</span><span class=\"p\">&lt;</span><span class=\"n\">PaymentCompleted</span><span class=\"p\">&gt;((</span><span class=\"k\">from</span><span class=\"p\">,</span> <span class=\"n\">@event</span><span class=\"p\">)</span> <span class=\"p\">=&gt;</span> <span class=\"k\">from</span><span class=\"p\">.</span><span class=\"n\">PaymentIds</span><span class=\"p\">.</span><span class=\"nf\">All</span><span class=\"p\">(</span>\n        <span class=\"n\">id</span> <span class=\"p\">=&gt;</span> <span class=\"k\">from</span><span class=\"p\">.</span><span class=\"n\">CompletedPaymentIds</span><span class=\"p\">.</span><span class=\"nf\">Contains</span><span class=\"p\">(</span><span class=\"n\">id</span><span class=\"p\">)</span> <span class=\"p\">||</span> <span class=\"n\">id</span> <span class=\"p\">==</span> <span class=\"n\">@event</span><span class=\"p\">.</span><span class=\"n\">PaymentId</span><span class=\"p\">))</span>\n    <span class=\"p\">.</span><span class=\"n\">ToState</span><span class=\"p\">&lt;</span><span class=\"n\">Completed</span><span class=\"p\">&gt;((</span><span class=\"k\">from</span><span class=\"p\">,</span> <span class=\"n\">@event</span><span class=\"p\">)</span> <span class=\"p\">=&gt;</span>\n    <span class=\"p\">{</span>\n        <span class=\"kt\">var</span> <span class=\"n\">to</span> <span class=\"p\">=</span> <span class=\"k\">new</span> <span class=\"nf\">Completed</span><span class=\"p\">(</span><span class=\"k\">from</span><span class=\"p\">);</span>\n        <span class=\"n\">to</span><span class=\"p\">.</span><span class=\"n\">CompletedPaymentIds</span><span class=\"p\">.</span><span class=\"nf\">Add</span><span class=\"p\">(</span><span class=\"n\">@event</span><span class=\"p\">.</span><span class=\"n\">PaymentId</span><span class=\"p\">);</span>\n        <span class=\"k\">return</span> <span class=\"n\">to</span><span class=\"p\">;</span>\n    <span class=\"p\">});</span>\n\n<span class=\"c1\">// 7'. Paid : PaymentCompleted -&gt; Paid</span>\n<span class=\"n\">stateMachine</span>\n    <span class=\"p\">.</span><span class=\"n\">FromState</span><span class=\"p\">&lt;</span><span class=\"n\">Paid</span><span class=\"p\">&gt;()</span>\n    <span class=\"p\">.</span><span class=\"n\">When</span><span class=\"p\">&lt;</span><span class=\"n\">PaymentCompleted</span><span class=\"p\">&gt;((</span><span class=\"k\">from</span><span class=\"p\">,</span> <span class=\"n\">@event</span><span class=\"p\">)</span> <span class=\"p\">=&gt;</span> <span class=\"p\">!</span><span class=\"k\">from</span><span class=\"p\">.</span><span class=\"n\">PaymentIds</span><span class=\"p\">.</span><span class=\"nf\">All</span><span class=\"p\">(</span>\n        <span class=\"n\">id</span> <span class=\"p\">=&gt;</span> <span class=\"k\">from</span><span class=\"p\">.</span><span class=\"n\">CompletedPaymentIds</span><span class=\"p\">.</span><span class=\"nf\">Contains</span><span class=\"p\">(</span><span class=\"n\">id</span><span class=\"p\">)</span> <span class=\"p\">||</span> <span class=\"n\">id</span> <span class=\"p\">==</span> <span class=\"n\">@event</span><span class=\"p\">.</span><span class=\"n\">PaymentId</span><span class=\"p\">))</span>\n    <span class=\"p\">.</span><span class=\"n\">ToState</span><span class=\"p\">&lt;</span><span class=\"n\">Completed</span><span class=\"p\">&gt;((</span><span class=\"k\">from</span><span class=\"p\">,</span> <span class=\"n\">@event</span><span class=\"p\">)</span> <span class=\"p\">=&gt;</span>\n    <span class=\"p\">{</span>\n        <span class=\"kt\">var</span> <span class=\"n\">to</span> <span class=\"p\">=</span> <span class=\"k\">new</span> <span class=\"nf\">Completed</span><span class=\"p\">(</span><span class=\"k\">from</span><span class=\"p\">);</span>\n        <span class=\"n\">to</span><span class=\"p\">.</span><span class=\"n\">CompletedPaymentIds</span><span class=\"p\">.</span><span class=\"nf\">Add</span><span class=\"p\">(</span><span class=\"n\">@event</span><span class=\"p\">.</span><span class=\"n\">PaymentId</span><span class=\"p\">);</span>\n        <span class=\"k\">return</span> <span class=\"n\">to</span><span class=\"p\">;</span>\n    <span class=\"p\">});</span>\n\n<span class=\"c1\">// 7''. Paid : PaymentCompleted -&gt; Completed</span>\n<span class=\"n\">stateMachine</span>\n    <span class=\"p\">.</span><span class=\"n\">FromState</span><span class=\"p\">&lt;</span><span class=\"n\">Paid</span><span class=\"p\">&gt;()</span>\n    <span class=\"p\">.</span><span class=\"n\">When</span><span class=\"p\">&lt;</span><span class=\"n\">PaymentCompleted</span><span class=\"p\">&gt;((</span><span class=\"k\">from</span><span class=\"p\">,</span> <span class=\"n\">@event</span><span class=\"p\">)</span> <span class=\"p\">=&gt;</span> <span class=\"k\">from</span><span class=\"p\">.</span><span class=\"n\">PaymentIds</span><span class=\"p\">.</span><span class=\"nf\">All</span><span class=\"p\">(</span>\n        <span class=\"n\">id</span> <span class=\"p\">=&gt;</span> <span class=\"k\">from</span><span class=\"p\">.</span><span class=\"n\">CompletedPaymentIds</span><span class=\"p\">.</span><span class=\"nf\">Contains</span><span class=\"p\">(</span><span class=\"n\">id</span><span class=\"p\">)</span> <span class=\"p\">||</span> <span class=\"n\">id</span> <span class=\"p\">==</span> <span class=\"n\">@event</span><span class=\"p\">.</span><span class=\"n\">PaymentId</span><span class=\"p\">))</span>\n    <span class=\"p\">.</span><span class=\"n\">ToState</span><span class=\"p\">&lt;</span><span class=\"n\">Completed</span><span class=\"p\">&gt;((</span><span class=\"k\">from</span><span class=\"p\">,</span> <span class=\"n\">@event</span><span class=\"p\">)</span> <span class=\"p\">=&gt;</span>\n    <span class=\"p\">{</span>\n        <span class=\"kt\">var</span> <span class=\"n\">to</span> <span class=\"p\">=</span> <span class=\"k\">new</span> <span class=\"nf\">Completed</span><span class=\"p\">(</span><span class=\"k\">from</span><span class=\"p\">);</span>\n        <span class=\"n\">to</span><span class=\"p\">.</span><span class=\"n\">CompletedPaymentIds</span><span class=\"p\">.</span><span class=\"nf\">Add</span><span class=\"p\">(</span><span class=\"n\">@event</span><span class=\"p\">.</span><span class=\"n\">PaymentId</span><span class=\"p\">);</span>\n        <span class=\"k\">return</span> <span class=\"n\">to</span><span class=\"p\">;</span>\n    <span class=\"p\">});</span>\n</code></pre></div></div>\n\n<p>And we’re done!\nThis time for real.\nAfter all this work we ended up with something that can be visualized with a diagram like this:</p>\n\n<p><img src=\"/img/articles/2021-03-05-state-machines-made-easy/repayment-state-machine-v2.png\" alt=\"Repayment state machine diagram (V2)\" /></p>\n\n<p>I mentioned earlier that we have internal back-office tools to view state machines and their transition history.\nHere is an example view of a repayment process that was coordinated with the state machine we defined above (sensitive\ndata was redacted, since this was taken in production):</p>\n\n<p><img src=\"/img/articles/2021-03-05-state-machines-made-easy/back-office-state-machine-view.png\" alt=\"Back-office state machine view\" /></p>\n\n<h3 id=\"caveats\">Caveats</h3>\n\n<p>You may have noticed some problems here.\nWhat would happen if we received an event with a wrong payment identifier?\nRight now the state machine is not ready for that.\nHowever, that can be remedied relatively easily by adding another condition to <code class=\"language-plaintext highlighter-rouge\">When</code> methods of all transitions for\n<code class=\"language-plaintext highlighter-rouge\">PaymentRegistered</code> and <code class=\"language-plaintext highlighter-rouge\">PaymentCompleted</code> events, such as:</p>\n\n<div class=\"language-csharp highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"p\">.</span><span class=\"nf\">When</span><span class=\"p\">((</span><span class=\"k\">from</span><span class=\"p\">,</span> <span class=\"n\">@event</span><span class=\"p\">)</span> <span class=\"p\">=&gt;</span> <span class=\"k\">from</span><span class=\"p\">.</span><span class=\"n\">PaymentIds</span><span class=\"p\">.</span><span class=\"nf\">Contains</span><span class=\"p\">(</span><span class=\"n\">@event</span><span class=\"p\">.</span><span class=\"n\">PaymentId</span><span class=\"p\">)</span> <span class=\"p\">&amp;&amp;</span> <span class=\"cm\">/* ... */</span><span class=\"p\">)</span>\n</code></pre></div></div>\n\n<p>This would essentialy ensure that we react only to events with correct identifiers.</p>\n\n<p>And what about retries and duplicated events?\nTransition no. 8’ is especially susceptible to that, because it may result in the email being sent to the user twice.\nAnd we don’t want that!\nFortunately, achieving deduplication is just as easy — we have to ignore events for payments that are already\nregistered:</p>\n\n<div class=\"language-csharp highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"p\">.</span><span class=\"nf\">When</span><span class=\"p\">((</span><span class=\"k\">from</span><span class=\"p\">,</span> <span class=\"n\">@event</span><span class=\"p\">)</span> <span class=\"p\">=&gt;</span> <span class=\"p\">!</span><span class=\"k\">from</span><span class=\"p\">.</span><span class=\"n\">RegisteredPaymentIds</span><span class=\"p\">.</span><span class=\"nf\">Contains</span><span class=\"p\">(</span><span class=\"n\">@event</span><span class=\"p\">.</span><span class=\"n\">PaymentId</span><span class=\"p\">)</span> <span class=\"p\">&amp;&amp;</span> <span class=\"cm\">/* ... */</span><span class=\"p\">)</span>\n</code></pre></div></div>\n\n<p>For the sake of readability I also decided to skip a lot of other validations, which would otherwise have to be there,\nsuch as simple null checks.</p>\n\n<h3 id=\"how-to-test\">How to test</h3>\n\n<p>Testing state machines is important, because, well, ideally all code should be tested.\nIn this case, apart from the usual assurance that we are able to handle both happy paths and edge cases, we can also\nensure that we keep the transitions backwards compatible.\nAn event that is once inserted into the stream will stay there forever.</p>\n\n<p>We developed a simple DSL in F# to help us test state machines created with our framework.\nThis is a perfect solution to test a declarative definition of a state machine like the one we developed in this post.\nHere’s an example of a happy path test for our state machine:</p>\n\n<div class=\"language-fsharp highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"p\">[&lt;</span><span class=\"nc\">Fact</span><span class=\"p\">&gt;]</span>\n<span class=\"k\">let</span> <span class=\"n\">``Online repayment - single payment happy path``</span> <span class=\"bp\">()</span> <span class=\"p\">=</span>\n    <span class=\"p\">[</span>\n        <span class=\"nc\">When</span><span class=\"p\">(</span><span class=\"nn\">Events</span><span class=\"p\">.</span><span class=\"nc\">OnlineRepaymentCreated</span> <span class=\"p\">(</span><span class=\"s2\">\"paymentId1\"</span><span class=\"o\">))</span>\n            <span class=\"p\">|&gt;</span> <span class=\"nc\">GoToState</span><span class=\"p\">&lt;</span><span class=\"nc\">Created</span><span class=\"p\">&gt;</span>\n            <span class=\"p\">|&gt;</span> <span class=\"nc\">DoNothing</span>\n        <span class=\"nc\">When</span><span class=\"p\">(</span><span class=\"nn\">Events</span><span class=\"p\">.</span><span class=\"nc\">OnlineRepaymentPaid</span> <span class=\"bp\">()</span><span class=\"p\">)</span>\n            <span class=\"p\">|&gt;</span> <span class=\"nc\">GoToState</span><span class=\"p\">&lt;</span><span class=\"nc\">Paid</span><span class=\"p\">&gt;</span>\n            <span class=\"p\">|&gt;</span> <span class=\"nc\">Do</span><span class=\"p\">&lt;</span><span class=\"nc\">RegisterPaymentsCommand</span><span class=\"p\">&gt;</span>\n        <span class=\"nc\">When</span><span class=\"p\">(</span><span class=\"nn\">Events</span><span class=\"p\">.</span><span class=\"nc\">PaymentRegistered</span> <span class=\"p\">(</span><span class=\"s2\">\"paymentId1\"</span><span class=\"o\">))</span>\n            <span class=\"p\">|&gt;</span> <span class=\"nc\">GoToState</span><span class=\"p\">&lt;</span><span class=\"nc\">Registered</span><span class=\"p\">&gt;</span>\n            <span class=\"p\">|&gt;</span> <span class=\"nc\">Do</span><span class=\"p\">&lt;</span><span class=\"nc\">SendRepaymentRegisteredEmailCommand</span><span class=\"p\">&gt;</span>\n        <span class=\"nc\">When</span><span class=\"p\">(</span><span class=\"nn\">Events</span><span class=\"p\">.</span><span class=\"nc\">PaymentCompleted</span> <span class=\"p\">(</span><span class=\"s2\">\"paymentId1\"</span><span class=\"o\">))</span>\n            <span class=\"p\">|&gt;</span> <span class=\"nc\">GoToState</span><span class=\"p\">&lt;</span><span class=\"nc\">Completed</span><span class=\"p\">&gt;</span>\n            <span class=\"p\">|&gt;</span> <span class=\"nc\">DoNothing</span>\n    <span class=\"p\">]</span>\n    <span class=\"p\">|&gt;</span> <span class=\"n\">apply</span>\n</code></pre></div></div>\n\n<p>A test like this is essentially a list of events with expected side effects that are then aggregated using the <code class=\"language-plaintext highlighter-rouge\">apply</code>\nfunction that feeds them one by one into the state machine and verifies the outcome.</p>\n\n<h2 id=\"summary\">Summary</h2>\n\n<p>I hope I was able to convince you how a framework like this can make designing complex state machines easy.\nIt provides numerous advantages, such as declarative syntax, effortless testability, thorough instrumentation and\nvisualization.</p>\n\n<p>This is precisely why state machines became an integral part of pretty much every business process architecture\nin our project.\nHaving such a robust and scalable solution for asynchronous process orchestration and isolation is crucial in\ndistributed systems.\nThe presented code, albeit extremely simplified, is from an actual state machine — one of many used in our\napplications.</p>\n\n<p>While the presented solution is a strictly internal framework right now, who knows what the future might bring?\nStay tuned!</p>\n","contentSnippet":"Coordinating complex processes, both business and technical, can be a challenging issue in a distributed system.\nEspecially when the complications associated with them, such as concurrency, idempotency, scalability and hindered\ntestability, come into play — possibly all at once.\nThis is definitely something that can keep many programmers awake at night.\nWhile this may sound dramatic, in reality there are many different solutions to this problem.\nOne group of such solutions extensively uses finite-state machines also known as finite-state automata.\nAs this article is meant for everyone, let’s start with some background information about what they are and how\nthey work.\nWhat are finite-state machines\nFor the sake of readability, I will sometimes be referring to finite-state machines as simply “state machines”.\nIf you’re already familiar with their formal definition, you may skip to the next section.\nFormally speaking, a finite-state machine is a mathematical model of computation that describes an abstract system\nhaving a finite number of permissible states. At any given point in time, the system is in exactly one of these\nstates.\nIn practical terms such a machine is described by:\nan initial (start) state,\na set of possible states,\na sequence of possible inputs (events),\na transition function which based on the last observed input and the machine’s current state, determines the next\nstate,\nand a set of terminal (end) states — optionally.\nThe machine starts off in the initial state and inspects all inputs in sequence.\nUpon observing each input, it uses the transition function to change its state.\nThe processing ends once all inputs have been observed.\nIf the machine’s state at the end of processing is one of the terminal states, the machine is assumed to accept the\ngiven input, and to reject it otherwise.\nAs a side note, the description provided above uses the deterministic model of a finite-state automaton.\nThere are also alternative, non-deterministic machines, but I won’t be delving into them too much, as they can be\nconverted to deterministic ones anyway.\nIf you’ve read this far, hopefully the rest of this post will be easier on the mind!\nDespite the intimidating formal definition, finite-state machines are more widespread than you might imagine.\nUpon closer inspection you might be able to spot them in your everyday life under the hood of things such as vending\nmachines, traffic lights and elevators.\nIn .NET they are used in the implementation of async/await or yield syntax.\nTry decompiling your code and see how the language authors implemented those features.\nYou have probably already used some sort of state machine in your code without even realising it!\nA simple example of a basic state machine implementation\nLet’s take a closer look at the following piece of code:\n\npublic enum Button\n{\n    Play,\n    Stop\n}\n\npublic enum State\n{\n    Playing,\n    NotPlaying\n}\n\npublic class Player\n{\n    public State CurrentState { get; private set; } = State.NotPlaying;\n\n    public void HandleClick(Button button)\n    {\n        if (button == Button.Play)\n        {\n            CurrentState = State.Playing;\n        }\n        else if (button == Button.Stop)\n        {\n            CurrentState = State.NotPlaying;\n        }\n    }\n}\n\n\nThis is an example of a very simple state machine with two states and two events.\nThe player can be either playing or not playing music.\nPressing the Play button will start or keep playing music, while pressing the Stop button will stop the music or keep\nit stopped.\nThe code is manageable at this point, since the example is quite straightforward.\nHowever, I hope you can imagine how adding more media controls that are usually present in music players will quickly\nresult in complex code that will not be easily maintainable anymore.\nFor instance, consider a feature request to have the Previous button change to the previous track if the player is less\nthan 3 seconds into the current track, or stay at the current track but rewind it to the beginning otherwise.\nThat being said, in many cases this kind of state machine implementation would be more than enough.\nYou don’t always have to use a state-of-the-art, bleeding-edge solution to achieve desired goals.\nHowever, this is not something I would recommend to someone who is trying to tackle coordination of asynchronous\noperations within a distributed system.\nA more maintainable approach\nLet me share our approach to this problem.\nWe have come up with a framework for building state machines in .NET with very little code that is maintainable and\ntestable.\nState machines built with this framework serve a purpose of orchestrating a wide range of business and technical\nprocesses in our microservice-based distributed architecture.\nThe framework is equipped with various features dictated by paradigms of distributed systems, which extend the\nstandard state machine definition.\nBefore I move on to an example of its real-life application, I want to break down the state machine’s API, so that you\nknow what you’re looking at later on.\nTo keep things short, I will be showing you only snippets of simplified code, as implementation details can be\nexpanded upon in follow-up posts.\nThe state machine is defined as follows:\n\npublic class StateMachine<TStateBase, TEventBase>\n{\n    public StateMachine(TStateBase initialState)\n    {\n        // ...\n    }\n}\n\n\nIt is a generic class that requires a definition of base types for all states (TStateBase) and for all transition\ntriggers (TEventBase).\nThe constructor accepts an initial state from which the state machine will start its operation.\nWe can create the state machine like so:\n\nvar stateMachine = new StateMachine<StateBase, EventBase>(new InitialState());\n\n\nHaving created this object, we may start defining transitions.\nEach transtion consists of three required elements:\nthe state from which the transition can be triggered,\nthe transition trigger (an event),\nthe state to which the transition leads.\nOptionally, a transition can have side effects, called simply commands.\nA command (or a set of commands) will be run after a successful transition.\nThose can be pretty much anything from sending a message to another state machine to calling a specific service and\ndelegating a task to it.\nCommands allow a seamless integration of the state machine with external components.\nThere is a drawback, however.\nCommand execution may fail, what requires an idempotent retry policy to be employed.\nTransitions and commands can be conditional, meaning that a logical expression can be guarding and preventing the\nexecution of the whole transition, or just a command in some cases.\nA builder pattern which combines all of the aforementioned requirements is used to compose a transition:\n\nstateMachine\n    .FromState<TStateFrom>()\n    .When<TEvent>(/* Expression<Func<TStateFrom, TEvent, bool>> */)\n    .ToState<TStateTo>(/* Expression<Func<TStateFrom, TEvent, TStateTo>> */)\n    .RunCommand(\n        when: /* Expression<Func<TStateFrom, TEvent, TStateTo, bool>> */,\n        then: /* Expression<Func<TStateFrom, TEvent, TStateTo, TCommand>> */)\n    .RunCommand(/* ... */)\n    // ...\n    .RunCommand(/* ... */);\n\n\nThis structure may be overwhelming at first, but bear with me.\nIt will all make sense in a bit.\nAs for now you need to know that:\nif the state machine is in a state of TStateFrom type,\nand an event of type TEvent occured,\nand the condition (if defined) passed to When method is satisfied,\nthe transition will fire up and the state machine will switch to a new state of type TStateTo using the factory method\nexpression passed to ToState method.\nThe state machine class exposes a method which can be used to trigger a transition with an event:\n\npublic TransitionResult Apply(TEventBase @event);\n\n\nThis method applies the supplied event to the current state by trying to find a matching transition in the transition\nmapping and changes the internal state of the machine.\nThe result contains information about the performed transition, along with commands that should be run.\n\npublic class TransitionResult\n{\n    public TStateBase StateFrom { get; }\n    public TEventBase Event { get; }\n    public TStateBase StateTo { get; }\n    public IEnumerable<object> Commands { get; }\n    public bool IsValid { get; }\n}\n\n\nIf no matching transition definition is found given the machine’s current state – or if a transition is found, but its\nprecondition is not met – the event application will result in an invalid transition.\nIn that case, the state machine will not react to the event and simply retain its state, possibly logging that an\ninvalid event was received.\nIf there are multiple matching transitions, the first one will fire up (in definition order).\nWe should, however, avoid designing states machines in such way if possible.\nAs you can see, the representation of the machine is primarily type-based, so we can use polymorphism to our advantage.\nBy calling FromState<TStateBase>() we can have a transition that can be fired up from any state.\nSimilarily, if we use a type that only some selected states derive from, we will have a transition applicable to these\nstates only.\nIt would be equivalent to duplicating that same transition for every one of these states.\nThis syntax can be particularly useful, when dealing with processes that have an expiration date and have to be\ncompleted within a specific time frame.\nReceiving an event about the process’ expiration may have to be handled regardless of the machine’s current state and\nresult in termination immediately.\nImplementation manifest\nNow that I’ve described how a state machine can be defined in a declarative way using our framework, let’s talk a bit\nabout how that definition actually runs.\nIn general, we use dependency injection to make the state machine definition work with other services and add-ons,\nsuch as specific command runners.\nI promised I would not dive deep into implementation details, but nonetheless I want to give you a little taste of\nwhat sits behind the scenes.\nIf you don’t care for any of that, you may skip to the “Real-life example” section.\nStorage\nThe state machine implementation is based on event sourcing.\nIn summary, this means that we don’t save the state of our application objects, but rather a series of events that\nchange the object’s state.\nThese events will give us the current view of the object when aggregated (“replayed”) in the order in which they\noccured.\nFor this purpose we currently use an open-source library,\nSQLStreamStore.\nSQLStreamStore offers an atomic and idempotent stream append operation.\nThanks to this, we don’t have to worry about race conditions between multiple instances of the same state machine\nhandling events in parallel, what is great for scalability.\nWe can also recognize a situation when the same event is being fed into the state machine again, what can happen\nwhen dealing with retry policies.\nThat, on the other hand, gives us a pretty good way of achieving deduplication.\nCaching\nReplaying all events every single time is an unnecessary overhead that we decided to mitigate by introducing\na lock-free cache for state snapshots.\nAfter each transition a state machine will cache its current state along with the stream version which it\ncorresponds to.\nThis gives us the ability to restore the state machine to the state it was in after handling n-1 events, when we want\nto handle the n-th event.\nIt requires, however, the states to be immutable, or else we may end up with an unexpected behaviour.\nIf states were not immutable, we could not be certain that the state object we cached after handling the n-th event\nis still the same and has not been modified in the meantime.\nMoreover, immutable objects are inherently thread-safe.\nInstrumentation\nThis state machine framework is also equipped with heavy instrumentation.\nEvery executed transition and state change is logged, so we can easily track any errors.\nThis data is also useful for our data analytics team to keep track of business processes.\nA lot of different metrics come into play to measure performance of each and every state machine deployed.\nFinally, every historical transition is saved in a stream — separate from the event stream — and can be viewed with our\ninternal back-office tools.\nThanks to the finite nature of the state machines, we can always log the current state and trace what made the system\nto be in that state, along with all its previous states.\nThis is something quite invaluable and helps immensely when diagnosing issues, especially in complex and\ninter-dependent business scenarios where a lot of things happen at the same time.\nReal-life example\nSo finally, the big question: how is this framework used on our platform?\nTo answer that we don’t need to reach far.\nIn July of 2020 we launched a new payment method called Allegro Pay, which will eventually be available to every buyer\non Allegro.\nThis service allows the users to buy items now and pay for them later in a single payment after 30 days, or\nin multiple smaller monthly payments, depending on the value of purchased goods.\nRepayments can be easily made online using our Allegro Pay dashboard.\nUsers are even able to pay for multiple purchases at once.\n\nFor more detailed information, I encourage you to read our\nAllegro Pay FAQ.\nI suspect you already know where I’m going with this — my goal is to show you how our state machine framework is used\nto coordinate an actual business process of handling a repayment within Allegro Pay.\nThe process specification\nBefore we create our state machine, we need to have a rough idea of which states and events we want to handle.\nThe repayment process is started in two different ways, but will end alike in both cases.\nThe user can initialize an immediate online repayment via the Allegro Pay dashboard.\n They are redirected to the payment provider’s website and complete the process there.\nAlternatively, the user can request to repay their purchase with a traditional wire transfer, what we call an\noffline repayment.\n We know nothing about it until the money actually arrives at the target bank account.\n That method may take up to a couple of days.\nAt this point both repayment paths merge, since from now on we can discard any knowledge about how the money\nwas received and focus on the fact that we have it.\nThe money source won’t be useful during the process coordination anymore.\nThe next step is to register the repayment in our bookkeeping system.\nThe registration part is important for us, because it will tell us whether the purchase was paid in full or if further\nrepayments are required.\nAfter receiving information about successful registration, an email is sent to the user confirming that the\nrepayment was registered.\nAfter repayment is registered, we asynchronously await the feedback from the bookkeeping system on the transaction\nbeing settled and the repayment is to be marked as completed.\nDesigning the state machine\nI could show you the finished state machine and just paste a wall of text here, describing what it does, but where’s\nthe fun in that?\nInstead, I’d like to show you the step-by-step process I would go through when designing this kind of state machine.\nI’ll start off by simply creating a state machine that handles a repayment of a single purchase and then extend it\nto work for all cases.\nFirst we need to define the base types for all states and events:\n\npublic abstract class StateBase\n{\n    public string UserId { get; init; }\n    public string RepaymentId { get; init; }\n    public string PaymentId { get; init; }\n\n    public StateBase(StateBase other)\n    {\n        if (other == null) return;\n\n        UserId = other.UserId;\n        RepaymentId = other.RepaymentId;\n        PaymentId = other.PaymentId;\n    }\n}\n\npublic abstract class EventBase { }\n\n\nAs you can see, I already equipped the base state with all the properties we will need later to orchestrate this\nprocess:\nUserId — tells us who is repaying,\nRepaymentId — uniquely identifies the repayment process,\nPaymentId — identifies the payment made by the user for this repayment.\nAs for the event base, we don’t need anything special there, so it’s empty.\nStateBase class features a copy constructor, which rewrites all properties from the previous state when creating\na new one.\nNone of the states will have any special properties, so there’s no point in painstakingly showing all individual\nsubclasses representing each state.\nHere are just a few sample classes of the initial state (NotStarted) and one of the subsequent states:\n\npublic class NotStarted : StateBase\n{\n    public NotStarted() : base(null) { }\n}\n\npublic class Created : StateBase\n{\n    public Created(StateBase other) : base(other) { }\n}\n\n\nAll of the remaining states are defined similarly to Created state.\nThose states are:\nPaid,\nFailed,\nRegistered,\nCompleted.\nOnce we have our states, we can focus on events and introduce transitions, one by one.\nWe’ll start by handling an online repayment.\nIt begins with the user creating a repayment entity by selecting a payment in the Allegro Pay dashboard.\nThis generates an event, let’s call it OnlineRepaymentCreated:\n\npublic class OnlineRepaymentCreated : EventBase\n{\n    public string UserId { get; init; }\n    public string RepaymentId { get; init; }\n    public string PaymentId { get; init; }\n}\n\n\nWe want this event to trigger a transition from NotStarted to Created state.\n\n// 1. NotStarted : OnlineRepaymentCreated -> Created\nstateMachine\n    .FromState<NotStarted>()\n    .When<OnlineRepaymentCreated>()\n    .ToState<Created>((from, @event) => new Created(from)\n    {\n        UserId = @event.UserId,\n        RepaymentId = @event.RepaymentId,\n        PaymentId = @event.PaymentId\n    });\n\n\nAt this point the user sees the repayment form, where they select a payment method.\nThey are then redirected to the payment provider’s website to finish the repayment.\nIn most cases it will succeed, but in some it fails due to a multitude of reasons, such as insufficient\nfunds on the account or the user providing wrong confirmation code.\nTherefore, we need two events:\n\npublic class OnlineRepaymentPaid : EventBase { }\n\npublic class OnlineRepaymentFailed : EventBase { }\n\n\nWe could go about a single event called RepaymentResult with an enum property indicating a success or a failure, but\nin my opinion the former approach is cleaner and more open to future changes.\nThese events will play a role in tranistions no. 2 and 3:\n\n// 2. Created : OnlineRepaymentPaid -> Paid\nstateMachine\n    .FromState<Created>()\n    .When<OnlineRepaymentPaid>()\n    .ToState<Paid>((from, @event) => new Paid(from))\n    .RunCommand((from, @event, to) => new RegisterPaymentCommand(to.PaymentId));\n\n// 3. Created : OnlineRepaymentFailed -> Failed\nstateMachine\n    .FromState<Created>()\n    .When<OnlineRepaymentFailed>()\n    .ToState<Failed>((from, @event) => new Failed(from));\n\n\nYou might notice that transition no. 2 has a command that I didn’t mention earlier specified.\nIt’s a simple class wrapping the payment identifier, which is interpreted by the command runner as a request to our\nbookkeeping system for registering this payment.\nThis concludes the online path and we can move on to the offline repayment.\nIt is significantly easier, since we are simply notified that the money has been transferred to us.\nBecause of this, we can completely skip the Created state and go straight to Paid.\nWe need an event called OfflineRepaymentPaid which contains the same properties as OnlineRepaymentCreated:\n\npublic class OfflineRepaymentPaid : EventBase\n{\n    public string UserId { get; init; }\n    public string RepaymentId { get; init; }\n    public string PaymentId { get; init; }\n}\n\n\nLet’s use it in the fourth transition that will once again call the registration command:\n\n// 4. NotStarted : OfflineRepaymentPaid -> Paid\nstateMachine\n    .FromState<NotStarted>()\n    .When<OfflineRepaymentPaid>()\n    .ToState<Paid>((from, @event) => new Paid(from)\n    {\n        UserId = @event.UserId,\n        RepaymentId = @event.RepaymentId,\n        PaymentId = @event.PaymentId\n    })\n    .RunCommand((from, @event, to) => new RegisterPaymentCommand(@event.PaymentId));\n\n\nThis is where both repayment types merge and we can focus on our bookkeeping system.\nAs mentioned before, we are mostly interested in registration events published by the bookkeeping system.\n\npublic class PaymentRegistered : EventBase\n{\n    public string PaymentId { get; init; }\n}\n\n\nOnce we know that a payment is registered in our bookkeeping system, we are able to send an email to the user\nsummarizing what they paid for and follow-up information whether they still have more payments to be made.\nThis can be done with a transition like this:\n\n// 5. Paid : PaymentRegistered -> Registered\nstateMachine\n    .FromState<Paid>()\n    .When<PaymentRegistered>()\n    .ToState<Registered>((from, @event) => new Registered(from))\n    .RunCommand((from, @event, to) => new SendRepaymentRegisteredEmailCommand(to.UserId, to.RepaymentId));\n\n\nAgain, SendRepaymentRegisteredEmailCommand is a simple class wrapping two properties that will be interpreted by the\ncommand runner and result in an email sent to the user.\nThe last step is to wait for the final event PaymentCompleted.\nTheoretically it could be omitted in this state machine, but it’s useful for auditing purposes.\n\npublic class PaymentCompleted : EventBase\n{\n    public string PaymentId { get; init; }\n}\n\n\nIt’s time to create the final transition:\n\n// 6. Registered : PaymentCompleted -> Completed\nstateMachine\n    .FromState<Registered>()\n    .When<PaymentCompleted>()\n    .ToState<Completed>((from, @event) => new Completed(from));\n\n\nAnd we’re done!\nRight?\nNot really.\nAs is usually the case with event-sourced systems, the order of incoming events can’t always be relied on.\nThe bookkeeping system will sometimes — for reasons I don’t want to delve into — publish events PaymentRegistered and\nPaymentCompleted at the same time.\nDue to a lack of message ordering guarantees, it’s possible for us to receive PaymentCompleted event before\nPaymentRegistered.\nThe current definition of the state machine is not prepared for that.\nFortunately, the fix is quite easy, as we can simply introduce two more transitions:\n\n// 7. Paid : PaymentCompleted -> Completed\nstateMachine\n    .FromState<Paid>()\n    .When<PaymentCompleted>()\n    .ToState<Completed>((from, @event) => new Completed(from));\n\n// 8. Completed : PaymentRegistered -> Completed\nstateMachine\n    .FromState<Completed>()\n    .When<PaymentRegistered>()\n    .ToState<Completed>((from, @event) => new Completed(from))\n    .RunCommand((from, @event, to) => new SendRepaymentRegisteredEmailCommand(to.UserId, to.RepaymentId));\n\n\nIn this scenario we completely skip Registered state, but that’s something we just have to deal with.\nEvents are important from analytics and diagnostics standpoints, states — not so much.\nThat wraps up the event flow for this scenario.\nIt can be visualized with a diagram like this:\n\nOur state machine framework is equipped with a pretty useful visualisation extension.\nIt’s a pretty neat tool that makes it easy to figure out how the state machine works, without having to delve into the\ncode.\nA simple unit test that calls this extension can render a state machine diagram like one above using PlantUML\nsyntax, which in this case would go as follows:\n\n@startuml\nhide empty description\n[*] --> NotStarted\nNotStarted --> Created: <b>OnlineRepaymentCreated</b>\nCreated --> Paid: <b>OnlineRepaymentPaid</b>\\n<i>then:</i> RegisterPaymentCommand\nCreated --> Failed: <b>OnlineRepaymentFailed</b>\nNotStarted --> Paid: <b>OfflineRepaymentPaid</b>\\n<i>then:</i> RegisterPaymentCommand\nPaid --> Registered: <b>PaymentRegistered</b>\\n<i>then:</i> SendRepaymentRegisteredEmailCommand\nRegistered --> Completed: <b>PaymentCompleted</b>\nPaid --> Completed: <b>PaymentCompleted</b>\nCompleted --> Completed: <b>PaymentRegistered</b>\\n<i>then:</i> SendRepaymentRegisteredEmailCommand\n@enduml\n\n\nHowever, recall that this is just a state machine to handle a repayment for a single payment selected by the user.\nI promised we would extend it to handle multiple payments.\nLet’s do that.\nFirst we’ll extend the base state definition:\n\npublic abstract class StateBase\n{\n    public string UserId { get; init; }\n    public string RepaymentId { get; init; }\n    public HashSet<string> PaymentIds { get; init; }\n    public HashSet<string> RegisteredPaymentIds { get; init; }\n    public HashSet<string> CompletedPaymentIds { get; init; }\n\n    public StateBase(StateBase other)\n    {\n        if (other == null) return;\n\n        UserId = other.UserId;\n        RepaymentId = other.RepaymentId;\n        PaymentIds = new HashSet<string>(other.PaymentIds);\n        RegisteredPaymentIds = new HashSet<string>(other.RegisteredPaymentIds);\n        CompletedPaymentIds = new HashSet<string>(other.CompletedPaymentIds);\n    }\n}\n\n\nThree things have changed:\nPaymentId changed from a string to a HashSet<string> and is now called PaymentIds to represent multiple\npayments selected by the user,\na HashSet<string> called RegisteredPaymentIds was added to keep track of registered payments,\na HashSet<string> called CompletedPaymentIds was added to keep track of completed payments.\nWe also have to modify OnlineRepaymentCreated event by introducing a collection of payment identifiers, like so:\n\npublic class OnlineRepaymentCreated : EventBase\n{\n    public string UserId { get; init; }\n    public string RepaymentId { get; init; }\n    public IEnumerable<string> PaymentIds { get; init; }\n}\n\n\nBecause of this, we need to introduce a small change to transition no. 1:\n\n// 1'. NotStarted : OnlineRepaymentCreated -> Created\nstateMachine\n    .FromState<NotStarted>()\n    .When<OnlineRepaymentCreated>()\n    .ToState<Created>((from, @event) => new Created(from)\n    {\n        UserId = @event.UserId,\n        RepaymentId = @event.RepaymentId,\n        PaymentIds = new HashSet<string>(@event.PaymentIds)\n    });\n\n\nTransition no. 2 is similarly adjusted to these changes by passing the set of payment identifiers to the\nbookkeeping system:\n\n(from, @event, to) => new RegisterPaymentsCommand(to.PaymentIds)\n\n\nNow we can move to the remaining transitions.\nTransition no. 5 has to be split into two.\nWe want to stay in the Paid state until all registration events are received and only then switch to Registered.\nThis can be achieved with:\n\n// 5'. Paid : PaymentRegistered -> Paid\nstateMachine\n    .FromState<Paid>()\n    .When<PaymentRegistered>((from, @event) => !from.PaymentIds.All(\n        id => from.RegisteredPaymentIds.Contains(id) || id == @event.PaymentId))\n    .ToState<Paid>((from, @event) =>\n    {\n        var to = new Paid(from);\n        to.RegisteredPaymentIds.Add(@event.PaymentId);\n        return to;\n    });\n\n// 5''. Paid : PaymentRegistered -> Registered\nstateMachine\n    .FromState<Paid>()\n    .When<PaymentRegistered>((from, @event) => from.PaymentIds.All(\n        id => from.RegisteredPaymentIds.Contains(id) || id == @event.PaymentId))\n    .ToState<Registered>((from, @event) =>\n    {\n        var to = new Registered(from);\n        to.RegisteredPaymentIds.Add(@event.PaymentId);\n        return to;\n    });\n    .RunCommand((from, @event, to) => new SendRepaymentRegisteredEmailCommand(to.UserId, to.RepaymentId));\n\n\nAs you can see, the command is now defined only for the second transition that triggers after all payments are\nregistered.\nWe have to slightly adjust transition no. 8, which is responsible for sending the email, too:\n\n// 8'. Completed : PaymentRegistered -> Completed\nstateMachine\n    .FromState<Completed>()\n    .When<PaymentRegistered>()\n    .ToState<Completed>((from, @event) =>\n    {\n        var to = new Completed(from);\n        to.RegisteredPaymentIds.Add(@event.PaymentId);\n        return to;\n    })\n    .RunCommand(\n        when: (from, @event, to) => to.PaymentIds.SetEquals(to.RegisteredPaymentIds),\n        then: (from, @event, to) => new SendRepaymentRegisteredEmailCommand(to.UserId, to.RepaymentId));\n\n\nThis time the transition is not conditional, however the command is.\nIt will execute only after we handle final registration event and the payment identifier sets PaymentIds and\nRegisteredPaymentIds become equal.\nWe cannot forget about all transitions that are triggered by PaymentCompleted event.\nThose will have to be changed like so:\n\n// 6'. Registered : PaymentCompleted -> Registered\nstateMachine\n    .FromState<Registered>()\n    .When<PaymentCompleted>((from, @event) => !from.PaymentIds.All(\n        id => from.CompletedPaymentIds.Contains(id) || id == @event.PaymentId))\n    .ToState<Registered>((from, @event) =>\n    {\n        var to = new Registered(from);\n        to.CompletedPaymentIds.Add(@event.PaymentId);\n        return to;\n    });\n\n// 6''. Registered : PaymentCompleted -> Completed\nstateMachine\n    .FromState<Registered>()\n    .When<PaymentCompleted>((from, @event) => from.PaymentIds.All(\n        id => from.CompletedPaymentIds.Contains(id) || id == @event.PaymentId))\n    .ToState<Completed>((from, @event) =>\n    {\n        var to = new Completed(from);\n        to.CompletedPaymentIds.Add(@event.PaymentId);\n        return to;\n    });\n\n// 7'. Paid : PaymentCompleted -> Paid\nstateMachine\n    .FromState<Paid>()\n    .When<PaymentCompleted>((from, @event) => !from.PaymentIds.All(\n        id => from.CompletedPaymentIds.Contains(id) || id == @event.PaymentId))\n    .ToState<Completed>((from, @event) =>\n    {\n        var to = new Completed(from);\n        to.CompletedPaymentIds.Add(@event.PaymentId);\n        return to;\n    });\n\n// 7''. Paid : PaymentCompleted -> Completed\nstateMachine\n    .FromState<Paid>()\n    .When<PaymentCompleted>((from, @event) => from.PaymentIds.All(\n        id => from.CompletedPaymentIds.Contains(id) || id == @event.PaymentId))\n    .ToState<Completed>((from, @event) =>\n    {\n        var to = new Completed(from);\n        to.CompletedPaymentIds.Add(@event.PaymentId);\n        return to;\n    });\n\n\nAnd we’re done!\nThis time for real.\nAfter all this work we ended up with something that can be visualized with a diagram like this:\n\nI mentioned earlier that we have internal back-office tools to view state machines and their transition history.\nHere is an example view of a repayment process that was coordinated with the state machine we defined above (sensitive\ndata was redacted, since this was taken in production):\n\nCaveats\nYou may have noticed some problems here.\nWhat would happen if we received an event with a wrong payment identifier?\nRight now the state machine is not ready for that.\nHowever, that can be remedied relatively easily by adding another condition to When methods of all transitions for\nPaymentRegistered and PaymentCompleted events, such as:\n\n.When((from, @event) => from.PaymentIds.Contains(@event.PaymentId) && /* ... */)\n\n\nThis would essentialy ensure that we react only to events with correct identifiers.\nAnd what about retries and duplicated events?\nTransition no. 8’ is especially susceptible to that, because it may result in the email being sent to the user twice.\nAnd we don’t want that!\nFortunately, achieving deduplication is just as easy — we have to ignore events for payments that are already\nregistered:\n\n.When((from, @event) => !from.RegisteredPaymentIds.Contains(@event.PaymentId) && /* ... */)\n\n\nFor the sake of readability I also decided to skip a lot of other validations, which would otherwise have to be there,\nsuch as simple null checks.\nHow to test\nTesting state machines is important, because, well, ideally all code should be tested.\nIn this case, apart from the usual assurance that we are able to handle both happy paths and edge cases, we can also\nensure that we keep the transitions backwards compatible.\nAn event that is once inserted into the stream will stay there forever.\nWe developed a simple DSL in F# to help us test state machines created with our framework.\nThis is a perfect solution to test a declarative definition of a state machine like the one we developed in this post.\nHere’s an example of a happy path test for our state machine:\n\n[<Fact>]\nlet ``Online repayment - single payment happy path`` () =\n    [\n        When(Events.OnlineRepaymentCreated (\"paymentId1\"))\n            |> GoToState<Created>\n            |> DoNothing\n        When(Events.OnlineRepaymentPaid ())\n            |> GoToState<Paid>\n            |> Do<RegisterPaymentsCommand>\n        When(Events.PaymentRegistered (\"paymentId1\"))\n            |> GoToState<Registered>\n            |> Do<SendRepaymentRegisteredEmailCommand>\n        When(Events.PaymentCompleted (\"paymentId1\"))\n            |> GoToState<Completed>\n            |> DoNothing\n    ]\n    |> apply\n\n\nA test like this is essentially a list of events with expected side effects that are then aggregated using the apply\nfunction that feeds them one by one into the state machine and verifies the outcome.\nSummary\nI hope I was able to convince you how a framework like this can make designing complex state machines easy.\nIt provides numerous advantages, such as declarative syntax, effortless testability, thorough instrumentation and\nvisualization.\nThis is precisely why state machines became an integral part of pretty much every business process architecture\nin our project.\nHaving such a robust and scalable solution for asynchronous process orchestration and isolation is crucial in\ndistributed systems.\nThe presented code, albeit extremely simplified, is from an actual state machine — one of many used in our\napplications.\nWhile the presented solution is a strictly internal framework right now, who knows what the future might bring?\nStay tuned!","guid":"https://blog.allegro.tech/2021/03/state-machines-made-easy.html","categories":["tech","dotnet","state_machine","allegro_pay"],"isoDate":"2021-03-04T23:00:00.000Z","thumbnail":"images/post-headers/default.jpg"},{"title":"My first days at Allegro","link":"https://blog.allegro.tech/2021/02/first-days-at-allegro.html","pubDate":"Mon, 15 Feb 2021 00:00:00 +0100","authors":{"author":[{"name":["Krzysztof Przychodzki"],"photo":["https://blog.allegro.tech/img/authors/krzysztof.przychodzki.jpg"],"url":["https://blog.allegro.tech/authors/krzysztof.przychodzki"]}]},"content":"<p>So you’re new to <a href=\"https://blog.allegro.tech/about-us/\">Allegro</a>, have just finished your tech onboarding and are stunned with information overflow? Or perhaps you\nare planning to join Allegro and don’t know what it looks like in here? I am about to try and describe how I felt just a few months ago and what startled or\ndismayed me. I hope this short article will answer all your concerns.</p>\n\n<p>But first I would like to give you a little background of my professional work life.</p>\n\n<h2 id=\"background\">Background</h2>\n\n<p>Long before becoming a developer, I was a chemical engineer, and I was designing distilleries, cosmetic and oil refinery plants, etc. During my work, I often\nused Microsoft Excel and VBA as my main apps for solving complex problems. I enjoyed it more than the job I was assigned. So I decided to take a Java bootcamp\nand afterwards I got hired by an IT company in my area. At my first IT job, I was hired as a junior, but I was already treated as a regular programmer.\nIt was nice, I owe them a lot, but on the other hand the only feedback I got was when something was not working. From the beginning, I was fully aware of how\nbasic my knowledge was after the bootcamp. While catching up I realized that at this company I would not develop anymore, and I would be working with legacy\ntechnologies throughout the rest of my career.</p>\n\n<h2 id=\"a-piece-of-cake\">A piece of cake?</h2>\n\n<p>The recruitment process at Allegro — let me tell you straight, is not a piece of cake. I am pretty sure that a year after the recruitment meeting you are\nstill going to remember the questions you were torpedoed with.</p>\n\n<p>First of all — after applying, you will receive an email with all the necessary information about the recruitment process. Each step is briefly\ncharacterized, so you know what is going to happen next and what to expect. The first step is a task on DevSkiller. Then, you will take part in technical\ninterviews in the form of conversation about the technologies and architecture of modern IT systems, touching on aspects of design, performance, monitoring, etc.\nIt was very different from the previous recruitment processes in which I sometimes spoke to people who had no clue what I was talking about. At Allegro I really\nappreciate that these meetings are with real professionals! What is more, during my recruitments I have never encountered such a human approach. They treat you\nlike a human, not like a robot. That’s cool. In the last step you will meet with a team leader and people from HR.</p>\n\n<h2 id=\"first-days\">First days</h2>\n\n<p>My first days at Allegro — what a rollercoaster, considering the current coronavirus situation. Onboarding normally takes 3 days and is conducted at the\ncompany’s headquarters in Poznań. There is another two-day long technical onboarding for technical employees at the workplace. However, due to the COVID-19\nsituation, the entire onboarding process was carried out remotely. This tech onboarding is conducted with a workshop on how to create a new service and\neverything that goes with it like deploying, running and maintaining. I understood why (this was not possible remotely), but it is a pity that it did not take\nplace. Fortunately, everybody wants to help you with any issue you have — and this is the great power of Allegro: people and their readiness to help.\nIt is natural for everyone that a new person needs support and time to get to know the organization. Moreover, if you are a junior like me, and have never\nwritten a line of code for example in Kotlin, you can spend some time learning a new programming language and everybody is okay with that.</p>\n\n<p>Someone might ask: What is difficult in the beginning? That depends, because everything is new. I work in a team responsible for Allegro Smart! loyalty\nprogramme — ensuring proper marking of offers qualified for free delivery — so the most confusing thing for me was the business complexity of those\nprocesses.</p>\n\n<p>Nevertheless, there are over 1200 microservices communicating with each other — a status quo you have to deal with. Thousands of decisions were made and\na lot of them don’t sound reasonable when you first hear about them, but after a day passes, everything starts to clarify. I think this is what everyone deals\nwith when they come to a new place.</p>\n\n<h2 id=\"somebody-is-reading-my-code\">Somebody is reading my code</h2>\n\n<p>One of my favorite things at Allegro is code review. Virtually nothing gets merged unless it is reviewed and approved. Code review is mandatory and necessary\n— reading others’ code is not only about finding bugs, it is mainly to provide code that is clear, understandable, and maintainable. For me, it is mainly\nfor learning and better understanding our services and business domain.</p>\n\n<p>Another great thing is pair programming. During these sessions it is easier to understand the business domain and to catch the wider context of our services.</p>\n\n<h2 id=\"unit-integration-and-end-to-end-testing\">Unit, integration, and end-to-end testing</h2>\n\n<p>As I wrote, unreviewed code will not be deployed to production and without tests it is not going to pass the review. At Allegro, each change in code needs\nto be tested. We write unit and integration tests, and we work with two test environments.</p>\n\n<p>One is totally a developer’s playground where you make your ‘little Allegro’. It is called phoenix. Every team has its own phoenix env for\nexperiments. However, it has some issues. Since there are so many dependencies to other services, your already set up environment may not work properly until it\nis manually updated. So a very common situation is that before you start testing your change, you need to spend some time to get the whole environment working.\nThis is frustrating, especially in the beginning.</p>\n\n<p>The second one is a pre-prod sandbox — it is like normal Allegro, but unlike the dev environment, the sandbox is more consistent and works almost like\nprod. So there are a lot of possibilities to test your change and it’s good to have this feeling of confidence.</p>\n\n<p>Sometimes despite all these tests, code reviews, etc. a mistake happens — the app is already deployed to production, and our clients are complaining.\nWe have to act quickly to fix the error. I really appreciate that we look for bugs, not the guilty party. When somebody makes a mistake, we don’t blame each\nother, but we look for the best solution to the problem and fix it.</p>\n\n<h2 id=\"hack-the-day\">Hack the day</h2>\n\n<p>Sometimes teams do internal hackathons (called fedex-days) — we divide into two or three teams and we work on subjects that we choose. We want\nto try a new programming language — we just do it; make an application for sharing memes — perfectly fine; write an extension for Slack — why\nnot, go have some fun! Usually, we spend two working days getting off work. That’s very refreshing.</p>\n\n<p>I also know that once in a while there are hackathons for the whole Allegro — but I didn’t have a chance to participate.</p>\n\n<h2 id=\"dobrze-tu-być\">Dobrze tu być?</h2>\n\n<p>At Allegro we all understand the great importance of ensuring the code we are working on is of the highest quality. We care about our services to the point\nwhere we sometimes spend hours discussing if it is better to throw an exception or just 404?</p>\n\n<p>However, Allegro is not only about programming, it is a place with a lot of experts in many other disciplines — and every one of us has a straightforward\ngoal to make Allegro the best place/platform not only for shoppers and sellers, but also for each other.</p>\n\n<p>Hope you enjoyed this article. I know it sounds like a chorus of praise, but in my situation it arises from my work experiences — for me, it is really a\n“Good to be here!” place. Or as we say <a href=\"https://www.linkedin.com/company/allegro-pl/life/team\">#dobrzetubyć</a>.</p>\n","contentSnippet":"So you’re new to Allegro, have just finished your tech onboarding and are stunned with information overflow? Or perhaps you\nare planning to join Allegro and don’t know what it looks like in here? I am about to try and describe how I felt just a few months ago and what startled or\ndismayed me. I hope this short article will answer all your concerns.\nBut first I would like to give you a little background of my professional work life.\nBackground\nLong before becoming a developer, I was a chemical engineer, and I was designing distilleries, cosmetic and oil refinery plants, etc. During my work, I often\nused Microsoft Excel and VBA as my main apps for solving complex problems. I enjoyed it more than the job I was assigned. So I decided to take a Java bootcamp\nand afterwards I got hired by an IT company in my area. At my first IT job, I was hired as a junior, but I was already treated as a regular programmer.\nIt was nice, I owe them a lot, but on the other hand the only feedback I got was when something was not working. From the beginning, I was fully aware of how\nbasic my knowledge was after the bootcamp. While catching up I realized that at this company I would not develop anymore, and I would be working with legacy\ntechnologies throughout the rest of my career.\nA piece of cake?\nThe recruitment process at Allegro — let me tell you straight, is not a piece of cake. I am pretty sure that a year after the recruitment meeting you are\nstill going to remember the questions you were torpedoed with.\nFirst of all — after applying, you will receive an email with all the necessary information about the recruitment process. Each step is briefly\ncharacterized, so you know what is going to happen next and what to expect. The first step is a task on DevSkiller. Then, you will take part in technical\ninterviews in the form of conversation about the technologies and architecture of modern IT systems, touching on aspects of design, performance, monitoring, etc.\nIt was very different from the previous recruitment processes in which I sometimes spoke to people who had no clue what I was talking about. At Allegro I really\nappreciate that these meetings are with real professionals! What is more, during my recruitments I have never encountered such a human approach. They treat you\nlike a human, not like a robot. That’s cool. In the last step you will meet with a team leader and people from HR.\nFirst days\nMy first days at Allegro — what a rollercoaster, considering the current coronavirus situation. Onboarding normally takes 3 days and is conducted at the\ncompany’s headquarters in Poznań. There is another two-day long technical onboarding for technical employees at the workplace. However, due to the COVID-19\nsituation, the entire onboarding process was carried out remotely. This tech onboarding is conducted with a workshop on how to create a new service and\neverything that goes with it like deploying, running and maintaining. I understood why (this was not possible remotely), but it is a pity that it did not take\nplace. Fortunately, everybody wants to help you with any issue you have — and this is the great power of Allegro: people and their readiness to help.\nIt is natural for everyone that a new person needs support and time to get to know the organization. Moreover, if you are a junior like me, and have never\nwritten a line of code for example in Kotlin, you can spend some time learning a new programming language and everybody is okay with that.\nSomeone might ask: What is difficult in the beginning? That depends, because everything is new. I work in a team responsible for Allegro Smart! loyalty\nprogramme — ensuring proper marking of offers qualified for free delivery — so the most confusing thing for me was the business complexity of those\nprocesses.\nNevertheless, there are over 1200 microservices communicating with each other — a status quo you have to deal with. Thousands of decisions were made and\na lot of them don’t sound reasonable when you first hear about them, but after a day passes, everything starts to clarify. I think this is what everyone deals\nwith when they come to a new place.\nSomebody is reading my code\nOne of my favorite things at Allegro is code review. Virtually nothing gets merged unless it is reviewed and approved. Code review is mandatory and necessary\n— reading others’ code is not only about finding bugs, it is mainly to provide code that is clear, understandable, and maintainable. For me, it is mainly\nfor learning and better understanding our services and business domain.\nAnother great thing is pair programming. During these sessions it is easier to understand the business domain and to catch the wider context of our services.\nUnit, integration, and end-to-end testing\nAs I wrote, unreviewed code will not be deployed to production and without tests it is not going to pass the review. At Allegro, each change in code needs\nto be tested. We write unit and integration tests, and we work with two test environments.\nOne is totally a developer’s playground where you make your ‘little Allegro’. It is called phoenix. Every team has its own phoenix env for\nexperiments. However, it has some issues. Since there are so many dependencies to other services, your already set up environment may not work properly until it\nis manually updated. So a very common situation is that before you start testing your change, you need to spend some time to get the whole environment working.\nThis is frustrating, especially in the beginning.\nThe second one is a pre-prod sandbox — it is like normal Allegro, but unlike the dev environment, the sandbox is more consistent and works almost like\nprod. So there are a lot of possibilities to test your change and it’s good to have this feeling of confidence.\nSometimes despite all these tests, code reviews, etc. a mistake happens — the app is already deployed to production, and our clients are complaining.\nWe have to act quickly to fix the error. I really appreciate that we look for bugs, not the guilty party. When somebody makes a mistake, we don’t blame each\nother, but we look for the best solution to the problem and fix it.\nHack the day\nSometimes teams do internal hackathons (called fedex-days) — we divide into two or three teams and we work on subjects that we choose. We want\nto try a new programming language — we just do it; make an application for sharing memes — perfectly fine; write an extension for Slack — why\nnot, go have some fun! Usually, we spend two working days getting off work. That’s very refreshing.\nI also know that once in a while there are hackathons for the whole Allegro — but I didn’t have a chance to participate.\nDobrze tu być?\nAt Allegro we all understand the great importance of ensuring the code we are working on is of the highest quality. We care about our services to the point\nwhere we sometimes spend hours discussing if it is better to throw an exception or just 404?\nHowever, Allegro is not only about programming, it is a place with a lot of experts in many other disciplines — and every one of us has a straightforward\ngoal to make Allegro the best place/platform not only for shoppers and sellers, but also for each other.\nHope you enjoyed this article. I know it sounds like a chorus of praise, but in my situation it arises from my work experiences — for me, it is really a\n“Good to be here!” place. Or as we say #dobrzetubyć.","guid":"https://blog.allegro.tech/2021/02/first-days-at-allegro.html","categories":["tech"],"isoDate":"2021-02-14T23:00:00.000Z","thumbnail":"images/post-headers/default.jpg"}],"jobs":[{"id":"743999745625290","name":"Front-End Software Engineer - Technology Consumer Experience","uuid":"d2fe50f3-c3b4-4226-91b0-fcb5f6c24634","refNumber":"REF2761G","company":{"identifier":"Allegro","name":"Allegro"},"releasedDate":"2021-05-05T08:54:24.000Z","location":{"city":"Warszawa, Poznań, Toruń, Kraków","country":"pl","remote":false},"industry":{"id":"internet","label":"Internet"},"department":{"id":"2216093","label":"Development"},"function":{"id":"information_technology","label":"Information Technology"},"typeOfEmployment":{"label":"Full-time"},"experienceLevel":{"id":"mid_senior_level","label":"Mid-Senior Level"},"customField":[{"fieldId":"58c15608e4b01d4b19ddf790","fieldLabel":"Proces rekrutacji","valueId":"c807eec2-8a53-4b55-b7c5-c03180f2059b","valueLabel":"IT Allegro"},{"fieldId":"58c1575ee4b01d4b19ddf797","fieldLabel":"Kraków","valueId":"2cfcfcc1-da44-43f7-8eaa-3907faf2797c","valueLabel":"Tak"},{"fieldId":"COUNTRY","fieldLabel":"Country","valueId":"pl","valueLabel":"Poland"},{"fieldId":"58c13159e4b01d4b19ddf729","fieldLabel":"Department","valueId":"2216093","valueLabel":"Development"},{"fieldId":"58c158e9e4b0614667d5973e","fieldLabel":"Więcej lokalizacji","valueId":"3a186e8d-a82c-4955-af81-fcef9a63928a","valueLabel":"Tak"},{"fieldId":"58c13159e4b01d4b19ddf728","fieldLabel":"Brands","valueId":"4ccb4fab-6c3f-4ed0-9140-8533fe17447f","valueLabel":"Allegro.pl sp. z o.o."},{"fieldId":"58c156b9e4b01d4b19ddf792","fieldLabel":"Poznań","valueId":"ac20917b-cb6a-4280-aff3-4fae2532a33e","valueLabel":"Tak"},{"fieldId":"58c1576ee4b0614667d59732","fieldLabel":"Toruń","valueId":"987e8884-bad1-4a8f-b149-99e4184cc221","valueLabel":"Tak"},{"fieldId":"58c156e6e4b01d4b19ddf793","fieldLabel":"Warszawa","valueId":"6a428533-1586-4372-89ec-65fb45366363","valueLabel":"Tak"}],"ref":"https://api.smartrecruiters.com/v1/companies/allegro/postings/743999745625290","creator":{"name":"Aleksandra Sotowska"},"language":{"code":"pl","label":"Polish","labelNative":"polski"}},{"id":"743999745621530","name":"Front-End Software Engineer - Merchant Experience","uuid":"62db3a5d-8ff7-4760-8db2-e5f17d4e13c2","refNumber":"REF2762H","company":{"identifier":"Allegro","name":"Allegro"},"releasedDate":"2021-05-05T08:22:54.000Z","location":{"city":"Poznań, Warszawa, Toruń","country":"pl","remote":false},"industry":{"id":"internet","label":"Internet"},"department":{"id":"1013462","label":"Technology - Product Development"},"function":{"id":"information_technology","label":"Information Technology"},"typeOfEmployment":{"label":"Full-time"},"experienceLevel":{"id":"mid_senior_level","label":"Mid-Senior Level"},"customField":[{"fieldId":"58c15608e4b01d4b19ddf790","fieldLabel":"Proces rekrutacji","valueId":"c807eec2-8a53-4b55-b7c5-c03180f2059b","valueLabel":"IT Allegro"},{"fieldId":"COUNTRY","fieldLabel":"Country","valueId":"pl","valueLabel":"Poland"},{"fieldId":"58c15798e4b01d4b19ddf79b","fieldLabel":"Wrocław","valueId":"64818201-cdba-422e-8e8c-8ec633b0d327","valueLabel":"Tak"},{"fieldId":"58c13159e4b01d4b19ddf729","fieldLabel":"Department","valueId":"1013462","valueLabel":"Technology - Product Development"},{"fieldId":"58c158e9e4b0614667d5973e","fieldLabel":"Więcej lokalizacji","valueId":"3a186e8d-a82c-4955-af81-fcef9a63928a","valueLabel":"Tak"},{"fieldId":"58c13159e4b01d4b19ddf728","fieldLabel":"Brands","valueId":"4ccb4fab-6c3f-4ed0-9140-8533fe17447f","valueLabel":"Allegro.pl sp. z o.o."},{"fieldId":"58c156b9e4b01d4b19ddf792","fieldLabel":"Poznań","valueId":"ac20917b-cb6a-4280-aff3-4fae2532a33e","valueLabel":"Tak"},{"fieldId":"58c1576ee4b0614667d59732","fieldLabel":"Toruń","valueId":"987e8884-bad1-4a8f-b149-99e4184cc221","valueLabel":"Tak"},{"fieldId":"58c156e6e4b01d4b19ddf793","fieldLabel":"Warszawa","valueId":"6a428533-1586-4372-89ec-65fb45366363","valueLabel":"Tak"}],"ref":"https://api.smartrecruiters.com/v1/companies/allegro/postings/743999745621530","creator":{"name":"Justyna Kucharska-Minicka"},"language":{"code":"pl","label":"Polish","labelNative":"polski"}},{"id":"743999744914124","name":"Front-End Software Engineer - Marketing & Advertising & Allegro Biznes","uuid":"ff4b4dea-d423-49dc-90eb-e4768e136102","refNumber":"REF2760S","company":{"identifier":"Allegro","name":"Allegro"},"releasedDate":"2021-04-30T15:45:01.000Z","location":{"city":"Kraków, Warszawa","country":"pl","remote":false},"industry":{"id":"internet","label":"Internet"},"department":{"id":"1013462","label":"Technology - Product Development"},"function":{"id":"information_technology","label":"Information Technology"},"typeOfEmployment":{"label":"Full-time"},"experienceLevel":{"id":"mid_senior_level","label":"Mid-Senior Level"},"customField":[{"fieldId":"58c15608e4b01d4b19ddf790","fieldLabel":"Proces rekrutacji","valueId":"c807eec2-8a53-4b55-b7c5-c03180f2059b","valueLabel":"IT Allegro"},{"fieldId":"58c1575ee4b01d4b19ddf797","fieldLabel":"Kraków","valueId":"2cfcfcc1-da44-43f7-8eaa-3907faf2797c","valueLabel":"Tak"},{"fieldId":"COUNTRY","fieldLabel":"Country","valueId":"pl","valueLabel":"Poland"},{"fieldId":"58c13159e4b01d4b19ddf729","fieldLabel":"Department","valueId":"1013462","valueLabel":"Technology - Product Development"},{"fieldId":"58c158e9e4b0614667d5973e","fieldLabel":"Więcej lokalizacji","valueId":"3a186e8d-a82c-4955-af81-fcef9a63928a","valueLabel":"Tak"},{"fieldId":"58c13159e4b01d4b19ddf728","fieldLabel":"Brands","valueId":"4ccb4fab-6c3f-4ed0-9140-8533fe17447f","valueLabel":"Allegro.pl sp. z o.o."},{"fieldId":"58c156e6e4b01d4b19ddf793","fieldLabel":"Warszawa","valueId":"6a428533-1586-4372-89ec-65fb45366363","valueLabel":"Tak"}],"ref":"https://api.smartrecruiters.com/v1/companies/allegro/postings/743999744914124","creator":{"name":"Jagoda Rusiniak"},"language":{"code":"pl","label":"Polish","labelNative":"polski"}},{"id":"743999744911046","name":"Data Scientist - Marketing & Advertising & Allegro Biznes","uuid":"cbb3a1ef-b70d-4982-a70b-e54c356aaf84","refNumber":"REF2775O","company":{"identifier":"Allegro","name":"Allegro"},"releasedDate":"2021-04-30T15:27:07.000Z","location":{"city":"Kraków, Warszawa","country":"pl","remote":false},"industry":{"id":"internet","label":"Internet"},"department":{"id":"1013462","label":"Technology - Product Development"},"function":{"id":"information_technology","label":"Information Technology"},"typeOfEmployment":{"label":"Full-time"},"experienceLevel":{"id":"mid_senior_level","label":"Mid-Senior Level"},"customField":[{"fieldId":"58c15608e4b01d4b19ddf790","fieldLabel":"Proces rekrutacji","valueId":"c807eec2-8a53-4b55-b7c5-c03180f2059b","valueLabel":"IT Allegro"},{"fieldId":"COUNTRY","fieldLabel":"Country","valueId":"pl","valueLabel":"Poland"},{"fieldId":"58c13159e4b01d4b19ddf729","fieldLabel":"Department","valueId":"1013462","valueLabel":"Technology - Product Development"},{"fieldId":"58c13159e4b01d4b19ddf728","fieldLabel":"Brands","valueId":"4ccb4fab-6c3f-4ed0-9140-8533fe17447f","valueLabel":"Allegro.pl sp. z o.o."},{"fieldId":"5cdab2c84cedfd0006e7758c","fieldLabel":"Key words","valueLabel":"python, Hadoop, PySpark, GCP"}],"ref":"https://api.smartrecruiters.com/v1/companies/allegro/postings/743999744911046","creator":{"name":"Jagoda Rusiniak"},"language":{"code":"pl","label":"Polish","labelNative":"polski"}},{"id":"743999744910695","name":"Software Engineer (Big Data team) - Marketing & Advertising & Allegro Biznes","uuid":"c99bb6d3-8abc-4aa0-8a1a-ef910da4a967","refNumber":"REF2774P","company":{"identifier":"Allegro","name":"Allegro"},"releasedDate":"2021-04-30T15:26:08.000Z","location":{"city":"Kraków, Warszawa","country":"pl","remote":false},"industry":{"id":"internet","label":"Internet"},"department":{"id":"1013462","label":"Technology - Product Development"},"function":{"id":"information_technology","label":"Information Technology"},"typeOfEmployment":{"label":"Full-time"},"experienceLevel":{"id":"mid_senior_level","label":"Mid-Senior Level"},"customField":[{"fieldId":"58c15608e4b01d4b19ddf790","fieldLabel":"Proces rekrutacji","valueId":"c807eec2-8a53-4b55-b7c5-c03180f2059b","valueLabel":"IT Allegro"},{"fieldId":"COUNTRY","fieldLabel":"Country","valueId":"pl","valueLabel":"Poland"},{"fieldId":"58c13159e4b01d4b19ddf729","fieldLabel":"Department","valueId":"1013462","valueLabel":"Technology - Product Development"},{"fieldId":"58c13159e4b01d4b19ddf728","fieldLabel":"Brands","valueId":"4ccb4fab-6c3f-4ed0-9140-8533fe17447f","valueLabel":"Allegro.pl sp. z o.o."},{"fieldId":"5cdab2c84cedfd0006e7758c","fieldLabel":"Key words","valueLabel":"Java, Kotlin, Groovy, Scala, Python, Spring, Reactive Programming, Spark, Hadoop, Mesos, TensorFlow"}],"ref":"https://api.smartrecruiters.com/v1/companies/allegro/postings/743999744910695","creator":{"name":"Jagoda Rusiniak"},"language":{"code":"pl","label":"Polish","labelNative":"polski"}}],"events":[{"created":1619620661000,"duration":5400000,"id":"277852879","name":"Allegro Tech Live #18 PM w Allegro, jak do nas dołączyć i czerpać radość z pracy","date_in_series_pattern":false,"status":"upcoming","time":1620921600000,"local_date":"2021-05-13","local_time":"18:00","updated":1619620661000,"utc_offset":7200000,"waitlist_count":0,"yes_rsvp_count":28,"venue":{"id":26906060,"name":"Online event","repinned":false,"country":"","localized_country_name":""},"is_online_event":true,"group":{"created":1425052059000,"name":"allegro Tech","id":18465254,"join_mode":"open","lat":52.2599983215332,"lon":21.020000457763672,"urlname":"allegrotech","who":"Techs","localized_location":"Warsaw, Poland","state":"","country":"pl","region":"en_US","timezone":"Europe/Warsaw"},"link":"https://www.meetup.com/allegrotech/events/277852879/","description":"Allegro Tech Live to w 100% zdalna odsłona naszych stacjonarnych meetupów Allegro Tech Talks. Zazwyczaj spotykaliśmy się w naszych biurach, ale tym razem to my…","how_to_find_us":"https://www.youtube.com/channel/UC66wC6RBjFk6CuVz7wdjJ5g","visibility":"public","member_pay_fee":false},{"created":1618821709000,"duration":7200000,"id":"277660388","name":"Allegro Tech Labs #8 Online: Praktyczne prognozowanie w Allegro ","date_in_series_pattern":false,"status":"upcoming","time":1620316800000,"local_date":"2021-05-06","local_time":"18:00","updated":1618821709000,"utc_offset":7200000,"waitlist_count":0,"yes_rsvp_count":43,"venue":{"id":26906060,"name":"Online event","repinned":false,"country":"","localized_country_name":""},"is_online_event":true,"group":{"created":1425052059000,"name":"allegro Tech","id":18465254,"join_mode":"open","lat":52.2599983215332,"lon":21.020000457763672,"urlname":"allegrotech","who":"Techs","localized_location":"Warsaw, Poland","state":"","country":"pl","region":"en_US","timezone":"Europe/Warsaw"},"link":"https://www.meetup.com/allegrotech/events/277660388/","description":"***REJESTRACJA***Ze względu na ograniczoną liczbę miejsc, prosimy o rejestrację na wydarzenie poprzez stronę: https://app.evenea.pl/event/allegro-tech-labs-8/Wybierając przycisk \"Chcę wziąć udział w warsztatach\" przeniesiesz się na formularz rejestracyjny…","visibility":"public","member_pay_fee":false},{"created":1617359547000,"duration":9000000,"id":"277320825","name":"Allegro Tech Live #17 - iOS pod maską","date_in_series_pattern":false,"status":"past","time":1618502400000,"local_date":"2021-04-15","local_time":"18:00","updated":1618516317000,"utc_offset":7200000,"waitlist_count":0,"yes_rsvp_count":61,"venue":{"id":26906060,"name":"Online event","repinned":false,"country":"","localized_country_name":""},"is_online_event":true,"group":{"created":1425052059000,"name":"allegro Tech","id":18465254,"join_mode":"open","lat":52.2599983215332,"lon":21.020000457763672,"urlname":"allegrotech","who":"Techs","localized_location":"Warsaw, Poland","state":"","country":"pl","region":"en_US","timezone":"Europe/Warsaw"},"link":"https://www.meetup.com/allegrotech/events/277320825/","description":"Allegro Tech Live to w 100% zdalna odsłona naszych stacjonarnych meetupów Allegro Tech Talks. Zazwyczaj spotykaliśmy się w naszych biurach, ale tym razem to my…","how_to_find_us":"https://youtu.be/Ra5T7MbUXW0","visibility":"public","member_pay_fee":false},{"created":1616053977000,"duration":7200000,"id":"277005370","name":"Allegro Tech Labs #7 Online: System design workshop","rsvp_limit":60,"date_in_series_pattern":false,"status":"past","time":1617811200000,"local_date":"2021-04-07","local_time":"18:00","updated":1617822969000,"utc_offset":7200000,"waitlist_count":0,"yes_rsvp_count":60,"venue":{"id":26906060,"name":"Online event","repinned":false,"country":"","localized_country_name":""},"is_online_event":true,"group":{"created":1425052059000,"name":"allegro Tech","id":18465254,"join_mode":"open","lat":52.2599983215332,"lon":21.020000457763672,"urlname":"allegrotech","who":"Techs","localized_location":"Warsaw, Poland","state":"","country":"pl","region":"en_US","timezone":"Europe/Warsaw"},"link":"https://www.meetup.com/allegrotech/events/277005370/","description":"***REJESTRACJA***Prosimy o rejestrację na wydarzenie poprzez stronę: https://app.evenea.pl/event/allegro-tech-labs-7/. Po kliknięciu przycisku \"Chcę wziąć udział w warsztatach\" przeniesiesz się na formularz rejestracyjny - prosimy o udzielenie…","visibility":"public","member_pay_fee":false}],"podcasts":[{"creator":{"name":["Michał Bareja"]},"title":"Inżynier w zespole produktowym","link":"https://podcast.allegro.tech/inzynier_w_zespole_produktowym","pubDate":"Thu, 22 Apr 2021 00:00:00 GMT","author":{"name":["Michał Bareja"]},"enclosure":{"url":"https://www.buzzsprout.com/887914/8371888.mp3","type":"audio/mpeg"},"content":"Czym zajmuje się Team Leader w Allegro? Jak wygląda cykl życia oprogramowania w zespole produktowym? Jaka jest rola inżyniera oprogramowania w rozwoju produktu? W jaki sposób wykorzystujemy w Allegro Event Storming? Jakich technologii używają programiści w zespołach produktowych? Między innymi o tym opowie Michał Bareja, Team Manager w Allegro, w rozmowie z Piotrem Betkierem.","contentSnippet":"Czym zajmuje się Team Leader w Allegro? Jak wygląda cykl życia oprogramowania w zespole produktowym? Jaka jest rola inżyniera oprogramowania w rozwoju produktu? W jaki sposób wykorzystujemy w Allegro Event Storming? Jakich technologii używają programiści w zespołach produktowych? Między innymi o tym opowie Michał Bareja, Team Manager w Allegro, w rozmowie z Piotrem Betkierem.","guid":"https://podcast.allegro.tech/inzynier_w_zespole_produktowym","isoDate":"2021-04-22T00:00:00.000Z","itunes":{"author":"Michał Bareja","summary":"Czym zajmuje się Team Leader w Allegro? Jak wygląda cykl życia oprogramowania w zespole produktowym? Jaka jest rola inżyniera oprogramowania w rozwoju produktu? W jaki sposób wykorzystujemy w Allegro Event Storming? Jakich technologii używają programiści w zespołach produktowych? Między innymi o tym opowie Michał Bareja, Team Manager w Allegro, w rozmowie z Piotrem Betkierem.","explicit":"false"}},{"creator":{"name":["Julia Bluszcz"]},"title":"Data Scientist w Allegro","link":"https://podcast.allegro.tech/data_scientist_w_allegro","pubDate":"Fri, 16 Apr 2021 00:00:00 GMT","author":{"name":["Julia Bluszcz"]},"enclosure":{"url":"https://www.buzzsprout.com/887914/8333231.mp3","type":"audio/mpeg"},"content":"Czym zajmuje się Data Scientist? Jak wygląda proces budowania modeli danych? Jak klasyczne i bayesowskie metody statystyczne pozwalają nam odpowiedzieć na pytanie “dlaczego”? Czym różni się korelacja od kauzacji i jak estymować efekty różnego rodzaju zmian, nawet gdy nie możemy przeprowadzić testów AB? Odpowiedzi na te pytania znajdziecie w najnowszym podcascie, którego gościem jest Julia Bluszcz.","contentSnippet":"Czym zajmuje się Data Scientist? Jak wygląda proces budowania modeli danych? Jak klasyczne i bayesowskie metody statystyczne pozwalają nam odpowiedzieć na pytanie “dlaczego”? Czym różni się korelacja od kauzacji i jak estymować efekty różnego rodzaju zmian, nawet gdy nie możemy przeprowadzić testów AB? Odpowiedzi na te pytania znajdziecie w najnowszym podcascie, którego gościem jest Julia Bluszcz.","guid":"https://podcast.allegro.tech/data_scientist_w_allegro","isoDate":"2021-04-16T00:00:00.000Z","itunes":{"author":"Julia Bluszcz","summary":"Czym zajmuje się Data Scientist? Jak wygląda proces budowania modeli danych? Jak klasyczne i bayesowskie metody statystyczne pozwalają nam odpowiedzieć na pytanie “dlaczego”? Czym różni się korelacja od kauzacji i jak estymować efekty różnego rodzaju zmian, nawet gdy nie możemy przeprowadzić testów AB? Odpowiedzi na te pytania znajdziecie w najnowszym podcascie, którego gościem jest Julia Bluszcz.","explicit":"false"}},{"creator":{"name":["Aleksandra Wasielewska"]},"title":"Świat Product Managera w Allegro","link":"https://podcast.allegro.tech/swiat_product_managera_w_allegro","pubDate":"Thu, 08 Apr 2021 00:00:00 GMT","author":{"name":["Aleksandra Wasielewska"]},"enclosure":{"url":"https://www.buzzsprout.com/887914/8163682.mp3","type":"audio/mpeg"},"content":"Jak tworzy się produkty dla milionów kupujących? Jak wygląda warsztat i ekosystem Product Managera w Allegro? Jak zaskakujące jest Allegro od środka? Jak mądrze wykorzystywać dane w pracy Product Managera? I jak w Allegro jeśli się chce, to można realizować się nie tylko jako pracownik, ale człowiek? Nie tylko to, ale też wiele wiele więcej w rozmowie z Piotrkiem, odkryje przed Wami Ola Wasielewska - Senior Product Manager w Allegro.","contentSnippet":"Jak tworzy się produkty dla milionów kupujących? Jak wygląda warsztat i ekosystem Product Managera w Allegro? Jak zaskakujące jest Allegro od środka? Jak mądrze wykorzystywać dane w pracy Product Managera? I jak w Allegro jeśli się chce, to można realizować się nie tylko jako pracownik, ale człowiek? Nie tylko to, ale też wiele wiele więcej w rozmowie z Piotrkiem, odkryje przed Wami Ola Wasielewska - Senior Product Manager w Allegro.","guid":"https://podcast.allegro.tech/swiat_product_managera_w_allegro","isoDate":"2021-04-08T00:00:00.000Z","itunes":{"author":"Aleksandra Wasielewska","summary":"Jak tworzy się produkty dla milionów kupujących? Jak wygląda warsztat i ekosystem Product Managera w Allegro? Jak zaskakujące jest Allegro od środka? Jak mądrze wykorzystywać dane w pracy Product Managera? I jak w Allegro jeśli się chce, to można realizować się nie tylko jako pracownik, ale człowiek? Nie tylko to, ale też wiele wiele więcej w rozmowie z Piotrkiem, odkryje przed Wami Ola Wasielewska - Senior Product Manager w Allegro.","explicit":"false"}},{"creator":{"name":["Jakub Kaczmarski"]},"title":"Logistyka na platformie Allegro","link":"https://podcast.allegro.tech/logistyka_na_platformie_allegro","pubDate":"Thu, 25 Mar 2021 00:00:00 GMT","author":{"name":["Jakub Kaczmarski"]},"enclosure":{"url":"https://www.buzzsprout.com/887914/8163669.mp3","type":"audio/mpeg"},"content":"Jak zarządzać zespołem ponad 100 osób? Jak rozwijać motywację, pasję i potencjał swoich pracowników? Na co zwracać uwagę? Jakie inspiracje można czerpać ze sportu w zarządzaniu? Jak zorganizować swoją pracę? O tym opowie Jakub Kaczmarski - Technology Director odpowiadając za obszar Delivery Experience i Allegro Smart! na platformie Allegro.","contentSnippet":"Jak zarządzać zespołem ponad 100 osób? Jak rozwijać motywację, pasję i potencjał swoich pracowników? Na co zwracać uwagę? Jakie inspiracje można czerpać ze sportu w zarządzaniu? Jak zorganizować swoją pracę? O tym opowie Jakub Kaczmarski - Technology Director odpowiadając za obszar Delivery Experience i Allegro Smart! na platformie Allegro.","guid":"https://podcast.allegro.tech/logistyka_na_platformie_allegro","isoDate":"2021-03-25T00:00:00.000Z","itunes":{"author":"Jakub Kaczmarski","summary":"Jak zarządzać zespołem ponad 100 osób? Jak rozwijać motywację, pasję i potencjał swoich pracowników? Na co zwracać uwagę? Jakie inspiracje można czerpać ze sportu w zarządzaniu? Jak zorganizować swoją pracę? O tym opowie Jakub Kaczmarski - Technology Director odpowiadając za obszar Delivery Experience i Allegro Smart! na platformie Allegro.","explicit":"false"}}]},"__N_SSG":true}