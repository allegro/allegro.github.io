<!DOCTYPE html><html lang="pl"><head><meta charSet="utf-8"/><link rel="prefetch" href="https://allegrotechio.disqus.com/count.js"/><meta name="viewport" content="initial-scale=1.0, width=device-width"/><meta name="description" content="Allegro Tech to miejsce, w którym nasi inżynierowie dzielą się wiedzą oraz case study z wybranych projektów w firmie - w formie artykułów, podcastów oraz eventów."/><title>Allegro Tech</title><meta property="og:site_name" content="allegro.tech"/><meta property="og:title" content="allegro.tech"/><meta property="og:url" content="https://allegro.tech"/><meta property="og:type" content="site"/><meta property="og:image" content="https://allegro.tech/images/allegro-tech.png"/><link rel="shortcut icon" href="favicon.ico"/><link rel="canonical" href="https://allegro.tech" itemProp="url"/><link rel="preload" href="images/splash.jpg" as="image"/><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-1M1FJ5PXWW"></script><script>
                    window.dataLayer = window.dataLayer || [];
                    function gtag(){dataLayer.push(arguments);}
                    gtag('js', new Date());
                    gtag('config', 'G-1M1FJ5PXWW');
                </script><meta name="next-head-count" content="15"/><link rel="preload" href="/_next/static/css/b2014360ddad0b69a0c7.css" as="style"/><link rel="stylesheet" href="/_next/static/css/b2014360ddad0b69a0c7.css" data-n-g=""/><link rel="preload" href="/_next/static/css/fd05cb88ad2ed1acd080.css" as="style"/><link rel="stylesheet" href="/_next/static/css/fd05cb88ad2ed1acd080.css" data-n-p=""/><noscript data-n-css=""></noscript><link rel="preload" href="/_next/static/chunks/main-23f4f2620a057c84f895.js" as="script"/><link rel="preload" href="/_next/static/chunks/webpack-50bee04d1dc61f8adf5b.js" as="script"/><link rel="preload" href="/_next/static/chunks/framework.b1290caeda235fc7bf40.js" as="script"/><link rel="preload" href="/_next/static/chunks/b651a894a35ea1e7d121ee74b6c7e8aa31faf049.71d68ec00d361c7548dd.js" as="script"/><link rel="preload" href="/_next/static/chunks/6753331a3a54fd35bc7d92cbaee2b67e833d028a.8bec33551a885abbb7ba.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/_app-3ea8ca3d27590bc99614.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/index-7303186a0aecc18782b4.js" as="script"/></head><body><div id="__next"><header class="m-padding-top_16 m-padding-top_24_lg m-padding-right_16 m-padding-right_24_lg m-padding-bottom_16 m-padding-bottom_24_lg m-padding-left_16 m-padding-left_24_lg m-card Header_navbar__2vWRp m-color-bg_card"><nav class="m-width-max_1600 m-margin-left_auto m-margin-right_auto m-display-flex m-flex-justify-between m-flex-items-center"><a href="/"><img src="images/logo.svg" alt="Allegro Tech" width="205" height="45"/></a><div><ul class="m-font-family_sans m-font-size_14 m-line-height_21 m-color_text m-text-size-adjust_100p m-list-style-type_none m-margin-top_0 m-margin-right_0 m-margin-bottom_0 m-margin-left_0 m-padding-top_0 m-padding-right_0 m-padding-bottom_0 m-padding-left_0 m-display-flex@lg m-display-none"><li class="m-margin-left-16@lg"><a class="m-font-size_14 m-font-family_sans m-color_text m-text-decoration_none m-text-size-adjust_100p m-cursor_pointer m-link m-display-block m-display-inline@lg m-padding-left-16 m-padding-right-16 m-padding-top-16 m-padding-bottom-16 m-padding-left-0@lg m-padding-top-0@lg m-padding-right-0@lg m-padding-bottom-0@lg m-link--signal m-line-height_21" href="https://blog.allegro.tech">Blog</a></li><li class="m-margin-left-16@lg"><a class="m-font-size_14 m-font-family_sans m-color_text m-text-decoration_none m-text-size-adjust_100p m-cursor_pointer m-link m-display-block m-display-inline@lg m-padding-left-16 m-padding-right-16 m-padding-top-16 m-padding-bottom-16 m-padding-left-0@lg m-padding-top-0@lg m-padding-right-0@lg m-padding-bottom-0@lg m-link--signal m-line-height_21" href="https://podcast.allegro.tech">Podcast</a></li><li class="m-margin-left-16@lg"><a class="m-font-size_14 m-font-family_sans m-color_text m-text-decoration_none m-text-size-adjust_100p m-cursor_pointer m-link m-display-block m-display-inline@lg m-padding-left-16 m-padding-right-16 m-padding-top-16 m-padding-bottom-16 m-padding-left-0@lg m-padding-top-0@lg m-padding-right-0@lg m-padding-bottom-0@lg m-link--signal m-line-height_21" href="https://github.com/Allegro">Open Source</a></li><li class="m-margin-left-16@lg"><a class="m-font-size_14 m-font-family_sans m-color_text m-text-decoration_none m-text-size-adjust_100p m-cursor_pointer m-link m-display-block m-display-inline@lg m-padding-left-16 m-padding-right-16 m-padding-top-16 m-padding-bottom-16 m-padding-left-0@lg m-padding-top-0@lg m-padding-right-0@lg m-padding-bottom-0@lg m-link--signal m-line-height_21" href="https://www.meetup.com/allegrotech/events">Wydarzenia</a></li><li class="m-margin-left-16@lg"><a class="m-font-size_14 m-font-family_sans m-color_text m-text-decoration_none m-text-size-adjust_100p m-cursor_pointer m-link m-display-block m-display-inline@lg m-padding-left-16 m-padding-right-16 m-padding-top-16 m-padding-bottom-16 m-padding-left-0@lg m-padding-top-0@lg m-padding-right-0@lg m-padding-bottom-0@lg m-link--signal m-line-height_21" href="https://praca.allegro.pl">Praca</a></li></ul><button class="m-display-none@lg m-height_40 m-line-height_40 m-border-style-top_none m-border-style-right_none m-border-style-bottom_none m-border-style-left_none m-border-radius-top-left_2 m-border-radius-top-right_2 m-border-radius-bottom-left_2 m-border-radius-bottom-right_2 m-cursor_pointer m-overflow_hidden m-appearance_none m-padding-left_4 m-padding-right_4 m-padding-top_4 m-padding-bottom_4 m-outline-style_dotted--focus m-outline-width_2 m-outline-color_teal m-outline-offset_n2 m-button" style="background:transparent" aria-label="Otwórz menu"><img src="https://assets.allegrostatic.com/metrum/icon/menu-23e046bf68.svg" alt="" class="m-icon" width="32" height="32"/></button></div></nav></header><div class="Header_hero__n5PN5"><div class="m-width-max_1600 m-margin-left_auto m-margin-right_auto m-display-flex m-flex-column m-flex-justify-end Header_image__15JNc"><div class="m-padding-top_16 m-padding-top_24_lg m-padding-right_16 m-padding-right_24_lg m-padding-bottom_16 m-padding-bottom_24_lg m-padding-left_16 m-padding-left_24_lg m-card m-color-bg_desk"><h2 class="m-font-family_roboto m-margin-left_0 m-margin-right_0 m-margin-top_0 m-color_text  m-font-weight_100 m-font-size_32 m-font-size_43_sm m-margin-bottom_16 m-margin-bottom_24_sm m-line-height_125">O nas</h2><p class="m-font-family_sans m-line-height_21 m-font-size_14 m-text-size-adjust_100p m-margin-top_0 m-margin-right_0 m-margin-bottom_0 m-margin-left_0 m-color_text">Allegro to jedna z najbardziej zaawansowanych technologicznie firm w naszej części Europy. Allegro to również ponad 1000 specjalistów IT, różnych specjalizacji, rozwijających nasz serwis. Unikatowa skala i złożoność problemów, które rozwiązujemy na co dzień, dają nam możliwość rozwoju przy bardzo różnorodnych projektach. Allegro Tech to miejsce, w którym nasi inżynierowie dzielą się wiedzą oraz case study z wybranych projektów w firmie – w formie artykułów, podcastów oraz eventów.</p></div></div></div><div class="m-width-max_1600 m-margin-left_auto m-margin-right_auto m-padding-top-24"><h2 class="m-font-family_roboto m-margin-left_0 m-margin-right_0 m-margin-top_0 m-color_text m-font-weight_300 m-font-size_27 m-font-size_36_sm m-margin-bottom_16 m-margin-bottom_24_sm m-line-height_125 m-padding-left-24 m-padding-right-24">Blog</h2><div class="m-display_flex m-flex-wrap_1 m-flex-grow_1 m-grid"><div class="m-grid__col m-grid__col--12 m-grid__col--6@sm m-grid__col--3@xl m-display-flex m-flex-direction_column"><article class="m-margin-bottom_16 m-display-flex m-flex-column m-flex-grow_1"><a href="https://blog.allegro.tech/2021/03/state-machines-made-easy.html" title="Finite-state machines made easy"><img width="388" src="images/post-headers/default.jpg" alt="Finite-state machines made easy" class="m-display-block m-width-fluid"/></a><div class="m-padding-top_16 m-padding-top_24_lg m-padding-right_16 m-padding-right_24_lg m-padding-left_16 m-padding-left_24_lg m-card m-display-flex m-flex-column m-flex-grow_1 m-padding-bottom-0 m-color-bg_card"><a href="https://blog.allegro.tech/2021/03/state-machines-made-easy.html" title="Finite-state machines made easy" class="m-text-decoration_none"><h2 class="m-font-family_roboto m-margin-left_0 m-margin-right_0 m-margin-top_0 m-color_text m-font-weight_500 m-line-height_130 m-margin-bottom_8 m-margin-bottom_16_sm m-font-size_21 m-font-size_25_sm" style="text-overflow:ellipsis;display:-webkit-box;-webkit-box-orient:vertical;-webkit-line-clamp:2;min-height:2em;overflow:hidden">Finite-state machines made easy</h2></a><time class="m-font-family_sans m-line-height_21 m-font-size_14 m-text-size-adjust_100p m-margin-top_0 m-margin-right_0 m-margin-bottom_0 m-margin-left_0 m-color_text m-padding-bottom-16">16 dni temu</time><ul class="m-font-family_sans m-font-size_14 m-line-height_21 m-color_text m-text-size-adjust_100p m-list-style-type_none m-margin-top_0 m-margin-right_0 m-margin-bottom_0 m-margin-left_0 m-padding-top_0 m-padding-right_0 m-padding-bottom_0 m-padding-left_0"><li class="m-margin-right-8 m-display-inline-block"><a class="m-font-size_14 m-font-family_sans m-color_text m-text-decoration_none m-text-size-adjust_100p m-cursor_pointer m-link m-line-height_21" href="https://twitter.com/hashtag/tech">#<!-- -->tech</a></li><li class="m-margin-right-8 m-display-inline-block"><a class="m-font-size_14 m-font-family_sans m-color_text m-text-decoration_none m-text-size-adjust_100p m-cursor_pointer m-link m-line-height_21" href="https://twitter.com/hashtag/dotnet">#<!-- -->dotnet</a></li><li class="m-margin-right-8 m-display-inline-block"><a class="m-font-size_14 m-font-family_sans m-color_text m-text-decoration_none m-text-size-adjust_100p m-cursor_pointer m-link m-line-height_21" href="https://twitter.com/hashtag/state_machine">#<!-- -->state_machine</a></li><li class="m-margin-right-8 m-display-inline-block"><a class="m-font-size_14 m-font-family_sans m-color_text m-text-decoration_none m-text-size-adjust_100p m-cursor_pointer m-link m-line-height_21" href="https://twitter.com/hashtag/allegro_pay">#<!-- -->allegro_pay</a></li></ul><p class="m-font-family_sans m-line-height_21 m-font-size_14 m-text-size-adjust_100p m-margin-top_0 m-margin-right_0 m-margin-bottom_0 m-margin-left_0 m-color_text m-flex-grow-1 m-padding-top-16">Coordinating complex processes, both business and technical, can be a challenging issue in a distributed system.
Especially when the complications associated with them, such as concurrency,…</p><div class="m-display-flex m-flex-justify-between m-padding-top-16 m-flex-items_center"><div class="m-display-flex m-flex-items_center"><div class="MuiAvatarGroup-root m-padding-right_16 Post_avatars__1CeVw"><div class="MuiAvatar-root MuiAvatar-circle MuiAvatarGroup-avatar" style="z-index:1"><img alt="Tymon Felski" src="https://blog.allegro.tech/img/authors/tymon.felski.jpg" class="MuiAvatar-img" width="32" height="32"/></div></div><a class="m-font-size_14 m-font-family_sans m-color_text m-text-decoration_none m-text-size-adjust_100p m-cursor_pointer m-link m-line-height_21" href="https://blog.allegro.tech/authors/tymon.felski">Tymon Felski</a></div><a class="m-font-size_14 m-font-family_sans m-color_text m-text-decoration_none m-text-size-adjust_100p m-cursor_pointer m-link m-line-height_21" href="https://blog.allegro.tech/2021/03/state-machines-made-easy.html#disqus_thread">0 Comments</a></div><a class="m-font-size_14 m-font-family_sans m-color_text m-text-decoration_none m-text-size-adjust_100p m-cursor_pointer m-link m-margin-top-16 m-display_block m-border-width_1 m-border-color_gray m-border-style-top_solid m-height_40 m-line-height_40 m-text-transform_uppercase m-letter-spacing_2 m-white-space_nowrap m-cursor_pointer m-overflow_hidden m-padding-left_16 m-padding-right_16 m-padding-top_0 m-padding-bottom_0 m-outline-style_dotted--focus m-outline-width_2 m-outline-color_teal m-outline-offset_n2 m-button m-box_border m-text-align_center m-display_inline-block m-color_secondary m-background-position_50p m-background-size_5000p m-transition-property_background-color m-transition-duration_fast m-button--secondary" href="https://blog.allegro.tech/2021/03/state-machines-made-easy.html">przejdź do wpisu</a></div></article></div><div class="m-grid__col m-grid__col--12 m-grid__col--6@sm m-grid__col--3@xl m-display-flex m-flex-direction_column"><article class="m-margin-bottom_16 m-display-flex m-flex-column m-flex-grow_1"><a href="https://blog.allegro.tech/2021/02/first-days-at-allegro.html" title="My first days at Allegro"><img width="388" src="images/post-headers/default.jpg" alt="My first days at Allegro" class="m-display-block m-width-fluid"/></a><div class="m-padding-top_16 m-padding-top_24_lg m-padding-right_16 m-padding-right_24_lg m-padding-left_16 m-padding-left_24_lg m-card m-display-flex m-flex-column m-flex-grow_1 m-padding-bottom-0 m-color-bg_card"><a href="https://blog.allegro.tech/2021/02/first-days-at-allegro.html" title="My first days at Allegro" class="m-text-decoration_none"><h2 class="m-font-family_roboto m-margin-left_0 m-margin-right_0 m-margin-top_0 m-color_text m-font-weight_500 m-line-height_130 m-margin-bottom_8 m-margin-bottom_16_sm m-font-size_21 m-font-size_25_sm" style="text-overflow:ellipsis;display:-webkit-box;-webkit-box-orient:vertical;-webkit-line-clamp:2;min-height:2em;overflow:hidden">My first days at Allegro</h2></a><time class="m-font-family_sans m-line-height_21 m-font-size_14 m-text-size-adjust_100p m-margin-top_0 m-margin-right_0 m-margin-bottom_0 m-margin-left_0 m-color_text m-padding-bottom-16">około miesiąc temu</time><ul class="m-font-family_sans m-font-size_14 m-line-height_21 m-color_text m-text-size-adjust_100p m-list-style-type_none m-margin-top_0 m-margin-right_0 m-margin-bottom_0 m-margin-left_0 m-padding-top_0 m-padding-right_0 m-padding-bottom_0 m-padding-left_0"><li class="m-margin-right-8 m-display-inline-block"><a class="m-font-size_14 m-font-family_sans m-color_text m-text-decoration_none m-text-size-adjust_100p m-cursor_pointer m-link m-line-height_21" href="https://twitter.com/hashtag/tech">#<!-- -->tech</a></li></ul><p class="m-font-family_sans m-line-height_21 m-font-size_14 m-text-size-adjust_100p m-margin-top_0 m-margin-right_0 m-margin-bottom_0 m-margin-left_0 m-color_text m-flex-grow-1 m-padding-top-16">So you’re new to Allegro, have just finished your tech onboarding and are stunned with information overflow? Or perhaps you
are planning to join Allegro and…</p><div class="m-display-flex m-flex-justify-between m-padding-top-16 m-flex-items_center"><div class="m-display-flex m-flex-items_center"><div class="MuiAvatarGroup-root m-padding-right_16 Post_avatars__1CeVw"><div class="MuiAvatar-root MuiAvatar-circle MuiAvatarGroup-avatar" style="z-index:1"><img alt="Krzysztof Przychodzki" src="https://blog.allegro.tech/img/authors/krzysztof.przychodzki.jpg" class="MuiAvatar-img" width="32" height="32"/></div></div><a class="m-font-size_14 m-font-family_sans m-color_text m-text-decoration_none m-text-size-adjust_100p m-cursor_pointer m-link m-line-height_21" href="https://blog.allegro.tech/authors/krzysztof.przychodzki">Krzysztof Przychodzki</a></div><a class="m-font-size_14 m-font-family_sans m-color_text m-text-decoration_none m-text-size-adjust_100p m-cursor_pointer m-link m-line-height_21" href="https://blog.allegro.tech/2021/02/first-days-at-allegro.html#disqus_thread">0 Comments</a></div><a class="m-font-size_14 m-font-family_sans m-color_text m-text-decoration_none m-text-size-adjust_100p m-cursor_pointer m-link m-margin-top-16 m-display_block m-border-width_1 m-border-color_gray m-border-style-top_solid m-height_40 m-line-height_40 m-text-transform_uppercase m-letter-spacing_2 m-white-space_nowrap m-cursor_pointer m-overflow_hidden m-padding-left_16 m-padding-right_16 m-padding-top_0 m-padding-bottom_0 m-outline-style_dotted--focus m-outline-width_2 m-outline-color_teal m-outline-offset_n2 m-button m-box_border m-text-align_center m-display_inline-block m-color_secondary m-background-position_50p m-background-size_5000p m-transition-property_background-color m-transition-duration_fast m-button--secondary" href="https://blog.allegro.tech/2021/02/first-days-at-allegro.html">przejdź do wpisu</a></div></article></div><div class="m-grid__col m-grid__col--12 m-grid__col--6@sm m-grid__col--3@xl m-display-flex m-flex-direction_column"><article class="m-margin-bottom_16 m-display-flex m-flex-column m-flex-grow_1"><a href="https://blog.allegro.tech/2021/02/oauth-stateless-login.html" title="Implement stateless authentication like a pro using OAuth: A 100% correct approach"><img width="388" src="images/post-headers/default.jpg" alt="Implement stateless authentication like a pro using OAuth: A 100% correct approach" class="m-display-block m-width-fluid"/></a><div class="m-padding-top_16 m-padding-top_24_lg m-padding-right_16 m-padding-right_24_lg m-padding-left_16 m-padding-left_24_lg m-card m-display-flex m-flex-column m-flex-grow_1 m-padding-bottom-0 m-color-bg_card"><a href="https://blog.allegro.tech/2021/02/oauth-stateless-login.html" title="Implement stateless authentication like a pro using OAuth: A 100% correct approach" class="m-text-decoration_none"><h2 class="m-font-family_roboto m-margin-left_0 m-margin-right_0 m-margin-top_0 m-color_text m-font-weight_500 m-line-height_130 m-margin-bottom_8 m-margin-bottom_16_sm m-font-size_21 m-font-size_25_sm" style="text-overflow:ellipsis;display:-webkit-box;-webkit-box-orient:vertical;-webkit-line-clamp:2;min-height:2em;overflow:hidden">Implement stateless authentication like a pro using OAuth: A 100% correct approach</h2></a><time class="m-font-family_sans m-line-height_21 m-font-size_14 m-text-size-adjust_100p m-margin-top_0 m-margin-right_0 m-margin-bottom_0 m-margin-left_0 m-color_text m-padding-bottom-16">około 2 miesiące temu</time><ul class="m-font-family_sans m-font-size_14 m-line-height_21 m-color_text m-text-size-adjust_100p m-list-style-type_none m-margin-top_0 m-margin-right_0 m-margin-bottom_0 m-margin-left_0 m-padding-top_0 m-padding-right_0 m-padding-bottom_0 m-padding-left_0"><li class="m-margin-right-8 m-display-inline-block"><a class="m-font-size_14 m-font-family_sans m-color_text m-text-decoration_none m-text-size-adjust_100p m-cursor_pointer m-link m-line-height_21" href="https://twitter.com/hashtag/tech">#<!-- -->tech</a></li><li class="m-margin-right-8 m-display-inline-block"><a class="m-font-size_14 m-font-family_sans m-color_text m-text-decoration_none m-text-size-adjust_100p m-cursor_pointer m-link m-line-height_21" href="https://twitter.com/hashtag/security">#<!-- -->security</a></li><li class="m-margin-right-8 m-display-inline-block"><a class="m-font-size_14 m-font-family_sans m-color_text m-text-decoration_none m-text-size-adjust_100p m-cursor_pointer m-link m-line-height_21" href="https://twitter.com/hashtag/oauth">#<!-- -->oauth</a></li><li class="m-margin-right-8 m-display-inline-block"><a class="m-font-size_14 m-font-family_sans m-color_text m-text-decoration_none m-text-size-adjust_100p m-cursor_pointer m-link m-line-height_21" href="https://twitter.com/hashtag/authentication">#<!-- -->authentication</a></li><li class="m-margin-right-8 m-display-inline-block"><a class="m-font-size_14 m-font-family_sans m-color_text m-text-decoration_none m-text-size-adjust_100p m-cursor_pointer m-link m-line-height_21" href="https://twitter.com/hashtag/authorization">#<!-- -->authorization</a></li><li class="m-margin-right-8 m-display-inline-block"><a class="m-font-size_14 m-font-family_sans m-color_text m-text-decoration_none m-text-size-adjust_100p m-cursor_pointer m-link m-line-height_21" href="https://twitter.com/hashtag/jwt">#<!-- -->jwt</a></li><li class="m-margin-right-8 m-display-inline-block"><a class="m-font-size_14 m-font-family_sans m-color_text m-text-decoration_none m-text-size-adjust_100p m-cursor_pointer m-link m-line-height_21" href="https://twitter.com/hashtag/openid-connect">#<!-- -->openid-connect</a></li></ul><p class="m-font-family_sans m-line-height_21 m-font-size_14 m-text-size-adjust_100p m-margin-top_0 m-margin-right_0 m-margin-bottom_0 m-margin-left_0 m-color_text m-flex-grow-1 m-padding-top-16">Many of us spend most of their software development careers improving and extending applications protected by pre-existing security mechanisms. That’s why
we rarely address problems related…</p><div class="m-display-flex m-flex-justify-between m-padding-top-16 m-flex-items_center"><div class="m-display-flex m-flex-items_center"><div class="MuiAvatarGroup-root m-padding-right_16 Post_avatars__1CeVw"><div class="MuiAvatar-root MuiAvatar-circle MuiAvatarGroup-avatar" style="z-index:1"><img alt="Karol Kuc" src="https://blog.allegro.tech/img/authors/karol.kuc.jpg" class="MuiAvatar-img" width="32" height="32"/></div></div><a class="m-font-size_14 m-font-family_sans m-color_text m-text-decoration_none m-text-size-adjust_100p m-cursor_pointer m-link m-line-height_21" href="https://blog.allegro.tech/authors/karol.kuc">Karol Kuc</a></div><a class="m-font-size_14 m-font-family_sans m-color_text m-text-decoration_none m-text-size-adjust_100p m-cursor_pointer m-link m-line-height_21" href="https://blog.allegro.tech/2021/02/oauth-stateless-login.html#disqus_thread">0 Comments</a></div><a class="m-font-size_14 m-font-family_sans m-color_text m-text-decoration_none m-text-size-adjust_100p m-cursor_pointer m-link m-margin-top-16 m-display_block m-border-width_1 m-border-color_gray m-border-style-top_solid m-height_40 m-line-height_40 m-text-transform_uppercase m-letter-spacing_2 m-white-space_nowrap m-cursor_pointer m-overflow_hidden m-padding-left_16 m-padding-right_16 m-padding-top_0 m-padding-bottom_0 m-outline-style_dotted--focus m-outline-width_2 m-outline-color_teal m-outline-offset_n2 m-button m-box_border m-text-align_center m-display_inline-block m-color_secondary m-background-position_50p m-background-size_5000p m-transition-property_background-color m-transition-duration_fast m-button--secondary" href="https://blog.allegro.tech/2021/02/oauth-stateless-login.html">przejdź do wpisu</a></div></article></div><div class="m-grid__col m-grid__col--12 m-grid__col--6@sm m-grid__col--3@xl m-display-flex m-flex-direction_column"><article class="m-margin-bottom_16 m-display-flex m-flex-column m-flex-grow_1"><a href="https://blog.allegro.tech/2021/01/impact-of-the-data-model-on-the-MongoDB-database-size.html" title="Impact of data model on MongoDB database size"><img width="388" src="images/post-headers/mongodb.png" alt="Impact of data model on MongoDB database size" class="m-display-block m-width-fluid"/></a><div class="m-padding-top_16 m-padding-top_24_lg m-padding-right_16 m-padding-right_24_lg m-padding-left_16 m-padding-left_24_lg m-card m-display-flex m-flex-column m-flex-grow_1 m-padding-bottom-0 m-color-bg_card"><a href="https://blog.allegro.tech/2021/01/impact-of-the-data-model-on-the-MongoDB-database-size.html" title="Impact of data model on MongoDB database size" class="m-text-decoration_none"><h2 class="m-font-family_roboto m-margin-left_0 m-margin-right_0 m-margin-top_0 m-color_text m-font-weight_500 m-line-height_130 m-margin-bottom_8 m-margin-bottom_16_sm m-font-size_21 m-font-size_25_sm" style="text-overflow:ellipsis;display:-webkit-box;-webkit-box-orient:vertical;-webkit-line-clamp:2;min-height:2em;overflow:hidden">Impact of data model on MongoDB database size</h2></a><time class="m-font-family_sans m-line-height_21 m-font-size_14 m-text-size-adjust_100p m-margin-top_0 m-margin-right_0 m-margin-bottom_0 m-margin-left_0 m-color_text m-padding-bottom-16">2 miesiące temu</time><ul class="m-font-family_sans m-font-size_14 m-line-height_21 m-color_text m-text-size-adjust_100p m-list-style-type_none m-margin-top_0 m-margin-right_0 m-margin-bottom_0 m-margin-left_0 m-padding-top_0 m-padding-right_0 m-padding-bottom_0 m-padding-left_0"><li class="m-margin-right-8 m-display-inline-block"><a class="m-font-size_14 m-font-family_sans m-color_text m-text-decoration_none m-text-size-adjust_100p m-cursor_pointer m-link m-line-height_21" href="https://twitter.com/hashtag/mongodb">#<!-- -->mongodb</a></li></ul><p class="m-font-family_sans m-line-height_21 m-font-size_14 m-text-size-adjust_100p m-margin-top_0 m-margin-right_0 m-margin-bottom_0 m-margin-left_0 m-color_text m-flex-grow-1 m-padding-top-16">So I was tuning one of our services in order to speed up some MongoDB queries. Incidentally, my attention was caught by
the size of one…</p><div class="m-display-flex m-flex-justify-between m-padding-top-16 m-flex-items_center"><div class="m-display-flex m-flex-items_center"><div class="MuiAvatarGroup-root m-padding-right_16 Post_avatars__1CeVw"><div class="MuiAvatar-root MuiAvatar-circle MuiAvatarGroup-avatar" style="z-index:1"><img alt="Michał Knasiecki" src="https://blog.allegro.tech/img/authors/michal.knasiecki.jpg" class="MuiAvatar-img" width="32" height="32"/></div></div><a class="m-font-size_14 m-font-family_sans m-color_text m-text-decoration_none m-text-size-adjust_100p m-cursor_pointer m-link m-line-height_21" href="https://blog.allegro.tech/authors/michal.knasiecki">Michał Knasiecki</a></div><a class="m-font-size_14 m-font-family_sans m-color_text m-text-decoration_none m-text-size-adjust_100p m-cursor_pointer m-link m-line-height_21" href="https://blog.allegro.tech/2021/01/impact-of-the-data-model-on-the-MongoDB-database-size.html#disqus_thread">0 Comments</a></div><a class="m-font-size_14 m-font-family_sans m-color_text m-text-decoration_none m-text-size-adjust_100p m-cursor_pointer m-link m-margin-top-16 m-display_block m-border-width_1 m-border-color_gray m-border-style-top_solid m-height_40 m-line-height_40 m-text-transform_uppercase m-letter-spacing_2 m-white-space_nowrap m-cursor_pointer m-overflow_hidden m-padding-left_16 m-padding-right_16 m-padding-top_0 m-padding-bottom_0 m-outline-style_dotted--focus m-outline-width_2 m-outline-color_teal m-outline-offset_n2 m-button m-box_border m-text-align_center m-display_inline-block m-color_secondary m-background-position_50p m-background-size_5000p m-transition-property_background-color m-transition-duration_fast m-button--secondary" href="https://blog.allegro.tech/2021/01/impact-of-the-data-model-on-the-MongoDB-database-size.html">przejdź do wpisu</a></div></article></div></div><a class="m-font-size_14 m-font-family_sans m-color_text m-text-decoration_none m-text-size-adjust_100p m-cursor_pointer m-link m-display_block m-margin-bottom_8 m-width_100 m-height_40 m-line-height_40 m-text-transform_uppercase m-letter-spacing_2 m-white-space_nowrap m-cursor_pointer m-overflow_hidden m-padding-left_16 m-padding-right_16 m-padding-top_0 m-padding-bottom_0 m-outline-style_dotted--focus m-outline-width_2 m-outline-color_teal m-outline-offset_n2 m-button m-box_border m-text-align_center m-display_inline-block m-color_secondary m-background-position_50p m-background-size_5000p m-transition-property_background-color m-transition-duration_fast m-button--secondary" href="https://blog.allegro.tech">Zobacz więcej wpisów</a></div><div class="m-width-max_1600 m-margin-left_auto m-margin-right_auto m-padding-top-24"><h2 class="m-font-family_roboto m-margin-left_0 m-margin-right_0 m-margin-top_0 m-color_text m-font-weight_300 m-font-size_27 m-font-size_36_sm m-margin-bottom_16 m-margin-bottom_24_sm m-line-height_125 m-padding-left-24 m-padding-right-24">Podcasty</h2><div class="m-display_flex m-flex-wrap_1 m-flex-grow_1 m-grid"><div class="m-grid__col m-grid__col--12 m-grid__col--6@sm m-grid__col--3@xl m-display-flex m-flex-direction_column"><article class="m-margin-bottom_16 m-display-flex m-flex-column m-flex-grow_1"><a href="https://podcast.allegro.tech/summer_e_xperience_w_allegro" title="Summer e-Xperience w Allegro"><img src="images/podcast.png" alt="Summer e-Xperience w Allegro" class="m-display-block m-width-fluid"/></a><div class="m-padding-top_16 m-padding-top_24_lg m-padding-right_16 m-padding-right_24_lg m-padding-left_16 m-padding-left_24_lg m-card m-display-flex m-flex-column m-flex-grow_1 m-padding-bottom-0 m-color-bg_card"><a href="https://podcast.allegro.tech/summer_e_xperience_w_allegro" title="Summer e-Xperience w Allegro" class="m-text-decoration_none"><h2 class="m-font-family_roboto m-margin-left_0 m-margin-right_0 m-margin-top_0 m-color_text m-font-weight_500 m-line-height_130 m-margin-bottom_8 m-margin-bottom_16_sm m-font-size_21 m-font-size_25_sm" style="text-overflow:ellipsis;display:-webkit-box;-webkit-box-orient:vertical;-webkit-line-clamp:2;min-height:2em;overflow:hidden">Summer e-Xperience w Allegro</h2></a><time class="m-font-family_sans m-line-height_21 m-font-size_14 m-text-size-adjust_100p m-margin-top_0 m-margin-right_0 m-margin-bottom_0 m-margin-left_0 m-color_text m-padding-bottom-16">3 dni temu</time><p class="m-font-family_sans m-line-height_21 m-font-size_14 m-text-size-adjust_100p m-margin-top_0 m-margin-right_0 m-margin-bottom_0 m-margin-left_0 m-color_text m-flex-grow-1">Jak wygląda program Summer e-Xperience w obszarze technologii? Czego można nauczyć się podczas programu jako Software Engineer? Dlaczego #dobrzetubyć najlepiej oddaje ideę programu? Komu polecamy nasz letni program i co radzimy? Na te pytania odpowie Alicja Halamska - Junior Software Engineer w Allegro, która w 2020 roku dołączyła do programu Summer e-Xperience.</p><a class="m-font-size_14 m-font-family_sans m-color_text m-text-decoration_none m-text-size-adjust_100p m-cursor_pointer m-link m-margin-top-16 m-display_block m-border-width_1 m-border-color_gray m-border-style-top_solid m-height_40 m-line-height_40 m-text-transform_uppercase m-letter-spacing_2 m-white-space_nowrap m-cursor_pointer m-overflow_hidden m-padding-left_16 m-padding-right_16 m-padding-top_0 m-padding-bottom_0 m-outline-style_dotted--focus m-outline-width_2 m-outline-color_teal m-outline-offset_n2 m-button m-box_border m-text-align_center m-display_inline-block m-color_secondary m-background-position_50p m-background-size_5000p m-transition-property_background-color m-transition-duration_fast m-button--secondary" href="https://podcast.allegro.tech/summer_e_xperience_w_allegro">Posłuchaj odcinka</a></div></article></div><div class="m-grid__col m-grid__col--12 m-grid__col--6@sm m-grid__col--3@xl m-display-flex m-flex-direction_column"><article class="m-margin-bottom_16 m-display-flex m-flex-column m-flex-grow_1"><a href="https://podcast.allegro.tech/sre_w_allegro" title="SRE w Allegro"><img src="images/podcast.png" alt="SRE w Allegro" class="m-display-block m-width-fluid"/></a><div class="m-padding-top_16 m-padding-top_24_lg m-padding-right_16 m-padding-right_24_lg m-padding-left_16 m-padding-left_24_lg m-card m-display-flex m-flex-column m-flex-grow_1 m-padding-bottom-0 m-color-bg_card"><a href="https://podcast.allegro.tech/sre_w_allegro" title="SRE w Allegro" class="m-text-decoration_none"><h2 class="m-font-family_roboto m-margin-left_0 m-margin-right_0 m-margin-top_0 m-color_text m-font-weight_500 m-line-height_130 m-margin-bottom_8 m-margin-bottom_16_sm m-font-size_21 m-font-size_25_sm" style="text-overflow:ellipsis;display:-webkit-box;-webkit-box-orient:vertical;-webkit-line-clamp:2;min-height:2em;overflow:hidden">SRE w Allegro</h2></a><time class="m-font-family_sans m-line-height_21 m-font-size_14 m-text-size-adjust_100p m-margin-top_0 m-margin-right_0 m-margin-bottom_0 m-margin-left_0 m-color_text m-padding-bottom-16">17 dni temu</time><p class="m-font-family_sans m-line-height_21 m-font-size_14 m-text-size-adjust_100p m-margin-top_0 m-margin-right_0 m-margin-bottom_0 m-margin-left_0 m-color_text m-flex-grow-1">Jak w Allegro radzimy sobie z awariami? Jak im zapobiegać oraz dlaczego sami je wywołujemy? Czy szalonym jest składanie całego Data Center? Czym jest SRE w Allegro i dlaczego jest unikatowe? Na te wszystkie pytania odpowie Piotr Klapczyński - Team Leader w Allegro.</p><a class="m-font-size_14 m-font-family_sans m-color_text m-text-decoration_none m-text-size-adjust_100p m-cursor_pointer m-link m-margin-top-16 m-display_block m-border-width_1 m-border-color_gray m-border-style-top_solid m-height_40 m-line-height_40 m-text-transform_uppercase m-letter-spacing_2 m-white-space_nowrap m-cursor_pointer m-overflow_hidden m-padding-left_16 m-padding-right_16 m-padding-top_0 m-padding-bottom_0 m-outline-style_dotted--focus m-outline-width_2 m-outline-color_teal m-outline-offset_n2 m-button m-box_border m-text-align_center m-display_inline-block m-color_secondary m-background-position_50p m-background-size_5000p m-transition-property_background-color m-transition-duration_fast m-button--secondary" href="https://podcast.allegro.tech/sre_w_allegro">Posłuchaj odcinka</a></div></article></div><div class="m-grid__col m-grid__col--12 m-grid__col--6@sm m-grid__col--3@xl m-display-flex m-flex-direction_column"><article class="m-margin-bottom_16 m-display-flex m-flex-column m-flex-grow_1"><a href="https://podcast.allegro.tech/service_mesh_oraz_praca_programisty_w_allegro" title="Service Mesh oraz praca programisty w Allegro"><img src="images/podcast.png" alt="Service Mesh oraz praca programisty w Allegro" class="m-display-block m-width-fluid"/></a><div class="m-padding-top_16 m-padding-top_24_lg m-padding-right_16 m-padding-right_24_lg m-padding-left_16 m-padding-left_24_lg m-card m-display-flex m-flex-column m-flex-grow_1 m-padding-bottom-0 m-color-bg_card"><a href="https://podcast.allegro.tech/service_mesh_oraz_praca_programisty_w_allegro" title="Service Mesh oraz praca programisty w Allegro" class="m-text-decoration_none"><h2 class="m-font-family_roboto m-margin-left_0 m-margin-right_0 m-margin-top_0 m-color_text m-font-weight_500 m-line-height_130 m-margin-bottom_8 m-margin-bottom_16_sm m-font-size_21 m-font-size_25_sm" style="text-overflow:ellipsis;display:-webkit-box;-webkit-box-orient:vertical;-webkit-line-clamp:2;min-height:2em;overflow:hidden">Service Mesh oraz praca programisty w Allegro</h2></a><time class="m-font-family_sans m-line-height_21 m-font-size_14 m-text-size-adjust_100p m-margin-top_0 m-margin-right_0 m-margin-bottom_0 m-margin-left_0 m-color_text m-padding-bottom-16">24 dni temu</time><p class="m-font-family_sans m-line-height_21 m-font-size_14 m-text-size-adjust_100p m-margin-top_0 m-margin-right_0 m-margin-bottom_0 m-margin-left_0 m-color_text m-flex-grow-1">Czym jest Service Mesh? Jak został wdrożony do Allegro dla ponad 1000 usług na produkcji? Dlaczego usprawnianie pracy programistom jest dla nas ważne i dlaczego programista to klient? Jak wytwarzamy produkty używane przez zespoły deweloperskie? Kim jest Principal w Allegro? Jak może wyglądać ścieżka kariery programisty? Na te pytania odpowie Dariusz Jędrzejczyk - Principal Software Engineer.</p><a class="m-font-size_14 m-font-family_sans m-color_text m-text-decoration_none m-text-size-adjust_100p m-cursor_pointer m-link m-margin-top-16 m-display_block m-border-width_1 m-border-color_gray m-border-style-top_solid m-height_40 m-line-height_40 m-text-transform_uppercase m-letter-spacing_2 m-white-space_nowrap m-cursor_pointer m-overflow_hidden m-padding-left_16 m-padding-right_16 m-padding-top_0 m-padding-bottom_0 m-outline-style_dotted--focus m-outline-width_2 m-outline-color_teal m-outline-offset_n2 m-button m-box_border m-text-align_center m-display_inline-block m-color_secondary m-background-position_50p m-background-size_5000p m-transition-property_background-color m-transition-duration_fast m-button--secondary" href="https://podcast.allegro.tech/service_mesh_oraz_praca_programisty_w_allegro">Posłuchaj odcinka</a></div></article></div><div class="m-grid__col m-grid__col--12 m-grid__col--6@sm m-grid__col--3@xl m-display-flex m-flex-direction_column"><article class="m-margin-bottom_16 m-display-flex m-flex-column m-flex-grow_1"><a href="https://podcast.allegro.tech/zbiory_danych_w_allegro" title="Zbiory danych w Allegro"><img src="images/podcast.png" alt="Zbiory danych w Allegro" class="m-display-block m-width-fluid"/></a><div class="m-padding-top_16 m-padding-top_24_lg m-padding-right_16 m-padding-right_24_lg m-padding-left_16 m-padding-left_24_lg m-card m-display-flex m-flex-column m-flex-grow_1 m-padding-bottom-0 m-color-bg_card"><a href="https://podcast.allegro.tech/zbiory_danych_w_allegro" title="Zbiory danych w Allegro" class="m-text-decoration_none"><h2 class="m-font-family_roboto m-margin-left_0 m-margin-right_0 m-margin-top_0 m-color_text m-font-weight_500 m-line-height_130 m-margin-bottom_8 m-margin-bottom_16_sm m-font-size_21 m-font-size_25_sm" style="text-overflow:ellipsis;display:-webkit-box;-webkit-box-orient:vertical;-webkit-line-clamp:2;min-height:2em;overflow:hidden">Zbiory danych w Allegro</h2></a><time class="m-font-family_sans m-line-height_21 m-font-size_14 m-text-size-adjust_100p m-margin-top_0 m-margin-right_0 m-margin-bottom_0 m-margin-left_0 m-color_text m-padding-bottom-16">około miesiąc temu</time><p class="m-font-family_sans m-line-height_21 m-font-size_14 m-text-size-adjust_100p m-margin-top_0 m-margin-right_0 m-margin-bottom_0 m-margin-left_0 m-color_text m-flex-grow-1">Czym zajmuje się inżynier danych? Jak powstało Big Data? Jak wykorzystuje się oraz kto korzysta z nowych zbiorów danych? Czym różni się Data Scientist od Data Engineera? Jak połączyć przetwarzanie streamingowe z przetwarzaniem batchowym? Z jakich narzędzi korzysta Data Engineer? Na te pytania odpowie Łukasz Ściga - Data Engineer w Allegro, którego pasją jest programowanie gier komputerowych.</p><a class="m-font-size_14 m-font-family_sans m-color_text m-text-decoration_none m-text-size-adjust_100p m-cursor_pointer m-link m-margin-top-16 m-display_block m-border-width_1 m-border-color_gray m-border-style-top_solid m-height_40 m-line-height_40 m-text-transform_uppercase m-letter-spacing_2 m-white-space_nowrap m-cursor_pointer m-overflow_hidden m-padding-left_16 m-padding-right_16 m-padding-top_0 m-padding-bottom_0 m-outline-style_dotted--focus m-outline-width_2 m-outline-color_teal m-outline-offset_n2 m-button m-box_border m-text-align_center m-display_inline-block m-color_secondary m-background-position_50p m-background-size_5000p m-transition-property_background-color m-transition-duration_fast m-button--secondary" href="https://podcast.allegro.tech/zbiory_danych_w_allegro">Posłuchaj odcinka</a></div></article></div></div><a class="m-font-size_14 m-font-family_sans m-color_text m-text-decoration_none m-text-size-adjust_100p m-cursor_pointer m-link m-display_block m-margin-bottom_8 m-width_100 m-height_40 m-line-height_40 m-text-transform_uppercase m-letter-spacing_2 m-white-space_nowrap m-cursor_pointer m-overflow_hidden m-padding-left_16 m-padding-right_16 m-padding-top_0 m-padding-bottom_0 m-outline-style_dotted--focus m-outline-width_2 m-outline-color_teal m-outline-offset_n2 m-button m-box_border m-text-align_center m-display_inline-block m-color_secondary m-background-position_50p m-background-size_5000p m-transition-property_background-color m-transition-duration_fast m-button--secondary" href="https://podcast.allegro.tech">Zobacz więcej podcastów</a></div><div class="m-width-max_1600 m-margin-left_auto m-margin-right_auto m-padding-top-24"><h2 class="m-font-family_roboto m-margin-left_0 m-margin-right_0 m-margin-top_0 m-color_text m-font-weight_300 m-font-size_27 m-font-size_36_sm m-margin-bottom_16 m-margin-bottom_24_sm m-line-height_125 m-padding-left-24 m-padding-right-24">Wydarzenia</h2><div class="m-display_flex m-flex-wrap_1 m-flex-grow_1 m-grid"><div class="m-grid__col m-grid__col--12 m-grid__col--6@sm m-grid__col--6@xl m-display-flex m-flex-direction_column"><div class="m-margin-bottom_16 m-display-flex m-flex-direction_column m-flex-direction_row_sm m-padding-bottom_0"><a href="https://www.meetup.com/allegrotech/events/277005370/" title="Allegro Tech Labs #7 Online: System design workshop" class="m-display_none m-display_block_lg" style="background-color:#fd4a02"><img width="218" src="images/event.png" alt="Allegro Tech Labs #7 Online: System design workshop"/></a><article class="m-padding-top_16 m-padding-top_24_lg m-padding-right_16 m-padding-right_24_lg m-padding-left_16 m-padding-left_24_lg m-card m-display-flex m-flex-direction_column m-padding-bottom_0 m-flex_1 m-flex-justify_between m-color-bg_card"><a href="https://www.meetup.com/allegrotech/events/277005370/" title="Allegro Tech Labs #7 Online: System design workshop" class="m-text-decoration_none"><h2 class="m-font-family_roboto m-margin-left_0 m-margin-right_0 m-margin-top_0 m-color_text m-font-weight_500 m-line-height_130 m-margin-bottom_8 m-margin-bottom_16_sm m-font-size_21 m-font-size_25_sm" style="text-overflow:ellipsis;display:-webkit-box;-webkit-box-orient:vertical;-webkit-line-clamp:2;min-height:2em;overflow:hidden">Allegro Tech Labs #7 Online: System design workshop</h2></a><time class="m-font-family_sans m-line-height_21 m-font-size_14 m-text-size-adjust_100p m-margin-top_0 m-margin-right_0 m-margin-bottom_0 m-margin-left_0 m-color_text">za 18 dni<!-- -->, <!-- -->Online event</time><time class="m-font-family_sans m-line-height_21 m-font-size_14 m-text-size-adjust_100p m-margin-top_0 m-margin-right_0 m-margin-bottom_0 m-margin-left_0 m-color_text m-padding-top-8">***REJESTRACJA***Ze względu na duże zainteresowanie wydarzeniem oraz ograniczoną liczbę miejsc, zdecydowaliśmy się zmienić zasady rejestracji na warsztaty. Prosimy o rejestrację poprzez stronę: https://app.evenea.pl/event/allegro-tech-labs-7/. Po kliknięciu…</time><a class="m-font-size_14 m-font-family_sans m-color_text m-text-decoration_none m-text-size-adjust_100p m-cursor_pointer m-link m-margin-top-16 m-display_block m-border-width_1 m-border-color_gray m-border-style-top_solid m-height_40 m-line-height_40 m-text-transform_uppercase m-letter-spacing_2 m-white-space_nowrap m-cursor_pointer m-overflow_hidden m-padding-left_16 m-padding-right_16 m-padding-top_0 m-padding-bottom_0 m-outline-style_dotted--focus m-outline-width_2 m-outline-color_teal m-outline-offset_n2 m-button m-box_border m-text-align_center m-display_inline-block m-color_secondary m-background-position_50p m-background-size_5000p m-transition-property_background-color m-transition-duration_fast m-button--secondary" href="https://www.meetup.com/allegrotech/events/277005370/">Szczegóły</a></article></div></div><div class="m-grid__col m-grid__col--12 m-grid__col--6@sm m-grid__col--6@xl m-display-flex m-flex-direction_column"><div class="m-margin-bottom_16 m-display-flex m-flex-direction_column m-flex-direction_row_sm m-padding-bottom_0"><a href="https://www.meetup.com/allegrotech/events/276893259/" title="#16 Allegro Tech Live - Jak dostać się do Allegro?" class="m-display_none m-display_block_lg" style="background-color:#fd4a02"><img width="218" src="images/event.png" alt="#16 Allegro Tech Live - Jak dostać się do Allegro?"/></a><article class="m-padding-top_16 m-padding-top_24_lg m-padding-right_16 m-padding-right_24_lg m-padding-left_16 m-padding-left_24_lg m-card m-display-flex m-flex-direction_column m-padding-bottom_0 m-flex_1 m-flex-justify_between m-color-bg_card"><a href="https://www.meetup.com/allegrotech/events/276893259/" title="#16 Allegro Tech Live - Jak dostać się do Allegro?" class="m-text-decoration_none"><h2 class="m-font-family_roboto m-margin-left_0 m-margin-right_0 m-margin-top_0 m-color_text m-font-weight_500 m-line-height_130 m-margin-bottom_8 m-margin-bottom_16_sm m-font-size_21 m-font-size_25_sm" style="text-overflow:ellipsis;display:-webkit-box;-webkit-box-orient:vertical;-webkit-line-clamp:2;min-height:2em;overflow:hidden">#16 Allegro Tech Live - Jak dostać się do Allegro?</h2></a><time class="m-font-family_sans m-line-height_21 m-font-size_14 m-text-size-adjust_100p m-margin-top_0 m-margin-right_0 m-margin-bottom_0 m-margin-left_0 m-color_text">za 12 dni<!-- -->, <!-- -->Online event</time><time class="m-font-family_sans m-line-height_21 m-font-size_14 m-text-size-adjust_100p m-margin-top_0 m-margin-right_0 m-margin-bottom_0 m-margin-left_0 m-color_text m-padding-top-8">Allegro Tech Live to w 100% zdalna odsłona naszych stacjonarnych meetupów Allegro Tech Talks. Zazwyczaj spotykaliśmy się w naszych biurach, ale tym razem to my…</time><a class="m-font-size_14 m-font-family_sans m-color_text m-text-decoration_none m-text-size-adjust_100p m-cursor_pointer m-link m-margin-top-16 m-display_block m-border-width_1 m-border-color_gray m-border-style-top_solid m-height_40 m-line-height_40 m-text-transform_uppercase m-letter-spacing_2 m-white-space_nowrap m-cursor_pointer m-overflow_hidden m-padding-left_16 m-padding-right_16 m-padding-top_0 m-padding-bottom_0 m-outline-style_dotted--focus m-outline-width_2 m-outline-color_teal m-outline-offset_n2 m-button m-box_border m-text-align_center m-display_inline-block m-color_secondary m-background-position_50p m-background-size_5000p m-transition-property_background-color m-transition-duration_fast m-button--secondary" href="https://www.meetup.com/allegrotech/events/276893259/">Szczegóły</a></article></div></div><div class="m-grid__col m-grid__col--12 m-grid__col--6@sm m-grid__col--6@xl m-display-flex m-flex-direction_column"><div class="m-margin-bottom_16 m-display-flex m-flex-direction_column m-flex-direction_row_sm m-padding-bottom_0"><a href="https://www.meetup.com/allegrotech/events/276687714/" title="#15 Allegro Tech Live - Jak technicznie dbać o produkt?" class="m-display_none m-display_block_lg" style="background-color:#fd4a02"><img width="218" src="images/event.png" alt="#15 Allegro Tech Live - Jak technicznie dbać o produkt?"/></a><article class="m-padding-top_16 m-padding-top_24_lg m-padding-right_16 m-padding-right_24_lg m-padding-left_16 m-padding-left_24_lg m-card m-display-flex m-flex-direction_column m-padding-bottom_0 m-flex_1 m-flex-justify_between m-color-bg_card"><a href="https://www.meetup.com/allegrotech/events/276687714/" title="#15 Allegro Tech Live - Jak technicznie dbać o produkt?" class="m-text-decoration_none"><h2 class="m-font-family_roboto m-margin-left_0 m-margin-right_0 m-margin-top_0 m-color_text m-font-weight_500 m-line-height_130 m-margin-bottom_8 m-margin-bottom_16_sm m-font-size_21 m-font-size_25_sm" style="text-overflow:ellipsis;display:-webkit-box;-webkit-box-orient:vertical;-webkit-line-clamp:2;min-height:2em;overflow:hidden">#15 Allegro Tech Live - Jak technicznie dbać o produkt?</h2></a><time class="m-font-family_sans m-line-height_21 m-font-size_14 m-text-size-adjust_100p m-margin-top_0 m-margin-right_0 m-margin-bottom_0 m-margin-left_0 m-color_text">2 dni temu<!-- -->, <!-- -->Online event</time><time class="m-font-family_sans m-line-height_21 m-font-size_14 m-text-size-adjust_100p m-margin-top_0 m-margin-right_0 m-margin-bottom_0 m-margin-left_0 m-color_text m-padding-top-8">Allegro Tech Live to nowa, w 100% zdalna odsłona naszych stacjonarnych meetupów Allegro Tech Talks. Zazwyczaj spotykaliśmy się w naszych biurach, ale tym razem to…</time><a class="m-font-size_14 m-font-family_sans m-color_text m-text-decoration_none m-text-size-adjust_100p m-cursor_pointer m-link m-margin-top-16 m-display_block m-border-width_1 m-border-color_gray m-border-style-top_solid m-height_40 m-line-height_40 m-text-transform_uppercase m-letter-spacing_2 m-white-space_nowrap m-cursor_pointer m-overflow_hidden m-padding-left_16 m-padding-right_16 m-padding-top_0 m-padding-bottom_0 m-outline-style_dotted--focus m-outline-width_2 m-outline-color_teal m-outline-offset_n2 m-button m-box_border m-text-align_center m-display_inline-block m-color_secondary m-background-position_50p m-background-size_5000p m-transition-property_background-color m-transition-duration_fast m-button--secondary" href="https://www.meetup.com/allegrotech/events/276687714/">Szczegóły</a></article></div></div><div class="m-grid__col m-grid__col--12 m-grid__col--6@sm m-grid__col--6@xl m-display-flex m-flex-direction_column"><div class="m-margin-bottom_16 m-display-flex m-flex-direction_column m-flex-direction_row_sm m-padding-bottom_0"><a href="https://www.meetup.com/allegrotech/events/276458683/" title="Allegro Tech Labs #6 Online: Poznać Reacta - poziom podstawowy" class="m-display_none m-display_block_lg" style="background-color:#fd4a02"><img width="218" src="images/event.png" alt="Allegro Tech Labs #6 Online: Poznać Reacta - poziom podstawowy"/></a><article class="m-padding-top_16 m-padding-top_24_lg m-padding-right_16 m-padding-right_24_lg m-padding-left_16 m-padding-left_24_lg m-card m-display-flex m-flex-direction_column m-padding-bottom_0 m-flex_1 m-flex-justify_between m-color-bg_card"><a href="https://www.meetup.com/allegrotech/events/276458683/" title="Allegro Tech Labs #6 Online: Poznać Reacta - poziom podstawowy" class="m-text-decoration_none"><h2 class="m-font-family_roboto m-margin-left_0 m-margin-right_0 m-margin-top_0 m-color_text m-font-weight_500 m-line-height_130 m-margin-bottom_8 m-margin-bottom_16_sm m-font-size_21 m-font-size_25_sm" style="text-overflow:ellipsis;display:-webkit-box;-webkit-box-orient:vertical;-webkit-line-clamp:2;min-height:2em;overflow:hidden">Allegro Tech Labs #6 Online: Poznać Reacta - poziom podstawowy</h2></a><time class="m-font-family_sans m-line-height_21 m-font-size_14 m-text-size-adjust_100p m-margin-top_0 m-margin-right_0 m-margin-bottom_0 m-margin-left_0 m-color_text">10 dni temu<!-- -->, <!-- -->Online event</time><time class="m-font-family_sans m-line-height_21 m-font-size_14 m-text-size-adjust_100p m-margin-top_0 m-margin-right_0 m-margin-bottom_0 m-margin-left_0 m-color_text m-padding-top-8">***REJESTRACJA***Prosimy o rejestrację poprzez https://app.evenea.pl/event/allegro-tech-labs-6/ Po zarejestrowaniu otrzymasz e-mail z potwierdzeniem rejestracji, Twoim biletem oraz linkiem do warsztatów online. ***SZCZEGÓŁY***Allegro Tech Labs #6 to idealna…</time><a class="m-font-size_14 m-font-family_sans m-color_text m-text-decoration_none m-text-size-adjust_100p m-cursor_pointer m-link m-margin-top-16 m-display_block m-border-width_1 m-border-color_gray m-border-style-top_solid m-height_40 m-line-height_40 m-text-transform_uppercase m-letter-spacing_2 m-white-space_nowrap m-cursor_pointer m-overflow_hidden m-padding-left_16 m-padding-right_16 m-padding-top_0 m-padding-bottom_0 m-outline-style_dotted--focus m-outline-width_2 m-outline-color_teal m-outline-offset_n2 m-button m-box_border m-text-align_center m-display_inline-block m-color_secondary m-background-position_50p m-background-size_5000p m-transition-property_background-color m-transition-duration_fast m-button--secondary" href="https://www.meetup.com/allegrotech/events/276458683/">Szczegóły</a></article></div></div></div><a class="m-font-size_14 m-font-family_sans m-color_text m-text-decoration_none m-text-size-adjust_100p m-cursor_pointer m-link m-display_block m-margin-bottom_8 m-width_100 m-height_40 m-line-height_40 m-text-transform_uppercase m-letter-spacing_2 m-white-space_nowrap m-cursor_pointer m-overflow_hidden m-padding-left_16 m-padding-right_16 m-padding-top_0 m-padding-bottom_0 m-outline-style_dotted--focus m-outline-width_2 m-outline-color_teal m-outline-offset_n2 m-button m-box_border m-text-align_center m-display_inline-block m-color_secondary m-background-position_50p m-background-size_5000p m-transition-property_background-color m-transition-duration_fast m-button--secondary" href="https://www.meetup.com/allegrotech/events/">Zobacz więcej wydarzeń</a></div><div class="m-width-max_1600 m-margin-left_auto m-margin-right_auto m-padding-top-24"><h2 class="m-font-family_roboto m-margin-left_0 m-margin-right_0 m-margin-top_0 m-color_text m-font-weight_300 m-font-size_27 m-font-size_36_sm m-margin-bottom_16 m-margin-bottom_24_sm m-line-height_125 m-padding-left-24 m-padding-right-24">Oferty pracy</h2><div class="m-width-max_1600 m-margin-left_auto m-margin-right_auto"><article class="m-padding-top_16 m-padding-top_24_lg m-padding-right_16 m-padding-right_24_lg m-padding-bottom_16 m-padding-bottom_24_lg m-padding-left_16 m-padding-left_24_lg m-card m-margin-bottom_16 m-display-flex m-flex-justify_between m-flex-items-center m-flex-direction_column m-flex-direction_row_md m-color-bg_card"><h2 class="m-font-family_roboto m-margin-left_0 m-margin-right_0 m-margin-top_0 m-color_text m-font-weight_500 m-line-height_130 m-margin-bottom_8 m-margin-bottom_16_sm m-font-size_21 m-font-size_25_sm m-margin-bottom_0_sm m-flex-grow_1">Team Leader (Java/Kotlin) - Delivery Experience</h2><p class="m-font-family_sans m-line-height_21 m-font-size_14 m-text-size-adjust_100p m-margin-top_0 m-margin-right_0 m-margin-bottom_0 m-margin-left_0 m-color_text m-margin-right_0 m-margin-bottom_0 m-margin-left_0 m-color_text m-font-size_21 m-font-size_25_sm m-font-weight_300 m-line-height_normal m-margin-top_16 m-text-align_left m-padding-right_16">Warszawa</p><a class="m-font-size_14 m-font-family_sans m-color_text m-text-decoration_none m-text-size-adjust_100p m-cursor_pointer m-link m-height_40 m-line-height_40 m-text-transform_uppercase m-letter-spacing_2 m-white-space_nowrap m-cursor_pointer m-overflow_hidden m-padding-left_16 m-padding-right_16 m-padding-top_0 m-padding-bottom_0 m-outline-style_dotted--focus m-outline-width_2 m-outline-color_teal m-outline-offset_n2 m-button m-box_border m-text-align_center m-display_inline-block m-color_secondary m-background-position_50p m-background-size_5000p m-transition-property_background-color m-transition-duration_fast m-button--secondary" href="https://www.smartrecruiters.com/Allegro/743999739442143-team-leader-javakotlin-delivery-experience?trid=de9dfdf3-7f9e-4ebf-8a64-49f6c69ad640">Sprawdź</a></article><article class="m-padding-top_16 m-padding-top_24_lg m-padding-right_16 m-padding-right_24_lg m-padding-bottom_16 m-padding-bottom_24_lg m-padding-left_16 m-padding-left_24_lg m-card m-margin-bottom_16 m-display-flex m-flex-justify_between m-flex-items-center m-flex-direction_column m-flex-direction_row_md m-color-bg_card"><h2 class="m-font-family_roboto m-margin-left_0 m-margin-right_0 m-margin-top_0 m-color_text m-font-weight_500 m-line-height_130 m-margin-bottom_8 m-margin-bottom_16_sm m-font-size_21 m-font-size_25_sm m-margin-bottom_0_sm m-flex-grow_1">Business Application Administrator (Cognos)</h2><p class="m-font-family_sans m-line-height_21 m-font-size_14 m-text-size-adjust_100p m-margin-top_0 m-margin-right_0 m-margin-bottom_0 m-margin-left_0 m-color_text m-margin-right_0 m-margin-bottom_0 m-margin-left_0 m-color_text m-font-size_21 m-font-size_25_sm m-font-weight_300 m-line-height_normal m-margin-top_16 m-text-align_left m-padding-right_16">Poznań</p><a class="m-font-size_14 m-font-family_sans m-color_text m-text-decoration_none m-text-size-adjust_100p m-cursor_pointer m-link m-height_40 m-line-height_40 m-text-transform_uppercase m-letter-spacing_2 m-white-space_nowrap m-cursor_pointer m-overflow_hidden m-padding-left_16 m-padding-right_16 m-padding-top_0 m-padding-bottom_0 m-outline-style_dotted--focus m-outline-width_2 m-outline-color_teal m-outline-offset_n2 m-button m-box_border m-text-align_center m-display_inline-block m-color_secondary m-background-position_50p m-background-size_5000p m-transition-property_background-color m-transition-duration_fast m-button--secondary" href="https://www.smartrecruiters.com/Allegro/743999739437299-business-application-administrator-cognos?trid=de9dfdf3-7f9e-4ebf-8a64-49f6c69ad640">Sprawdź</a></article><article class="m-padding-top_16 m-padding-top_24_lg m-padding-right_16 m-padding-right_24_lg m-padding-bottom_16 m-padding-bottom_24_lg m-padding-left_16 m-padding-left_24_lg m-card m-margin-bottom_16 m-display-flex m-flex-justify_between m-flex-items-center m-flex-direction_column m-flex-direction_row_md m-color-bg_card"><h2 class="m-font-family_roboto m-margin-left_0 m-margin-right_0 m-margin-top_0 m-color_text m-font-weight_500 m-line-height_130 m-margin-bottom_8 m-margin-bottom_16_sm m-font-size_21 m-font-size_25_sm m-margin-bottom_0_sm m-flex-grow_1">Software Engineer (Java/Kotlin) - Data&amp;AI</h2><p class="m-font-family_sans m-line-height_21 m-font-size_14 m-text-size-adjust_100p m-margin-top_0 m-margin-right_0 m-margin-bottom_0 m-margin-left_0 m-color_text m-margin-right_0 m-margin-bottom_0 m-margin-left_0 m-color_text m-font-size_21 m-font-size_25_sm m-font-weight_300 m-line-height_normal m-margin-top_16 m-text-align_left m-padding-right_16">Warsaw,Poznań,Toruń,Kraków</p><a class="m-font-size_14 m-font-family_sans m-color_text m-text-decoration_none m-text-size-adjust_100p m-cursor_pointer m-link m-height_40 m-line-height_40 m-text-transform_uppercase m-letter-spacing_2 m-white-space_nowrap m-cursor_pointer m-overflow_hidden m-padding-left_16 m-padding-right_16 m-padding-top_0 m-padding-bottom_0 m-outline-style_dotted--focus m-outline-width_2 m-outline-color_teal m-outline-offset_n2 m-button m-box_border m-text-align_center m-display_inline-block m-color_secondary m-background-position_50p m-background-size_5000p m-transition-property_background-color m-transition-duration_fast m-button--secondary" href="https://www.smartrecruiters.com/Allegro/743999739406755-software-engineer-javakotlin-dataai?trid=de9dfdf3-7f9e-4ebf-8a64-49f6c69ad640">Sprawdź</a></article><article class="m-padding-top_16 m-padding-top_24_lg m-padding-right_16 m-padding-right_24_lg m-padding-bottom_16 m-padding-bottom_24_lg m-padding-left_16 m-padding-left_24_lg m-card m-margin-bottom_16 m-display-flex m-flex-justify_between m-flex-items-center m-flex-direction_column m-flex-direction_row_md m-color-bg_card"><h2 class="m-font-family_roboto m-margin-left_0 m-margin-right_0 m-margin-top_0 m-color_text m-font-weight_500 m-line-height_130 m-margin-bottom_8 m-margin-bottom_16_sm m-font-size_21 m-font-size_25_sm m-margin-bottom_0_sm m-flex-grow_1">Senior Software Engineer (Kotlin/Java) - Site Reliability Engineering</h2><p class="m-font-family_sans m-line-height_21 m-font-size_14 m-text-size-adjust_100p m-margin-top_0 m-margin-right_0 m-margin-bottom_0 m-margin-left_0 m-color_text m-margin-right_0 m-margin-bottom_0 m-margin-left_0 m-color_text m-font-size_21 m-font-size_25_sm m-font-weight_300 m-line-height_normal m-margin-top_16 m-text-align_left m-padding-right_16">Poznań</p><a class="m-font-size_14 m-font-family_sans m-color_text m-text-decoration_none m-text-size-adjust_100p m-cursor_pointer m-link m-height_40 m-line-height_40 m-text-transform_uppercase m-letter-spacing_2 m-white-space_nowrap m-cursor_pointer m-overflow_hidden m-padding-left_16 m-padding-right_16 m-padding-top_0 m-padding-bottom_0 m-outline-style_dotted--focus m-outline-width_2 m-outline-color_teal m-outline-offset_n2 m-button m-box_border m-text-align_center m-display_inline-block m-color_secondary m-background-position_50p m-background-size_5000p m-transition-property_background-color m-transition-duration_fast m-button--secondary" href="https://www.smartrecruiters.com/Allegro/743999739294221-senior-software-engineer-kotlinjava-site-reliability-engineering?trid=de9dfdf3-7f9e-4ebf-8a64-49f6c69ad640">Sprawdź</a></article><article class="m-padding-top_16 m-padding-top_24_lg m-padding-right_16 m-padding-right_24_lg m-padding-bottom_16 m-padding-bottom_24_lg m-padding-left_16 m-padding-left_24_lg m-card m-margin-bottom_16 m-display-flex m-flex-justify_between m-flex-items-center m-flex-direction_column m-flex-direction_row_md m-color-bg_card"><h2 class="m-font-family_roboto m-margin-left_0 m-margin-right_0 m-margin-top_0 m-color_text m-font-weight_500 m-line-height_130 m-margin-bottom_8 m-margin-bottom_16_sm m-font-size_21 m-font-size_25_sm m-margin-bottom_0_sm m-flex-grow_1">Business Applications Administrator (Salesforce)</h2><p class="m-font-family_sans m-line-height_21 m-font-size_14 m-text-size-adjust_100p m-margin-top_0 m-margin-right_0 m-margin-bottom_0 m-margin-left_0 m-color_text m-margin-right_0 m-margin-bottom_0 m-margin-left_0 m-color_text m-font-size_21 m-font-size_25_sm m-font-weight_300 m-line-height_normal m-margin-top_16 m-text-align_left m-padding-right_16">Poznań</p><a class="m-font-size_14 m-font-family_sans m-color_text m-text-decoration_none m-text-size-adjust_100p m-cursor_pointer m-link m-height_40 m-line-height_40 m-text-transform_uppercase m-letter-spacing_2 m-white-space_nowrap m-cursor_pointer m-overflow_hidden m-padding-left_16 m-padding-right_16 m-padding-top_0 m-padding-bottom_0 m-outline-style_dotted--focus m-outline-width_2 m-outline-color_teal m-outline-offset_n2 m-button m-box_border m-text-align_center m-display_inline-block m-color_secondary m-background-position_50p m-background-size_5000p m-transition-property_background-color m-transition-duration_fast m-button--secondary" href="https://www.smartrecruiters.com/Allegro/743999739293071-business-applications-administrator-salesforce?trid=de9dfdf3-7f9e-4ebf-8a64-49f6c69ad640">Sprawdź</a></article></div><a class="m-font-size_14 m-font-family_sans m-color_text m-text-decoration_none m-text-size-adjust_100p m-cursor_pointer m-link m-display_block m-margin-bottom_8 m-width_100 m-height_40 m-line-height_40 m-text-transform_uppercase m-letter-spacing_2 m-white-space_nowrap m-cursor_pointer m-overflow_hidden m-padding-left_16 m-padding-right_16 m-padding-top_0 m-padding-bottom_0 m-outline-style_dotted--focus m-outline-width_2 m-outline-color_teal m-outline-offset_n2 m-button m-box_border m-text-align_center m-display_inline-block m-color_secondary m-background-position_50p m-background-size_5000p m-transition-property_background-color m-transition-duration_fast m-button--secondary" href="https://allegro.pl/praca">Zobacz więcej ofert</a></div><footer class="m-color-bg_navy m-margin-top-32"><div class="m-width-max_1600 m-margin-left_auto m-margin-right_auto m-padding-top-24 m-padding-bottom-24 m-display-flex@sm m-flex-justify-between m-flex-items-center m-text-align_center"><p class="m-font-family_sans m-line-height_21 m-font-size_14 m-text-size-adjust_100p m-margin-top_0 m-margin-right_0 m-margin-bottom_0 m-margin-left_0 m-color_text m-color_white m-padding-left-24@sm">Proudly built by Allegro Tech engineers</p><ul class="m-font-family_sans m-font-size_14 m-line-height_21 m-color_text m-text-size-adjust_100p m-list-style-type_none m-margin-top_0 m-margin-right_0 m-margin-bottom_0 m-margin-left_0 m-padding-top_0 m-padding-right_0 m-padding-bottom_0 m-padding-left_0 m-display-flex m-flex-justify-center"><li style="filter:brightness(0) invert(1);opacity:0.5" class="m-margin-right-8 m-margin-top-16 m-margin-top-0@sm m-color_white"><a class="m-font-size_14 m-font-family_sans m-color_text m-text-decoration_none m-text-size-adjust_100p m-cursor_pointer m-link m-line-height_21" href="https://github.com/allegro"><img src="https://assets.allegrostatic.com/metrum/icon/github-6a18df1729.svg" alt="Github" class="m-icon"/></a></li><li style="filter:brightness(0) invert(1);opacity:0.5" class="m-margin-right-8 m-margin-top-16 m-margin-top-0@sm m-color_white"><a class="m-font-size_14 m-font-family_sans m-color_text m-text-decoration_none m-text-size-adjust_100p m-cursor_pointer m-link m-line-height_21" href="https://www.facebook.com/allegro.tech/"><img src="https://assets.allegrostatic.com/metrum/icon/facebook-a2b92f9dcb.svg" alt="Facebook" class="m-icon"/></a></li><li style="filter:brightness(0) invert(1);opacity:0.5" class="m-margin-right-8 m-margin-top-16 m-margin-top-0@sm m-color_white"><a class="m-font-size_14 m-font-family_sans m-color_text m-text-decoration_none m-text-size-adjust_100p m-cursor_pointer m-link m-line-height_21" href="https://twitter.com/allegrotech"><img src="https://assets.allegrostatic.com/metrum/icon/twitter-25164a58aa.svg" alt="Twitter" class="m-icon"/></a></li></ul></div></footer><div style="visibility:hidden;height:0;overflow:hidden;position:relative"><img alt="doubleclick" width="1" height="1" style="position:absolute" src="https://pubads.g.doubleclick.net/activity;dc_iu=/21612525419/DFPAudiencePixel;ord=4930290932061.248;dc_seg=507368552?"/><img alt="fb" height="1" width="1" style="position:absolute" src="https://www.facebook.com/tr?id=1650870088530325&amp;ev=PageView&amp;noscript=1"/></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"posts":[{"title":"Finite-state machines made easy","link":"https://blog.allegro.tech/2021/03/state-machines-made-easy.html","pubDate":"Fri, 05 Mar 2021 00:00:00 +0100","authors":{"author":[{"name":["Tymon Felski"],"photo":["https://blog.allegro.tech/img/authors/tymon.felski.jpg"],"url":["https://blog.allegro.tech/authors/tymon.felski"]}]},"content":"\u003cp\u003eCoordinating complex processes, both business and technical, can be a challenging issue in a distributed system.\nEspecially when the complications associated with them, such as concurrency, idempotency, scalability and hindered\ntestability, come into play — possibly all at once.\nThis is definitely something that can keep many programmers awake at night.\u003c/p\u003e\n\n\u003cp\u003eWhile this may sound dramatic, in reality there are many different solutions to this problem.\nOne group of such solutions extensively uses finite-state machines also known as finite-state automata.\nAs this article is meant for everyone, let’s start with some background information about what they are and how\nthey work.\u003c/p\u003e\n\n\u003ch2 id=\"what-are-finite-state-machines\"\u003eWhat are finite-state machines\u003c/h2\u003e\n\n\u003cp\u003eFor the sake of readability, I will sometimes be referring to finite-state machines as simply “state machines”.\nIf you’re already familiar with their formal definition, you may skip to the next section.\u003c/p\u003e\n\n\u003cp\u003eFormally speaking, a finite-state machine is a mathematical model of computation that describes an abstract system\nhaving a finite number of permissible states. At any given point in time, the system is in exactly one of these\nstates.\u003c/p\u003e\n\n\u003cp\u003eIn practical terms such a machine is described by:\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003ean initial (start) state,\u003c/li\u003e\n  \u003cli\u003ea set of possible states,\u003c/li\u003e\n  \u003cli\u003ea sequence of possible inputs (events),\u003c/li\u003e\n  \u003cli\u003ea transition function which based on the last observed input and the machine’s current state, determines the next\nstate,\u003c/li\u003e\n  \u003cli\u003eand a set of terminal (end) states — optionally.\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eThe machine starts off in the initial state and inspects all inputs in sequence.\nUpon observing each input, it uses the transition function to change its state.\nThe processing ends once all inputs have been observed.\nIf the machine’s state at the end of processing is one of the terminal states, the machine is assumed to accept the\ngiven input, and to reject it otherwise.\u003c/p\u003e\n\n\u003cp\u003eAs a side note, the description provided above uses the deterministic model of a finite-state automaton.\nThere are also alternative, non-deterministic machines, but I won’t be delving into them too much, as they can be\nconverted to deterministic ones anyway.\u003c/p\u003e\n\n\u003cp\u003eIf you’ve read this far, hopefully the rest of this post will be easier on the mind!\nDespite the intimidating formal definition, finite-state machines are more widespread than you might imagine.\nUpon closer inspection you might be able to spot them in your everyday life under the hood of things such as vending\nmachines, traffic lights and elevators.\nIn .NET they are used in the implementation of \u003ccode class=\"language-plaintext highlighter-rouge\"\u003easync\u003c/code\u003e/\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eawait\u003c/code\u003e or \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eyield\u003c/code\u003e syntax.\nTry decompiling your code and see how the language authors implemented those features.\nYou have probably already used some sort of state machine in your code without even realising it!\u003c/p\u003e\n\n\u003ch2 id=\"a-simple-example-of-a-basic-state-machine-implementation\"\u003eA simple example of a basic state machine implementation\u003c/h2\u003e\n\n\u003cp\u003eLet’s take a closer look at the following piece of code:\u003c/p\u003e\n\n\u003cdiv class=\"language-csharp highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eenum\u003c/span\u003e \u003cspan class=\"n\"\u003eButton\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003ePlay\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eStop\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eenum\u003c/span\u003e \u003cspan class=\"n\"\u003eState\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003ePlaying\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eNotPlaying\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003ePlayer\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"n\"\u003eState\u003c/span\u003e \u003cspan class=\"n\"\u003eCurrentState\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003eget\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003eset\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eState\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eNotPlaying\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eHandleClick\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eButton\u003c/span\u003e \u003cspan class=\"n\"\u003ebutton\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebutton\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"n\"\u003eButton\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ePlay\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eCurrentState\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eState\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ePlaying\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eelse\u003c/span\u003e \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebutton\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"n\"\u003eButton\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eStop\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eCurrentState\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eState\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eNotPlaying\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eThis is an example of a very simple state machine with two states and two events.\nThe player can be either playing or not playing music.\nPressing the Play button will start or keep playing music, while pressing the Stop button will stop the music or keep\nit stopped.\u003c/p\u003e\n\n\u003cp\u003eThe code is manageable at this point, since the example is quite straightforward.\nHowever, I hope you can imagine how adding more media controls that are usually present in music players will quickly\nresult in complex code that will not be easily maintainable anymore.\nFor instance, consider a feature request to have the Previous button change to the previous track if the player is less\nthan 3 seconds into the current track, or stay at the current track but rewind it to the beginning otherwise.\u003c/p\u003e\n\n\u003cp\u003eThat being said, in many cases this kind of state machine implementation would be more than enough.\nYou don’t always have to use a state-of-the-art, bleeding-edge solution to achieve desired goals.\nHowever, this is not something I would recommend to someone who is trying to tackle coordination of asynchronous\noperations within a distributed system.\u003c/p\u003e\n\n\u003ch2 id=\"a-more-maintainable-approach\"\u003eA more maintainable approach\u003c/h2\u003e\n\n\u003cp\u003eLet me share our approach to this problem.\nWe have come up with a framework for building state machines in .NET with very little code that is maintainable and\ntestable.\nState machines built with this framework serve a purpose of orchestrating a wide range of business and technical\nprocesses in our microservice-based distributed architecture.\nThe framework is equipped with various features dictated by paradigms of distributed systems, which extend the\nstandard state machine definition.\u003c/p\u003e\n\n\u003cp\u003eBefore I move on to an example of its real-life application, I want to break down the state machine’s API, so that you\nknow what you’re looking at later on.\nTo keep things short, I will be showing you only snippets of simplified code, as implementation details can be\nexpanded upon in follow-up posts.\u003c/p\u003e\n\n\u003cp\u003eThe state machine is defined as follows:\u003c/p\u003e\n\n\u003cdiv class=\"language-csharp highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eStateMachine\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eTStateBase\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eTEventBase\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"nf\"\u003eStateMachine\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eTStateBase\u003c/span\u003e \u003cspan class=\"n\"\u003einitialState\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// ...\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eIt is a generic class that requires a definition of base types for all states (\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eTStateBase\u003c/code\u003e) and for all transition\ntriggers (\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eTEventBase\u003c/code\u003e).\nThe constructor accepts an initial state from which the state machine will start its operation.\u003c/p\u003e\n\n\u003cp\u003eWe can create the state machine like so:\u003c/p\u003e\n\n\u003cdiv class=\"language-csharp highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003estateMachine\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eStateMachine\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eStateBase\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eEventBase\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;(\u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eInitialState\u003c/span\u003e\u003cspan class=\"p\"\u003e());\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eHaving created this object, we may start defining transitions.\nEach transtion consists of three required elements:\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003ethe state from which the transition can be triggered,\u003c/li\u003e\n  \u003cli\u003ethe transition trigger (an event),\u003c/li\u003e\n  \u003cli\u003ethe state to which the transition leads.\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eOptionally, a transition can have side effects, called simply commands.\nA command (or a set of commands) will be run after a successful transition.\nThose can be pretty much anything from sending a message to another state machine to calling a specific service and\ndelegating a task to it.\nCommands allow a seamless integration of the state machine with external components.\nThere is a drawback, however.\nCommand execution may fail, what requires an idempotent retry policy to be employed.\u003c/p\u003e\n\n\u003cp\u003eTransitions and commands can be conditional, meaning that a logical expression can be guarding and preventing the\nexecution of the whole transition, or just a command in some cases.\u003c/p\u003e\n\n\u003cp\u003eA builder pattern which combines all of the aforementioned requirements is used to compose a transition:\u003c/p\u003e\n\n\u003cdiv class=\"language-csharp highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"n\"\u003estateMachine\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eFromState\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eTStateFrom\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eWhen\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eTEvent\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;(\u003c/span\u003e\u003cspan class=\"cm\"\u003e/* Expression\u0026lt;Func\u0026lt;TStateFrom, TEvent, bool\u0026gt;\u0026gt; */\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eToState\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eTStateTo\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;(\u003c/span\u003e\u003cspan class=\"cm\"\u003e/* Expression\u0026lt;Func\u0026lt;TStateFrom, TEvent, TStateTo\u0026gt;\u0026gt; */\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eRunCommand\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ewhen\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"cm\"\u003e/* Expression\u0026lt;Func\u0026lt;TStateFrom, TEvent, TStateTo, bool\u0026gt;\u0026gt; */\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ethen\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"cm\"\u003e/* Expression\u0026lt;Func\u0026lt;TStateFrom, TEvent, TStateTo, TCommand\u0026gt;\u0026gt; */\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eRunCommand\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"cm\"\u003e/* ... */\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// ...\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eRunCommand\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"cm\"\u003e/* ... */\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eThis structure may be overwhelming at first, but bear with me.\nIt will all make sense in a bit.\nAs for now you need to know that:\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003eif the state machine is in a state of \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eTStateFrom\u003c/code\u003e type,\u003c/li\u003e\n  \u003cli\u003eand an event of type \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eTEvent\u003c/code\u003e occured,\u003c/li\u003e\n  \u003cli\u003eand the condition (if defined) passed to \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eWhen\u003c/code\u003e method is satisfied,\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003ethe transition will fire up and the state machine will switch to a new state of type \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eTStateTo\u003c/code\u003e using the factory method\nexpression passed to \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eToState\u003c/code\u003e method.\u003c/p\u003e\n\n\u003cp\u003eThe state machine class exposes a method which can be used to trigger a transition with an event:\u003c/p\u003e\n\n\u003cdiv class=\"language-csharp highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"n\"\u003eTransitionResult\u003c/span\u003e \u003cspan class=\"nf\"\u003eApply\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eTEventBase\u003c/span\u003e \u003cspan class=\"n\"\u003e@event\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eThis method applies the supplied event to the current state by trying to find a matching transition in the transition\nmapping and changes the internal state of the machine.\nThe result contains information about the performed transition, along with commands that should be run.\u003c/p\u003e\n\n\u003cdiv class=\"language-csharp highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eTransitionResult\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"n\"\u003eTStateBase\u003c/span\u003e \u003cspan class=\"n\"\u003eStateFrom\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003eget\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"n\"\u003eTEventBase\u003c/span\u003e \u003cspan class=\"n\"\u003eEvent\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003eget\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"n\"\u003eTStateBase\u003c/span\u003e \u003cspan class=\"n\"\u003eStateTo\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003eget\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"n\"\u003eIEnumerable\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003eobject\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eCommands\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003eget\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"n\"\u003eIsValid\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003eget\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eIf no matching transition definition is found given the machine’s current state – or if a transition is found, but its\nprecondition is not met – the event application will result in an invalid transition.\nIn that case, the state machine will not react to the event and simply retain its state, possibly logging that an\ninvalid event was received.\u003c/p\u003e\n\n\u003cp\u003eIf there are multiple matching transitions, the first one will fire up (in definition order).\nWe should, however, avoid designing states machines in such way if possible.\u003c/p\u003e\n\n\u003cp\u003eAs you can see, the representation of the machine is primarily type-based, so we can use polymorphism to our advantage.\nBy calling \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eFromState\u0026lt;TStateBase\u0026gt;()\u003c/code\u003e we can have a transition that can be fired up from any state.\nSimilarily, if we use a type that only some selected states derive from, we will have a transition applicable to these\nstates only.\nIt would be equivalent to duplicating that same transition for every one of these states.\nThis syntax can be particularly useful, when dealing with processes that have an expiration date and have to be\ncompleted within a specific time frame.\nReceiving an event about the process’ expiration may have to be handled regardless of the machine’s current state and\nresult in termination immediately.\u003c/p\u003e\n\n\u003ch2 id=\"implementation-manifest\"\u003eImplementation manifest\u003c/h2\u003e\n\n\u003cp\u003eNow that I’ve described how a state machine can be defined in a declarative way using our framework, let’s talk a bit\nabout how that definition actually runs.\u003c/p\u003e\n\n\u003cp\u003eIn general, we use dependency injection to make the state machine definition work with other services and add-ons,\nsuch as specific command runners.\nI promised I would not dive deep into implementation details, but nonetheless I want to give you a little taste of\nwhat sits behind the scenes.\u003c/p\u003e\n\n\u003cp\u003eIf you don’t care for any of that, you may skip to the “Real-life example” section.\u003c/p\u003e\n\n\u003ch3 id=\"storage\"\u003eStorage\u003c/h3\u003e\n\n\u003cp\u003eThe state machine implementation is based on event sourcing.\nIn summary, this means that we don’t save the state of our application objects, but rather a series of events that\nchange the object’s state.\nThese events will give us the current view of the object when aggregated (“replayed”) in the order in which they\noccured.\nFor this purpose we currently use an open-source library,\n\u003ca href=\"https://github.com/SQLStreamStore/SQLStreamStore\"\u003eSQLStreamStore\u003c/a\u003e.\u003c/p\u003e\n\n\u003cp\u003eSQLStreamStore offers an atomic and idempotent stream append operation.\nThanks to this, we don’t have to worry about race conditions between multiple instances of the same state machine\nhandling events in parallel, what is great for scalability.\nWe can also recognize a situation when the same event is being fed into the state machine again, what can happen\nwhen dealing with retry policies.\nThat, on the other hand, gives us a pretty good way of achieving deduplication.\u003c/p\u003e\n\n\u003ch3 id=\"caching\"\u003eCaching\u003c/h3\u003e\n\n\u003cp\u003eReplaying all events every single time is an unnecessary overhead that we decided to mitigate by introducing\na lock-free cache for state snapshots.\nAfter each transition a state machine will cache its current state along with the stream version which it\ncorresponds to.\nThis gives us the ability to restore the state machine to the state it was in after handling \u003ccode class=\"language-plaintext highlighter-rouge\"\u003en-1\u003c/code\u003e events, when we want\nto handle the \u003ccode class=\"language-plaintext highlighter-rouge\"\u003en\u003c/code\u003e-th event.\u003c/p\u003e\n\n\u003cp\u003eIt requires, however, the states to be immutable, or else we may end up with an unexpected behaviour.\nIf states were not immutable, we could not be certain that the state object we cached after handling the \u003ccode class=\"language-plaintext highlighter-rouge\"\u003en\u003c/code\u003e-th event\nis still the same and has not been modified in the meantime.\nMoreover, immutable objects are inherently thread-safe.\u003c/p\u003e\n\n\u003ch3 id=\"instrumentation\"\u003eInstrumentation\u003c/h3\u003e\n\n\u003cp\u003eThis state machine framework is also equipped with heavy instrumentation.\nEvery executed transition and state change is logged, so we can easily track any errors.\nThis data is also useful for our data analytics team to keep track of business processes.\nA lot of different metrics come into play to measure performance of each and every state machine deployed.\u003c/p\u003e\n\n\u003cp\u003eFinally, every historical transition is saved in a stream — separate from the event stream — and can be viewed with our\ninternal back-office tools.\u003c/p\u003e\n\n\u003cp\u003eThanks to the finite nature of the state machines, we can always log the current state and trace what made the system\nto be in that state, along with all its previous states.\nThis is something quite invaluable and helps immensely when diagnosing issues, especially in complex and\ninter-dependent business scenarios where a lot of things happen at the same time.\u003c/p\u003e\n\n\u003ch2 id=\"real-life-example\"\u003eReal-life example\u003c/h2\u003e\n\n\u003cp\u003eSo finally, the big question: how is this framework used on our platform?\nTo answer that we don’t need to reach far.\u003c/p\u003e\n\n\u003cp\u003eIn July of 2020 we launched a new payment method called Allegro Pay, which will eventually be available to every buyer\non Allegro.\nThis service allows the users to buy items now and pay for them later in a single payment after 30 days, or\nin multiple smaller monthly payments, depending on the value of purchased goods.\u003c/p\u003e\n\n\u003cp\u003eRepayments can be easily made online using our Allegro Pay dashboard.\nUsers are even able to pay for multiple purchases at once.\u003c/p\u003e\n\n\u003cp\u003e\u003cimg src=\"/img/articles/2021-03-05-state-machines-made-easy/allegro-pay-dashboard.png\" alt=\"Allegro Pay dashboard\" /\u003e\u003c/p\u003e\n\n\u003cp\u003eFor more detailed information, I encourage you to read our\n\u003ca href=\"https://allegro.pl/pomoc/dla-kupujacych/allegro-pay/\"\u003eAllegro Pay FAQ\u003c/a\u003e.\u003c/p\u003e\n\n\u003cp\u003eI suspect you already know where I’m going with this — my goal is to show you how our state machine framework is used\nto coordinate an actual business process of handling a repayment within Allegro Pay.\u003c/p\u003e\n\n\u003ch3 id=\"the-process-specification\"\u003eThe process specification\u003c/h3\u003e\n\n\u003cp\u003eBefore we create our state machine, we need to have a rough idea of which states and events we want to handle.\u003c/p\u003e\n\n\u003cp\u003eThe repayment process is started in two different ways, but will end alike in both cases.\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003e\n    \u003cp\u003eThe user can initialize an immediate online repayment via the Allegro Pay dashboard.\n They are redirected to the payment provider’s website and complete the process there.\u003c/p\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\n    \u003cp\u003eAlternatively, the user can request to repay their purchase with a traditional wire transfer, what we call an\noffline repayment.\n We know nothing about it until the money actually arrives at the target bank account.\n That method may take up to a couple of days.\u003c/p\u003e\n  \u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp\u003eAt this point both repayment paths merge, since from now on we can discard any knowledge about how the money\nwas received and focus on the fact that we have it.\nThe money source won’t be useful during the process coordination anymore.\u003c/p\u003e\n\n\u003cp\u003eThe next step is to register the repayment in our bookkeeping system.\nThe registration part is important for us, because it will tell us whether the purchase was paid in full or if further\nrepayments are required.\nAfter receiving information about successful registration, an email is sent to the user confirming that the\nrepayment was registered.\u003c/p\u003e\n\n\u003cp\u003eAfter repayment is registered, we asynchronously await the feedback from the bookkeeping system on the transaction\nbeing settled and the repayment is to be marked as completed.\u003c/p\u003e\n\n\u003ch3 id=\"designing-the-state-machine\"\u003eDesigning the state machine\u003c/h3\u003e\n\n\u003cp\u003eI could show you the finished state machine and just paste a wall of text here, describing what it does, but where’s\nthe fun in that?\nInstead, I’d like to show you the step-by-step process I would go through when designing this kind of state machine.\u003c/p\u003e\n\n\u003cp\u003eI’ll start off by simply creating a state machine that handles a repayment of a single purchase and then extend it\nto work for all cases.\nFirst we need to define the base types for all states and events:\u003c/p\u003e\n\n\u003cdiv class=\"language-csharp highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eabstract\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eStateBase\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003eUserId\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003eget\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003einit\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003eRepaymentId\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003eget\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003einit\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003ePaymentId\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003eget\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003einit\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"nf\"\u003eStateBase\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eStateBase\u003c/span\u003e \u003cspan class=\"n\"\u003eother\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eother\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"k\"\u003enull\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003eUserId\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eother\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eUserId\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eRepaymentId\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eother\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eRepaymentId\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ePaymentId\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eother\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ePaymentId\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eabstract\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eEventBase\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eAs you can see, I already equipped the base state with all the properties we will need later to orchestrate this\nprocess:\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eUserId\u003c/code\u003e — tells us who is repaying,\u003c/li\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eRepaymentId\u003c/code\u003e — uniquely identifies the repayment process,\u003c/li\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003ePaymentId\u003c/code\u003e — identifies the payment made by the user for this repayment.\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eAs for the event base, we don’t need anything special there, so it’s empty.\u003c/p\u003e\n\n\u003cp\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eStateBase\u003c/code\u003e class features a copy constructor, which rewrites all properties from the previous state when creating\na new one.\u003c/p\u003e\n\n\u003cp\u003eNone of the states will have any special properties, so there’s no point in painstakingly showing all individual\nsubclasses representing each state.\nHere are just a few sample classes of the initial state (\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eNotStarted\u003c/code\u003e) and one of the subsequent states:\u003c/p\u003e\n\n\u003cdiv class=\"language-csharp highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eNotStarted\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eStateBase\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"nf\"\u003eNotStarted\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"k\"\u003ebase\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enull\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eCreated\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eStateBase\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"nf\"\u003eCreated\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eStateBase\u003c/span\u003e \u003cspan class=\"n\"\u003eother\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"k\"\u003ebase\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eother\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eAll of the remaining states are defined similarly to \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eCreated\u003c/code\u003e state.\nThose states are:\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003ePaid\u003c/code\u003e,\u003c/li\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eFailed\u003c/code\u003e,\u003c/li\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eRegistered\u003c/code\u003e,\u003c/li\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eCompleted\u003c/code\u003e.\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eOnce we have our states, we can focus on events and introduce transitions, one by one.\u003c/p\u003e\n\n\u003cp\u003eWe’ll start by handling an online repayment.\nIt begins with the user creating a repayment entity by selecting a payment in the Allegro Pay dashboard.\nThis generates an event, let’s call it \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eOnlineRepaymentCreated\u003c/code\u003e:\u003c/p\u003e\n\n\u003cdiv class=\"language-csharp highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eOnlineRepaymentCreated\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eEventBase\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003eUserId\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003eget\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003einit\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003eRepaymentId\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003eget\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003einit\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003ePaymentId\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003eget\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003einit\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eWe want this event to trigger a transition from \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eNotStarted\u003c/code\u003e to \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eCreated\u003c/code\u003e state.\u003c/p\u003e\n\n\u003cdiv class=\"language-csharp highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// 1. NotStarted : OnlineRepaymentCreated -\u0026gt; Created\u003c/span\u003e\n\u003cspan class=\"n\"\u003estateMachine\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eFromState\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eNotStarted\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eWhen\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eOnlineRepaymentCreated\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eToState\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eCreated\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;((\u003c/span\u003e\u003cspan class=\"k\"\u003efrom\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003e@event\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eCreated\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003efrom\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eUserId\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003e@event\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eUserId\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eRepaymentId\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003e@event\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eRepaymentId\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ePaymentId\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003e@event\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ePaymentId\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e});\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eAt this point the user sees the repayment form, where they select a payment method.\nThey are then redirected to the payment provider’s website to finish the repayment.\nIn most cases it will succeed, but in some it fails due to a multitude of reasons, such as insufficient\nfunds on the account or the user providing wrong confirmation code.\u003c/p\u003e\n\n\u003cp\u003eTherefore, we need two events:\u003c/p\u003e\n\n\u003cdiv class=\"language-csharp highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eOnlineRepaymentPaid\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eEventBase\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eOnlineRepaymentFailed\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eEventBase\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eWe could go about a single event called \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eRepaymentResult\u003c/code\u003e with an enum property indicating a success or a failure, but\nin my opinion the former approach is cleaner and more open to future changes.\nThese events will play a role in tranistions no. 2 and 3:\u003c/p\u003e\n\n\u003cdiv class=\"language-csharp highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// 2. Created : OnlineRepaymentPaid -\u0026gt; Paid\u003c/span\u003e\n\u003cspan class=\"n\"\u003estateMachine\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eFromState\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eCreated\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eWhen\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eOnlineRepaymentPaid\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eToState\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003ePaid\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;((\u003c/span\u003e\u003cspan class=\"k\"\u003efrom\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003e@event\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003ePaid\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003efrom\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eRunCommand\u003c/span\u003e\u003cspan class=\"p\"\u003e((\u003c/span\u003e\u003cspan class=\"k\"\u003efrom\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003e@event\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eto\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eRegisterPaymentCommand\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eto\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ePaymentId\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n\n\u003cspan class=\"c1\"\u003e// 3. Created : OnlineRepaymentFailed -\u0026gt; Failed\u003c/span\u003e\n\u003cspan class=\"n\"\u003estateMachine\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eFromState\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eCreated\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eWhen\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eOnlineRepaymentFailed\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eToState\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eFailed\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;((\u003c/span\u003e\u003cspan class=\"k\"\u003efrom\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003e@event\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eFailed\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003efrom\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eYou might notice that transition no. 2 has a command that I didn’t mention earlier specified.\nIt’s a simple class wrapping the payment identifier, which is interpreted by the command runner as a request to our\nbookkeeping system for registering this payment.\u003c/p\u003e\n\n\u003cp\u003eThis concludes the online path and we can move on to the offline repayment.\nIt is significantly easier, since we are simply notified that the money has been transferred to us.\nBecause of this, we can completely skip the \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eCreated\u003c/code\u003e state and go straight to \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ePaid\u003c/code\u003e.\nWe need an event called \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eOfflineRepaymentPaid\u003c/code\u003e which contains the same properties as \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eOnlineRepaymentCreated\u003c/code\u003e:\u003c/p\u003e\n\n\u003cdiv class=\"language-csharp highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eOfflineRepaymentPaid\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eEventBase\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003eUserId\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003eget\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003einit\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003eRepaymentId\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003eget\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003einit\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003ePaymentId\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003eget\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003einit\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eLet’s use it in the fourth transition that will once again call the registration command:\u003c/p\u003e\n\n\u003cdiv class=\"language-csharp highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// 4. NotStarted : OfflineRepaymentPaid -\u0026gt; Paid\u003c/span\u003e\n\u003cspan class=\"n\"\u003estateMachine\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eFromState\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eNotStarted\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eWhen\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eOfflineRepaymentPaid\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eToState\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003ePaid\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;((\u003c/span\u003e\u003cspan class=\"k\"\u003efrom\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003e@event\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003ePaid\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003efrom\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eUserId\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003e@event\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eUserId\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eRepaymentId\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003e@event\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eRepaymentId\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ePaymentId\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003e@event\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ePaymentId\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e})\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eRunCommand\u003c/span\u003e\u003cspan class=\"p\"\u003e((\u003c/span\u003e\u003cspan class=\"k\"\u003efrom\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003e@event\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eto\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eRegisterPaymentCommand\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e@event\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ePaymentId\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eThis is where both repayment types merge and we can focus on our bookkeeping system.\nAs mentioned before, we are mostly interested in registration events published by the bookkeeping system.\u003c/p\u003e\n\n\u003cdiv class=\"language-csharp highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003ePaymentRegistered\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eEventBase\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003ePaymentId\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003eget\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003einit\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eOnce we know that a payment is registered in our bookkeeping system, we are able to send an email to the user\nsummarizing what they paid for and follow-up information whether they still have more payments to be made.\nThis can be done with a transition like this:\u003c/p\u003e\n\n\u003cdiv class=\"language-csharp highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// 5. Paid : PaymentRegistered -\u0026gt; Registered\u003c/span\u003e\n\u003cspan class=\"n\"\u003estateMachine\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eFromState\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003ePaid\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eWhen\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003ePaymentRegistered\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eToState\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eRegistered\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;((\u003c/span\u003e\u003cspan class=\"k\"\u003efrom\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003e@event\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eRegistered\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003efrom\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eRunCommand\u003c/span\u003e\u003cspan class=\"p\"\u003e((\u003c/span\u003e\u003cspan class=\"k\"\u003efrom\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003e@event\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eto\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eSendRepaymentRegisteredEmailCommand\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eto\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eUserId\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eto\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eRepaymentId\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eAgain, \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eSendRepaymentRegisteredEmailCommand\u003c/code\u003e is a simple class wrapping two properties that will be interpreted by the\ncommand runner and result in an email sent to the user.\u003c/p\u003e\n\n\u003cp\u003eThe last step is to wait for the final event \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ePaymentCompleted\u003c/code\u003e.\nTheoretically it could be omitted in this state machine, but it’s useful for auditing purposes.\u003c/p\u003e\n\n\u003cdiv class=\"language-csharp highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003ePaymentCompleted\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eEventBase\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003ePaymentId\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003eget\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003einit\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eIt’s time to create the final transition:\u003c/p\u003e\n\n\u003cdiv class=\"language-csharp highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// 6. Registered : PaymentCompleted -\u0026gt; Completed\u003c/span\u003e\n\u003cspan class=\"n\"\u003estateMachine\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eFromState\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eRegistered\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eWhen\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003ePaymentCompleted\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eToState\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eCompleted\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;((\u003c/span\u003e\u003cspan class=\"k\"\u003efrom\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003e@event\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eCompleted\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003efrom\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eAnd we’re done!\nRight?\nNot really.\u003c/p\u003e\n\n\u003cp\u003eAs is usually the case with event-sourced systems, the order of incoming events can’t always be relied on.\nThe bookkeeping system will sometimes — for reasons I don’t want to delve into — publish events \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ePaymentRegistered\u003c/code\u003e and\n\u003ccode class=\"language-plaintext highlighter-rouge\"\u003ePaymentCompleted\u003c/code\u003e at the same time.\nDue to a lack of message ordering guarantees, it’s possible for us to receive \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ePaymentCompleted\u003c/code\u003e event before\n\u003ccode class=\"language-plaintext highlighter-rouge\"\u003ePaymentRegistered\u003c/code\u003e.\nThe current definition of the state machine is not prepared for that.\u003c/p\u003e\n\n\u003cp\u003eFortunately, the fix is quite easy, as we can simply introduce two more transitions:\u003c/p\u003e\n\n\u003cdiv class=\"language-csharp highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// 7. Paid : PaymentCompleted -\u0026gt; Completed\u003c/span\u003e\n\u003cspan class=\"n\"\u003estateMachine\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eFromState\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003ePaid\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eWhen\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003ePaymentCompleted\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eToState\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eCompleted\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;((\u003c/span\u003e\u003cspan class=\"k\"\u003efrom\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003e@event\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eCompleted\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003efrom\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n\n\u003cspan class=\"c1\"\u003e// 8. Completed : PaymentRegistered -\u0026gt; Completed\u003c/span\u003e\n\u003cspan class=\"n\"\u003estateMachine\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eFromState\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eCompleted\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eWhen\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003ePaymentRegistered\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eToState\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eCompleted\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;((\u003c/span\u003e\u003cspan class=\"k\"\u003efrom\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003e@event\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eCompleted\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003efrom\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eRunCommand\u003c/span\u003e\u003cspan class=\"p\"\u003e((\u003c/span\u003e\u003cspan class=\"k\"\u003efrom\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003e@event\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eto\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eSendRepaymentRegisteredEmailCommand\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eto\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eUserId\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eto\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eRepaymentId\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eIn this scenario we completely skip \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eRegistered\u003c/code\u003e state, but that’s something we just have to deal with.\nEvents are important from analytics and diagnostics standpoints, states — not so much.\u003c/p\u003e\n\n\u003cp\u003eThat wraps up the event flow for this scenario.\nIt can be visualized with a diagram like this:\u003c/p\u003e\n\n\u003cp\u003e\u003cimg src=\"/img/articles/2021-03-05-state-machines-made-easy/repayment-state-machine-v1.png\" alt=\"Repayment state machine diagram (V1)\" /\u003e\u003c/p\u003e\n\n\u003cp\u003eOur state machine framework is equipped with a pretty useful visualisation extension.\nIt’s a pretty neat tool that makes it easy to figure out how the state machine works, without having to delve into the\ncode.\nA simple unit test that calls this extension can render a state machine diagram like one above using PlantUML\nsyntax, which in this case would go as follows:\u003c/p\u003e\n\n\u003cdiv class=\"language-plaintext highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e@startuml\nhide empty description\n[*] --\u0026gt; NotStarted\nNotStarted --\u0026gt; Created: \u0026lt;b\u0026gt;OnlineRepaymentCreated\u0026lt;/b\u0026gt;\nCreated --\u0026gt; Paid: \u0026lt;b\u0026gt;OnlineRepaymentPaid\u0026lt;/b\u0026gt;\\n\u0026lt;i\u0026gt;then:\u0026lt;/i\u0026gt; RegisterPaymentCommand\nCreated --\u0026gt; Failed: \u0026lt;b\u0026gt;OnlineRepaymentFailed\u0026lt;/b\u0026gt;\nNotStarted --\u0026gt; Paid: \u0026lt;b\u0026gt;OfflineRepaymentPaid\u0026lt;/b\u0026gt;\\n\u0026lt;i\u0026gt;then:\u0026lt;/i\u0026gt; RegisterPaymentCommand\nPaid --\u0026gt; Registered: \u0026lt;b\u0026gt;PaymentRegistered\u0026lt;/b\u0026gt;\\n\u0026lt;i\u0026gt;then:\u0026lt;/i\u0026gt; SendRepaymentRegisteredEmailCommand\nRegistered --\u0026gt; Completed: \u0026lt;b\u0026gt;PaymentCompleted\u0026lt;/b\u0026gt;\nPaid --\u0026gt; Completed: \u0026lt;b\u0026gt;PaymentCompleted\u0026lt;/b\u0026gt;\nCompleted --\u0026gt; Completed: \u0026lt;b\u0026gt;PaymentRegistered\u0026lt;/b\u0026gt;\\n\u0026lt;i\u0026gt;then:\u0026lt;/i\u0026gt; SendRepaymentRegisteredEmailCommand\n@enduml\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eHowever, recall that this is just a state machine to handle a repayment for a single payment selected by the user.\nI promised we would extend it to handle multiple payments.\nLet’s do that.\nFirst we’ll extend the base state definition:\u003c/p\u003e\n\n\u003cdiv class=\"language-csharp highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eabstract\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eStateBase\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003eUserId\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003eget\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003einit\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003eRepaymentId\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003eget\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003einit\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"n\"\u003eHashSet\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003ePaymentIds\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003eget\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003einit\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"n\"\u003eHashSet\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eRegisteredPaymentIds\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003eget\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003einit\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"n\"\u003eHashSet\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eCompletedPaymentIds\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003eget\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003einit\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"nf\"\u003eStateBase\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eStateBase\u003c/span\u003e \u003cspan class=\"n\"\u003eother\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eother\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"k\"\u003enull\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003eUserId\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eother\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eUserId\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eRepaymentId\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eother\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eRepaymentId\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ePaymentIds\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eHashSet\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;(\u003c/span\u003e\u003cspan class=\"n\"\u003eother\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ePaymentIds\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eRegisteredPaymentIds\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eHashSet\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;(\u003c/span\u003e\u003cspan class=\"n\"\u003eother\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eRegisteredPaymentIds\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eCompletedPaymentIds\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eHashSet\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;(\u003c/span\u003e\u003cspan class=\"n\"\u003eother\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCompletedPaymentIds\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eThree things have changed:\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003ePaymentId\u003c/code\u003e changed from a \u003ccode class=\"language-plaintext highlighter-rouge\"\u003estring\u003c/code\u003e to a \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eHashSet\u0026lt;string\u0026gt;\u003c/code\u003e and is now called \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ePaymentIds\u003c/code\u003e to represent multiple\npayments selected by the user,\u003c/li\u003e\n  \u003cli\u003ea \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eHashSet\u0026lt;string\u0026gt;\u003c/code\u003e called \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eRegisteredPaymentIds\u003c/code\u003e was added to keep track of registered payments,\u003c/li\u003e\n  \u003cli\u003ea \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eHashSet\u0026lt;string\u0026gt;\u003c/code\u003e called \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eCompletedPaymentIds\u003c/code\u003e was added to keep track of completed payments.\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eWe also have to modify \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eOnlineRepaymentCreated\u003c/code\u003e event by introducing a collection of payment identifiers, like so:\u003c/p\u003e\n\n\u003cdiv class=\"language-csharp highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eOnlineRepaymentCreated\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eEventBase\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003eUserId\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003eget\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003einit\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003eRepaymentId\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003eget\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003einit\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"n\"\u003eIEnumerable\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003ePaymentIds\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003eget\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003einit\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eBecause of this, we need to introduce a small change to transition no. 1:\u003c/p\u003e\n\n\u003cdiv class=\"language-csharp highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// 1'. NotStarted : OnlineRepaymentCreated -\u0026gt; Created\u003c/span\u003e\n\u003cspan class=\"n\"\u003estateMachine\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eFromState\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eNotStarted\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eWhen\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eOnlineRepaymentCreated\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eToState\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eCreated\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;((\u003c/span\u003e\u003cspan class=\"k\"\u003efrom\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003e@event\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eCreated\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003efrom\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eUserId\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003e@event\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eUserId\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eRepaymentId\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003e@event\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eRepaymentId\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ePaymentIds\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eHashSet\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;(\u003c/span\u003e\u003cspan class=\"n\"\u003e@event\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ePaymentIds\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e});\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eTransition no. 2 is similarly adjusted to these changes by passing the set of payment identifiers to the\nbookkeeping system:\u003c/p\u003e\n\n\u003cdiv class=\"language-csharp highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003efrom\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003e@event\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eto\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eRegisterPaymentsCommand\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eto\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ePaymentIds\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eNow we can move to the remaining transitions.\nTransition no. 5 has to be split into two.\nWe want to stay in the \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ePaid\u003c/code\u003e state until all registration events are received and only then switch to \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eRegistered\u003c/code\u003e.\nThis can be achieved with:\u003c/p\u003e\n\n\u003cdiv class=\"language-csharp highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// 5'. Paid : PaymentRegistered -\u0026gt; Paid\u003c/span\u003e\n\u003cspan class=\"n\"\u003estateMachine\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eFromState\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003ePaid\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eWhen\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003ePaymentRegistered\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;((\u003c/span\u003e\u003cspan class=\"k\"\u003efrom\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003e@event\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"p\"\u003e!\u003c/span\u003e\u003cspan class=\"k\"\u003efrom\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ePaymentIds\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAll\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eid\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"k\"\u003efrom\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eRegisteredPaymentIds\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eContains\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eid\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e||\u003c/span\u003e \u003cspan class=\"n\"\u003eid\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"n\"\u003e@event\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ePaymentId\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eToState\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003ePaid\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;((\u003c/span\u003e\u003cspan class=\"k\"\u003efrom\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003e@event\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eto\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003ePaid\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003efrom\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eto\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eRegisteredPaymentIds\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e@event\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ePaymentId\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eto\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e});\u003c/span\u003e\n\n\u003cspan class=\"c1\"\u003e// 5''. Paid : PaymentRegistered -\u0026gt; Registered\u003c/span\u003e\n\u003cspan class=\"n\"\u003estateMachine\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eFromState\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003ePaid\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eWhen\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003ePaymentRegistered\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;((\u003c/span\u003e\u003cspan class=\"k\"\u003efrom\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003e@event\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"k\"\u003efrom\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ePaymentIds\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAll\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eid\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"k\"\u003efrom\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eRegisteredPaymentIds\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eContains\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eid\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e||\u003c/span\u003e \u003cspan class=\"n\"\u003eid\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"n\"\u003e@event\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ePaymentId\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eToState\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eRegistered\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;((\u003c/span\u003e\u003cspan class=\"k\"\u003efrom\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003e@event\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eto\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eRegistered\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003efrom\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eto\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eRegisteredPaymentIds\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e@event\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ePaymentId\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eto\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e});\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eRunCommand\u003c/span\u003e\u003cspan class=\"p\"\u003e((\u003c/span\u003e\u003cspan class=\"k\"\u003efrom\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003e@event\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eto\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eSendRepaymentRegisteredEmailCommand\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eto\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eUserId\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eto\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eRepaymentId\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eAs you can see, the command is now defined only for the second transition that triggers after all payments are\nregistered.\nWe have to slightly adjust transition no. 8, which is responsible for sending the email, too:\u003c/p\u003e\n\n\u003cdiv class=\"language-csharp highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// 8'. Completed : PaymentRegistered -\u0026gt; Completed\u003c/span\u003e\n\u003cspan class=\"n\"\u003estateMachine\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eFromState\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eCompleted\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eWhen\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003ePaymentRegistered\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eToState\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eCompleted\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;((\u003c/span\u003e\u003cspan class=\"k\"\u003efrom\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003e@event\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eto\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eCompleted\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003efrom\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eto\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eRegisteredPaymentIds\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e@event\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ePaymentId\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eto\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e})\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eRunCommand\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ewhen\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003efrom\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003e@event\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eto\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eto\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ePaymentIds\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSetEquals\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eto\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eRegisteredPaymentIds\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ethen\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003efrom\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003e@event\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eto\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eSendRepaymentRegisteredEmailCommand\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eto\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eUserId\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eto\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eRepaymentId\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eThis time the transition is not conditional, however the command is.\nIt will execute only after we handle final registration event and the payment identifier sets \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ePaymentIds\u003c/code\u003e and\n\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eRegisteredPaymentIds\u003c/code\u003e become equal.\u003c/p\u003e\n\n\u003cp\u003eWe cannot forget about all transitions that are triggered by \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ePaymentCompleted\u003c/code\u003e event.\nThose will have to be changed like so:\u003c/p\u003e\n\n\u003cdiv class=\"language-csharp highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// 6'. Registered : PaymentCompleted -\u0026gt; Registered\u003c/span\u003e\n\u003cspan class=\"n\"\u003estateMachine\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eFromState\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eRegistered\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eWhen\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003ePaymentCompleted\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;((\u003c/span\u003e\u003cspan class=\"k\"\u003efrom\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003e@event\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"p\"\u003e!\u003c/span\u003e\u003cspan class=\"k\"\u003efrom\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ePaymentIds\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAll\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eid\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"k\"\u003efrom\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCompletedPaymentIds\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eContains\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eid\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e||\u003c/span\u003e \u003cspan class=\"n\"\u003eid\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"n\"\u003e@event\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ePaymentId\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eToState\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eRegistered\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;((\u003c/span\u003e\u003cspan class=\"k\"\u003efrom\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003e@event\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eto\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eRegistered\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003efrom\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eto\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCompletedPaymentIds\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e@event\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ePaymentId\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eto\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e});\u003c/span\u003e\n\n\u003cspan class=\"c1\"\u003e// 6''. Registered : PaymentCompleted -\u0026gt; Completed\u003c/span\u003e\n\u003cspan class=\"n\"\u003estateMachine\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eFromState\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eRegistered\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eWhen\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003ePaymentCompleted\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;((\u003c/span\u003e\u003cspan class=\"k\"\u003efrom\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003e@event\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"k\"\u003efrom\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ePaymentIds\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAll\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eid\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"k\"\u003efrom\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCompletedPaymentIds\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eContains\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eid\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e||\u003c/span\u003e \u003cspan class=\"n\"\u003eid\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"n\"\u003e@event\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ePaymentId\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eToState\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eCompleted\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;((\u003c/span\u003e\u003cspan class=\"k\"\u003efrom\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003e@event\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eto\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eCompleted\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003efrom\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eto\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCompletedPaymentIds\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e@event\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ePaymentId\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eto\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e});\u003c/span\u003e\n\n\u003cspan class=\"c1\"\u003e// 7'. Paid : PaymentCompleted -\u0026gt; Paid\u003c/span\u003e\n\u003cspan class=\"n\"\u003estateMachine\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eFromState\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003ePaid\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eWhen\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003ePaymentCompleted\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;((\u003c/span\u003e\u003cspan class=\"k\"\u003efrom\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003e@event\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"p\"\u003e!\u003c/span\u003e\u003cspan class=\"k\"\u003efrom\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ePaymentIds\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAll\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eid\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"k\"\u003efrom\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCompletedPaymentIds\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eContains\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eid\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e||\u003c/span\u003e \u003cspan class=\"n\"\u003eid\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"n\"\u003e@event\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ePaymentId\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eToState\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eCompleted\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;((\u003c/span\u003e\u003cspan class=\"k\"\u003efrom\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003e@event\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eto\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eCompleted\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003efrom\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eto\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCompletedPaymentIds\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e@event\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ePaymentId\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eto\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e});\u003c/span\u003e\n\n\u003cspan class=\"c1\"\u003e// 7''. Paid : PaymentCompleted -\u0026gt; Completed\u003c/span\u003e\n\u003cspan class=\"n\"\u003estateMachine\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eFromState\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003ePaid\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eWhen\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003ePaymentCompleted\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;((\u003c/span\u003e\u003cspan class=\"k\"\u003efrom\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003e@event\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"k\"\u003efrom\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ePaymentIds\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAll\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eid\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"k\"\u003efrom\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCompletedPaymentIds\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eContains\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eid\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e||\u003c/span\u003e \u003cspan class=\"n\"\u003eid\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"n\"\u003e@event\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ePaymentId\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eToState\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eCompleted\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;((\u003c/span\u003e\u003cspan class=\"k\"\u003efrom\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003e@event\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eto\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eCompleted\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003efrom\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eto\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCompletedPaymentIds\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e@event\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ePaymentId\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eto\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e});\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eAnd we’re done!\nThis time for real.\nAfter all this work we ended up with something that can be visualized with a diagram like this:\u003c/p\u003e\n\n\u003cp\u003e\u003cimg src=\"/img/articles/2021-03-05-state-machines-made-easy/repayment-state-machine-v2.png\" alt=\"Repayment state machine diagram (V2)\" /\u003e\u003c/p\u003e\n\n\u003cp\u003eI mentioned earlier that we have internal back-office tools to view state machines and their transition history.\nHere is an example view of a repayment process that was coordinated with the state machine we defined above (sensitive\ndata was redacted, since this was taken in production):\u003c/p\u003e\n\n\u003cp\u003e\u003cimg src=\"/img/articles/2021-03-05-state-machines-made-easy/back-office-state-machine-view.png\" alt=\"Back-office state machine view\" /\u003e\u003c/p\u003e\n\n\u003ch3 id=\"caveats\"\u003eCaveats\u003c/h3\u003e\n\n\u003cp\u003eYou may have noticed some problems here.\nWhat would happen if we received an event with a wrong payment identifier?\nRight now the state machine is not ready for that.\nHowever, that can be remedied relatively easily by adding another condition to \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eWhen\u003c/code\u003e methods of all transitions for\n\u003ccode class=\"language-plaintext highlighter-rouge\"\u003ePaymentRegistered\u003c/code\u003e and \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ePaymentCompleted\u003c/code\u003e events, such as:\u003c/p\u003e\n\n\u003cdiv class=\"language-csharp highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWhen\u003c/span\u003e\u003cspan class=\"p\"\u003e((\u003c/span\u003e\u003cspan class=\"k\"\u003efrom\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003e@event\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"k\"\u003efrom\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ePaymentIds\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eContains\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e@event\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ePaymentId\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"cm\"\u003e/* ... */\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eThis would essentialy ensure that we react only to events with correct identifiers.\u003c/p\u003e\n\n\u003cp\u003eAnd what about retries and duplicated events?\nTransition no. 8’ is especially susceptible to that, because it may result in the email being sent to the user twice.\nAnd we don’t want that!\nFortunately, achieving deduplication is just as easy — we have to ignore events for payments that are already\nregistered:\u003c/p\u003e\n\n\u003cdiv class=\"language-csharp highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWhen\u003c/span\u003e\u003cspan class=\"p\"\u003e((\u003c/span\u003e\u003cspan class=\"k\"\u003efrom\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003e@event\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"p\"\u003e!\u003c/span\u003e\u003cspan class=\"k\"\u003efrom\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eRegisteredPaymentIds\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eContains\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e@event\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ePaymentId\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"cm\"\u003e/* ... */\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eFor the sake of readability I also decided to skip a lot of other validations, which would otherwise have to be there,\nsuch as simple null checks.\u003c/p\u003e\n\n\u003ch3 id=\"how-to-test\"\u003eHow to test\u003c/h3\u003e\n\n\u003cp\u003eTesting state machines is important, because, well, ideally all code should be tested.\nIn this case, apart from the usual assurance that we are able to handle both happy paths and edge cases, we can also\nensure that we keep the transitions backwards compatible.\nAn event that is once inserted into the stream will stay there forever.\u003c/p\u003e\n\n\u003cp\u003eWe developed a simple DSL in F# to help us test state machines created with our framework.\nThis is a perfect solution to test a declarative definition of a state machine like the one we developed in this post.\nHere’s an example of a happy path test for our state machine:\u003c/p\u003e\n\n\u003cdiv class=\"language-fsharp highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"p\"\u003e[\u0026lt;\u003c/span\u003e\u003cspan class=\"nc\"\u003eFact\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;]\u003c/span\u003e\n\u003cspan class=\"k\"\u003elet\u003c/span\u003e \u003cspan class=\"n\"\u003e``Online repayment - single payment happy path``\u003c/span\u003e \u003cspan class=\"bp\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e[\u003c/span\u003e\n        \u003cspan class=\"nc\"\u003eWhen\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nn\"\u003eEvents\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nc\"\u003eOnlineRepaymentCreated\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s2\"\u003e\"paymentId1\"\u003c/span\u003e\u003cspan class=\"o\"\u003e))\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e|\u0026gt;\u003c/span\u003e \u003cspan class=\"nc\"\u003eGoToState\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"nc\"\u003eCreated\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e|\u0026gt;\u003c/span\u003e \u003cspan class=\"nc\"\u003eDoNothing\u003c/span\u003e\n        \u003cspan class=\"nc\"\u003eWhen\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nn\"\u003eEvents\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nc\"\u003eOnlineRepaymentPaid\u003c/span\u003e \u003cspan class=\"bp\"\u003e()\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e|\u0026gt;\u003c/span\u003e \u003cspan class=\"nc\"\u003eGoToState\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"nc\"\u003ePaid\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e|\u0026gt;\u003c/span\u003e \u003cspan class=\"nc\"\u003eDo\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"nc\"\u003eRegisterPaymentsCommand\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e\n        \u003cspan class=\"nc\"\u003eWhen\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nn\"\u003eEvents\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nc\"\u003ePaymentRegistered\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s2\"\u003e\"paymentId1\"\u003c/span\u003e\u003cspan class=\"o\"\u003e))\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e|\u0026gt;\u003c/span\u003e \u003cspan class=\"nc\"\u003eGoToState\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"nc\"\u003eRegistered\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e|\u0026gt;\u003c/span\u003e \u003cspan class=\"nc\"\u003eDo\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"nc\"\u003eSendRepaymentRegisteredEmailCommand\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e\n        \u003cspan class=\"nc\"\u003eWhen\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nn\"\u003eEvents\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nc\"\u003ePaymentCompleted\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s2\"\u003e\"paymentId1\"\u003c/span\u003e\u003cspan class=\"o\"\u003e))\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e|\u0026gt;\u003c/span\u003e \u003cspan class=\"nc\"\u003eGoToState\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"nc\"\u003eCompleted\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e|\u0026gt;\u003c/span\u003e \u003cspan class=\"nc\"\u003eDoNothing\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e]\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e|\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eapply\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eA test like this is essentially a list of events with expected side effects that are then aggregated using the \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eapply\u003c/code\u003e\nfunction that feeds them one by one into the state machine and verifies the outcome.\u003c/p\u003e\n\n\u003ch2 id=\"summary\"\u003eSummary\u003c/h2\u003e\n\n\u003cp\u003eI hope I was able to convince you how a framework like this can make designing complex state machines easy.\nIt provides numerous advantages, such as declarative syntax, effortless testability, thorough instrumentation and\nvisualization.\u003c/p\u003e\n\n\u003cp\u003eThis is precisely why state machines became an integral part of pretty much every business process architecture\nin our project.\nHaving such a robust and scalable solution for asynchronous process orchestration and isolation is crucial in\ndistributed systems.\nThe presented code, albeit extremely simplified, is from an actual state machine — one of many used in our\napplications.\u003c/p\u003e\n\n\u003cp\u003eWhile the presented solution is a strictly internal framework right now, who knows what the future might bring?\nStay tuned!\u003c/p\u003e\n","contentSnippet":"Coordinating complex processes, both business and technical, can be a challenging issue in a distributed system.\nEspecially when the complications associated with them, such as concurrency, idempotency, scalability and hindered\ntestability, come into play — possibly all at once.\nThis is definitely something that can keep many programmers awake at night.\nWhile this may sound dramatic, in reality there are many different solutions to this problem.\nOne group of such solutions extensively uses finite-state machines also known as finite-state automata.\nAs this article is meant for everyone, let’s start with some background information about what they are and how\nthey work.\nWhat are finite-state machines\nFor the sake of readability, I will sometimes be referring to finite-state machines as simply “state machines”.\nIf you’re already familiar with their formal definition, you may skip to the next section.\nFormally speaking, a finite-state machine is a mathematical model of computation that describes an abstract system\nhaving a finite number of permissible states. At any given point in time, the system is in exactly one of these\nstates.\nIn practical terms such a machine is described by:\nan initial (start) state,\na set of possible states,\na sequence of possible inputs (events),\na transition function which based on the last observed input and the machine’s current state, determines the next\nstate,\nand a set of terminal (end) states — optionally.\nThe machine starts off in the initial state and inspects all inputs in sequence.\nUpon observing each input, it uses the transition function to change its state.\nThe processing ends once all inputs have been observed.\nIf the machine’s state at the end of processing is one of the terminal states, the machine is assumed to accept the\ngiven input, and to reject it otherwise.\nAs a side note, the description provided above uses the deterministic model of a finite-state automaton.\nThere are also alternative, non-deterministic machines, but I won’t be delving into them too much, as they can be\nconverted to deterministic ones anyway.\nIf you’ve read this far, hopefully the rest of this post will be easier on the mind!\nDespite the intimidating formal definition, finite-state machines are more widespread than you might imagine.\nUpon closer inspection you might be able to spot them in your everyday life under the hood of things such as vending\nmachines, traffic lights and elevators.\nIn .NET they are used in the implementation of async/await or yield syntax.\nTry decompiling your code and see how the language authors implemented those features.\nYou have probably already used some sort of state machine in your code without even realising it!\nA simple example of a basic state machine implementation\nLet’s take a closer look at the following piece of code:\n\npublic enum Button\n{\n    Play,\n    Stop\n}\n\npublic enum State\n{\n    Playing,\n    NotPlaying\n}\n\npublic class Player\n{\n    public State CurrentState { get; private set; } = State.NotPlaying;\n\n    public void HandleClick(Button button)\n    {\n        if (button == Button.Play)\n        {\n            CurrentState = State.Playing;\n        }\n        else if (button == Button.Stop)\n        {\n            CurrentState = State.NotPlaying;\n        }\n    }\n}\n\n\nThis is an example of a very simple state machine with two states and two events.\nThe player can be either playing or not playing music.\nPressing the Play button will start or keep playing music, while pressing the Stop button will stop the music or keep\nit stopped.\nThe code is manageable at this point, since the example is quite straightforward.\nHowever, I hope you can imagine how adding more media controls that are usually present in music players will quickly\nresult in complex code that will not be easily maintainable anymore.\nFor instance, consider a feature request to have the Previous button change to the previous track if the player is less\nthan 3 seconds into the current track, or stay at the current track but rewind it to the beginning otherwise.\nThat being said, in many cases this kind of state machine implementation would be more than enough.\nYou don’t always have to use a state-of-the-art, bleeding-edge solution to achieve desired goals.\nHowever, this is not something I would recommend to someone who is trying to tackle coordination of asynchronous\noperations within a distributed system.\nA more maintainable approach\nLet me share our approach to this problem.\nWe have come up with a framework for building state machines in .NET with very little code that is maintainable and\ntestable.\nState machines built with this framework serve a purpose of orchestrating a wide range of business and technical\nprocesses in our microservice-based distributed architecture.\nThe framework is equipped with various features dictated by paradigms of distributed systems, which extend the\nstandard state machine definition.\nBefore I move on to an example of its real-life application, I want to break down the state machine’s API, so that you\nknow what you’re looking at later on.\nTo keep things short, I will be showing you only snippets of simplified code, as implementation details can be\nexpanded upon in follow-up posts.\nThe state machine is defined as follows:\n\npublic class StateMachine\u003cTStateBase, TEventBase\u003e\n{\n    public StateMachine(TStateBase initialState)\n    {\n        // ...\n    }\n}\n\n\nIt is a generic class that requires a definition of base types for all states (TStateBase) and for all transition\ntriggers (TEventBase).\nThe constructor accepts an initial state from which the state machine will start its operation.\nWe can create the state machine like so:\n\nvar stateMachine = new StateMachine\u003cStateBase, EventBase\u003e(new InitialState());\n\n\nHaving created this object, we may start defining transitions.\nEach transtion consists of three required elements:\nthe state from which the transition can be triggered,\nthe transition trigger (an event),\nthe state to which the transition leads.\nOptionally, a transition can have side effects, called simply commands.\nA command (or a set of commands) will be run after a successful transition.\nThose can be pretty much anything from sending a message to another state machine to calling a specific service and\ndelegating a task to it.\nCommands allow a seamless integration of the state machine with external components.\nThere is a drawback, however.\nCommand execution may fail, what requires an idempotent retry policy to be employed.\nTransitions and commands can be conditional, meaning that a logical expression can be guarding and preventing the\nexecution of the whole transition, or just a command in some cases.\nA builder pattern which combines all of the aforementioned requirements is used to compose a transition:\n\nstateMachine\n    .FromState\u003cTStateFrom\u003e()\n    .When\u003cTEvent\u003e(/* Expression\u003cFunc\u003cTStateFrom, TEvent, bool\u003e\u003e */)\n    .ToState\u003cTStateTo\u003e(/* Expression\u003cFunc\u003cTStateFrom, TEvent, TStateTo\u003e\u003e */)\n    .RunCommand(\n        when: /* Expression\u003cFunc\u003cTStateFrom, TEvent, TStateTo, bool\u003e\u003e */,\n        then: /* Expression\u003cFunc\u003cTStateFrom, TEvent, TStateTo, TCommand\u003e\u003e */)\n    .RunCommand(/* ... */)\n    // ...\n    .RunCommand(/* ... */);\n\n\nThis structure may be overwhelming at first, but bear with me.\nIt will all make sense in a bit.\nAs for now you need to know that:\nif the state machine is in a state of TStateFrom type,\nand an event of type TEvent occured,\nand the condition (if defined) passed to When method is satisfied,\nthe transition will fire up and the state machine will switch to a new state of type TStateTo using the factory method\nexpression passed to ToState method.\nThe state machine class exposes a method which can be used to trigger a transition with an event:\n\npublic TransitionResult Apply(TEventBase @event);\n\n\nThis method applies the supplied event to the current state by trying to find a matching transition in the transition\nmapping and changes the internal state of the machine.\nThe result contains information about the performed transition, along with commands that should be run.\n\npublic class TransitionResult\n{\n    public TStateBase StateFrom { get; }\n    public TEventBase Event { get; }\n    public TStateBase StateTo { get; }\n    public IEnumerable\u003cobject\u003e Commands { get; }\n    public bool IsValid { get; }\n}\n\n\nIf no matching transition definition is found given the machine’s current state – or if a transition is found, but its\nprecondition is not met – the event application will result in an invalid transition.\nIn that case, the state machine will not react to the event and simply retain its state, possibly logging that an\ninvalid event was received.\nIf there are multiple matching transitions, the first one will fire up (in definition order).\nWe should, however, avoid designing states machines in such way if possible.\nAs you can see, the representation of the machine is primarily type-based, so we can use polymorphism to our advantage.\nBy calling FromState\u003cTStateBase\u003e() we can have a transition that can be fired up from any state.\nSimilarily, if we use a type that only some selected states derive from, we will have a transition applicable to these\nstates only.\nIt would be equivalent to duplicating that same transition for every one of these states.\nThis syntax can be particularly useful, when dealing with processes that have an expiration date and have to be\ncompleted within a specific time frame.\nReceiving an event about the process’ expiration may have to be handled regardless of the machine’s current state and\nresult in termination immediately.\nImplementation manifest\nNow that I’ve described how a state machine can be defined in a declarative way using our framework, let’s talk a bit\nabout how that definition actually runs.\nIn general, we use dependency injection to make the state machine definition work with other services and add-ons,\nsuch as specific command runners.\nI promised I would not dive deep into implementation details, but nonetheless I want to give you a little taste of\nwhat sits behind the scenes.\nIf you don’t care for any of that, you may skip to the “Real-life example” section.\nStorage\nThe state machine implementation is based on event sourcing.\nIn summary, this means that we don’t save the state of our application objects, but rather a series of events that\nchange the object’s state.\nThese events will give us the current view of the object when aggregated (“replayed”) in the order in which they\noccured.\nFor this purpose we currently use an open-source library,\nSQLStreamStore.\nSQLStreamStore offers an atomic and idempotent stream append operation.\nThanks to this, we don’t have to worry about race conditions between multiple instances of the same state machine\nhandling events in parallel, what is great for scalability.\nWe can also recognize a situation when the same event is being fed into the state machine again, what can happen\nwhen dealing with retry policies.\nThat, on the other hand, gives us a pretty good way of achieving deduplication.\nCaching\nReplaying all events every single time is an unnecessary overhead that we decided to mitigate by introducing\na lock-free cache for state snapshots.\nAfter each transition a state machine will cache its current state along with the stream version which it\ncorresponds to.\nThis gives us the ability to restore the state machine to the state it was in after handling n-1 events, when we want\nto handle the n-th event.\nIt requires, however, the states to be immutable, or else we may end up with an unexpected behaviour.\nIf states were not immutable, we could not be certain that the state object we cached after handling the n-th event\nis still the same and has not been modified in the meantime.\nMoreover, immutable objects are inherently thread-safe.\nInstrumentation\nThis state machine framework is also equipped with heavy instrumentation.\nEvery executed transition and state change is logged, so we can easily track any errors.\nThis data is also useful for our data analytics team to keep track of business processes.\nA lot of different metrics come into play to measure performance of each and every state machine deployed.\nFinally, every historical transition is saved in a stream — separate from the event stream — and can be viewed with our\ninternal back-office tools.\nThanks to the finite nature of the state machines, we can always log the current state and trace what made the system\nto be in that state, along with all its previous states.\nThis is something quite invaluable and helps immensely when diagnosing issues, especially in complex and\ninter-dependent business scenarios where a lot of things happen at the same time.\nReal-life example\nSo finally, the big question: how is this framework used on our platform?\nTo answer that we don’t need to reach far.\nIn July of 2020 we launched a new payment method called Allegro Pay, which will eventually be available to every buyer\non Allegro.\nThis service allows the users to buy items now and pay for them later in a single payment after 30 days, or\nin multiple smaller monthly payments, depending on the value of purchased goods.\nRepayments can be easily made online using our Allegro Pay dashboard.\nUsers are even able to pay for multiple purchases at once.\n\nFor more detailed information, I encourage you to read our\nAllegro Pay FAQ.\nI suspect you already know where I’m going with this — my goal is to show you how our state machine framework is used\nto coordinate an actual business process of handling a repayment within Allegro Pay.\nThe process specification\nBefore we create our state machine, we need to have a rough idea of which states and events we want to handle.\nThe repayment process is started in two different ways, but will end alike in both cases.\nThe user can initialize an immediate online repayment via the Allegro Pay dashboard.\n They are redirected to the payment provider’s website and complete the process there.\nAlternatively, the user can request to repay their purchase with a traditional wire transfer, what we call an\noffline repayment.\n We know nothing about it until the money actually arrives at the target bank account.\n That method may take up to a couple of days.\nAt this point both repayment paths merge, since from now on we can discard any knowledge about how the money\nwas received and focus on the fact that we have it.\nThe money source won’t be useful during the process coordination anymore.\nThe next step is to register the repayment in our bookkeeping system.\nThe registration part is important for us, because it will tell us whether the purchase was paid in full or if further\nrepayments are required.\nAfter receiving information about successful registration, an email is sent to the user confirming that the\nrepayment was registered.\nAfter repayment is registered, we asynchronously await the feedback from the bookkeeping system on the transaction\nbeing settled and the repayment is to be marked as completed.\nDesigning the state machine\nI could show you the finished state machine and just paste a wall of text here, describing what it does, but where’s\nthe fun in that?\nInstead, I’d like to show you the step-by-step process I would go through when designing this kind of state machine.\nI’ll start off by simply creating a state machine that handles a repayment of a single purchase and then extend it\nto work for all cases.\nFirst we need to define the base types for all states and events:\n\npublic abstract class StateBase\n{\n    public string UserId { get; init; }\n    public string RepaymentId { get; init; }\n    public string PaymentId { get; init; }\n\n    public StateBase(StateBase other)\n    {\n        if (other == null) return;\n\n        UserId = other.UserId;\n        RepaymentId = other.RepaymentId;\n        PaymentId = other.PaymentId;\n    }\n}\n\npublic abstract class EventBase { }\n\n\nAs you can see, I already equipped the base state with all the properties we will need later to orchestrate this\nprocess:\nUserId — tells us who is repaying,\nRepaymentId — uniquely identifies the repayment process,\nPaymentId — identifies the payment made by the user for this repayment.\nAs for the event base, we don’t need anything special there, so it’s empty.\nStateBase class features a copy constructor, which rewrites all properties from the previous state when creating\na new one.\nNone of the states will have any special properties, so there’s no point in painstakingly showing all individual\nsubclasses representing each state.\nHere are just a few sample classes of the initial state (NotStarted) and one of the subsequent states:\n\npublic class NotStarted : StateBase\n{\n    public NotStarted() : base(null) { }\n}\n\npublic class Created : StateBase\n{\n    public Created(StateBase other) : base(other) { }\n}\n\n\nAll of the remaining states are defined similarly to Created state.\nThose states are:\nPaid,\nFailed,\nRegistered,\nCompleted.\nOnce we have our states, we can focus on events and introduce transitions, one by one.\nWe’ll start by handling an online repayment.\nIt begins with the user creating a repayment entity by selecting a payment in the Allegro Pay dashboard.\nThis generates an event, let’s call it OnlineRepaymentCreated:\n\npublic class OnlineRepaymentCreated : EventBase\n{\n    public string UserId { get; init; }\n    public string RepaymentId { get; init; }\n    public string PaymentId { get; init; }\n}\n\n\nWe want this event to trigger a transition from NotStarted to Created state.\n\n// 1. NotStarted : OnlineRepaymentCreated -\u003e Created\nstateMachine\n    .FromState\u003cNotStarted\u003e()\n    .When\u003cOnlineRepaymentCreated\u003e()\n    .ToState\u003cCreated\u003e((from, @event) =\u003e new Created(from)\n    {\n        UserId = @event.UserId,\n        RepaymentId = @event.RepaymentId,\n        PaymentId = @event.PaymentId\n    });\n\n\nAt this point the user sees the repayment form, where they select a payment method.\nThey are then redirected to the payment provider’s website to finish the repayment.\nIn most cases it will succeed, but in some it fails due to a multitude of reasons, such as insufficient\nfunds on the account or the user providing wrong confirmation code.\nTherefore, we need two events:\n\npublic class OnlineRepaymentPaid : EventBase { }\n\npublic class OnlineRepaymentFailed : EventBase { }\n\n\nWe could go about a single event called RepaymentResult with an enum property indicating a success or a failure, but\nin my opinion the former approach is cleaner and more open to future changes.\nThese events will play a role in tranistions no. 2 and 3:\n\n// 2. Created : OnlineRepaymentPaid -\u003e Paid\nstateMachine\n    .FromState\u003cCreated\u003e()\n    .When\u003cOnlineRepaymentPaid\u003e()\n    .ToState\u003cPaid\u003e((from, @event) =\u003e new Paid(from))\n    .RunCommand((from, @event, to) =\u003e new RegisterPaymentCommand(to.PaymentId));\n\n// 3. Created : OnlineRepaymentFailed -\u003e Failed\nstateMachine\n    .FromState\u003cCreated\u003e()\n    .When\u003cOnlineRepaymentFailed\u003e()\n    .ToState\u003cFailed\u003e((from, @event) =\u003e new Failed(from));\n\n\nYou might notice that transition no. 2 has a command that I didn’t mention earlier specified.\nIt’s a simple class wrapping the payment identifier, which is interpreted by the command runner as a request to our\nbookkeeping system for registering this payment.\nThis concludes the online path and we can move on to the offline repayment.\nIt is significantly easier, since we are simply notified that the money has been transferred to us.\nBecause of this, we can completely skip the Created state and go straight to Paid.\nWe need an event called OfflineRepaymentPaid which contains the same properties as OnlineRepaymentCreated:\n\npublic class OfflineRepaymentPaid : EventBase\n{\n    public string UserId { get; init; }\n    public string RepaymentId { get; init; }\n    public string PaymentId { get; init; }\n}\n\n\nLet’s use it in the fourth transition that will once again call the registration command:\n\n// 4. NotStarted : OfflineRepaymentPaid -\u003e Paid\nstateMachine\n    .FromState\u003cNotStarted\u003e()\n    .When\u003cOfflineRepaymentPaid\u003e()\n    .ToState\u003cPaid\u003e((from, @event) =\u003e new Paid(from)\n    {\n        UserId = @event.UserId,\n        RepaymentId = @event.RepaymentId,\n        PaymentId = @event.PaymentId\n    })\n    .RunCommand((from, @event, to) =\u003e new RegisterPaymentCommand(@event.PaymentId));\n\n\nThis is where both repayment types merge and we can focus on our bookkeeping system.\nAs mentioned before, we are mostly interested in registration events published by the bookkeeping system.\n\npublic class PaymentRegistered : EventBase\n{\n    public string PaymentId { get; init; }\n}\n\n\nOnce we know that a payment is registered in our bookkeeping system, we are able to send an email to the user\nsummarizing what they paid for and follow-up information whether they still have more payments to be made.\nThis can be done with a transition like this:\n\n// 5. Paid : PaymentRegistered -\u003e Registered\nstateMachine\n    .FromState\u003cPaid\u003e()\n    .When\u003cPaymentRegistered\u003e()\n    .ToState\u003cRegistered\u003e((from, @event) =\u003e new Registered(from))\n    .RunCommand((from, @event, to) =\u003e new SendRepaymentRegisteredEmailCommand(to.UserId, to.RepaymentId));\n\n\nAgain, SendRepaymentRegisteredEmailCommand is a simple class wrapping two properties that will be interpreted by the\ncommand runner and result in an email sent to the user.\nThe last step is to wait for the final event PaymentCompleted.\nTheoretically it could be omitted in this state machine, but it’s useful for auditing purposes.\n\npublic class PaymentCompleted : EventBase\n{\n    public string PaymentId { get; init; }\n}\n\n\nIt’s time to create the final transition:\n\n// 6. Registered : PaymentCompleted -\u003e Completed\nstateMachine\n    .FromState\u003cRegistered\u003e()\n    .When\u003cPaymentCompleted\u003e()\n    .ToState\u003cCompleted\u003e((from, @event) =\u003e new Completed(from));\n\n\nAnd we’re done!\nRight?\nNot really.\nAs is usually the case with event-sourced systems, the order of incoming events can’t always be relied on.\nThe bookkeeping system will sometimes — for reasons I don’t want to delve into — publish events PaymentRegistered and\nPaymentCompleted at the same time.\nDue to a lack of message ordering guarantees, it’s possible for us to receive PaymentCompleted event before\nPaymentRegistered.\nThe current definition of the state machine is not prepared for that.\nFortunately, the fix is quite easy, as we can simply introduce two more transitions:\n\n// 7. Paid : PaymentCompleted -\u003e Completed\nstateMachine\n    .FromState\u003cPaid\u003e()\n    .When\u003cPaymentCompleted\u003e()\n    .ToState\u003cCompleted\u003e((from, @event) =\u003e new Completed(from));\n\n// 8. Completed : PaymentRegistered -\u003e Completed\nstateMachine\n    .FromState\u003cCompleted\u003e()\n    .When\u003cPaymentRegistered\u003e()\n    .ToState\u003cCompleted\u003e((from, @event) =\u003e new Completed(from))\n    .RunCommand((from, @event, to) =\u003e new SendRepaymentRegisteredEmailCommand(to.UserId, to.RepaymentId));\n\n\nIn this scenario we completely skip Registered state, but that’s something we just have to deal with.\nEvents are important from analytics and diagnostics standpoints, states — not so much.\nThat wraps up the event flow for this scenario.\nIt can be visualized with a diagram like this:\n\nOur state machine framework is equipped with a pretty useful visualisation extension.\nIt’s a pretty neat tool that makes it easy to figure out how the state machine works, without having to delve into the\ncode.\nA simple unit test that calls this extension can render a state machine diagram like one above using PlantUML\nsyntax, which in this case would go as follows:\n\n@startuml\nhide empty description\n[*] --\u003e NotStarted\nNotStarted --\u003e Created: \u003cb\u003eOnlineRepaymentCreated\u003c/b\u003e\nCreated --\u003e Paid: \u003cb\u003eOnlineRepaymentPaid\u003c/b\u003e\\n\u003ci\u003ethen:\u003c/i\u003e RegisterPaymentCommand\nCreated --\u003e Failed: \u003cb\u003eOnlineRepaymentFailed\u003c/b\u003e\nNotStarted --\u003e Paid: \u003cb\u003eOfflineRepaymentPaid\u003c/b\u003e\\n\u003ci\u003ethen:\u003c/i\u003e RegisterPaymentCommand\nPaid --\u003e Registered: \u003cb\u003ePaymentRegistered\u003c/b\u003e\\n\u003ci\u003ethen:\u003c/i\u003e SendRepaymentRegisteredEmailCommand\nRegistered --\u003e Completed: \u003cb\u003ePaymentCompleted\u003c/b\u003e\nPaid --\u003e Completed: \u003cb\u003ePaymentCompleted\u003c/b\u003e\nCompleted --\u003e Completed: \u003cb\u003ePaymentRegistered\u003c/b\u003e\\n\u003ci\u003ethen:\u003c/i\u003e SendRepaymentRegisteredEmailCommand\n@enduml\n\n\nHowever, recall that this is just a state machine to handle a repayment for a single payment selected by the user.\nI promised we would extend it to handle multiple payments.\nLet’s do that.\nFirst we’ll extend the base state definition:\n\npublic abstract class StateBase\n{\n    public string UserId { get; init; }\n    public string RepaymentId { get; init; }\n    public HashSet\u003cstring\u003e PaymentIds { get; init; }\n    public HashSet\u003cstring\u003e RegisteredPaymentIds { get; init; }\n    public HashSet\u003cstring\u003e CompletedPaymentIds { get; init; }\n\n    public StateBase(StateBase other)\n    {\n        if (other == null) return;\n\n        UserId = other.UserId;\n        RepaymentId = other.RepaymentId;\n        PaymentIds = new HashSet\u003cstring\u003e(other.PaymentIds);\n        RegisteredPaymentIds = new HashSet\u003cstring\u003e(other.RegisteredPaymentIds);\n        CompletedPaymentIds = new HashSet\u003cstring\u003e(other.CompletedPaymentIds);\n    }\n}\n\n\nThree things have changed:\nPaymentId changed from a string to a HashSet\u003cstring\u003e and is now called PaymentIds to represent multiple\npayments selected by the user,\na HashSet\u003cstring\u003e called RegisteredPaymentIds was added to keep track of registered payments,\na HashSet\u003cstring\u003e called CompletedPaymentIds was added to keep track of completed payments.\nWe also have to modify OnlineRepaymentCreated event by introducing a collection of payment identifiers, like so:\n\npublic class OnlineRepaymentCreated : EventBase\n{\n    public string UserId { get; init; }\n    public string RepaymentId { get; init; }\n    public IEnumerable\u003cstring\u003e PaymentIds { get; init; }\n}\n\n\nBecause of this, we need to introduce a small change to transition no. 1:\n\n// 1'. NotStarted : OnlineRepaymentCreated -\u003e Created\nstateMachine\n    .FromState\u003cNotStarted\u003e()\n    .When\u003cOnlineRepaymentCreated\u003e()\n    .ToState\u003cCreated\u003e((from, @event) =\u003e new Created(from)\n    {\n        UserId = @event.UserId,\n        RepaymentId = @event.RepaymentId,\n        PaymentIds = new HashSet\u003cstring\u003e(@event.PaymentIds)\n    });\n\n\nTransition no. 2 is similarly adjusted to these changes by passing the set of payment identifiers to the\nbookkeeping system:\n\n(from, @event, to) =\u003e new RegisterPaymentsCommand(to.PaymentIds)\n\n\nNow we can move to the remaining transitions.\nTransition no. 5 has to be split into two.\nWe want to stay in the Paid state until all registration events are received and only then switch to Registered.\nThis can be achieved with:\n\n// 5'. Paid : PaymentRegistered -\u003e Paid\nstateMachine\n    .FromState\u003cPaid\u003e()\n    .When\u003cPaymentRegistered\u003e((from, @event) =\u003e !from.PaymentIds.All(\n        id =\u003e from.RegisteredPaymentIds.Contains(id) || id == @event.PaymentId))\n    .ToState\u003cPaid\u003e((from, @event) =\u003e\n    {\n        var to = new Paid(from);\n        to.RegisteredPaymentIds.Add(@event.PaymentId);\n        return to;\n    });\n\n// 5''. Paid : PaymentRegistered -\u003e Registered\nstateMachine\n    .FromState\u003cPaid\u003e()\n    .When\u003cPaymentRegistered\u003e((from, @event) =\u003e from.PaymentIds.All(\n        id =\u003e from.RegisteredPaymentIds.Contains(id) || id == @event.PaymentId))\n    .ToState\u003cRegistered\u003e((from, @event) =\u003e\n    {\n        var to = new Registered(from);\n        to.RegisteredPaymentIds.Add(@event.PaymentId);\n        return to;\n    });\n    .RunCommand((from, @event, to) =\u003e new SendRepaymentRegisteredEmailCommand(to.UserId, to.RepaymentId));\n\n\nAs you can see, the command is now defined only for the second transition that triggers after all payments are\nregistered.\nWe have to slightly adjust transition no. 8, which is responsible for sending the email, too:\n\n// 8'. Completed : PaymentRegistered -\u003e Completed\nstateMachine\n    .FromState\u003cCompleted\u003e()\n    .When\u003cPaymentRegistered\u003e()\n    .ToState\u003cCompleted\u003e((from, @event) =\u003e\n    {\n        var to = new Completed(from);\n        to.RegisteredPaymentIds.Add(@event.PaymentId);\n        return to;\n    })\n    .RunCommand(\n        when: (from, @event, to) =\u003e to.PaymentIds.SetEquals(to.RegisteredPaymentIds),\n        then: (from, @event, to) =\u003e new SendRepaymentRegisteredEmailCommand(to.UserId, to.RepaymentId));\n\n\nThis time the transition is not conditional, however the command is.\nIt will execute only after we handle final registration event and the payment identifier sets PaymentIds and\nRegisteredPaymentIds become equal.\nWe cannot forget about all transitions that are triggered by PaymentCompleted event.\nThose will have to be changed like so:\n\n// 6'. Registered : PaymentCompleted -\u003e Registered\nstateMachine\n    .FromState\u003cRegistered\u003e()\n    .When\u003cPaymentCompleted\u003e((from, @event) =\u003e !from.PaymentIds.All(\n        id =\u003e from.CompletedPaymentIds.Contains(id) || id == @event.PaymentId))\n    .ToState\u003cRegistered\u003e((from, @event) =\u003e\n    {\n        var to = new Registered(from);\n        to.CompletedPaymentIds.Add(@event.PaymentId);\n        return to;\n    });\n\n// 6''. Registered : PaymentCompleted -\u003e Completed\nstateMachine\n    .FromState\u003cRegistered\u003e()\n    .When\u003cPaymentCompleted\u003e((from, @event) =\u003e from.PaymentIds.All(\n        id =\u003e from.CompletedPaymentIds.Contains(id) || id == @event.PaymentId))\n    .ToState\u003cCompleted\u003e((from, @event) =\u003e\n    {\n        var to = new Completed(from);\n        to.CompletedPaymentIds.Add(@event.PaymentId);\n        return to;\n    });\n\n// 7'. Paid : PaymentCompleted -\u003e Paid\nstateMachine\n    .FromState\u003cPaid\u003e()\n    .When\u003cPaymentCompleted\u003e((from, @event) =\u003e !from.PaymentIds.All(\n        id =\u003e from.CompletedPaymentIds.Contains(id) || id == @event.PaymentId))\n    .ToState\u003cCompleted\u003e((from, @event) =\u003e\n    {\n        var to = new Completed(from);\n        to.CompletedPaymentIds.Add(@event.PaymentId);\n        return to;\n    });\n\n// 7''. Paid : PaymentCompleted -\u003e Completed\nstateMachine\n    .FromState\u003cPaid\u003e()\n    .When\u003cPaymentCompleted\u003e((from, @event) =\u003e from.PaymentIds.All(\n        id =\u003e from.CompletedPaymentIds.Contains(id) || id == @event.PaymentId))\n    .ToState\u003cCompleted\u003e((from, @event) =\u003e\n    {\n        var to = new Completed(from);\n        to.CompletedPaymentIds.Add(@event.PaymentId);\n        return to;\n    });\n\n\nAnd we’re done!\nThis time for real.\nAfter all this work we ended up with something that can be visualized with a diagram like this:\n\nI mentioned earlier that we have internal back-office tools to view state machines and their transition history.\nHere is an example view of a repayment process that was coordinated with the state machine we defined above (sensitive\ndata was redacted, since this was taken in production):\n\nCaveats\nYou may have noticed some problems here.\nWhat would happen if we received an event with a wrong payment identifier?\nRight now the state machine is not ready for that.\nHowever, that can be remedied relatively easily by adding another condition to When methods of all transitions for\nPaymentRegistered and PaymentCompleted events, such as:\n\n.When((from, @event) =\u003e from.PaymentIds.Contains(@event.PaymentId) \u0026\u0026 /* ... */)\n\n\nThis would essentialy ensure that we react only to events with correct identifiers.\nAnd what about retries and duplicated events?\nTransition no. 8’ is especially susceptible to that, because it may result in the email being sent to the user twice.\nAnd we don’t want that!\nFortunately, achieving deduplication is just as easy — we have to ignore events for payments that are already\nregistered:\n\n.When((from, @event) =\u003e !from.RegisteredPaymentIds.Contains(@event.PaymentId) \u0026\u0026 /* ... */)\n\n\nFor the sake of readability I also decided to skip a lot of other validations, which would otherwise have to be there,\nsuch as simple null checks.\nHow to test\nTesting state machines is important, because, well, ideally all code should be tested.\nIn this case, apart from the usual assurance that we are able to handle both happy paths and edge cases, we can also\nensure that we keep the transitions backwards compatible.\nAn event that is once inserted into the stream will stay there forever.\nWe developed a simple DSL in F# to help us test state machines created with our framework.\nThis is a perfect solution to test a declarative definition of a state machine like the one we developed in this post.\nHere’s an example of a happy path test for our state machine:\n\n[\u003cFact\u003e]\nlet ``Online repayment - single payment happy path`` () =\n    [\n        When(Events.OnlineRepaymentCreated (\"paymentId1\"))\n            |\u003e GoToState\u003cCreated\u003e\n            |\u003e DoNothing\n        When(Events.OnlineRepaymentPaid ())\n            |\u003e GoToState\u003cPaid\u003e\n            |\u003e Do\u003cRegisterPaymentsCommand\u003e\n        When(Events.PaymentRegistered (\"paymentId1\"))\n            |\u003e GoToState\u003cRegistered\u003e\n            |\u003e Do\u003cSendRepaymentRegisteredEmailCommand\u003e\n        When(Events.PaymentCompleted (\"paymentId1\"))\n            |\u003e GoToState\u003cCompleted\u003e\n            |\u003e DoNothing\n    ]\n    |\u003e apply\n\n\nA test like this is essentially a list of events with expected side effects that are then aggregated using the apply\nfunction that feeds them one by one into the state machine and verifies the outcome.\nSummary\nI hope I was able to convince you how a framework like this can make designing complex state machines easy.\nIt provides numerous advantages, such as declarative syntax, effortless testability, thorough instrumentation and\nvisualization.\nThis is precisely why state machines became an integral part of pretty much every business process architecture\nin our project.\nHaving such a robust and scalable solution for asynchronous process orchestration and isolation is crucial in\ndistributed systems.\nThe presented code, albeit extremely simplified, is from an actual state machine — one of many used in our\napplications.\nWhile the presented solution is a strictly internal framework right now, who knows what the future might bring?\nStay tuned!","guid":"https://blog.allegro.tech/2021/03/state-machines-made-easy.html","categories":["tech","dotnet","state_machine","allegro_pay"],"isoDate":"2021-03-04T23:00:00.000Z","thumbnail":"images/post-headers/default.jpg"},{"title":"My first days at Allegro","link":"https://blog.allegro.tech/2021/02/first-days-at-allegro.html","pubDate":"Mon, 15 Feb 2021 00:00:00 +0100","authors":{"author":[{"name":["Krzysztof Przychodzki"],"photo":["https://blog.allegro.tech/img/authors/krzysztof.przychodzki.jpg"],"url":["https://blog.allegro.tech/authors/krzysztof.przychodzki"]}]},"content":"\u003cp\u003eSo you’re new to \u003ca href=\"https://blog.allegro.tech/about-us/\"\u003eAllegro\u003c/a\u003e, have just finished your tech onboarding and are stunned with information overflow? Or perhaps you\nare planning to join Allegro and don’t know what it looks like in here? I am about to try and describe how I felt just a few months ago and what startled or\ndismayed me. I hope this short article will answer all your concerns.\u003c/p\u003e\n\n\u003cp\u003eBut first I would like to give you a little background of my professional work life.\u003c/p\u003e\n\n\u003ch2 id=\"background\"\u003eBackground\u003c/h2\u003e\n\n\u003cp\u003eLong before becoming a developer, I was a chemical engineer, and I was designing distilleries, cosmetic and oil refinery plants, etc. During my work, I often\nused Microsoft Excel and VBA as my main apps for solving complex problems. I enjoyed it more than the job I was assigned. So I decided to take a Java bootcamp\nand afterwards I got hired by an IT company in my area. At my first IT job, I was hired as a junior, but I was already treated as a regular programmer.\nIt was nice, I owe them a lot, but on the other hand the only feedback I got was when something was not working. From the beginning, I was fully aware of how\nbasic my knowledge was after the bootcamp. While catching up I realized that at this company I would not develop anymore, and I would be working with legacy\ntechnologies throughout the rest of my career.\u003c/p\u003e\n\n\u003ch2 id=\"a-piece-of-cake\"\u003eA piece of cake?\u003c/h2\u003e\n\n\u003cp\u003eThe recruitment process at Allegro — let me tell you straight, is not a piece of cake. I am pretty sure that a year after the recruitment meeting you are\nstill going to remember the questions you were torpedoed with.\u003c/p\u003e\n\n\u003cp\u003eFirst of all — after applying, you will receive an email with all the necessary information about the recruitment process. Each step is briefly\ncharacterized, so you know what is going to happen next and what to expect. The first step is a task on DevSkiller. Then, you will take part in technical\ninterviews in the form of conversation about the technologies and architecture of modern IT systems, touching on aspects of design, performance, monitoring, etc.\nIt was very different from the previous recruitment processes in which I sometimes spoke to people who had no clue what I was talking about. At Allegro I really\nappreciate that these meetings are with real professionals! What is more, during my recruitments I have never encountered such a human approach. They treat you\nlike a human, not like a robot. That’s cool. In the last step you will meet with a team leader and people from HR.\u003c/p\u003e\n\n\u003ch2 id=\"first-days\"\u003eFirst days\u003c/h2\u003e\n\n\u003cp\u003eMy first days at Allegro — what a rollercoaster, considering the current coronavirus situation. Onboarding normally takes 3 days and is conducted at the\ncompany’s headquarters in Poznań. There is another two-day long technical onboarding for technical employees at the workplace. However, due to the COVID-19\nsituation, the entire onboarding process was carried out remotely. This tech onboarding is conducted with a workshop on how to create a new service and\neverything that goes with it like deploying, running and maintaining. I understood why (this was not possible remotely), but it is a pity that it did not take\nplace. Fortunately, everybody wants to help you with any issue you have — and this is the great power of Allegro: people and their readiness to help.\nIt is natural for everyone that a new person needs support and time to get to know the organization. Moreover, if you are a junior like me, and have never\nwritten a line of code for example in Kotlin, you can spend some time learning a new programming language and everybody is okay with that.\u003c/p\u003e\n\n\u003cp\u003eSomeone might ask: What is difficult in the beginning? That depends, because everything is new. I work in a team responsible for Allegro Smart! loyalty\nprogramme — ensuring proper marking of offers qualified for free delivery — so the most confusing thing for me was the business complexity of those\nprocesses.\u003c/p\u003e\n\n\u003cp\u003eNevertheless, there are over 1200 microservices communicating with each other — a status quo you have to deal with. Thousands of decisions were made and\na lot of them don’t sound reasonable when you first hear about them, but after a day passes, everything starts to clarify. I think this is what everyone deals\nwith when they come to a new place.\u003c/p\u003e\n\n\u003ch2 id=\"somebody-is-reading-my-code\"\u003eSomebody is reading my code\u003c/h2\u003e\n\n\u003cp\u003eOne of my favorite things at Allegro is code review. Virtually nothing gets merged unless it is reviewed and approved. Code review is mandatory and necessary\n— reading others’ code is not only about finding bugs, it is mainly to provide code that is clear, understandable, and maintainable. For me, it is mainly\nfor learning and better understanding our services and business domain.\u003c/p\u003e\n\n\u003cp\u003eAnother great thing is pair programming. During these sessions it is easier to understand the business domain and to catch the wider context of our services.\u003c/p\u003e\n\n\u003ch2 id=\"unit-integration-and-end-to-end-testing\"\u003eUnit, integration, and end-to-end testing\u003c/h2\u003e\n\n\u003cp\u003eAs I wrote, unreviewed code will not be deployed to production and without tests it is not going to pass the review. At Allegro, each change in code needs\nto be tested. We write unit and integration tests, and we work with two test environments.\u003c/p\u003e\n\n\u003cp\u003eOne is totally a developer’s playground where you make your ‘little Allegro’. It is called phoenix. Every team has its own phoenix env for\nexperiments. However, it has some issues. Since there are so many dependencies to other services, your already set up environment may not work properly until it\nis manually updated. So a very common situation is that before you start testing your change, you need to spend some time to get the whole environment working.\nThis is frustrating, especially in the beginning.\u003c/p\u003e\n\n\u003cp\u003eThe second one is a pre-prod sandbox — it is like normal Allegro, but unlike the dev environment, the sandbox is more consistent and works almost like\nprod. So there are a lot of possibilities to test your change and it’s good to have this feeling of confidence.\u003c/p\u003e\n\n\u003cp\u003eSometimes despite all these tests, code reviews, etc. a mistake happens — the app is already deployed to production, and our clients are complaining.\nWe have to act quickly to fix the error. I really appreciate that we look for bugs, not the guilty party. When somebody makes a mistake, we don’t blame each\nother, but we look for the best solution to the problem and fix it.\u003c/p\u003e\n\n\u003ch2 id=\"hack-the-day\"\u003eHack the day\u003c/h2\u003e\n\n\u003cp\u003eSometimes teams do internal hackathons (called fedex-days) — we divide into two or three teams and we work on subjects that we choose. We want\nto try a new programming language — we just do it; make an application for sharing memes — perfectly fine; write an extension for Slack — why\nnot, go have some fun! Usually, we spend two working days getting off work. That’s very refreshing.\u003c/p\u003e\n\n\u003cp\u003eI also know that once in a while there are hackathons for the whole Allegro — but I didn’t have a chance to participate.\u003c/p\u003e\n\n\u003ch2 id=\"dobrze-tu-być\"\u003eDobrze tu być?\u003c/h2\u003e\n\n\u003cp\u003eAt Allegro we all understand the great importance of ensuring the code we are working on is of the highest quality. We care about our services to the point\nwhere we sometimes spend hours discussing if it is better to throw an exception or just 404?\u003c/p\u003e\n\n\u003cp\u003eHowever, Allegro is not only about programming, it is a place with a lot of experts in many other disciplines — and every one of us has a straightforward\ngoal to make Allegro the best place/platform not only for shoppers and sellers, but also for each other.\u003c/p\u003e\n\n\u003cp\u003eHope you enjoyed this article. I know it sounds like a chorus of praise, but in my situation it arises from my work experiences — for me, it is really a\n“Good to be here!” place. Or as we say \u003ca href=\"https://www.linkedin.com/company/allegro-pl/life/team\"\u003e#dobrzetubyć\u003c/a\u003e.\u003c/p\u003e\n","contentSnippet":"So you’re new to Allegro, have just finished your tech onboarding and are stunned with information overflow? Or perhaps you\nare planning to join Allegro and don’t know what it looks like in here? I am about to try and describe how I felt just a few months ago and what startled or\ndismayed me. I hope this short article will answer all your concerns.\nBut first I would like to give you a little background of my professional work life.\nBackground\nLong before becoming a developer, I was a chemical engineer, and I was designing distilleries, cosmetic and oil refinery plants, etc. During my work, I often\nused Microsoft Excel and VBA as my main apps for solving complex problems. I enjoyed it more than the job I was assigned. So I decided to take a Java bootcamp\nand afterwards I got hired by an IT company in my area. At my first IT job, I was hired as a junior, but I was already treated as a regular programmer.\nIt was nice, I owe them a lot, but on the other hand the only feedback I got was when something was not working. From the beginning, I was fully aware of how\nbasic my knowledge was after the bootcamp. While catching up I realized that at this company I would not develop anymore, and I would be working with legacy\ntechnologies throughout the rest of my career.\nA piece of cake?\nThe recruitment process at Allegro — let me tell you straight, is not a piece of cake. I am pretty sure that a year after the recruitment meeting you are\nstill going to remember the questions you were torpedoed with.\nFirst of all — after applying, you will receive an email with all the necessary information about the recruitment process. Each step is briefly\ncharacterized, so you know what is going to happen next and what to expect. The first step is a task on DevSkiller. Then, you will take part in technical\ninterviews in the form of conversation about the technologies and architecture of modern IT systems, touching on aspects of design, performance, monitoring, etc.\nIt was very different from the previous recruitment processes in which I sometimes spoke to people who had no clue what I was talking about. At Allegro I really\nappreciate that these meetings are with real professionals! What is more, during my recruitments I have never encountered such a human approach. They treat you\nlike a human, not like a robot. That’s cool. In the last step you will meet with a team leader and people from HR.\nFirst days\nMy first days at Allegro — what a rollercoaster, considering the current coronavirus situation. Onboarding normally takes 3 days and is conducted at the\ncompany’s headquarters in Poznań. There is another two-day long technical onboarding for technical employees at the workplace. However, due to the COVID-19\nsituation, the entire onboarding process was carried out remotely. This tech onboarding is conducted with a workshop on how to create a new service and\neverything that goes with it like deploying, running and maintaining. I understood why (this was not possible remotely), but it is a pity that it did not take\nplace. Fortunately, everybody wants to help you with any issue you have — and this is the great power of Allegro: people and their readiness to help.\nIt is natural for everyone that a new person needs support and time to get to know the organization. Moreover, if you are a junior like me, and have never\nwritten a line of code for example in Kotlin, you can spend some time learning a new programming language and everybody is okay with that.\nSomeone might ask: What is difficult in the beginning? That depends, because everything is new. I work in a team responsible for Allegro Smart! loyalty\nprogramme — ensuring proper marking of offers qualified for free delivery — so the most confusing thing for me was the business complexity of those\nprocesses.\nNevertheless, there are over 1200 microservices communicating with each other — a status quo you have to deal with. Thousands of decisions were made and\na lot of them don’t sound reasonable when you first hear about them, but after a day passes, everything starts to clarify. I think this is what everyone deals\nwith when they come to a new place.\nSomebody is reading my code\nOne of my favorite things at Allegro is code review. Virtually nothing gets merged unless it is reviewed and approved. Code review is mandatory and necessary\n— reading others’ code is not only about finding bugs, it is mainly to provide code that is clear, understandable, and maintainable. For me, it is mainly\nfor learning and better understanding our services and business domain.\nAnother great thing is pair programming. During these sessions it is easier to understand the business domain and to catch the wider context of our services.\nUnit, integration, and end-to-end testing\nAs I wrote, unreviewed code will not be deployed to production and without tests it is not going to pass the review. At Allegro, each change in code needs\nto be tested. We write unit and integration tests, and we work with two test environments.\nOne is totally a developer’s playground where you make your ‘little Allegro’. It is called phoenix. Every team has its own phoenix env for\nexperiments. However, it has some issues. Since there are so many dependencies to other services, your already set up environment may not work properly until it\nis manually updated. So a very common situation is that before you start testing your change, you need to spend some time to get the whole environment working.\nThis is frustrating, especially in the beginning.\nThe second one is a pre-prod sandbox — it is like normal Allegro, but unlike the dev environment, the sandbox is more consistent and works almost like\nprod. So there are a lot of possibilities to test your change and it’s good to have this feeling of confidence.\nSometimes despite all these tests, code reviews, etc. a mistake happens — the app is already deployed to production, and our clients are complaining.\nWe have to act quickly to fix the error. I really appreciate that we look for bugs, not the guilty party. When somebody makes a mistake, we don’t blame each\nother, but we look for the best solution to the problem and fix it.\nHack the day\nSometimes teams do internal hackathons (called fedex-days) — we divide into two or three teams and we work on subjects that we choose. We want\nto try a new programming language — we just do it; make an application for sharing memes — perfectly fine; write an extension for Slack — why\nnot, go have some fun! Usually, we spend two working days getting off work. That’s very refreshing.\nI also know that once in a while there are hackathons for the whole Allegro — but I didn’t have a chance to participate.\nDobrze tu być?\nAt Allegro we all understand the great importance of ensuring the code we are working on is of the highest quality. We care about our services to the point\nwhere we sometimes spend hours discussing if it is better to throw an exception or just 404?\nHowever, Allegro is not only about programming, it is a place with a lot of experts in many other disciplines — and every one of us has a straightforward\ngoal to make Allegro the best place/platform not only for shoppers and sellers, but also for each other.\nHope you enjoyed this article. I know it sounds like a chorus of praise, but in my situation it arises from my work experiences — for me, it is really a\n“Good to be here!” place. Or as we say #dobrzetubyć.","guid":"https://blog.allegro.tech/2021/02/first-days-at-allegro.html","categories":["tech"],"isoDate":"2021-02-14T23:00:00.000Z","thumbnail":"images/post-headers/default.jpg"},{"title":"Implement stateless authentication like a pro using OAuth: A 100% correct approach","link":"https://blog.allegro.tech/2021/02/oauth-stateless-login.html","pubDate":"Mon, 01 Feb 2021 00:00:00 +0100","authors":{"author":[{"name":["Karol Kuc"],"photo":["https://blog.allegro.tech/img/authors/karol.kuc.jpg"],"url":["https://blog.allegro.tech/authors/karol.kuc"]}]},"content":"\u003cp\u003eMany of us spend most of their software development careers improving and extending applications protected by pre-existing security mechanisms. That’s why\nwe rarely address problems related directly to authentication and authorization unless we build apps from scratch.\nRegardless of your experience I still hope you will find this article interesting.\nIt’s not meant to be a tutorial. I would like to focus on clarifying basic concepts and highlighting common misconceptions.\u003c/p\u003e\n\n\u003ch4 id=\"alpha-disclaimer\"\u003eAlpha disclaimer:\u003c/h4\u003e\n\u003cp\u003eSorry to disappoint you, but the title of this article is just a cheap click-bait.\nIt doesn’t matter whether you started reading because you disagree with\nthe title or because you hoped to find the holy grail\nof securing web applications. There is a chance you will find something for yourself anyway.\u003c/p\u003e\n\n\u003ch4 id=\"beta-disclaimer\"\u003eBeta disclaimer:\u003c/h4\u003e\n\u003cp\u003eThis post is not meant to answer the “how does the login with Facebook work“ question.\nWe will spend some time on it, but just to provoke a discussion, not to go through a tutorial.\u003c/p\u003e\n\n\u003ch4 id=\"gamma-disclaimer\"\u003eGamma disclaimer:\u003c/h4\u003e\n\u003cp\u003eI have never built a full-fledged auth process from scratch myself in a commercial web app.\nI’m no security expert, so you read at your own risk.\u003c/p\u003e\n\n\u003ch2 id=\"authentication-vs-authorization\"\u003eAuthentication vs Authorization\u003c/h2\u003e\n\u003cp\u003eWow! If you are still reading, cool!\nLet’s start with a short recap on these two basic concepts. Authentication is about verifying \u003cstrong\u003ewho you are\u003c/strong\u003e.\nYou need to prove your identity, that’s all. You may authenticate, for example, by using a password or your fingerprint.\nYou may need to use a token (hard or soft), an authentication-app-generated code or a text message sent to your phone number.\nI hope you tend to use at least two of these. Anyway, once you’ve done it, you are in.\u003c/p\u003e\n\n\u003cp\u003e\u003cimg src=\"/img/articles/2021-02-01-oauth-stateless-login/password.png\" alt=\"Say the password and enter\" /\u003e\u003c/p\u003e\n\n\u003cp\u003eAuthorization is about verifying \u003cem\u003ewhat you are allowed to do\u003c/em\u003e. I’m not going to copy-paste bookish definitions here. For example, when entering a university library, you authenticate by presenting your ID.\nThe librarian checks the authenticity of the document and analyzes whether you are the one on the photograph or not.\nThe authorization process starts right away.\nTo keep things simple, the librarian checks, based on your confirmed identity, whether you are a professor or a student. This implies which books you can borrow and how many you can take home.\nThis is where the privileges or permissions come into play.\u003c/p\u003e\n\n\u003cp\u003e\u003cimg src=\"/img/articles/2021-02-01-oauth-stateless-login/authorization.jpeg\" alt=\"But only if you are a friend\" /\u003e\u003c/p\u003e\n\n\u003cp\u003eIf you are already bored with the most obvious meme I could use, let me give you another obvious example of authorization.\nWhen entering a military zone, you also present your ID for authentication. You can’t get in unless you ARE, e.g. a military officer. It’s not the authentication that failed then.\nThe guardian knows who you are now.\nYou are forbidden to enter as you have not been granted such an authority.\u003c/p\u003e\n\n\u003cp\u003eOne last meme, I promise.\u003c/p\u003e\n\n\u003cp\u003e\u003cimg src=\"/img/articles/2021-02-01-oauth-stateless-login/authority_not_granted.png\" alt=\"Authority is not granted to you\" /\u003e\u003c/p\u003e\n\n\u003ch2 id=\"oauth-20-why-is-it-not-about-authenticating-the-user\"\u003eOAuth 2.0: why is it not about authenticating the user?\u003c/h2\u003e\n\n\u003cp\u003eI started with the above trivia because the concepts of authorization and authentication are mingled so often that, even when you know them, you may still get a headache\nwhen reading about OAuth (from now on, I will omit the 2.0 specification version).\u003c/p\u003e\n\n\u003cp\u003eWhat is OAuth? I hate copy-pasting definitions from official docs and other blogs. What I hate even more is copy-pasting them, rephrasing and selling as my own.\nSo, unless you already did, please stop reading and check out the \u003ca href=\"https://tools.ietf.org/html/rfc6749\"\u003edocs\u003c/a\u003e, \u003ca href=\"https://oauth.net/2/\"\u003ethis website\u003c/a\u003e and then \u003ca href=\"https://auth0.com/docs/protocols/protocol-oauth2\"\u003ethe auth0 website\u003c/a\u003e. If you liked the latter, you may also check out \u003ca href=\"https://auth0.com/blog/\"\u003etheir blog\u003c/a\u003e in general.\nI assume you’ve read the suggested docs so I will move on to using the traditional OAuth lingo (grants, flows, resources, third-party servers etc).\u003c/p\u003e\n\n\u003ch3 id=\"oauth-flows-revisited\"\u003eOAuth flows revisited\u003c/h3\u003e\n\u003cp\u003eThe OAuth specification describes this framework as available in \u003ca href=\"https://tools.ietf.org/html/rfc6749#section-1.3\"\u003efour flavours\u003c/a\u003e:\u003c/p\u003e\n\u003cul\u003e\n  \u003cli\u003eAuthorization Code\u003c/li\u003e\n  \u003cli\u003eImplicit\u003c/li\u003e\n  \u003cli\u003eResource Owner Credentials\u003c/li\u003e\n  \u003cli\u003eClient Credentials\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eSo 2012.\u003c/p\u003e\n\n\u003cp\u003e\u003cimg src=\"/img/articles/2021-02-01-oauth-stateless-login/i-built-a-time-machine-to-travel-through-time.jpg\" alt=\"Ten years later\" /\u003e\u003c/p\u003e\n\n\u003cp\u003eThe \u003ca href=\"https://auth0.com/docs/flows/resource-owner-password-flow\"\u003eResource Owner Credentials\u003c/a\u003e (User Credentials) flow is already legacy and \u003ca href=\"https://tools.ietf.org/html/draft-ietf-oauth-security-topics-13#section-3.4\"\u003eofficially banned by IETF\u003c/a\u003e.\n    The latest OAuth 2.0 Security Best Current Practice disallows the password grant entirely.\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://oauth.net/2/grant-types/password/\"\u003eSource\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eThe same applies to the \u003ca href=\"https://oauth.net/2/grant-types/implicit/\"\u003eImplicit\u003c/a\u003e flow, also discouraged in its \u003ca href=\"https://tools.ietf.org/html/rfc6749#section-1.3.2\"\u003eoriginal form\u003c/a\u003e.\nSome experts analyze whether it is already \u003ca href=\"https://developer.okta.com/blog/2019/05/01/is-the-oauth-implicit-flow-dead\"\u003edead\u003c/a\u003e or not.\nIn the following two \u003cem\u003e“login with..“\u003c/em\u003e examples you should understand OAuth as limited to the \u003ca href=\"https://auth0.com/docs/flows/authorization-code-flow\"\u003eAuthorization Code\u003c/a\u003e grant. The \u003ca href=\"https://auth0.com/docs/flows/client-credentials-flow\"\u003eClient Credentials\u003c/a\u003e grant is a completely different story, handled\nin a further part of the article.\u003c/p\u003e\n\n\u003ch3 id=\"its-hello-world-time\"\u003eIt’s \u003cstrong\u003eHello World\u003c/strong\u003e Time\u003c/h3\u003e\n\u003cp\u003eI prefer to think of OAuth as a set of guidelines and best practices that help you solve a common problem related to authorization, as opposed to a strict framework or protocol.\nThis common problem may be for instance the following. Damn, how the hell did these guys implement the cool \u003cem\u003elog in with Facebook\u003c/em\u003e feature in their app (not so cool anymore, let’s be honest it’s 2021 not 2015).\nLet’s call this app fb64.com .\nTo be precise, how did those guys use the Facebook API to delegate the process of asking the user whether or not fb64.com can access some of their Facebook account data?\nYou may find an analogous scenario described in virtually EVERY SINGLE blog post referring to OAuth, but there is a good reason why I do it here too. I use it because it sucks and introduces misunderstandigs regarding real-life\n\u003cstrong\u003edelegated authorization\u003c/strong\u003e and \u003cstrong\u003elog in with a third party identity provider\u003c/strong\u003e scenarios.\nLet’s consider the dumbest example ever.\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003eThe \u003cem\u003eresource\u003c/em\u003e is your Facebook wall and everything you’ve posted on it.\u003c/li\u003e\n  \u003cli\u003eThe \u003cem\u003eresource owner\u003c/em\u003e is, well, just you.\u003c/li\u003e\n  \u003cli\u003eThe \u003cem\u003eresource server\u003c/em\u003e is Facebook.\u003c/li\u003e\n  \u003cli\u003eThe \u003cem\u003eclient\u003c/em\u003e is the fb64.com app. Its cool feature is presenting your 10 recent posts\nas Base64 encoded strings.\u003c/li\u003e\n  \u003cli\u003eThe \u003cem\u003eauthorization server\u003c/em\u003e is also Facebook itself.\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e\u003cimg src=\"/img/articles/2021-02-01-oauth-stateless-login/legit.jpg\" alt=\"Phishing level master\" /\u003e\u003c/p\u003e\n\n\u003cp\u003eSo, in the above scenario, you get the cool feature without giving these guys your Facebook login and password. When you are redirected to the Facebook login page\nfirst you give your consent for fb64.com to access a specific subset of your profile data. Next you type in your credentials (you send them to facebook.com, not to fb64.com) and\nwhen you get redirected back to fb64.com you are already logged-in and see an awesome black-and-white website with your Base64 encoded posts.\u003c/p\u003e\n\n\u003cp\u003eWhat have you done? You’ve \u003cstrong\u003egranted\u003c/strong\u003e some \u003cstrong\u003eclient\u003c/strong\u003e app access to your \u003cstrong\u003eprotected resource\u003c/strong\u003e data without sharing your \u003cstrong\u003ecredentials\u003c/strong\u003e with it. Full stop.\u003c/p\u003e\n\n\u003cp\u003eBut is that what we meant? Is that the kind of \u003cstrong\u003eresource sharing\u003c/strong\u003e and \u003cstrong\u003edelegated authorization\u003c/strong\u003e you expect when you want to, for example, log in to Booking, via Facebook, to book a hotel room but don’t want to set up an account?\u003c/p\u003e\n\n\u003cp\u003e\u003cimg src=\"/img/articles/2021-02-01-oauth-stateless-login/no-no-no-thank-you.jpg\" alt=\"Thanks but thanks\" /\u003e\u003c/p\u003e\n\n\u003ch3 id=\"its-real-life-scenario-time\"\u003eIt’s \u003cstrong\u003eReal Life Scenario\u003c/strong\u003e Time\u003c/h3\u003e\n\n\u003cp\u003eLet’s come up with a more \u003cem\u003ereal-life-ish\u003c/em\u003e scenario.\nWhen you choose a \u003cstrong\u003ethird party identity provider login\u003c/strong\u003e you probably expect to get an account without wasting time to sign-up and come up with Yet Another Password.\nBefore you click \u003cem\u003econtinue as John Smith\u003c/em\u003e you are assured that:\u003c/p\u003e\n\u003cul\u003e\n  \u003cli\u003ewhat the website will have access to are your name, surname, email and profile picture,\u003c/li\u003e\n  \u003cli\u003eit will not be allowed to post on your wall.\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eSo what is the resource you are granting some app access to? Your identity! You use Facebook to let Booking know your name, surname, email and picture.\nObviously, in the meantime, Facebook needs to check and confirm that \u003cem\u003eyou are who you say you are\u003c/em\u003e, e.g. john.smith@somemail.com. So sharing your identity,\nwhich is the actual resource you are authorizing booking.com to access, implies being authenticated behind the scenes. \u003cstrong\u003eProving\u003c/strong\u003e your identity is \u003cstrong\u003eauthentication\u003c/strong\u003e while \u003cstrong\u003esharing\u003c/strong\u003e it is \u003cstrong\u003eauthorization\u003c/strong\u003e.\u003c/p\u003e\n\u003ch4 id=\"digression\"\u003eDigression:\u003c/h4\u003e\n\u003cp\u003eSeriously, how often do people use and authorize post, tweet or photo importing apps? Apps that post to your wall? I cannot name even one. Importing contacts from Gmail or one social network while logging in to another\nsocial network is the only everyday use case I can think of, apart from identity resource sharing.\u003c/p\u003e\n\n\u003ch3 id=\"oauth-based-authentication\"\u003eOAuth based \u003cstrong\u003e“authentication“\u003c/strong\u003e\u003c/h3\u003e\n\n\u003cp\u003eOAuth does not say a word about the way the authorization server should authenticate the user before letting them authorize the client app.\nHow does OAuth help in authenticating the user then? It doesn’t! The authentication happens transparently to the client app, sort of in-between the ongoing authorization process.\nIt depends on the authorization server’s internal authentication implementation. When you get redirected to Facebook and you type\nin your email and password and hit enter, it could even trigger basic authentication underneath and send your Base64 encoded plain-text credentials in the \u003cem\u003eAuthorization\u003c/em\u003e (sic!) HTTP header.\nOr it could trigger a three factor authentication process including a hard token and a magic link sent to your email.\nNever forget that OAuth is an authorization framework when you go to job interviews.\u003c/p\u003e\n\n\u003ch4 id=\"first-get-in\"\u003eFirst, get in\u003c/h4\u003e\n\n\u003cp\u003eWhy do we say that we \u003cem\u003elog in to Booking with Facebook using OAuth\u003c/em\u003e? I guess the reason of one of the common misunderstandings regarding the purpose of the framework is just this unfortunate mental shortcut. And the fact that most of us think \u003cem\u003elog in\u003c/em\u003e === \u003cem\u003eauthenticate\u003c/em\u003e (which is not wrong, I refuse to elaborate on the semantics in this case).\nWe should rather say that we \u003cem\u003eauthorize Booking to delegate authentication to Facebook and use the confirmed identity\u003c/em\u003e, in the background of logging in to Booking. We do all that instead of logging in to Booking directly.\nI guess it’s just too long and convoluted ;).\u003c/p\u003e\n\n\u003ch4 id=\"then-stay-inside\"\u003eThen, stay inside\u003c/h4\u003e\n\u003cp\u003eI can’t stress this enough: OAuth based authorization implies authentication performed by the authorization server. But to keep you logged in, the client app needs\nto use some other mechanism underneath, e.g. HTTP session based on cookies. That’s another blank spot on the OAuth map. Which is not wrong, it’s just not the concern of this framework.\nJust, please, don’t use the access token as a session ID.\u003c/p\u003e\n\n\u003ch4 id=\"authorizer-and-authorizee-\"\u003eAuthorizer and authorizee ;)\u003c/h4\u003e\n\u003cp\u003eYou build the sign-in layer of your app using OAuth as the authorization framework. The user gets authenticated by the third party and allows your app to access their identity data. Let’s clarify another common misconception\nrelated to the part OAuth plays here. Who is the one being authorized? The user? No, it’s your app. The client app is being authorized - by the user - to access a resource, via the authorization server.\nDoes that imply authorizing the user, too? Yes, it may when you think of it the other way round. You cannot authorize the client app to do something that you are not yourself authorized to do in the resource server.\nThis is where \u003ca href=\"https://tools.ietf.org/html/rfc6749#page-23\"\u003eaccess token scopes\u003c/a\u003e grow out of resource owner privileges, permissions, roles etc.\nCan the shared identity resource also contain some permissions and privileges granted to the user within the authorization server? Yes, they can and they often do, e.g. as a \u003cem\u003epermissions\u003c/em\u003e or \u003cem\u003eroles\u003c/em\u003e field in the access token returned by the authorization server.\nI specifically think of \u003ca href=\"https://auth0.com/docs/tokens/access-tokens\"\u003eJson Web Tokens\u003c/a\u003e and their custom claims.\nForgive me for not pasting in an example of a JWT, but I’m allergic to pasting things you have probably seen a hundred times elsewhere.\u003c/p\u003e\n\n\u003ch2 id=\"oauth-based-authentication-no-quotes\"\u003eOAuth based \u003cstrong\u003eauthentication\u003c/strong\u003e (no quotes)\u003c/h2\u003e\n\n\u003cp\u003eYep, here \u003cstrong\u003e100% correct approach\u003c/strong\u003e is not just a clickbait title.\u003c/p\u003e\n\n\u003cp\u003eA corresponding authentication framework which you can use to implement the identity layer of your\napplication is \u003ca href=\"https://auth0.com/docs/protocols/openid-connect-protocol\"\u003eOpen ID Connect\u003c/a\u003e.\u003c/p\u003e\n\n\u003cp\u003eWhile the purpose of OAuth is Delegated Authorization, what describes OpenID Connect best is Federated Identity Management.\nWhat does it mean?\u003c/p\u003e\n\n\u003cp\u003eOK, I lied. Brace yourselves, for a citation is coming:\u003c/p\u003e\n\n\u003cblockquote\u003e\n  \u003cp\u003eWhile OAuth 2.0 is about resource access and sharing, OIDC is all about user authentication.\nIts purpose is to give you one login for multiple sites.\nEach time you need to log in to a website using OIDC, you are redirected to your OpenID site where you login,\nand then taken back to the website.\u003c/p\u003e\n\u003c/blockquote\u003e\n\n\u003cp\u003eI guess you’ve just said: “Wait, wait, whaaat???“\u003c/p\u003e\n\n\u003cblockquote\u003e\n  \u003cp\u003e… you are redirected to your OpenID site where you login, and then taken back to the website\u003c/p\u003e\n\u003c/blockquote\u003e\n\n\u003cp\u003eNow you may think: “We’ve just gone through that, haven’t we? You’ve just swapped one framework for another to make the post longer.“\u003c/p\u003e\n\n\u003cp\u003eNo, it’s just that OIDC is not loosely based on OAuth, it’s actually plugged into it, filling all the authentication\ngaps we’ve mentioned before. It’s best suited to develop your own Identity Provider or more likely an internal security component\nof a system you are building. It may also be a universal login and authorization service for a broader environment of applications\nand systems in your or your client’s company. We will not dig deeper into OIDC in this post, as it deserves\na post of its own. The fact that OIDC perfectly fits into OAuth is best illustrated by the following. While OAuth lets you control access to given resources (like user identity)\nby issuing either JWT access tokens or UUID access tokens, OIDC handles user identity with ID tokens. Access tokens are opaque from the client’s perspective.\nID tokens MUST be a JWT user identity state representation because the ID token, unlike the access token, is readable for the client.\nOIDC does all what was \u003cem\u003ebehind the scenes\u003c/em\u003e and \u003cem\u003edepending on the identity provider\u003c/em\u003e implementation.\u003c/p\u003e\n\n\u003ch2 id=\"client-authentication\"\u003eClient authentication\u003c/h2\u003e\n\n\u003cp\u003eThe biggest lie in OAuth is that it has nothing to do with authentication. It’s true only for the resource owner.\nThe client needs to authenticate itself every time it asks for an access token. Usually it implies sending the client ID and secret as Basic Authentication plain-text string.\nSPA applications have no way of “storing“ the secret securely, as it would have to be included in the source code.\nThat’s why the simplified Implicit flow, devised for JavaScript applications as they were understood almost a decade ago, is now officially\nbanned. It omits the client secret, uses only the client ID, and imposes several other limitations. As per storing the client secret on the client side, when using the Authorization Code grant, mobile and native apps have been believed to be\nsecure enough to do it. \u003ca href=\"https://www.youtube.com/watch?v=H6MxsFMAoP8\"\u003eThey are not\u003c/a\u003e.\nThe only way traditional Authorization Code grant can be used securely is by rendering your web application server-side.\nA huge step forward for OAuth for SPA and mobile apps is enriching the Authorization Code with \u003ca href=\"https://developer.okta.com/blog/2018/12/13/oauth-2-for-native-and-mobile-apps\"\u003ePKCE\u003c/a\u003e, which I only link here,\nas it deserves an article of its own.\u003c/p\u003e\n\n\u003ch2 id=\"stateless-is-a-techie-euphemism-for-useless\"\u003eStateless is a techie euphemism for useless\u003c/h2\u003e\n\n\u003cp\u003eAnother matter I find very often misunderstood is how OAuth as an authorization framework and OIDC as an authentication framework\ncan be used to secure an app using a completely stateless implementation.\u003c/p\u003e\n\n\u003cp\u003eImplementing (\u003cstrong\u003efully\u003c/strong\u003e) stateless authorization and authentication mechanisms requires\nabandoning the traditional battle-tested server-side sessions with identifiers stored client-side as cookies\nfor (stateless) Json Web Tokens (or some other isomorphic solution).\u003c/p\u003e\n\n\u003cp\u003eBy stateless JWT I mean an approach where the whole identity and access control context is fetched \u003cstrong\u003eonce\u003c/strong\u003e when the user logs in (or upon token refresh). Then it’s sent back and forth in form of JWT tokens as cookies (sic!), HTTP request headers or body.\nI will not dig into the pros and cons of where to store and how to transfer JWTs as this would mean copying and pasting half\nof the software-literate Internet. You will find the details in the expert articles I link in further sections.\u003c/p\u003e\n\n\u003cp\u003eI treat this section as a challenge to prove that an article can be built virtually out of citations only.\nWith minimal intellectual effort from the author. Let’s get started:\n    Unlike sessions - which can be invalidated by the server\n    whenever it feels like it - individual stateless JWT tokens\n    cannot be invalidated. By design, they will be valid until\n    they expire, no matter what happens. This means that you cannot,\n    for example, invalidate the session of an attacker after detecting\n    a compromise. You also cannot invalidate old sessions when a user\n    changes their password.\u003c/p\u003e\n\n\u003cblockquote\u003e\n  \u003cp\u003eYou are essentially powerless, and cannot ‘kill’ a session\nwithout building complex (and stateful!) infrastructure to\nexplicitly detect and reject them, defeating the entire\npoint of using stateless JWT tokens to begin with.\u003c/p\u003e\n\u003c/blockquote\u003e\n\n\u003cp\u003eThe above and below citations by Sven Slootweg come from \u003ca href=\"http://cryto.net/%7Ejoepie91/blog/2016/06/13/stop-using-jwt-for-sessions/\"\u003ethis\u003c/a\u003e\nand \u003ca href=\"http://cryto.net/~joepie91/blog/2016/06/19/stop-using-jwt-for-sessions-part-2-why-your-solution-doesnt-work/\"\u003ethis\u003c/a\u003e article.\u003c/p\u003e\n\n\u003cp\u003eRegarding the highlighted session invalidation concerns, the same applies to challenges related to revoking only some of the user privileges without logging them out, so I will not\ndifferentiate between these two cases.\nBy stateful JWT you should understand any hybrid that tries to balance what is necessary to store (and potentially invalidate)\nserver-side and the data that can be stored in the browser and transferred in an encoded, encrypted and signed form with every request\nuntil it automatically expires. The question is: if something does not require a real-time invalidation - be it a user session or a user privilege -\nare we still talking about stateless authentication and authorization? Or just about some user data that may be stale so there is no need to fetch them\nwith every request? That’s an entirely different story.\u003c/p\u003e\n\n\u003cp\u003eI have an auto-reloading citation clip in my gun:\u003c/p\u003e\n\n\u003cblockquote\u003e\n  \u003cp\u003eThis can mean that a token contains some outdated information like an old website URL that somebody changed\nin their profile - but more seriously, it can also mean somebody has a token with a role of admin,\neven though you’ve just revoked their admin role. Because you can’t invalidate tokens either,\nthere’s no way for you to remove their administrator access,\nshort of shutting down the entire system.\u003c/p\u003e\n\u003c/blockquote\u003e\n\n\u003cp\u003eI would appreciate if you suggested an example of an application\nthat needs some security mechanisms but it is not critical to be able to\nrevoke or invalidate them in real time.\u003c/p\u003e\n\n\u003cp\u003eI have once read that losing a JWT token is like losing your house keys. Be it true or not, you can always say that\nyou can leave your apartment door open for several minutes if you just go down to the groceries and will be right back. Of course you can, you could also\nleave your bank account without logging out on a university library computer, there is a good chance the session will expire before someone\nsteals your money. The same applies to the expiry of a JWT session or access token which is not either whitelisted\nor blacklisted server-side.\u003c/p\u003e\n\n\u003cp\u003eWhen I imagine myself discovering that once I’ve changed my Gmail account password using the desktop app\nI’m still logged in (even if only for the remaining four minutes) on my mobile app then… Well it’s embarrassing and frightening at the same time, when you think of all the accounts\nyou could potentially reset passwords for by taking over someone’s email account. But yeah, go ahead and just remove the user’s token from local storage.\u003c/p\u003e\n\n\u003cp\u003eOK, sit down, it’s citation break:\u003c/p\u003e\n\n\u003cblockquote\u003e\n  \u003cp\u003eIf you are concerned about somebody intercepting your session cookie,\nyou should just be using TLS instead - any kind of session implementation\nwill be interceptable if you don’t use TLS, including JWT.\u003c/p\u003e\n\u003c/blockquote\u003e\n\n\u003cp\u003eMe discovering someone took over the evergreen refresh token to my mail account:\u003c/p\u003e\n\n\u003cp\u003e\u003cimg src=\"/img/articles/2021-02-01-oauth-stateless-login/refresh_token.jpg\" alt=\"Me discovering someone took over the evergreen refresh token linked to my mail account\" /\u003e\u003c/p\u003e\n\n\u003cp\u003eThere is no you-meme-it-wrong record I couldn’t break.\u003c/p\u003e\n\n\u003cp\u003eAnother citation (same source):\u003c/p\u003e\n\u003cblockquote\u003e\n  \u003cp\u003eSimply put, using cookies is not optional, regardless of whether you use JWT or not.\u003c/p\u003e\n\u003c/blockquote\u003e\n\n\u003cp\u003eYet Another Citation\u003c/p\u003e\n\n\u003cblockquote\u003e\n  \u003cp\u003eTrue statelessness and revocation are mutually exclusive.\u003c/p\u003e\n\u003c/blockquote\u003e\n\n\u003cp\u003ePlease do look it up in \u003ca href=\"https://lmgtfy.app/?q=%22statelessness+and+revocation+are+mutually+exclusive%22\"\u003ethese articles\u003c/a\u003e\nor at least notice how many of them come up.\u003c/p\u003e\n\n\u003cp\u003eNow that I’m done with throwing angry links at you, let’s focus on the other side of the problem.\u003c/p\u003e\n\n\u003ch2 id=\"statelessness-is-a-key-to-easier-scalability\"\u003eStatelessness is a key to easier scalability\u003c/h2\u003e\n\n\u003cp\u003eIt’s not true that introducing stateless elements to your authentication and authorization is something wrong.\nMy intention was to play bad cop to emphasize things you have to be careful about.\nHDD (Hype Driven Development) is a bad practice in general, but as far as security is concerned it’s the shortest path to\ngetting hacked.\nEvery reasonable JWT-based security implementation is a hybrid of stateless, token-based solutions and stateful,\nserver-side-stored solutions. If moving away from traditional, fully stateful implementations is a challenge for\nyour team, you may start \u003ca href=\"https://auth0.com/blog/stateless-auth-for-stateful-minds/\"\u003ewith this auth0 article\u003c/a\u003e\nwhich may make the mind shift easier.\u003c/p\u003e\n\n\u003cp\u003eOne of the key points from my point of view:\u003c/p\u003e\n\n\u003cblockquote\u003e\n  \u003cp\u003eOne of the cool things about session IDs is that they are opaque.\n“Opaque” means no data can be extracted from it by third parties (other than the issuer).\nThe association between session ID and data is entirely done server-side.\nAre there any other ways of achieving something of the sort without relying on state?\nEnter cryptography.\u003c/p\u003e\n\u003c/blockquote\u003e\n\n\u003cp\u003eThe general idea, as mentioned in the OIDC section, is that access tokens should be\nseen by the client as UUIDs or other meaningless text. It’s the server that should be able to interpret them.\nThat obviously works for traditional session IDs and can be achieved in the JWT-based\napproach using encryption. Obviously, to achieve revocation you need to store those tokens\nanyway.\u003c/p\u003e\n\n\u003cp\u003eThis is where the critics of introducing JWTs in the main authorization flows, as opposed to one-time operations or server-side machine-to-machine communication, hit you hard:\n\u003cimg src=\"/img/articles/2021-02-01-oauth-stateless-login/jwt-flowchart.png\" alt=\"Authority is not granted to you\" /\u003e\n\u003ca href=\"http://cryto.net/~joepie91/blog/2016/06/19/stop-using-jwt-for-sessions-part-2-why-your-solution-doesnt-work/\"\u003eSource: again the Slootweg article\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eThis positions us somewhere between the second and the third “swimlane“ on the above chart, which means\nkeeping a blacklist of revocations to invalidate or storing ID in the token and rest of the data server-side.\u003c/p\u003e\n\n\u003cp\u003eIt brings you either to:\u003c/p\u003e\n\n\u003cblockquote\u003e\n  \u003cp\u003eYour blacklisting/authenticaiton server goes down. What now?\nOnce the attacker takes down the server he has free roam and there is nothing\nyou can do to stop him.\u003c/p\u003e\n\u003c/blockquote\u003e\n\n\u003cp\u003eor to:\u003c/p\u003e\n\n\u003cblockquote\u003e\n  \u003cp\u003eCongratulations! You’ve reinvented sessions, with all their problems (notably,\ntheir need for central state) and gained nothing in the process. But the implementation\nyou are using is less battle tested and you run a higher risk of vulnerabilities.\u003c/p\u003e\n\u003c/blockquote\u003e\n\n\u003cp\u003eYay, time for pasting a JWT body example like in all these other articles:\u003c/p\u003e\n\n\u003cdiv class=\"language-json highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n        \u003c/span\u003e\u003cspan class=\"nl\"\u003e\"sub\"\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s2\"\u003e\"some_user_id\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"err\"\u003e//no\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"err\"\u003ereasonable\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"err\"\u003ecase\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"err\"\u003efor\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"err\"\u003eit\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"err\"\u003eto\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"err\"\u003ego\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"err\"\u003estale\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"err\"\u003ebut\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"err\"\u003edangerous\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"err\"\u003eif\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"err\"\u003ecompromised\u003c/span\u003e\u003cspan class=\"w\"\u003e\n        \u003c/span\u003e\u003cspan class=\"nl\"\u003e\"name\"\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s2\"\u003e\"Jason William Toak\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"err\"\u003e//highly\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"err\"\u003eunlikely\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"err\"\u003eto\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"err\"\u003echange\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"err\"\u003ebut\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"err\"\u003eit's\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"err\"\u003esensitive\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"err\"\u003edata\u003c/span\u003e\u003cspan class=\"w\"\u003e\n        \u003c/span\u003e\u003cspan class=\"nl\"\u003e\"email\"\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s2\"\u003e\"j.w.toak@somemail.com\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"err\"\u003e//stale\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"err\"\u003eemail\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"err\"\u003emay\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"err\"\u003eobviously\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"err\"\u003ebe\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"err\"\u003ea\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"err\"\u003esecurity\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"err\"\u003eissue\u003c/span\u003e\u003cspan class=\"w\"\u003e\n        \u003c/span\u003e\u003cspan class=\"nl\"\u003e\"scope\"\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"w\"\u003e\n            \u003c/span\u003e\u003cspan class=\"s2\"\u003e\"admin\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"err\"\u003e//this\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"err\"\u003ereally\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"err\"\u003esucks\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"err\"\u003eif\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"err\"\u003ethe\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"err\"\u003etoken\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"err\"\u003eis\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"err\"\u003enot\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"err\"\u003erevocable\u003c/span\u003e\u003cspan class=\"w\"\u003e\n            \u003c/span\u003e\u003cspan class=\"s2\"\u003e\"user\"\u003c/span\u003e\u003cspan class=\"w\"\u003e\n        \u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\u003cspan class=\"w\"\u003e\n    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eObviously, the above token needs to be \u003ca href=\"https://tools.ietf.org/html/rfc7515\"\u003esigned\u003c/a\u003e so that you are sure that no one changed\nits content and it needs to be \u003ca href=\"https://tools.ietf.org/html/rfc7516\"\u003eencrypted\u003c/a\u003e as it contains sensitive data. There is a \u003ca href=\"https://auth0.com/blog/json-web-token-signing-algorithms-overview/\"\u003echoice of algorithms\u003c/a\u003e available.\nAn interesting fact \u003ca href=\"https://auth0.com/blog/stateless-auth-for-stateful-minds/#The-Technical-Magic--JWTs--Digital-Signatures-and-Encryption\"\u003ementioned\u003c/a\u003e by Sebastian Peyrott from the auth0 team:\u003c/p\u003e\n\n\u003cblockquote\u003e\n  \u003cp\u003eA typical encryption scheme uses an already signed JWT as the payload for encryption. This is known as a nested JWT. It is acceptable to use the same key for encryption and validation.\u003c/p\u003e\n\u003c/blockquote\u003e\n\n\u003cp\u003eI guess there is a bottom line that somehow finds a common denominator for both Slootweg and Peyrott manifestos. I do not put these articles in opposition to each other, just as points of view on the same problems from different angles and with different bias.\nThis bottom line, as I see it, is as follows:\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003eAlthough JWTs are validated cryptographically, most systems need to use some storage for tokens anyway. By most systems I mean all using refresh tokens, which on its own should, in my opinion, mean virtually each end every token-based application.\u003c/li\u003e\n  \u003cli\u003eThe storage, depending on the application’s requirements, would be either a blacklist or a whitelist of tokens. These\ncan include short-lived access tokens, long-lived refresh tokens, ID tokens or a cartesian product of all the mentioned options.\u003c/li\u003e\n  \u003cli\u003eThe only way for the token storage to prevent leakage is checking every applicable token\nagainst the white/black list.\u003c/li\u003e\n  \u003cli\u003eYou can either call it “reinventing sessions“ or “negating some benefits of the token-based approach“, but revocation and statelessness\nare mutually exclusive and nothing can change it.\u003c/li\u003e\n  \u003cli\u003eThe more you reduce the tokens’ TTL, the less \u003cem\u003ebenefit of statelessness\u003c/em\u003e you get. I mean that reducing access tokens’ TTL to a reasonable minimum is probably a must-have in\nmost real-life scenarios. Refreshing them is based on refresh tokens stored server-side anyway and a short access tokens’ TTL requires frequent calls to a single point of failure.\nOne still benefits on using a semi-stateless solution, yet the fully stateless one is usually fiction. “The Benefits of Going Stateless“, a slogan which starts Peyrott’s article, is actually just a figure of speech.\u003c/li\u003e\n  \u003cli\u003eFor some systems even a five seconds long access token validity may be a security breach.\u003c/li\u003e\n  \u003cli\u003eRolling the signing key is always an option, but it’s like a nuclear suicide attack on your users’ sessions.\u003c/li\u003e\n  \u003cli\u003eEven if you check every token against some kind of storage, this does not mean you are back\nto centralized sessions, you still greatly reduce the number of HTTP calls regarding user identity, privilege and other\ndata you choose to fit into a token.\u003c/li\u003e\n  \u003cli\u003eLet’s emphasize that again: there is a huge difference between accessing a VALID/INVALID key-value storage with every request versus querying\na set of storages for distributed user-related data, and aggregating them for every request.\u003c/li\u003e\n  \u003cli\u003eIn a microservice architecture it’s a COLOSSAL, crucial change, which means a difference\nbetween a system that barely crawls and one that performs very well.\u003c/li\u003e\n  \u003cli\u003eIn an event-driven microservice architecture, you can handle both user log-outs and privilege revocation or stale data\nwith events invalidating corresponding tokens. Generating a new token does not necessarily mean fetching all data again, it depends on the granularity\nof information included in the event.\u003c/li\u003e\n  \u003cli\u003eDoes it mean latency, possible race conditions, eventual consistency? Well, yeah, just as pretty much everything does nowadays.\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch2 id=\"summary\"\u003eSummary\u003c/h2\u003e\n\n\u003cp\u003e\u003cem\u003eAuthorization, authentication, statelessness, revocation, tokens, sessions.\u003c/em\u003e\u003c/p\u003e\n\n\u003cp\u003eLots of stuff easy to misunderstand, implement the wrong way, oversimplify and wrongly criticise.\u003c/p\u003e\n\n\u003cp\u003e\u003cem\u003eOAuth, JWT, OpenID Connect, Authorization Code Grant, Implicit Flow, User and Client Credentials, Third-Party Identity Providers,\nDelegated Authorization, Federated Identity Management.\u003c/em\u003e\u003c/p\u003e\n\n\u003cp\u003eThat’s again a lot of words and it’s not even a sentence, though a nice SEO booster ;)  We’ve gone more or less through\nall of that, but studying all these terms in detail here was impossible. Should there be at least one thing this article made clear to you and if you\nfeel some misconceptions have been clarified, I’m very happy. If there is at least one comment\nbelow this article which will prove me wrong in some or most of views on this broad subject, I will be\nmore than happy to learn something and exchange opinions. As I’ve mentioned in\nthe beginning of the article, security is not something most of us can study, implement and\nwork with every day. Please feel invited to share your knowledge and experience, also including stuff\nthat looks good on paper, but didn’t work for you in production. I will appreciate it a lot.\u003c/p\u003e\n","contentSnippet":"Many of us spend most of their software development careers improving and extending applications protected by pre-existing security mechanisms. That’s why\nwe rarely address problems related directly to authentication and authorization unless we build apps from scratch.\nRegardless of your experience I still hope you will find this article interesting.\nIt’s not meant to be a tutorial. I would like to focus on clarifying basic concepts and highlighting common misconceptions.\nAlpha disclaimer:\nSorry to disappoint you, but the title of this article is just a cheap click-bait.\nIt doesn’t matter whether you started reading because you disagree with\nthe title or because you hoped to find the holy grail\nof securing web applications. There is a chance you will find something for yourself anyway.\nBeta disclaimer:\nThis post is not meant to answer the “how does the login with Facebook work“ question.\nWe will spend some time on it, but just to provoke a discussion, not to go through a tutorial.\nGamma disclaimer:\nI have never built a full-fledged auth process from scratch myself in a commercial web app.\nI’m no security expert, so you read at your own risk.\nAuthentication vs Authorization\nWow! If you are still reading, cool!\nLet’s start with a short recap on these two basic concepts. Authentication is about verifying who you are.\nYou need to prove your identity, that’s all. You may authenticate, for example, by using a password or your fingerprint.\nYou may need to use a token (hard or soft), an authentication-app-generated code or a text message sent to your phone number.\nI hope you tend to use at least two of these. Anyway, once you’ve done it, you are in.\n\nAuthorization is about verifying what you are allowed to do. I’m not going to copy-paste bookish definitions here. For example, when entering a university library, you authenticate by presenting your ID.\nThe librarian checks the authenticity of the document and analyzes whether you are the one on the photograph or not.\nThe authorization process starts right away.\nTo keep things simple, the librarian checks, based on your confirmed identity, whether you are a professor or a student. This implies which books you can borrow and how many you can take home.\nThis is where the privileges or permissions come into play.\n\nIf you are already bored with the most obvious meme I could use, let me give you another obvious example of authorization.\nWhen entering a military zone, you also present your ID for authentication. You can’t get in unless you ARE, e.g. a military officer. It’s not the authentication that failed then.\nThe guardian knows who you are now.\nYou are forbidden to enter as you have not been granted such an authority.\nOne last meme, I promise.\n\nOAuth 2.0: why is it not about authenticating the user?\nI started with the above trivia because the concepts of authorization and authentication are mingled so often that, even when you know them, you may still get a headache\nwhen reading about OAuth (from now on, I will omit the 2.0 specification version).\nWhat is OAuth? I hate copy-pasting definitions from official docs and other blogs. What I hate even more is copy-pasting them, rephrasing and selling as my own.\nSo, unless you already did, please stop reading and check out the docs, this website and then the auth0 website. If you liked the latter, you may also check out their blog in general.\nI assume you’ve read the suggested docs so I will move on to using the traditional OAuth lingo (grants, flows, resources, third-party servers etc).\nOAuth flows revisited\nThe OAuth specification describes this framework as available in four flavours:\nAuthorization Code\nImplicit\nResource Owner Credentials\nClient Credentials\nSo 2012.\n\nThe Resource Owner Credentials (User Credentials) flow is already legacy and officially banned by IETF.\n    The latest OAuth 2.0 Security Best Current Practice disallows the password grant entirely.\nSource\nThe same applies to the Implicit flow, also discouraged in its original form.\nSome experts analyze whether it is already dead or not.\nIn the following two “login with..“ examples you should understand OAuth as limited to the Authorization Code grant. The Client Credentials grant is a completely different story, handled\nin a further part of the article.\nIt’s Hello World Time\nI prefer to think of OAuth as a set of guidelines and best practices that help you solve a common problem related to authorization, as opposed to a strict framework or protocol.\nThis common problem may be for instance the following. Damn, how the hell did these guys implement the cool log in with Facebook feature in their app (not so cool anymore, let’s be honest it’s 2021 not 2015).\nLet’s call this app fb64.com .\nTo be precise, how did those guys use the Facebook API to delegate the process of asking the user whether or not fb64.com can access some of their Facebook account data?\nYou may find an analogous scenario described in virtually EVERY SINGLE blog post referring to OAuth, but there is a good reason why I do it here too. I use it because it sucks and introduces misunderstandigs regarding real-life\ndelegated authorization and log in with a third party identity provider scenarios.\nLet’s consider the dumbest example ever.\nThe resource is your Facebook wall and everything you’ve posted on it.\nThe resource owner is, well, just you.\nThe resource server is Facebook.\nThe client is the fb64.com app. Its cool feature is presenting your 10 recent posts\nas Base64 encoded strings.\nThe authorization server is also Facebook itself.\n\nSo, in the above scenario, you get the cool feature without giving these guys your Facebook login and password. When you are redirected to the Facebook login page\nfirst you give your consent for fb64.com to access a specific subset of your profile data. Next you type in your credentials (you send them to facebook.com, not to fb64.com) and\nwhen you get redirected back to fb64.com you are already logged-in and see an awesome black-and-white website with your Base64 encoded posts.\nWhat have you done? You’ve granted some client app access to your protected resource data without sharing your credentials with it. Full stop.\nBut is that what we meant? Is that the kind of resource sharing and delegated authorization you expect when you want to, for example, log in to Booking, via Facebook, to book a hotel room but don’t want to set up an account?\n\nIt’s Real Life Scenario Time\nLet’s come up with a more real-life-ish scenario.\nWhen you choose a third party identity provider login you probably expect to get an account without wasting time to sign-up and come up with Yet Another Password.\nBefore you click continue as John Smith you are assured that:\nwhat the website will have access to are your name, surname, email and profile picture,\nit will not be allowed to post on your wall.\nSo what is the resource you are granting some app access to? Your identity! You use Facebook to let Booking know your name, surname, email and picture.\nObviously, in the meantime, Facebook needs to check and confirm that you are who you say you are, e.g. john.smith@somemail.com. So sharing your identity,\nwhich is the actual resource you are authorizing booking.com to access, implies being authenticated behind the scenes. Proving your identity is authentication while sharing it is authorization.\nDigression:\nSeriously, how often do people use and authorize post, tweet or photo importing apps? Apps that post to your wall? I cannot name even one. Importing contacts from Gmail or one social network while logging in to another\nsocial network is the only everyday use case I can think of, apart from identity resource sharing.\nOAuth based “authentication“\nOAuth does not say a word about the way the authorization server should authenticate the user before letting them authorize the client app.\nHow does OAuth help in authenticating the user then? It doesn’t! The authentication happens transparently to the client app, sort of in-between the ongoing authorization process.\nIt depends on the authorization server’s internal authentication implementation. When you get redirected to Facebook and you type\nin your email and password and hit enter, it could even trigger basic authentication underneath and send your Base64 encoded plain-text credentials in the Authorization (sic!) HTTP header.\nOr it could trigger a three factor authentication process including a hard token and a magic link sent to your email.\nNever forget that OAuth is an authorization framework when you go to job interviews.\nFirst, get in\nWhy do we say that we log in to Booking with Facebook using OAuth? I guess the reason of one of the common misunderstandings regarding the purpose of the framework is just this unfortunate mental shortcut. And the fact that most of us think log in === authenticate (which is not wrong, I refuse to elaborate on the semantics in this case).\nWe should rather say that we authorize Booking to delegate authentication to Facebook and use the confirmed identity, in the background of logging in to Booking. We do all that instead of logging in to Booking directly.\nI guess it’s just too long and convoluted ;).\nThen, stay inside\nI can’t stress this enough: OAuth based authorization implies authentication performed by the authorization server. But to keep you logged in, the client app needs\nto use some other mechanism underneath, e.g. HTTP session based on cookies. That’s another blank spot on the OAuth map. Which is not wrong, it’s just not the concern of this framework.\nJust, please, don’t use the access token as a session ID.\nAuthorizer and authorizee ;)\nYou build the sign-in layer of your app using OAuth as the authorization framework. The user gets authenticated by the third party and allows your app to access their identity data. Let’s clarify another common misconception\nrelated to the part OAuth plays here. Who is the one being authorized? The user? No, it’s your app. The client app is being authorized - by the user - to access a resource, via the authorization server.\nDoes that imply authorizing the user, too? Yes, it may when you think of it the other way round. You cannot authorize the client app to do something that you are not yourself authorized to do in the resource server.\nThis is where access token scopes grow out of resource owner privileges, permissions, roles etc.\nCan the shared identity resource also contain some permissions and privileges granted to the user within the authorization server? Yes, they can and they often do, e.g. as a permissions or roles field in the access token returned by the authorization server.\nI specifically think of Json Web Tokens and their custom claims.\nForgive me for not pasting in an example of a JWT, but I’m allergic to pasting things you have probably seen a hundred times elsewhere.\nOAuth based authentication (no quotes)\nYep, here 100% correct approach is not just a clickbait title.\nA corresponding authentication framework which you can use to implement the identity layer of your\napplication is Open ID Connect.\nWhile the purpose of OAuth is Delegated Authorization, what describes OpenID Connect best is Federated Identity Management.\nWhat does it mean?\nOK, I lied. Brace yourselves, for a citation is coming:\nWhile OAuth 2.0 is about resource access and sharing, OIDC is all about user authentication.\nIts purpose is to give you one login for multiple sites.\nEach time you need to log in to a website using OIDC, you are redirected to your OpenID site where you login,\nand then taken back to the website.\nI guess you’ve just said: “Wait, wait, whaaat???“\n… you are redirected to your OpenID site where you login, and then taken back to the website\nNow you may think: “We’ve just gone through that, haven’t we? You’ve just swapped one framework for another to make the post longer.“\nNo, it’s just that OIDC is not loosely based on OAuth, it’s actually plugged into it, filling all the authentication\ngaps we’ve mentioned before. It’s best suited to develop your own Identity Provider or more likely an internal security component\nof a system you are building. It may also be a universal login and authorization service for a broader environment of applications\nand systems in your or your client’s company. We will not dig deeper into OIDC in this post, as it deserves\na post of its own. The fact that OIDC perfectly fits into OAuth is best illustrated by the following. While OAuth lets you control access to given resources (like user identity)\nby issuing either JWT access tokens or UUID access tokens, OIDC handles user identity with ID tokens. Access tokens are opaque from the client’s perspective.\nID tokens MUST be a JWT user identity state representation because the ID token, unlike the access token, is readable for the client.\nOIDC does all what was behind the scenes and depending on the identity provider implementation.\nClient authentication\nThe biggest lie in OAuth is that it has nothing to do with authentication. It’s true only for the resource owner.\nThe client needs to authenticate itself every time it asks for an access token. Usually it implies sending the client ID and secret as Basic Authentication plain-text string.\nSPA applications have no way of “storing“ the secret securely, as it would have to be included in the source code.\nThat’s why the simplified Implicit flow, devised for JavaScript applications as they were understood almost a decade ago, is now officially\nbanned. It omits the client secret, uses only the client ID, and imposes several other limitations. As per storing the client secret on the client side, when using the Authorization Code grant, mobile and native apps have been believed to be\nsecure enough to do it. They are not.\nThe only way traditional Authorization Code grant can be used securely is by rendering your web application server-side.\nA huge step forward for OAuth for SPA and mobile apps is enriching the Authorization Code with PKCE, which I only link here,\nas it deserves an article of its own.\nStateless is a techie euphemism for useless\nAnother matter I find very often misunderstood is how OAuth as an authorization framework and OIDC as an authentication framework\ncan be used to secure an app using a completely stateless implementation.\nImplementing (fully) stateless authorization and authentication mechanisms requires\nabandoning the traditional battle-tested server-side sessions with identifiers stored client-side as cookies\nfor (stateless) Json Web Tokens (or some other isomorphic solution).\nBy stateless JWT I mean an approach where the whole identity and access control context is fetched once when the user logs in (or upon token refresh). Then it’s sent back and forth in form of JWT tokens as cookies (sic!), HTTP request headers or body.\nI will not dig into the pros and cons of where to store and how to transfer JWTs as this would mean copying and pasting half\nof the software-literate Internet. You will find the details in the expert articles I link in further sections.\nI treat this section as a challenge to prove that an article can be built virtually out of citations only.\nWith minimal intellectual effort from the author. Let’s get started:\n    Unlike sessions - which can be invalidated by the server\n    whenever it feels like it - individual stateless JWT tokens\n    cannot be invalidated. By design, they will be valid until\n    they expire, no matter what happens. This means that you cannot,\n    for example, invalidate the session of an attacker after detecting\n    a compromise. You also cannot invalidate old sessions when a user\n    changes their password.\nYou are essentially powerless, and cannot ‘kill’ a session\nwithout building complex (and stateful!) infrastructure to\nexplicitly detect and reject them, defeating the entire\npoint of using stateless JWT tokens to begin with.\nThe above and below citations by Sven Slootweg come from this\nand this article.\nRegarding the highlighted session invalidation concerns, the same applies to challenges related to revoking only some of the user privileges without logging them out, so I will not\ndifferentiate between these two cases.\nBy stateful JWT you should understand any hybrid that tries to balance what is necessary to store (and potentially invalidate)\nserver-side and the data that can be stored in the browser and transferred in an encoded, encrypted and signed form with every request\nuntil it automatically expires. The question is: if something does not require a real-time invalidation - be it a user session or a user privilege -\nare we still talking about stateless authentication and authorization? Or just about some user data that may be stale so there is no need to fetch them\nwith every request? That’s an entirely different story.\nI have an auto-reloading citation clip in my gun:\nThis can mean that a token contains some outdated information like an old website URL that somebody changed\nin their profile - but more seriously, it can also mean somebody has a token with a role of admin,\neven though you’ve just revoked their admin role. Because you can’t invalidate tokens either,\nthere’s no way for you to remove their administrator access,\nshort of shutting down the entire system.\nI would appreciate if you suggested an example of an application\nthat needs some security mechanisms but it is not critical to be able to\nrevoke or invalidate them in real time.\nI have once read that losing a JWT token is like losing your house keys. Be it true or not, you can always say that\nyou can leave your apartment door open for several minutes if you just go down to the groceries and will be right back. Of course you can, you could also\nleave your bank account without logging out on a university library computer, there is a good chance the session will expire before someone\nsteals your money. The same applies to the expiry of a JWT session or access token which is not either whitelisted\nor blacklisted server-side.\nWhen I imagine myself discovering that once I’ve changed my Gmail account password using the desktop app\nI’m still logged in (even if only for the remaining four minutes) on my mobile app then… Well it’s embarrassing and frightening at the same time, when you think of all the accounts\nyou could potentially reset passwords for by taking over someone’s email account. But yeah, go ahead and just remove the user’s token from local storage.\nOK, sit down, it’s citation break:\nIf you are concerned about somebody intercepting your session cookie,\nyou should just be using TLS instead - any kind of session implementation\nwill be interceptable if you don’t use TLS, including JWT.\nMe discovering someone took over the evergreen refresh token to my mail account:\n\nThere is no you-meme-it-wrong record I couldn’t break.\nAnother citation (same source):\nSimply put, using cookies is not optional, regardless of whether you use JWT or not.\nYet Another Citation\nTrue statelessness and revocation are mutually exclusive.\nPlease do look it up in these articles\nor at least notice how many of them come up.\nNow that I’m done with throwing angry links at you, let’s focus on the other side of the problem.\nStatelessness is a key to easier scalability\nIt’s not true that introducing stateless elements to your authentication and authorization is something wrong.\nMy intention was to play bad cop to emphasize things you have to be careful about.\nHDD (Hype Driven Development) is a bad practice in general, but as far as security is concerned it’s the shortest path to\ngetting hacked.\nEvery reasonable JWT-based security implementation is a hybrid of stateless, token-based solutions and stateful,\nserver-side-stored solutions. If moving away from traditional, fully stateful implementations is a challenge for\nyour team, you may start with this auth0 article\nwhich may make the mind shift easier.\nOne of the key points from my point of view:\nOne of the cool things about session IDs is that they are opaque.\n“Opaque” means no data can be extracted from it by third parties (other than the issuer).\nThe association between session ID and data is entirely done server-side.\nAre there any other ways of achieving something of the sort without relying on state?\nEnter cryptography.\nThe general idea, as mentioned in the OIDC section, is that access tokens should be\nseen by the client as UUIDs or other meaningless text. It’s the server that should be able to interpret them.\nThat obviously works for traditional session IDs and can be achieved in the JWT-based\napproach using encryption. Obviously, to achieve revocation you need to store those tokens\nanyway.\nThis is where the critics of introducing JWTs in the main authorization flows, as opposed to one-time operations or server-side machine-to-machine communication, hit you hard:\n\nSource: again the Slootweg article\nThis positions us somewhere between the second and the third “swimlane“ on the above chart, which means\nkeeping a blacklist of revocations to invalidate or storing ID in the token and rest of the data server-side.\nIt brings you either to:\nYour blacklisting/authenticaiton server goes down. What now?\nOnce the attacker takes down the server he has free roam and there is nothing\nyou can do to stop him.\nor to:\nCongratulations! You’ve reinvented sessions, with all their problems (notably,\ntheir need for central state) and gained nothing in the process. But the implementation\nyou are using is less battle tested and you run a higher risk of vulnerabilities.\nYay, time for pasting a JWT body example like in all these other articles:\n\n    {\n        \"sub\": \"some_user_id\", //no reasonable case for it to go stale, but dangerous if compromised\n        \"name\": \"Jason William Toak\", //highly unlikely to change, but it's sensitive data\n        \"email\": \"j.w.toak@somemail.com\", //stale email may obviously be a security issue\n        \"scope\": [\n            \"admin\", //this really sucks if the token is not revocable\n            \"user\"\n        ]\n    }\n\n\nObviously, the above token needs to be signed so that you are sure that no one changed\nits content and it needs to be encrypted as it contains sensitive data. There is a choice of algorithms available.\nAn interesting fact mentioned by Sebastian Peyrott from the auth0 team:\nA typical encryption scheme uses an already signed JWT as the payload for encryption. This is known as a nested JWT. It is acceptable to use the same key for encryption and validation.\nI guess there is a bottom line that somehow finds a common denominator for both Slootweg and Peyrott manifestos. I do not put these articles in opposition to each other, just as points of view on the same problems from different angles and with different bias.\nThis bottom line, as I see it, is as follows:\nAlthough JWTs are validated cryptographically, most systems need to use some storage for tokens anyway. By most systems I mean all using refresh tokens, which on its own should, in my opinion, mean virtually each end every token-based application.\nThe storage, depending on the application’s requirements, would be either a blacklist or a whitelist of tokens. These\ncan include short-lived access tokens, long-lived refresh tokens, ID tokens or a cartesian product of all the mentioned options.\nThe only way for the token storage to prevent leakage is checking every applicable token\nagainst the white/black list.\nYou can either call it “reinventing sessions“ or “negating some benefits of the token-based approach“, but revocation and statelessness\nare mutually exclusive and nothing can change it.\nThe more you reduce the tokens’ TTL, the less benefit of statelessness you get. I mean that reducing access tokens’ TTL to a reasonable minimum is probably a must-have in\nmost real-life scenarios. Refreshing them is based on refresh tokens stored server-side anyway and a short access tokens’ TTL requires frequent calls to a single point of failure.\nOne still benefits on using a semi-stateless solution, yet the fully stateless one is usually fiction. “The Benefits of Going Stateless“, a slogan which starts Peyrott’s article, is actually just a figure of speech.\nFor some systems even a five seconds long access token validity may be a security breach.\nRolling the signing key is always an option, but it’s like a nuclear suicide attack on your users’ sessions.\nEven if you check every token against some kind of storage, this does not mean you are back\nto centralized sessions, you still greatly reduce the number of HTTP calls regarding user identity, privilege and other\ndata you choose to fit into a token.\nLet’s emphasize that again: there is a huge difference between accessing a VALID/INVALID key-value storage with every request versus querying\na set of storages for distributed user-related data, and aggregating them for every request.\nIn a microservice architecture it’s a COLOSSAL, crucial change, which means a difference\nbetween a system that barely crawls and one that performs very well.\nIn an event-driven microservice architecture, you can handle both user log-outs and privilege revocation or stale data\nwith events invalidating corresponding tokens. Generating a new token does not necessarily mean fetching all data again, it depends on the granularity\nof information included in the event.\nDoes it mean latency, possible race conditions, eventual consistency? Well, yeah, just as pretty much everything does nowadays.\nSummary\nAuthorization, authentication, statelessness, revocation, tokens, sessions.\nLots of stuff easy to misunderstand, implement the wrong way, oversimplify and wrongly criticise.\nOAuth, JWT, OpenID Connect, Authorization Code Grant, Implicit Flow, User and Client Credentials, Third-Party Identity Providers,\nDelegated Authorization, Federated Identity Management.\nThat’s again a lot of words and it’s not even a sentence, though a nice SEO booster ;)  We’ve gone more or less through\nall of that, but studying all these terms in detail here was impossible. Should there be at least one thing this article made clear to you and if you\nfeel some misconceptions have been clarified, I’m very happy. If there is at least one comment\nbelow this article which will prove me wrong in some or most of views on this broad subject, I will be\nmore than happy to learn something and exchange opinions. As I’ve mentioned in\nthe beginning of the article, security is not something most of us can study, implement and\nwork with every day. Please feel invited to share your knowledge and experience, also including stuff\nthat looks good on paper, but didn’t work for you in production. I will appreciate it a lot.","guid":"https://blog.allegro.tech/2021/02/oauth-stateless-login.html","categories":["tech","security","oauth","authentication","authorization","jwt","openid-connect"],"isoDate":"2021-01-31T23:00:00.000Z","thumbnail":"images/post-headers/default.jpg"},{"title":"Impact of data model on MongoDB database size","link":"https://blog.allegro.tech/2021/01/impact-of-the-data-model-on-the-MongoDB-database-size.html","pubDate":"Thu, 14 Jan 2021 00:00:00 +0100","authors":{"author":[{"name":["Michał Knasiecki"],"photo":["https://blog.allegro.tech/img/authors/michal.knasiecki.jpg"],"url":["https://blog.allegro.tech/authors/michal.knasiecki"]}]},"content":"\u003cp\u003eSo I was tuning one of our services in order to speed up some MongoDB queries. Incidentally, my attention was caught by\nthe size of one of the collections that contains archived objects and therefore is rarely used. Unfortunately I wasn’t\nable to reduce the size of the documents stored there, but I started to wonder: is it possible to store the same data\nin a more compact way? Mongo stores \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eJSON\u003c/code\u003e that allows many different ways of expressing similar data, so there seems\nto be room for improvements.\u003c/p\u003e\n\n\u003cp\u003eIt is worth asking: why make such an effort in the era of Big Data and unlimited resources? There are several reasons.\u003c/p\u003e\n\n\u003cp\u003eFirst of all, the resources are not unlimited and at the end we have physical drives that cost money to buy, replace,\nmaintain, and be supplied with power.\u003c/p\u003e\n\n\u003cp\u003eSecondly, less stored data results in less time to access it. Moreover, less data means that more of it will fit into\ncache, so the next data access will be an order of magnitude faster.\u003c/p\u003e\n\n\u003cp\u003eI decided to do some experiments and check how the model design affects the size of database files.\u003c/p\u003e\n\n\u003cp\u003eI used a local MongoDB Community Edition 4.4 installation and I initially tested collections containing 1\nmillion and 10 million documents. One of the variants contained up to 100 million, but the results were proportional\n(nearly linear). Therefore, in the end I decided to stop at 1M collections, because loading the data was simply much faster.\u003c/p\u003e\n\n\u003cp\u003eHaving access to local database files, I could easily check the size of the files storing individual collections.\nHowever, it turned out to be unnecessary, because the same data can be obtained with the command:\u003c/p\u003e\n\n\u003cdiv class=\"language-sql highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"n\"\u003edb\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003egetCollection\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e'COLLECTION_NAME'\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"n\"\u003estats\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e\u003cimg src=\"/img/articles/2021-01-14-impact-of-the-data-model-on-the-MongoDB-database-size/collection-stats.png\" alt=\"Collection stats\" /\u003e\u003c/p\u003e\n\n\u003cp\u003eThe following fields are expressed in bytes:\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003esize\u003c/code\u003e: size of all collection documents, before compression,\u003c/li\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eavgObjSize\u003c/code\u003e: average document size, before compression,\u003c/li\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003estorageSize\u003c/code\u003e: file size on the disk; this is the value after the data is compressed, the same value is returned by\n\u003ccode class=\"language-plaintext highlighter-rouge\"\u003els\u003c/code\u003e command,\u003c/li\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003efreeStorageSize\u003c/code\u003e: size of unused space allocated for the data; Mongo does not increase the file size byte-by-byte,\nbut allocates a percentage of the current file size and this value indicates how much data will still fit into the file.\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eTo present the results I used (storageSize - freeStorageSize) value that indicates the actual space occupied by the data.\u003c/p\u003e\n\n\u003cp\u003eMy local MongoDB instance had compression enabled. Not every storage engine has this option enabled by default, so when\nyou start your own analysis it is worth checking how it is in your particular case.\u003c/p\u003e\n\n\u003ch3 id=\"id-field-type\"\u003eId field type\u003c/h3\u003e\n\n\u003cp\u003eIn the beginning I decided to check \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eID\u003c/code\u003e fields. Not the collection primary key, mind you – it is ‘ObjectId’ type by\ndefault and generally shouldn’t be changed. I decided to focus on user\nand offers identifiers which, although numerical, are often saved as String in Mongo. I believe it comes partly due to\nthe contract of our services - identifiers in \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eJSON\u003c/code\u003e most often come as Strings and in this form they are later stored\nin our databases.\u003c/p\u003e\n\n\u003cp\u003eLet’s start with some theory: the number of \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eint32\u003c/code\u003e type in Mongo has a fixed size of 4 bytes. The same number\nwritten as a \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eString\u003c/code\u003e of characters has a size dependent on the number of digits; additionally it contains the length of\nthe text (4 bytes) and a terminator character. For example, the text “0” is 12 bytes long and “1234567890” is 25 bytes\nlong. So in theory we should get interesting results, but what does it look like in reality?\u003c/p\u003e\n\n\u003cp\u003eI prepared 2 collections, one million documents each, containing the following documents:\u003c/p\u003e\n\n\u003cdiv class=\"language-json highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nl\"\u003e\"_id\"\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eand\u003c/p\u003e\n\n\u003cdiv class=\"language-json highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nl\"\u003e\"_id\"\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s2\"\u003e\"1\"\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eThe values of identifiers were consecutive natural numbers. Here is the comparison of results:\u003c/p\u003e\n\n\u003cp\u003e\u003cimg src=\"/img/articles/2021-01-14-impact-of-the-data-model-on-the-MongoDB-database-size/chart-id.png\" alt=\"String vs int32 size\" /\u003e\u003c/p\u003e\n\n\u003cp\u003eAs you can see the difference is significant since the size on disk decreased by half. Additionally, it is worth\nnoting here that my data is synthetic and the identifiers start from 1. The advantage of a numerical identifier over a\n\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eString\u003c/code\u003e increases the more digits a number has, so benefits should be even better for the real life data.\u003c/p\u003e\n\n\u003cp\u003eEncouraged by the success I decided to check if field type had any influence on the size of an index created on it. In\nthis case, unfortunately, I got disappointed: the sizes were similar. This is due to the fact that MongoDB\nuses a hash function when creating indexes, so physically both indexes are composed of numerical values.\nHowever, if we are dealing with hashing, maybe at least searching by index in a numerical field is faster?\u003c/p\u003e\n\n\u003cp\u003eI made a comparison of searching for a million and 10 million documents by indexed key in a random but the same order\nfor both collections. Again, a missed shot: both tests ended up with a similar result, so the conclusion is this:\nit is worth using numerical identifiers, because they require less disk space, but we will not get additional benefits\nassociated with indexes on these fields.\u003c/p\u003e\n\n\u003cp\u003e\u003cimg src=\"/img/articles/2021-01-14-impact-of-the-data-model-on-the-MongoDB-database-size/chart-search-1M.png\" alt=\"String vs int32 search time 1M\" /\u003e\u003c/p\u003e\n\n\u003cp\u003e\u003cimg src=\"/img/articles/2021-01-14-impact-of-the-data-model-on-the-MongoDB-database-size/chart-search-10M.png\" alt=\"String vs int32 search time 10M\" /\u003e\u003c/p\u003e\n\n\u003ch3 id=\"simple-and-complex-structures\"\u003eSimple and complex structures\u003c/h3\u003e\n\n\u003cp\u003eLet’s move on to more complex data. Our models are often built from smaller structures grouping data such as user,\norder or offer. I decided to compare the size of documents storing such structures and their flat counterparts:\u003c/p\u003e\n\n\u003cdiv class=\"language-json highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"nl\"\u003e\"_id\"\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nl\"\u003e\"user\"\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"nl\"\u003e\"name\"\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s2\"\u003e\"Jan\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nl\"\u003e\"surname\"\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s2\"\u003e\"Nowak\"\u003c/span\u003e\u003cspan class=\"p\"\u003e}}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eand\u003c/p\u003e\n\n\u003cdiv class=\"language-json highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"nl\"\u003e\"_id\"\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nl\"\u003e\"userName\"\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s2\"\u003e\"Jan\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nl\"\u003e\"userSurname\"\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s2\"\u003e\"Nowak\"\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eIn both cases we store identical data, the documents differ only in the schema. Take a look at the result:\u003c/p\u003e\n\n\u003cp\u003e\u003cimg src=\"/img/articles/2021-01-14-impact-of-the-data-model-on-the-MongoDB-database-size/chart-struct-1.png\" alt=\"complex vs simple size\" /\u003e\u003c/p\u003e\n\n\u003cp\u003eThere is a slight reduction by 0.4MB. It may seem not much compared to the effect we achieved for the field\ncontaining an ID. However, we have to bear in mind that in this case we were dealing with a more complex document. It\ncontained – in addition to the compared fields – a numerical type identifier that, as we remember from previous\nexperiments, takes up about 5MB of disk space.\u003c/p\u003e\n\n\u003cp\u003eTaking this into account in the above results we are talking about a decrease from 3.4MB to 3MB. It actually looks\nbetter as percentage - we saved 12% of the space needed to store personal data.\u003c/p\u003e\n\n\u003cp\u003eLet’s go back to the discussed documents for a moment:\u003c/p\u003e\n\n\u003cdiv class=\"language-json highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"nl\"\u003e\"_id\"\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nl\"\u003e\"user\"\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"nl\"\u003e\"name\"\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s2\"\u003e\"Jan\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nl\"\u003e\"surname\"\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s2\"\u003e\"Nowak\"\u003c/span\u003e\u003cspan class=\"p\"\u003e}}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eand\u003c/p\u003e\n\n\u003cdiv class=\"language-json highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"nl\"\u003e\"_id\"\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nl\"\u003e\"userName\"\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s2\"\u003e\"Jan\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nl\"\u003e\"userSurname\"\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s2\"\u003e\"Nowak\"\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eA watchful eye will notice that I used longer field names in the document after flattening. So instead of \u003ccode class=\"language-plaintext highlighter-rouge\"\u003euser.name\u003c/code\u003e\nand \u003ccode class=\"language-plaintext highlighter-rouge\"\u003euser.surname\u003c/code\u003e I made \u003ccode class=\"language-plaintext highlighter-rouge\"\u003euserName\u003c/code\u003e and \u003ccode class=\"language-plaintext highlighter-rouge\"\u003euserSurname\u003c/code\u003e. I did it automatically, a bit unconsciously, to make the\nresulting \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eJSON\u003c/code\u003e more readable.  However, if by changing only the schema of the document from compound to flat we managed\nto reduce the size of the data, maybe it is worth to go a step further and shorten the field names?\u003c/p\u003e\n\n\u003cp\u003eI decided to add a third document for comparison, flattened and with shorter field names:\u003c/p\u003e\n\n\u003cdiv class=\"language-json highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"nl\"\u003e\"_id\"\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nl\"\u003e\"name\"\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s2\"\u003e\"Jan\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nl\"\u003e\"surname\"\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s2\"\u003e\"Nowak\"\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eThe results are shown in the chart below:\u003c/p\u003e\n\n\u003cp\u003e\u003cimg src=\"/img/articles/2021-01-14-impact-of-the-data-model-on-the-MongoDB-database-size/chart-struct-2.png\" alt=\"complex vs simple vs short size\" /\u003e\u003c/p\u003e\n\n\u003cp\u003eThe result is even better than just flattening. Apart from the document’s key size, we achieved a decrease from\n3.4MB to 2MB. Why does this happen even though we store exactly the same data?\u003c/p\u003e\n\n\u003cp\u003eThe reason for the decrease is the nature of NoSQL databases that, unlike the relational ones, do not have a schema\ndefined at the level of the entire collection. If someone is very stubborn, they can store user data, offers, orders and\npayments in one collection. It would still be possible to read, index and search that data. This is because the\ndatabase, in addition to the data itself, stores its schema with each document. Thus, the total size of a document\nconsists of its data and its schema. And that explains the whole puzzle. By reducing the size of the schema, we also\nreduce the size of each document, i.e. the size of the final file with the collection data. It is worth taking this into\naccount when designing a collection schema in order not to blow it up too much. Of course, you cannot go to extremes, because\nthat would lead us to fields named \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ea\u003c/code\u003e, \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eb\u003c/code\u003e and \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ec\u003c/code\u003e, what would make the collection completely illegible for a human.\u003c/p\u003e\n\n\u003cp\u003eFor very large collections, however, this approach is used, an example of which is the MongoDB operation log\nthat contains fields called:\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003eh\u003c/li\u003e\n  \u003cli\u003eop\u003c/li\u003e\n  \u003cli\u003ens\u003c/li\u003e\n  \u003cli\u003eo\u003c/li\u003e\n  \u003cli\u003eo2\u003c/li\u003e\n  \u003cli\u003eb\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch3 id=\"empty-fields\"\u003eEmpty fields\u003c/h3\u003e\n\n\u003cp\u003eSince we are at the document’s schema, it is still worth looking at the problem of blank fields. In the case of\n\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eJSON\u003c/code\u003e the lack of value in a certain field can be written in two ways, either directly - by writing null in its value -\nor by not serializing the field at all. I prepared a comparison of documents with the following structure:\u003c/p\u003e\n\n\u003cdiv class=\"language-json highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nl\"\u003e\"id\"\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eand\u003c/p\u003e\n\n\u003cdiv class=\"language-json highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nl\"\u003e\"id\"\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nl\"\u003e\"phone\"\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kc\"\u003enull\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eThe meaning of the data in both documents is identical - the user has no phone number. However, the schema of the second\ndocument is different from the first one because it contains two fields.\u003c/p\u003e\n\n\u003cp\u003eHere are the results:\u003c/p\u003e\n\n\u003cp\u003e\u003cimg src=\"/img/articles/2021-01-14-impact-of-the-data-model-on-the-MongoDB-database-size/chart-null.png\" alt=\"null vs empty size\" /\u003e\u003c/p\u003e\n\n\u003cp\u003eThe results are quite surprising: saving a million null’s is quite expensive as it takes more than 1MB on a disk.\u003c/p\u003e\n\n\u003ch3 id=\"enumerated-types\"\u003eEnumerated types\u003c/h3\u003e\n\n\u003cp\u003eNow, let’s also look at the enumerated types. You can store them in two ways, either by using a label:\u003c/p\u003e\n\n\u003cdiv class=\"language-json highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"nl\"\u003e\"_id\"\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nl\"\u003e\"source\"\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s2\"\u003e\"ALLEGRO\"\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eor by ordinal value:\u003c/p\u003e\n\n\u003cdiv class=\"language-json highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"nl\"\u003e\"_id\"\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nl\"\u003e\"source\"\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eHere an analogy with the first experiment can be found: again we replace a character string with a numerical value.\nSince we got a great result the first time, maybe we could repeat it here?\u003c/p\u003e\n\n\u003cp\u003e\u003cimg src=\"/img/articles/2021-01-14-impact-of-the-data-model-on-the-MongoDB-database-size/chart-enums-1.png\" alt=\"label vs index size\" /\u003e\u003c/p\u003e\n\n\u003cp\u003eUnfortunately, the result is disappointing and the reduction in size is small. However, if we think more deeply, we will\ncome to the conclusion that it could not have been otherwise. The enumerated types are not unique identifiers. We are\ndealing only with a few possible values, appearing many times in the whole collection, so it’s a great chance for\nMongoDB data compression to prove its worth. Most likely the values from the first collection have been automatically replaced by the\nengine to its corresponding ordinal values. Additionally, we don’t have any profit on the schema here, because they are\nthe same in both cases. The situation might be different for collections that do not have data compression enabled.\u003c/p\u003e\n\n\u003cp\u003eThis is a good time to take a closer look at how \u003ca href=\"https://www.mongodb.com/blog/post/new-compression-options-mongodb-30\"\u003esnappy\u003c/a\u003e\ncompression works in MongoDB. I’ve prepared two more collections, with identical data, but with data compression\nturned off. The results are shown in the chart below, compiled together with the collections with data compression turned on.\u003c/p\u003e\n\n\u003cp\u003e\u003cimg src=\"/img/articles/2021-01-14-impact-of-the-data-model-on-the-MongoDB-database-size/chart-enums-2.png\" alt=\"snappy vs plain size\" /\u003e\u003c/p\u003e\n\n\u003cp\u003eIt is clear that the use of an ordinal value instead of a label of the enumerated type brings considerable profit for\ncollections with data compression disabled. In case of lack of compression it is definitely worth considering using numerical\nvalues.\u003c/p\u003e\n\n\u003ch3 id=\"useless-_class-field\"\u003eUseless _class field\u003c/h3\u003e\n\n\u003cp\u003eIf we use \u003ccode class=\"language-plaintext highlighter-rouge\"\u003espring-data\u003c/code\u003e, each of our collections additionally contains a \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e_class\u003c/code\u003e field storing the package and the\nname of the entity class containing the mapping for documents from this collection. This mechanism is used to support\ninheritance of model classes, that is not widely used. In most cases this field stores exactly the same values for each\ndocument what makes it useless. And how much does it cost? Let’s compare the following documents:\u003c/p\u003e\n\n\u003cdiv class=\"language-json highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"nl\"\u003e\"_id\"\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eand\u003c/p\u003e\n\n\u003cdiv class=\"language-json highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"nl\"\u003e\"_id\"\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nl\"\u003e\"_class\"\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s2\"\u003e\"pl.allegro.some.project.domain.sample\"\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e\u003cimg src=\"/img/articles/2021-01-14-impact-of-the-data-model-on-the-MongoDB-database-size/chart-class.png\" alt=\"_class field size\" /\u003e\u003c/p\u003e\n\n\u003cp\u003eThe difference is considerable, over 50%. Bearing in mind that the compression is enabled, I believe that the impact of\nthe data itself is small and the result is caused by the schema of the collection containing only the key being half as small\nas the one with the key (1 field vs 2 fields). After removal of the \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e_class\u003c/code\u003e field from a document with more fields,\nthe difference expressed in percent will be much smaller of course. However, storing useless data does not make sense.\u003c/p\u003e\n\n\u003ch3 id=\"useless-indexes\"\u003eUseless indexes\u003c/h3\u003e\n\n\u003cp\u003eWhen investigating the case with identifiers stored as strings, I checked whether manipulating the data type could reduce\nthe index size. Unfortunately I did not succeed, so I decided to focus on the problem of redundant indexes.\u003c/p\u003e\n\n\u003cp\u003eIt is usually a good practice to cover each query with an index so that the number of \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ecollscan\u003c/code\u003e operations is as small as\npossible. This often leads to situations where we have too many indexes. We add more queries, create new indexes for\nthem, and often it turns out that this newly created index takes over the queries of another one.\nAs a result, we have to maintain many unnecessary indexes, wasting disk space and CPU time.\u003c/p\u003e\n\n\u003cp\u003eFortunately, it is possible to check the number of index uses with the query:\u003c/p\u003e\n\n\u003cdiv class=\"language-sql highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"n\"\u003edb\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCOLLECTION_NAME\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"k\"\u003eaggregate\u003c/span\u003e\u003cspan class=\"p\"\u003e([\u003c/span\u003e\u003cspan class=\"err\"\u003e{$\u003c/span\u003e\u003cspan class=\"n\"\u003eindexStats\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"err\"\u003e{}}\u003c/span\u003e\u003cspan class=\"p\"\u003e])\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eIt allows you to find indexes that are not used so you can safely delete them.\u003c/p\u003e\n\n\u003cp\u003eAnd finally, one more thing. Indexes can be removed quickly, but they take much longer to rebuild. This means that the\nconsequences of removal of an index by mistake can be severe. Therefore it is better to make sure that the index to be\ndeleted is definitely not used by any query. The latest MongoDB 4.4 provides a command that helps to avoid errors:\u003c/p\u003e\n\n\u003cdiv class=\"language-sql highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"n\"\u003edb\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCOLLECTION_NAME\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ehideIndex\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"k\"\u003eindex\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eThe above-mentioned command hides the index from the query optimizer. It does not take this index into account when\nbuilding the query execution plan, but the index is still updated when modifying documents. Thanks to that, if it turns\nout that it was needed, we are able to restore it immediately and it will still be up-to-date.\u003c/p\u003e\n\n\u003ch3 id=\"conclusion\"\u003eConclusion\u003c/h3\u003e\n\n\u003cp\u003eUsing a few simple techniques, preparing several versions of the schema and using stats() command we are able to design\na model which does not overload our infrastructure. I encourage you to experiment with your own databases. Maybe you too\ncan save some disk space and CPU time.\u003c/p\u003e\n","contentSnippet":"So I was tuning one of our services in order to speed up some MongoDB queries. Incidentally, my attention was caught by\nthe size of one of the collections that contains archived objects and therefore is rarely used. Unfortunately I wasn’t\nable to reduce the size of the documents stored there, but I started to wonder: is it possible to store the same data\nin a more compact way? Mongo stores JSON that allows many different ways of expressing similar data, so there seems\nto be room for improvements.\nIt is worth asking: why make such an effort in the era of Big Data and unlimited resources? There are several reasons.\nFirst of all, the resources are not unlimited and at the end we have physical drives that cost money to buy, replace,\nmaintain, and be supplied with power.\nSecondly, less stored data results in less time to access it. Moreover, less data means that more of it will fit into\ncache, so the next data access will be an order of magnitude faster.\nI decided to do some experiments and check how the model design affects the size of database files.\nI used a local MongoDB Community Edition 4.4 installation and I initially tested collections containing 1\nmillion and 10 million documents. One of the variants contained up to 100 million, but the results were proportional\n(nearly linear). Therefore, in the end I decided to stop at 1M collections, because loading the data was simply much faster.\nHaving access to local database files, I could easily check the size of the files storing individual collections.\nHowever, it turned out to be unnecessary, because the same data can be obtained with the command:\n\ndb.getCollection('COLLECTION_NAME').stats()\n\n\n\nThe following fields are expressed in bytes:\nsize: size of all collection documents, before compression,\navgObjSize: average document size, before compression,\nstorageSize: file size on the disk; this is the value after the data is compressed, the same value is returned by\nls command,\nfreeStorageSize: size of unused space allocated for the data; Mongo does not increase the file size byte-by-byte,\nbut allocates a percentage of the current file size and this value indicates how much data will still fit into the file.\nTo present the results I used (storageSize - freeStorageSize) value that indicates the actual space occupied by the data.\nMy local MongoDB instance had compression enabled. Not every storage engine has this option enabled by default, so when\nyou start your own analysis it is worth checking how it is in your particular case.\nId field type\nIn the beginning I decided to check ID fields. Not the collection primary key, mind you – it is ‘ObjectId’ type by\ndefault and generally shouldn’t be changed. I decided to focus on user\nand offers identifiers which, although numerical, are often saved as String in Mongo. I believe it comes partly due to\nthe contract of our services - identifiers in JSON most often come as Strings and in this form they are later stored\nin our databases.\nLet’s start with some theory: the number of int32 type in Mongo has a fixed size of 4 bytes. The same number\nwritten as a String of characters has a size dependent on the number of digits; additionally it contains the length of\nthe text (4 bytes) and a terminator character. For example, the text “0” is 12 bytes long and “1234567890” is 25 bytes\nlong. So in theory we should get interesting results, but what does it look like in reality?\nI prepared 2 collections, one million documents each, containing the following documents:\n\n{ \"_id\" : 1 }\n\n\nand\n\n{ \"_id\" : \"1\" }\n\n\nThe values of identifiers were consecutive natural numbers. Here is the comparison of results:\n\nAs you can see the difference is significant since the size on disk decreased by half. Additionally, it is worth\nnoting here that my data is synthetic and the identifiers start from 1. The advantage of a numerical identifier over a\nString increases the more digits a number has, so benefits should be even better for the real life data.\nEncouraged by the success I decided to check if field type had any influence on the size of an index created on it. In\nthis case, unfortunately, I got disappointed: the sizes were similar. This is due to the fact that MongoDB\nuses a hash function when creating indexes, so physically both indexes are composed of numerical values.\nHowever, if we are dealing with hashing, maybe at least searching by index in a numerical field is faster?\nI made a comparison of searching for a million and 10 million documents by indexed key in a random but the same order\nfor both collections. Again, a missed shot: both tests ended up with a similar result, so the conclusion is this:\nit is worth using numerical identifiers, because they require less disk space, but we will not get additional benefits\nassociated with indexes on these fields.\n\n\nSimple and complex structures\nLet’s move on to more complex data. Our models are often built from smaller structures grouping data such as user,\norder or offer. I decided to compare the size of documents storing such structures and their flat counterparts:\n\n{\"_id\": 1, \"user\": {\"name\": \"Jan\", \"surname\": \"Nowak\"}}\n\n\nand\n\n{\"_id\": 1, \"userName\": \"Jan\", \"userSurname\": \"Nowak\"}\n\n\nIn both cases we store identical data, the documents differ only in the schema. Take a look at the result:\n\nThere is a slight reduction by 0.4MB. It may seem not much compared to the effect we achieved for the field\ncontaining an ID. However, we have to bear in mind that in this case we were dealing with a more complex document. It\ncontained – in addition to the compared fields – a numerical type identifier that, as we remember from previous\nexperiments, takes up about 5MB of disk space.\nTaking this into account in the above results we are talking about a decrease from 3.4MB to 3MB. It actually looks\nbetter as percentage - we saved 12% of the space needed to store personal data.\nLet’s go back to the discussed documents for a moment:\n\n{\"_id\": 1, \"user\": {\"name\": \"Jan\", \"surname\": \"Nowak\"}}\n\n\nand\n\n{\"_id\": 1, \"userName\": \"Jan\", \"userSurname\": \"Nowak\"}\n\n\nA watchful eye will notice that I used longer field names in the document after flattening. So instead of user.name\nand user.surname I made userName and userSurname. I did it automatically, a bit unconsciously, to make the\nresulting JSON more readable.  However, if by changing only the schema of the document from compound to flat we managed\nto reduce the size of the data, maybe it is worth to go a step further and shorten the field names?\nI decided to add a third document for comparison, flattened and with shorter field names:\n\n{\"_id\": 1, \"name\": \"Jan\", \"surname\": \"Nowak\"}\n\n\nThe results are shown in the chart below:\n\nThe result is even better than just flattening. Apart from the document’s key size, we achieved a decrease from\n3.4MB to 2MB. Why does this happen even though we store exactly the same data?\nThe reason for the decrease is the nature of NoSQL databases that, unlike the relational ones, do not have a schema\ndefined at the level of the entire collection. If someone is very stubborn, they can store user data, offers, orders and\npayments in one collection. It would still be possible to read, index and search that data. This is because the\ndatabase, in addition to the data itself, stores its schema with each document. Thus, the total size of a document\nconsists of its data and its schema. And that explains the whole puzzle. By reducing the size of the schema, we also\nreduce the size of each document, i.e. the size of the final file with the collection data. It is worth taking this into\naccount when designing a collection schema in order not to blow it up too much. Of course, you cannot go to extremes, because\nthat would lead us to fields named a, b and c, what would make the collection completely illegible for a human.\nFor very large collections, however, this approach is used, an example of which is the MongoDB operation log\nthat contains fields called:\nh\n  \nop\nns\no\n  \no2\nb\n\n\nEmpty fields\nSince we are at the document’s schema, it is still worth looking at the problem of blank fields. In the case of\nJSON the lack of value in a certain field can be written in two ways, either directly - by writing null in its value -\nor by not serializing the field at all. I prepared a comparison of documents with the following structure:\n\n{ \"id\" : 1 }\n\n\nand\n\n{ \"id\" : 1, \"phone\" : null}\n\n\nThe meaning of the data in both documents is identical - the user has no phone number. However, the schema of the second\ndocument is different from the first one because it contains two fields.\nHere are the results:\n\nThe results are quite surprising: saving a million null’s is quite expensive as it takes more than 1MB on a disk.\nEnumerated types\nNow, let’s also look at the enumerated types. You can store them in two ways, either by using a label:\n\n{\"_id\": 1, \"source\": \"ALLEGRO\"}\n\n\nor by ordinal value:\n\n{\"_id\": 1, \"source\": 1}\n\n\nHere an analogy with the first experiment can be found: again we replace a character string with a numerical value.\nSince we got a great result the first time, maybe we could repeat it here?\n\nUnfortunately, the result is disappointing and the reduction in size is small. However, if we think more deeply, we will\ncome to the conclusion that it could not have been otherwise. The enumerated types are not unique identifiers. We are\ndealing only with a few possible values, appearing many times in the whole collection, so it’s a great chance for\nMongoDB data compression to prove its worth. Most likely the values from the first collection have been automatically replaced by the\nengine to its corresponding ordinal values. Additionally, we don’t have any profit on the schema here, because they are\nthe same in both cases. The situation might be different for collections that do not have data compression enabled.\nThis is a good time to take a closer look at how snappy\ncompression works in MongoDB. I’ve prepared two more collections, with identical data, but with data compression\nturned off. The results are shown in the chart below, compiled together with the collections with data compression turned on.\n\nIt is clear that the use of an ordinal value instead of a label of the enumerated type brings considerable profit for\ncollections with data compression disabled. In case of lack of compression it is definitely worth considering using numerical\nvalues.\nUseless _class field\nIf we use spring-data, each of our collections additionally contains a _class field storing the package and the\nname of the entity class containing the mapping for documents from this collection. This mechanism is used to support\ninheritance of model classes, that is not widely used. In most cases this field stores exactly the same values for each\ndocument what makes it useless. And how much does it cost? Let’s compare the following documents:\n\n{\"_id\": 1}\n\n\nand\n\n{\"_id\": 1, \"_class\": \"pl.allegro.some.project.domain.sample\"}\n\n\n\nThe difference is considerable, over 50%. Bearing in mind that the compression is enabled, I believe that the impact of\nthe data itself is small and the result is caused by the schema of the collection containing only the key being half as small\nas the one with the key (1 field vs 2 fields). After removal of the _class field from a document with more fields,\nthe difference expressed in percent will be much smaller of course. However, storing useless data does not make sense.\nUseless indexes\nWhen investigating the case with identifiers stored as strings, I checked whether manipulating the data type could reduce\nthe index size. Unfortunately I did not succeed, so I decided to focus on the problem of redundant indexes.\nIt is usually a good practice to cover each query with an index so that the number of collscan operations is as small as\npossible. This often leads to situations where we have too many indexes. We add more queries, create new indexes for\nthem, and often it turns out that this newly created index takes over the queries of another one.\nAs a result, we have to maintain many unnecessary indexes, wasting disk space and CPU time.\nFortunately, it is possible to check the number of index uses with the query:\n\ndb.COLLECTION_NAME.aggregate([{$indexStats:{}}])\n\n\nIt allows you to find indexes that are not used so you can safely delete them.\nAnd finally, one more thing. Indexes can be removed quickly, but they take much longer to rebuild. This means that the\nconsequences of removal of an index by mistake can be severe. Therefore it is better to make sure that the index to be\ndeleted is definitely not used by any query. The latest MongoDB 4.4 provides a command that helps to avoid errors:\n\ndb.COLLECTION_NAME.hideIndex(\u003cindex\u003e)\n\n\nThe above-mentioned command hides the index from the query optimizer. It does not take this index into account when\nbuilding the query execution plan, but the index is still updated when modifying documents. Thanks to that, if it turns\nout that it was needed, we are able to restore it immediately and it will still be up-to-date.\nConclusion\nUsing a few simple techniques, preparing several versions of the schema and using stats() command we are able to design\na model which does not overload our infrastructure. I encourage you to experiment with your own databases. Maybe you too\ncan save some disk space and CPU time.","guid":"https://blog.allegro.tech/2021/01/impact-of-the-data-model-on-the-MongoDB-database-size.html","categories":["mongodb"],"isoDate":"2021-01-13T23:00:00.000Z","thumbnail":"images/post-headers/mongodb.png"}],"jobs":[{"id":"743999739442143","name":"Team Leader (Java/Kotlin) - Delivery Experience","uuid":"ac51bc62-9580-46c6-88ae-6c365e04837d","refNumber":"REF2692F","company":{"identifier":"Allegro","name":"Allegro"},"releasedDate":"2021-03-19T15:26:11.000Z","location":{"city":"Warszawa","country":"pl","remote":false},"industry":{"id":"internet","label":"Internet"},"department":{"id":"2216365","label":"Product Development"},"function":{"id":"engineering","label":"Engineering"},"typeOfEmployment":{"label":"Full-time"},"experienceLevel":{"id":"mid_senior_level","label":"Mid-Senior Level"},"customField":[{"fieldId":"58c15608e4b01d4b19ddf790","fieldLabel":"Proces rekrutacji","valueId":"c807eec2-8a53-4b55-b7c5-c03180f2059b","valueLabel":"IT Allegro"},{"fieldId":"COUNTRY","fieldLabel":"Country","valueId":"pl","valueLabel":"Poland"},{"fieldId":"58c13159e4b01d4b19ddf729","fieldLabel":"Department","valueId":"2216365","valueLabel":"Product Development"},{"fieldId":"58c13159e4b01d4b19ddf728","fieldLabel":"Brands","valueId":"4ccb4fab-6c3f-4ed0-9140-8533fe17447f","valueLabel":"Allegro"}],"ref":"https://api.smartrecruiters.com/v1/companies/allegro/postings/743999739442143","creator":{"name":"Paulina Partyka"},"language":{"code":"pl","label":"Polish","labelNative":"polski"}},{"id":"743999739437299","name":"Business Application Administrator (Cognos)","uuid":"46dbb67e-a05c-48f8-a820-2e89d7dffa5c","refNumber":"REF2689W","company":{"identifier":"Allegro","name":"Allegro"},"releasedDate":"2021-03-19T14:59:34.000Z","location":{"city":"Poznań","region":"Greater Poland Voivodeship","country":"pl","remote":false},"industry":{"id":"internet","label":"Internet"},"department":{"id":"1013275","label":"IT Business Services"},"function":{"id":"information_technology","label":"Information Technology"},"typeOfEmployment":{"label":"Full-time"},"experienceLevel":{"id":"mid_senior_level","label":"Mid-Senior Level"},"customField":[{"fieldId":"58c1575ee4b01d4b19ddf797","fieldLabel":"Kraków","valueId":"2cfcfcc1-da44-43f7-8eaa-3907faf2797c","valueLabel":"Tak"},{"fieldId":"58c15608e4b01d4b19ddf790","fieldLabel":"Proces rekrutacji","valueId":"c807eec2-8a53-4b55-b7c5-c03180f2059b","valueLabel":"IT Allegro"},{"fieldId":"COUNTRY","fieldLabel":"Country","valueId":"pl","valueLabel":"Poland"},{"fieldId":"58c15798e4b01d4b19ddf79b","fieldLabel":"Wrocław","valueId":"64818201-cdba-422e-8e8c-8ec633b0d327","valueLabel":"Tak"},{"fieldId":"58c158e9e4b0614667d5973e","fieldLabel":"Więcej lokalizacji","valueId":"3a186e8d-a82c-4955-af81-fcef9a63928a","valueLabel":"Tak"},{"fieldId":"58c13159e4b01d4b19ddf729","fieldLabel":"Department","valueId":"1013275","valueLabel":"IT Business Services"},{"fieldId":"58c13159e4b01d4b19ddf728","fieldLabel":"Brands","valueId":"4ccb4fab-6c3f-4ed0-9140-8533fe17447f","valueLabel":"Allegro"},{"fieldId":"58c1576ee4b0614667d59732","fieldLabel":"Toruń","valueId":"987e8884-bad1-4a8f-b149-99e4184cc221","valueLabel":"Tak"},{"fieldId":"58c156b9e4b01d4b19ddf792","fieldLabel":"Poznań","valueId":"ac20917b-cb6a-4280-aff3-4fae2532a33e","valueLabel":"Tak"},{"fieldId":"58c156e6e4b01d4b19ddf793","fieldLabel":"Warszawa","valueId":"6a428533-1586-4372-89ec-65fb45366363","valueLabel":"Tak"},{"fieldId":"5cdab2c84cedfd0006e7758c","fieldLabel":"Key words","valueLabel":"Cognos"}],"ref":"https://api.smartrecruiters.com/v1/companies/allegro/postings/743999739437299","creator":{"name":"Karolina Kwiecień"},"language":{"code":"en","label":"English","labelNative":"English (US)"}},{"id":"743999739406755","name":"Software Engineer (Java/Kotlin) - Data\u0026AI","uuid":"d7930fc0-3d85-44c3-a1a4-9bbbe6379237","refNumber":"REF2543F","company":{"identifier":"Allegro","name":"Allegro"},"releasedDate":"2021-03-19T12:05:19.000Z","location":{"city":"Warsaw,Poznań,Toruń,Kraków","country":"pl","remote":false},"industry":{"id":"internet","label":"Internet"},"department":{"id":"2215770","label":"AI and Big Data"},"function":{"id":"information_technology","label":"Information Technology"},"typeOfEmployment":{"label":"Full-time"},"experienceLevel":{"id":"mid_senior_level","label":"Mid-Senior Level"},"customField":[{"fieldId":"58c1575ee4b01d4b19ddf797","fieldLabel":"Kraków","valueId":"bcab9d4f-8624-4d85-8e3d-dbf12239b972","valueLabel":"Nie"},{"fieldId":"58c15608e4b01d4b19ddf790","fieldLabel":"Proces rekrutacji","valueId":"c807eec2-8a53-4b55-b7c5-c03180f2059b","valueLabel":"IT Allegro"},{"fieldId":"COUNTRY","fieldLabel":"Country","valueId":"pl","valueLabel":"Poland"},{"fieldId":"58c158e9e4b0614667d5973e","fieldLabel":"Więcej lokalizacji","valueId":"3a186e8d-a82c-4955-af81-fcef9a63928a","valueLabel":"Tak"},{"fieldId":"58c13159e4b01d4b19ddf729","fieldLabel":"Department","valueId":"2215770","valueLabel":"AI and Big Data"},{"fieldId":"58c13159e4b01d4b19ddf728","fieldLabel":"Brands","valueId":"4ccb4fab-6c3f-4ed0-9140-8533fe17447f","valueLabel":"Allegro"},{"fieldId":"58c1576ee4b0614667d59732","fieldLabel":"Toruń","valueId":"987e8884-bad1-4a8f-b149-99e4184cc221","valueLabel":"Tak"},{"fieldId":"58c156b9e4b01d4b19ddf792","fieldLabel":"Poznań","valueId":"ac20917b-cb6a-4280-aff3-4fae2532a33e","valueLabel":"Tak"},{"fieldId":"58c156e6e4b01d4b19ddf793","fieldLabel":"Warszawa","valueId":"6a428533-1586-4372-89ec-65fb45366363","valueLabel":"Tak"},{"fieldId":"5cdab2c84cedfd0006e7758c","fieldLabel":"Key words","valueLabel":"Java, Korlin, Data, Artificial Intelligence"}],"ref":"https://api.smartrecruiters.com/v1/companies/allegro/postings/743999739406755","creator":{"name":"Olga Makarewicz"},"language":{"code":"pl","label":"Polish","labelNative":"polski"}},{"id":"743999739294221","name":"Senior Software Engineer (Kotlin/Java) - Site Reliability Engineering","uuid":"319b35e1-849f-4927-a75f-278ee906ca5a","refNumber":"REF2691L","company":{"identifier":"Allegro","name":"Allegro"},"releasedDate":"2021-03-18T16:38:43.000Z","location":{"city":"Poznań","country":"pl","remote":false},"industry":{"id":"internet","label":"Internet"},"department":{"id":"1013462","label":"Technology - Product Development"},"function":{"id":"information_technology","label":"Information Technology"},"typeOfEmployment":{"label":"Full-time"},"experienceLevel":{"id":"mid_senior_level","label":"Mid-Senior Level"},"customField":[{"fieldId":"58c15608e4b01d4b19ddf790","fieldLabel":"Proces rekrutacji","valueId":"c807eec2-8a53-4b55-b7c5-c03180f2059b","valueLabel":"IT Allegro"},{"fieldId":"COUNTRY","fieldLabel":"Country","valueId":"pl","valueLabel":"Poland"},{"fieldId":"58c13159e4b01d4b19ddf729","fieldLabel":"Department","valueId":"1013462","valueLabel":"Technology - Product Development"},{"fieldId":"58c158e9e4b0614667d5973e","fieldLabel":"Więcej lokalizacji","valueId":"fa9e2c82-b44f-40df-a699-4dea59cb0c13","valueLabel":"Nie"},{"fieldId":"58c13159e4b01d4b19ddf728","fieldLabel":"Brands","valueId":"4ccb4fab-6c3f-4ed0-9140-8533fe17447f","valueLabel":"Allegro"}],"ref":"https://api.smartrecruiters.com/v1/companies/allegro/postings/743999739294221","creator":{"name":"Klaudia Sipurzyńska"},"language":{"code":"pl","label":"Polish","labelNative":"polski"}},{"id":"743999739293071","name":"Business Applications Administrator (Salesforce)","uuid":"dc3e3cb9-f3ce-4ad7-908c-dfc4100a3988","refNumber":"REF2559Q","company":{"identifier":"Allegro","name":"Allegro"},"releasedDate":"2021-03-18T16:31:50.000Z","location":{"city":"Poznań","region":"Greater Poland Voivodeship","country":"pl","remote":false},"industry":{"id":"internet","label":"Internet"},"department":{"id":"1013275","label":"IT Business Services"},"function":{"id":"information_technology","label":"Information Technology"},"typeOfEmployment":{"label":"Full-time"},"experienceLevel":{"id":"mid_senior_level","label":"Mid-Senior Level"},"customField":[{"fieldId":"58c1575ee4b01d4b19ddf797","fieldLabel":"Kraków","valueId":"2cfcfcc1-da44-43f7-8eaa-3907faf2797c","valueLabel":"Tak"},{"fieldId":"58c158e9e4b0614667d5973e","fieldLabel":"Więcej lokalizacji","valueId":"3a186e8d-a82c-4955-af81-fcef9a63928a","valueLabel":"Tak"},{"fieldId":"58c1576ee4b0614667d59732","fieldLabel":"Toruń","valueId":"987e8884-bad1-4a8f-b149-99e4184cc221","valueLabel":"Tak"},{"fieldId":"58c156e6e4b01d4b19ddf793","fieldLabel":"Warszawa","valueId":"6a428533-1586-4372-89ec-65fb45366363","valueLabel":"Tak"},{"fieldId":"58c15608e4b01d4b19ddf790","fieldLabel":"Proces rekrutacji","valueId":"c807eec2-8a53-4b55-b7c5-c03180f2059b","valueLabel":"IT Allegro"},{"fieldId":"COUNTRY","fieldLabel":"Country","valueId":"pl","valueLabel":"Poland"},{"fieldId":"58c15798e4b01d4b19ddf79b","fieldLabel":"Wrocław","valueId":"64818201-cdba-422e-8e8c-8ec633b0d327","valueLabel":"Tak"},{"fieldId":"58c13159e4b01d4b19ddf729","fieldLabel":"Department","valueId":"1013275","valueLabel":"IT Business Services"},{"fieldId":"58c13159e4b01d4b19ddf728","fieldLabel":"Brands","valueId":"4ccb4fab-6c3f-4ed0-9140-8533fe17447f","valueLabel":"Allegro"},{"fieldId":"5dee624907e370138f7ad0bd","fieldLabel":"Kompetencje Allegro","valueId":"236b702e-45b9-4c4b-82d4-01c640aaf881","valueLabel":"Nie"},{"fieldId":"58c156b9e4b01d4b19ddf792","fieldLabel":"Poznań","valueId":"ac20917b-cb6a-4280-aff3-4fae2532a33e","valueLabel":"Tak"},{"fieldId":"5cdab2c84cedfd0006e7758c","fieldLabel":"Key words","valueLabel":"Salesforce, CRM"}],"ref":"https://api.smartrecruiters.com/v1/companies/allegro/postings/743999739293071","creator":{"name":"Karolina Kwiecień"},"language":{"code":"pl","label":"Polish","labelNative":"polski"}}],"events":[{"created":1616053977000,"duration":7200000,"id":"277005370","name":"Allegro Tech Labs #7 Online: System design workshop","rsvp_limit":60,"date_in_series_pattern":false,"status":"upcoming","time":1617811200000,"local_date":"2021-04-07","local_time":"18:00","updated":1616053995000,"utc_offset":7200000,"waitlist_count":0,"yes_rsvp_count":5,"venue":{"id":26906060,"name":"Online event","repinned":false,"country":"","localized_country_name":""},"is_online_event":true,"group":{"created":1425052059000,"name":"allegro Tech","id":18465254,"join_mode":"open","lat":52.2599983215332,"lon":21.020000457763672,"urlname":"allegrotech","who":"Techs","localized_location":"Warsaw, Poland","state":"","country":"pl","region":"en_US","timezone":"Europe/Warsaw"},"link":"https://www.meetup.com/allegrotech/events/277005370/","description":"***REJESTRACJA***Ze względu na duże zainteresowanie wydarzeniem oraz ograniczoną liczbę miejsc, zdecydowaliśmy się zmienić zasady rejestracji na warsztaty. Prosimy o rejestrację poprzez stronę: https://app.evenea.pl/event/allegro-tech-labs-7/. Po kliknięciu…","visibility":"public","member_pay_fee":false},{"created":1615571910000,"duration":7200000,"id":"276893259","name":"#16 Allegro Tech Live - Jak dostać się do Allegro?","date_in_series_pattern":false,"status":"upcoming","time":1617292800000,"local_date":"2021-04-01","local_time":"18:00","updated":1615574835000,"utc_offset":7200000,"waitlist_count":0,"yes_rsvp_count":102,"venue":{"id":26906060,"name":"Online event","repinned":false,"country":"","localized_country_name":""},"is_online_event":true,"group":{"created":1425052059000,"name":"allegro Tech","id":18465254,"join_mode":"open","lat":52.2599983215332,"lon":21.020000457763672,"urlname":"allegrotech","who":"Techs","localized_location":"Warsaw, Poland","state":"","country":"pl","region":"en_US","timezone":"Europe/Warsaw"},"link":"https://www.meetup.com/allegrotech/events/276893259/","description":"Allegro Tech Live to w 100% zdalna odsłona naszych stacjonarnych meetupów Allegro Tech Talks. Zazwyczaj spotykaliśmy się w naszych biurach, ale tym razem to my…","how_to_find_us":"https://www.youtube.com/channel/UC66wC6RBjFk6CuVz7wdjJ5g","visibility":"public","member_pay_fee":false},{"created":1614684480000,"duration":7200000,"id":"276687714","name":"#15 Allegro Tech Live - Jak technicznie dbać o produkt?","date_in_series_pattern":false,"status":"past","time":1616086800000,"local_date":"2021-03-18","local_time":"18:00","updated":1616096848000,"utc_offset":3600000,"waitlist_count":0,"yes_rsvp_count":145,"venue":{"id":26906060,"name":"Online event","repinned":false,"country":"","localized_country_name":""},"is_online_event":true,"group":{"created":1425052059000,"name":"allegro Tech","id":18465254,"join_mode":"open","lat":52.2599983215332,"lon":21.020000457763672,"urlname":"allegrotech","who":"Techs","localized_location":"Warsaw, Poland","state":"","country":"pl","region":"en_US","timezone":"Europe/Warsaw"},"link":"https://www.meetup.com/allegrotech/events/276687714/","description":"Allegro Tech Live to nowa, w 100% zdalna odsłona naszych stacjonarnych meetupów Allegro Tech Talks. Zazwyczaj spotykaliśmy się w naszych biurach, ale tym razem to…","how_to_find_us":"https://www.facebook.com/allegro.tech/","visibility":"public","member_pay_fee":false},{"created":1613735379000,"duration":97200000,"id":"276458683","name":"Allegro Tech Labs #6 Online: Poznać Reacta - poziom podstawowy","date_in_series_pattern":false,"status":"past","time":1615392000000,"local_date":"2021-03-10","local_time":"17:00","updated":1615491463000,"utc_offset":3600000,"waitlist_count":0,"yes_rsvp_count":75,"venue":{"id":26906060,"name":"Online event","repinned":false,"country":"","localized_country_name":""},"is_online_event":true,"group":{"created":1425052059000,"name":"allegro Tech","id":18465254,"join_mode":"open","lat":52.2599983215332,"lon":21.020000457763672,"urlname":"allegrotech","who":"Techs","localized_location":"Warsaw, Poland","state":"","country":"pl","region":"en_US","timezone":"Europe/Warsaw"},"link":"https://www.meetup.com/allegrotech/events/276458683/","description":"***REJESTRACJA***Prosimy o rejestrację poprzez https://app.evenea.pl/event/allegro-tech-labs-6/ Po zarejestrowaniu otrzymasz e-mail z potwierdzeniem rejestracji, Twoim biletem oraz linkiem do warsztatów online. ***SZCZEGÓŁY***Allegro Tech Labs #6 to idealna…","visibility":"public","member_pay_fee":false}],"podcasts":[{"creator":{"name":["Alicja Halamska"]},"title":"Summer e-Xperience w Allegro","link":"https://podcast.allegro.tech/summer_e_xperience_w_allegro","pubDate":"Thu, 18 Mar 2021 00:00:00 GMT","author":{"name":["Alicja Halamska"]},"enclosure":{"url":"https://www.buzzsprout.com/887914/8150206-sezon-ii-4-summer-e-xperience-w-allegro-alicja-halamska.mp3","type":"audio/mpeg"},"content":"Jak wygląda program Summer e-Xperience w obszarze technologii? Czego można nauczyć się podczas programu jako Software Engineer? Dlaczego #dobrzetubyć najlepiej oddaje ideę programu? Komu polecamy nasz letni program i co radzimy? Na te pytania odpowie Alicja Halamska - Junior Software Engineer w Allegro, która w 2020 roku dołączyła do programu Summer e-Xperience.","contentSnippet":"Jak wygląda program Summer e-Xperience w obszarze technologii? Czego można nauczyć się podczas programu jako Software Engineer? Dlaczego #dobrzetubyć najlepiej oddaje ideę programu? Komu polecamy nasz letni program i co radzimy? Na te pytania odpowie Alicja Halamska - Junior Software Engineer w Allegro, która w 2020 roku dołączyła do programu Summer e-Xperience.","guid":"https://podcast.allegro.tech/summer_e_xperience_w_allegro","isoDate":"2021-03-18T00:00:00.000Z","itunes":{"author":"Alicja Halamska","summary":"Jak wygląda program Summer e-Xperience w obszarze technologii? Czego można nauczyć się podczas programu jako Software Engineer? Dlaczego #dobrzetubyć najlepiej oddaje ideę programu? Komu polecamy nasz letni program i co radzimy? Na te pytania odpowie Alicja Halamska - Junior Software Engineer w Allegro, która w 2020 roku dołączyła do programu Summer e-Xperience.","explicit":"false"}},{"creator":{"name":["Piotr Klapczyński"]},"title":"SRE w Allegro","link":"https://podcast.allegro.tech/sre_w_allegro","pubDate":"Thu, 04 Mar 2021 00:00:00 GMT","author":{"name":["Piotr Klapczyński"]},"enclosure":{"url":"https://www.buzzsprout.com/887914/8059450-sezon-ii-3-piotr-klapczynski.mp3","type":"audio/mpeg"},"content":"Jak w Allegro radzimy sobie z awariami? Jak im zapobiegać oraz dlaczego sami je wywołujemy? Czy szalonym jest składanie całego Data Center? Czym jest SRE w Allegro i dlaczego jest unikatowe? Na te wszystkie pytania odpowie Piotr Klapczyński - Team Leader w Allegro.","contentSnippet":"Jak w Allegro radzimy sobie z awariami? Jak im zapobiegać oraz dlaczego sami je wywołujemy? Czy szalonym jest składanie całego Data Center? Czym jest SRE w Allegro i dlaczego jest unikatowe? Na te wszystkie pytania odpowie Piotr Klapczyński - Team Leader w Allegro.","guid":"https://podcast.allegro.tech/sre_w_allegro","isoDate":"2021-03-04T00:00:00.000Z","itunes":{"author":"Piotr Klapczyński","summary":"Jak w Allegro radzimy sobie z awariami? Jak im zapobiegać oraz dlaczego sami je wywołujemy? Czy szalonym jest składanie całego Data Center? Czym jest SRE w Allegro i dlaczego jest unikatowe? Na te wszystkie pytania odpowie Piotr Klapczyński - Team Leader w Allegro.","explicit":"false"}},{"creator":{"name":["Dariusz Jędrzejczyk"]},"title":"Service Mesh oraz praca programisty w Allegro","link":"https://podcast.allegro.tech/service_mesh_oraz_praca_programisty_w_allegro","pubDate":"Thu, 25 Feb 2021 00:00:00 GMT","author":{"name":["Dariusz Jędrzejczyk"]},"enclosure":{"url":"https://www.buzzsprout.com/887914/7917649-sezon-ii-2-service-mesh-oraz-praca-praca-programisty-w-allegro-dariusz-jedrzejczak.mp3","type":"audio/mpeg"},"content":"Czym jest Service Mesh? Jak został wdrożony do Allegro dla ponad 1000 usług na produkcji? Dlaczego usprawnianie pracy programistom jest dla nas ważne i dlaczego programista to klient? Jak wytwarzamy produkty używane przez zespoły deweloperskie? Kim jest Principal w Allegro? Jak może wyglądać ścieżka kariery programisty? Na te pytania odpowie Dariusz Jędrzejczyk - Principal Software Engineer.","contentSnippet":"Czym jest Service Mesh? Jak został wdrożony do Allegro dla ponad 1000 usług na produkcji? Dlaczego usprawnianie pracy programistom jest dla nas ważne i dlaczego programista to klient? Jak wytwarzamy produkty używane przez zespoły deweloperskie? Kim jest Principal w Allegro? Jak może wyglądać ścieżka kariery programisty? Na te pytania odpowie Dariusz Jędrzejczyk - Principal Software Engineer.","guid":"https://podcast.allegro.tech/service_mesh_oraz_praca_programisty_w_allegro","isoDate":"2021-02-25T00:00:00.000Z","itunes":{"author":"Dariusz Jędrzejczyk","summary":"Czym jest Service Mesh? Jak został wdrożony do Allegro dla ponad 1000 usług na produkcji? Dlaczego usprawnianie pracy programistom jest dla nas ważne i dlaczego programista to klient? Jak wytwarzamy produkty używane przez zespoły deweloperskie? Kim jest Principal w Allegro? Jak może wyglądać ścieżka kariery programisty? Na te pytania odpowie Dariusz Jędrzejczyk - Principal Software Engineer.","explicit":"false"}},{"creator":{"name":["Łukasz Ściga"]},"title":"Zbiory danych w Allegro","link":"https://podcast.allegro.tech/zbiory_danych_w_allegro","pubDate":"Wed, 10 Feb 2021 00:00:00 GMT","author":{"name":["Łukasz Ściga"]},"enclosure":{"url":"https://www.buzzsprout.com/887914/7426294-sezon-ii-1-zbiory-danych-w-allegro-lukasz-scigak.mp3","type":"audio/mpeg"},"content":"Czym zajmuje się inżynier danych? Jak powstało Big Data? Jak wykorzystuje się oraz kto korzysta z nowych zbiorów danych? Czym różni się Data Scientist od Data Engineera? Jak połączyć przetwarzanie streamingowe z przetwarzaniem batchowym? Z jakich narzędzi korzysta Data Engineer? Na te pytania odpowie Łukasz Ściga - Data Engineer w Allegro, którego pasją jest programowanie gier komputerowych.","contentSnippet":"Czym zajmuje się inżynier danych? Jak powstało Big Data? Jak wykorzystuje się oraz kto korzysta z nowych zbiorów danych? Czym różni się Data Scientist od Data Engineera? Jak połączyć przetwarzanie streamingowe z przetwarzaniem batchowym? Z jakich narzędzi korzysta Data Engineer? Na te pytania odpowie Łukasz Ściga - Data Engineer w Allegro, którego pasją jest programowanie gier komputerowych.","guid":"https://podcast.allegro.tech/zbiory_danych_w_allegro","isoDate":"2021-02-10T00:00:00.000Z","itunes":{"author":"Łukasz Ściga","summary":"Czym zajmuje się inżynier danych? Jak powstało Big Data? Jak wykorzystuje się oraz kto korzysta z nowych zbiorów danych? Czym różni się Data Scientist od Data Engineera? Jak połączyć przetwarzanie streamingowe z przetwarzaniem batchowym? Z jakich narzędzi korzysta Data Engineer? Na te pytania odpowie Łukasz Ściga - Data Engineer w Allegro, którego pasją jest programowanie gier komputerowych.","explicit":"false"}}]},"__N_SSG":true},"page":"/","query":{},"buildId":"DHNXw5B80oVonXFiciLUT","nextExport":false,"isFallback":false,"gsp":true}</script><script nomodule="" src="/_next/static/chunks/polyfills-3cb8f7ab5d3930a1a759.js"></script><script src="/_next/static/chunks/main-23f4f2620a057c84f895.js" async=""></script><script src="/_next/static/chunks/webpack-50bee04d1dc61f8adf5b.js" async=""></script><script src="/_next/static/chunks/framework.b1290caeda235fc7bf40.js" async=""></script><script src="/_next/static/chunks/b651a894a35ea1e7d121ee74b6c7e8aa31faf049.71d68ec00d361c7548dd.js" async=""></script><script src="/_next/static/chunks/6753331a3a54fd35bc7d92cbaee2b67e833d028a.8bec33551a885abbb7ba.js" async=""></script><script src="/_next/static/chunks/pages/_app-3ea8ca3d27590bc99614.js" async=""></script><script src="/_next/static/chunks/pages/index-7303186a0aecc18782b4.js" async=""></script><script src="/_next/static/DHNXw5B80oVonXFiciLUT/_buildManifest.js" async=""></script><script src="/_next/static/DHNXw5B80oVonXFiciLUT/_ssgManifest.js" async=""></script></body></html>